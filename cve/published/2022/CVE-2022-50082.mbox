From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50082: ext4: fix warning in ext4_iomap_begin as race between bmap and write
Message-Id: <2025061857-CVE-2022-50082-f427@gregkh>
Content-Length: 3661
Lines: 95
X-Developer-Signature: v=1; a=openpgp-sha256; l=3757;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=F2J2C0r7d5braDBnOWQNg1NlQz0RXGCc4ox0eCwZ53I=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlBczI/6eZaTGQ4uHdB5j2H9h+bVuqsnJLS4/p+qsnVr
 fsfK+yV6IhlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJHAllWLDK7E+A9WWpkmVz
 K7qeTp3uuXf/7TSGBYfUui/saXmYk7/yCt+V1erx9+qmHgAA
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: fix warning in ext4_iomap_begin as race between bmap and write

We got issue as follows:
------------[ cut here ]------------
WARNING: CPU: 3 PID: 9310 at fs/ext4/inode.c:3441 ext4_iomap_begin+0x182/0x5d0
RIP: 0010:ext4_iomap_begin+0x182/0x5d0
RSP: 0018:ffff88812460fa08 EFLAGS: 00010293
RAX: ffff88811f168000 RBX: 0000000000000000 RCX: ffffffff97793c12
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000003
RBP: ffff88812c669160 R08: ffff88811f168000 R09: ffffed10258cd20f
R10: ffff88812c669077 R11: ffffed10258cd20e R12: 0000000000000001
R13: 00000000000000a4 R14: 000000000000000c R15: ffff88812c6691ee
FS:  00007fd0d6ff3740(0000) GS:ffff8883af180000(0000) knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fd0d6dda290 CR3: 0000000104a62000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
 iomap_apply+0x119/0x570
 iomap_bmap+0x124/0x150
 ext4_bmap+0x14f/0x250
 bmap+0x55/0x80
 do_vfs_ioctl+0x952/0xbd0
 __x64_sys_ioctl+0xc6/0x170
 do_syscall_64+0x33/0x40
 entry_SYSCALL_64_after_hwframe+0x44/0xa9

Above issue may happen as follows:
          bmap                    write
bmap
  ext4_bmap
    iomap_bmap
      ext4_iomap_begin
                            ext4_file_write_iter
			      ext4_buffered_write_iter
			        generic_perform_write
				  ext4_da_write_begin
				    ext4_da_write_inline_data_begin
				      ext4_prepare_inline_data
				        ext4_create_inline_data
					  ext4_set_inode_flag(inode,
						EXT4_INODE_INLINE_DATA);
      if (WARN_ON_ONCE(ext4_has_inline_data(inode))) ->trigger bug_on

To solved above issue hold inode lock in ext4_bamp.

The Linux kernel CVE team has assigned CVE-2022-50082 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.137 with commit e1682c7171a6c0ff576fe8116b8cba5b8f538b94
	Fixed in 5.15.61 with commit 30dfb75e1f8645404a536c74d468d498adcd4e74
	Fixed in 5.18.18 with commit a9fe6d1e3d343d7309f501b1f48020ce7127221f
	Fixed in 5.19.2 with commit fa6482f374fda29a71ad44d76d35b4842d43cda4
	Fixed in 6.0 with commit 51ae846cff568c8c29921b1b28eb2dfbcd4ac12d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50082
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/inode.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e1682c7171a6c0ff576fe8116b8cba5b8f538b94
	https://git.kernel.org/stable/c/30dfb75e1f8645404a536c74d468d498adcd4e74
	https://git.kernel.org/stable/c/a9fe6d1e3d343d7309f501b1f48020ce7127221f
	https://git.kernel.org/stable/c/fa6482f374fda29a71ad44d76d35b4842d43cda4
	https://git.kernel.org/stable/c/51ae846cff568c8c29921b1b28eb2dfbcd4ac12d
