From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50476: ntb_netdev: Use dev_kfree_skb_any() in interrupt context

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ntb_netdev: Use dev_kfree_skb_any() in interrupt context

TX/RX callback handlers (ntb_netdev_tx_handler(),
ntb_netdev_rx_handler()) can be called in interrupt
context via the DMA framework when the respective
DMA operations have completed. As such, any calls
by these routines to free skb's, should use the
interrupt context safe dev_kfree_skb_any() function.

Previously, these callback handlers would call the
interrupt unsafe version of dev_kfree_skb(). This has
not presented an issue on Intel IOAT DMA engines as
that driver utilizes tasklets rather than a hard
interrupt handler, like the AMD PTDMA DMA driver.
On AMD systems, a kernel WARNING message is
encountered, which is being issued from
skb_release_head_state() due to in_hardirq()
being true.

Besides the user visible WARNING from the kernel,
the other symptom of this bug was that TCP/IP performance
across the ntb_netdev interface was very poor, i.e.
approximately an order of magnitude below what was
expected. With the repair to use dev_kfree_skb_any(),
kernel WARNINGs from skb_release_head_state() ceased
and TCP/IP performance, as measured by iperf, was on
par with expected results, approximately 20 Gb/s on
AMD Milan based server. Note that this performance
is comparable with Intel based servers.

The Linux kernel CVE team has assigned CVE-2022-50476 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 4.9.337 with commit d4460c82177899751975180c268f352893302221
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 4.14.303 with commit dd860b39aa7c7b82e6c99b6fdb99d4610ce49d67
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 4.19.270 with commit 8b78493968ed3cef0326183ed059c55e42f24d5b
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 5.4.229 with commit a6b9e09403102bdf8402dae734800e4916c7ea58
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 5.10.163 with commit 13286ad1c7c49c606fdcba4cf66f953a1a16c1ca
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 5.15.86 with commit 21296a52caa6a6bad6debdfe40ad81d4f1a27e69
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 6.0.16 with commit 14d245da57a11e80277ab455aa9b6dcc5ed38a19
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 6.1.2 with commit 07e28a8f450217db679802ebd4de0915556ce846
	Issue introduced in 3.9 with commit 548c237c0a9972df5d1afaca38aa733ee577128d and fixed in 6.2 with commit 5f7d78b2b12a9d561f48fa00bab29b40f4616dad

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50476
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ntb_netdev.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d4460c82177899751975180c268f352893302221
	https://git.kernel.org/stable/c/dd860b39aa7c7b82e6c99b6fdb99d4610ce49d67
	https://git.kernel.org/stable/c/8b78493968ed3cef0326183ed059c55e42f24d5b
	https://git.kernel.org/stable/c/a6b9e09403102bdf8402dae734800e4916c7ea58
	https://git.kernel.org/stable/c/13286ad1c7c49c606fdcba4cf66f953a1a16c1ca
	https://git.kernel.org/stable/c/21296a52caa6a6bad6debdfe40ad81d4f1a27e69
	https://git.kernel.org/stable/c/14d245da57a11e80277ab455aa9b6dcc5ed38a19
	https://git.kernel.org/stable/c/07e28a8f450217db679802ebd4de0915556ce846
	https://git.kernel.org/stable/c/5f7d78b2b12a9d561f48fa00bab29b40f4616dad
