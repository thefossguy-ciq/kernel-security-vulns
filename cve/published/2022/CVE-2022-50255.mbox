From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50255: tracing: Fix reading strings from synthetic events
Message-Id: <2025091550-CVE-2022-50255-c5ec@gregkh>
Content-Length: 3326
Lines: 75
X-Developer-Signature: v=1; a=openpgp-sha256; l=3402;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=SgLqOlbtXDK2jA5r70Ngl8L/DUB0hId4Vg+Km7xJ5SU=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBknZPyuBKp8sefViv/aFx4z8Wllx07tCJOER4XJV9ztv
 66ZrcLcEcvCIMjEICumyPJlG8/R/RWHFL0MbU/DzGFlAhnCwMUpABPZ955hvh9vaqDh3ZwQ284o
 Huf/cmxK27ieM8yPbGMvWHVituMq1dkxJzWaxN44x2kBAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tracing: Fix reading strings from synthetic events

The follow commands caused a crash:

  # cd /sys/kernel/tracing
  # echo 's:open char file[]' > dynamic_events
  # echo 'hist:keys=common_pid:file=filename:onchange($file).trace(open,$file)' > events/syscalls/sys_enter_openat/trigger'
  # echo 1 > events/synthetic/open/enable

BOOM!

The problem is that the synthetic event field "char file[]" will read
the value given to it as a string without any memory checks to make sure
the address is valid. The above example will pass in the user space
address and the sythetic event code will happily call strlen() on it
and then strscpy() where either one will cause an oops when accessing
user space addresses.

Use the helper functions from trace_kprobe and trace_eprobe that can
read strings safely (and actually succeed when the address is from user
space and the memory is mapped in).

Now the above can show:

     packagekitd-1721    [000] ...2.   104.597170: open: file=/usr/lib/rpm/fileattrs/cmake.attr
    in:imjournal-978     [006] ...2.   104.599642: open: file=/var/lib/rsyslog/imjournal.state.tmp
     packagekitd-1721    [000] ...2.   104.626308: open: file=/usr/lib/rpm/fileattrs/debuginfo.attr

The Linux kernel CVE team has assigned CVE-2022-50255 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10 with commit bd82631d7ccdc894af2738e47abcba2cb6e7dea9 and fixed in 5.15.75 with commit d9c79fbcbdb6cb10c07c85040eaf615180b26c48
	Issue introduced in 5.10 with commit bd82631d7ccdc894af2738e47abcba2cb6e7dea9 and fixed in 5.19.17 with commit 149198d0b884e4606ed1d29b330c70016d878276
	Issue introduced in 5.10 with commit bd82631d7ccdc894af2738e47abcba2cb6e7dea9 and fixed in 6.0.3 with commit f8bae1853196b52ede50950387f5b48cf83b9815
	Issue introduced in 5.10 with commit bd82631d7ccdc894af2738e47abcba2cb6e7dea9 and fixed in 6.1 with commit 0934ae9977c27133449b6dd8c6213970e7eece38

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50255
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/trace/trace_events_synth.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d9c79fbcbdb6cb10c07c85040eaf615180b26c48
	https://git.kernel.org/stable/c/149198d0b884e4606ed1d29b330c70016d878276
	https://git.kernel.org/stable/c/f8bae1853196b52ede50950387f5b48cf83b9815
	https://git.kernel.org/stable/c/0934ae9977c27133449b6dd8c6213970e7eece38
