From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50286: ext4: fix delayed allocation bug in ext4_clu_mapped for bigalloc + inline

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: fix delayed allocation bug in ext4_clu_mapped for bigalloc + inline

When converting files with inline data to extents, delayed allocations
made on a file system created with both the bigalloc and inline options
can result in invalid extent status cache content, incorrect reserved
cluster counts, kernel memory leaks, and potential kernel panics.

With bigalloc, the code that determines whether a block must be
delayed allocated searches the extent tree to see if that block maps
to a previously allocated cluster.  If not, the block is delayed
allocated, and otherwise, it isn't.  However, if the inline option is
also used, and if the file containing the block is marked as able to
store data inline, there isn't a valid extent tree associated with
the file.  The current code in ext4_clu_mapped() calls
ext4_find_extent() to search the non-existent tree for a previously
allocated cluster anyway, which typically finds nothing, as desired.
However, a side effect of the search can be to cache invalid content
from the non-existent tree (garbage) in the extent status tree,
including bogus entries in the pending reservation tree.

To fix this, avoid searching the extent tree when allocating blocks
for bigalloc + inline files that are being converted from inline to
extent mapped.

The Linux kernel CVE team has assigned CVE-2022-50286 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.19.270 with commit d40e09f701cf7a44e595a558b067b2b4f67fbf87 and fixed in 4.19.271 with commit f83391339d8493b9ff24167516aaa5a5e88d8f81
	Issue introduced in 4.20 with commit 0b02f4c0d6d9e2c611dfbdd4317193e9dca740e6 and fixed in 5.4.229 with commit 6f4200ec76a0d31200c308ec5a71c68df5417004
	Issue introduced in 4.20 with commit 0b02f4c0d6d9e2c611dfbdd4317193e9dca740e6 and fixed in 5.10.163 with commit 9404839e0c9db5a517ea83c0ca3388b39d105fdf
	Issue introduced in 4.20 with commit 0b02f4c0d6d9e2c611dfbdd4317193e9dca740e6 and fixed in 5.15.87 with commit d440d6427a5e3a877c1c259b8d2b216ddb65e185
	Issue introduced in 4.20 with commit 0b02f4c0d6d9e2c611dfbdd4317193e9dca740e6 and fixed in 6.0.18 with commit c0c8edbc8abbe8f16d80a1d794d1ba2c12b6f193
	Issue introduced in 4.20 with commit 0b02f4c0d6d9e2c611dfbdd4317193e9dca740e6 and fixed in 6.1.4 with commit 81b915181c630ee1cffa052e52874fe4e1ba91ac
	Issue introduced in 4.20 with commit 0b02f4c0d6d9e2c611dfbdd4317193e9dca740e6 and fixed in 6.2 with commit 131294c35ed6f777bd4e79d42af13b5c41bf2775

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50286
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/extents.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/f83391339d8493b9ff24167516aaa5a5e88d8f81
	https://git.kernel.org/stable/c/6f4200ec76a0d31200c308ec5a71c68df5417004
	https://git.kernel.org/stable/c/9404839e0c9db5a517ea83c0ca3388b39d105fdf
	https://git.kernel.org/stable/c/d440d6427a5e3a877c1c259b8d2b216ddb65e185
	https://git.kernel.org/stable/c/c0c8edbc8abbe8f16d80a1d794d1ba2c12b6f193
	https://git.kernel.org/stable/c/81b915181c630ee1cffa052e52874fe4e1ba91ac
	https://git.kernel.org/stable/c/131294c35ed6f777bd4e79d42af13b5c41bf2775
