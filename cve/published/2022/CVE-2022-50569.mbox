From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50569: xfrm: Update ipcomp_scratches with NULL when freed

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

xfrm: Update ipcomp_scratches with NULL when freed

Currently if ipcomp_alloc_scratches() fails to allocate memory
ipcomp_scratches holds obsolete address. So when we try to free the
percpu scratches using ipcomp_free_scratches() it tries to vfree non
existent vm area. Described below:

static void * __percpu *ipcomp_alloc_scratches(void)
{
        ...
        scratches = alloc_percpu(void *);
        if (!scratches)
                return NULL;
ipcomp_scratches does not know about this allocation failure.
Therefore holding the old obsolete address.
        ...
}

So when we free,

static void ipcomp_free_scratches(void)
{
        ...
        scratches = ipcomp_scratches;
Assigning obsolete address from ipcomp_scratches

        if (!scratches)
                return;

        for_each_possible_cpu(i)
               vfree(*per_cpu_ptr(scratches, i));
Trying to free non existent page, causing warning: trying to vfree
existent vm area.
        ...
}

Fix this breakage by updating ipcomp_scrtches with NULL when scratches
is freed

The Linux kernel CVE team has assigned CVE-2022-50569 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.331 with commit debca61df6bc2f65e020656c9c5b878d6b38d30f
	Fixed in 4.14.296 with commit a39f456d62810c0efb43cead22f98d95b53e4b1a
	Fixed in 4.19.262 with commit 1e8abde895b3ac6a368cbdb372e8800c49e73a28
	Fixed in 5.4.220 with commit 18373ed500f7cd53e24d9b0bd0f1c09d78dba87e
	Fixed in 5.10.150 with commit be81c44242b20fc3bdcc73480ef8aaee56f5d0b6
	Fixed in 5.15.75 with commit 03155680191ef0f004b1d6a5714c5b8cd271ab61
	Fixed in 5.19.17 with commit f3bdba4440d82e0da2b1bfc35d3836c8a8e00677
	Fixed in 6.0.3 with commit 2c19945ce8095d065df550e7fe350cd5cc40c6e6
	Fixed in 6.1 with commit 8a04d2fc700f717104bfb95b0f6694e448a4537f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50569
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/xfrm/xfrm_ipcomp.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/debca61df6bc2f65e020656c9c5b878d6b38d30f
	https://git.kernel.org/stable/c/a39f456d62810c0efb43cead22f98d95b53e4b1a
	https://git.kernel.org/stable/c/1e8abde895b3ac6a368cbdb372e8800c49e73a28
	https://git.kernel.org/stable/c/18373ed500f7cd53e24d9b0bd0f1c09d78dba87e
	https://git.kernel.org/stable/c/be81c44242b20fc3bdcc73480ef8aaee56f5d0b6
	https://git.kernel.org/stable/c/03155680191ef0f004b1d6a5714c5b8cd271ab61
	https://git.kernel.org/stable/c/f3bdba4440d82e0da2b1bfc35d3836c8a8e00677
	https://git.kernel.org/stable/c/2c19945ce8095d065df550e7fe350cd5cc40c6e6
	https://git.kernel.org/stable/c/8a04d2fc700f717104bfb95b0f6694e448a4537f
