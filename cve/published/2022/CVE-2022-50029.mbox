From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50029: clk: qcom: ipq8074: dont disable gcc_sleep_clk_src
Message-Id: <2025061838-CVE-2022-50029-d0df@gregkh>
Content-Length: 5042
Lines: 108
X-Developer-Signature: v=1; a=openpgp-sha256; l=5151;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=ptrIKcZH8R7UvnfaIgh1tboRY7ggGMdXdz6cAjYrfYE=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlBc8KuVPhzHthrsdD/18t1H96veqSovKd/r0yUaPLWu
 lfLjIILOmJZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAiH7YxzFO5f7xE46jeFd1D
 e2S3zdQ7wPG/fSXDgmMtqmULmBo6PJ+XLF03q7db4V+KKgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

clk: qcom: ipq8074: dont disable gcc_sleep_clk_src

Once the usb sleep clocks are disabled, clock framework is trying to
disable the sleep clock source also.

However, it seems that it cannot be disabled and trying to do so produces:
[  245.436390] ------------[ cut here ]------------
[  245.441233] gcc_sleep_clk_src status stuck at 'on'
[  245.441254] WARNING: CPU: 2 PID: 223 at clk_branch_wait+0x130/0x140
[  245.450435] Modules linked in: xhci_plat_hcd xhci_hcd dwc3 dwc3_qcom leds_gpio
[  245.456601] CPU: 2 PID: 223 Comm: sh Not tainted 5.18.0-rc4 #215
[  245.463889] Hardware name: Xiaomi AX9000 (DT)
[  245.470050] pstate: 204000c5 (nzCv daIF +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
[  245.474307] pc : clk_branch_wait+0x130/0x140
[  245.481073] lr : clk_branch_wait+0x130/0x140
[  245.485588] sp : ffffffc009f2bad0
[  245.489838] x29: ffffffc009f2bad0 x28: ffffff8003e6c800 x27: 0000000000000000
[  245.493057] x26: 0000000000000000 x25: 0000000000000000 x24: ffffff800226ef20
[  245.500175] x23: ffffffc0089ff550 x22: 0000000000000000 x21: ffffffc008476ad0
[  245.507294] x20: 0000000000000000 x19: ffffffc00965ac70 x18: fffffffffffc51a7
[  245.514413] x17: 68702e3030303837 x16: 3a6d726f6674616c x15: ffffffc089f2b777
[  245.521531] x14: ffffffc0095c9d18 x13: 0000000000000129 x12: 0000000000000129
[  245.528649] x11: 00000000ffffffea x10: ffffffc009621d18 x9 : 0000000000000001
[  245.535767] x8 : 0000000000000001 x7 : 0000000000017fe8 x6 : 0000000000000001
[  245.542885] x5 : ffffff803fdca6d8 x4 : 0000000000000000 x3 : 0000000000000027
[  245.550002] x2 : 0000000000000027 x1 : 0000000000000023 x0 : 0000000000000026
[  245.557122] Call trace:
[  245.564229]  clk_branch_wait+0x130/0x140
[  245.566490]  clk_branch2_disable+0x2c/0x40
[  245.570656]  clk_core_disable+0x60/0xb0
[  245.574561]  clk_core_disable+0x68/0xb0
[  245.578293]  clk_disable+0x30/0x50
[  245.582113]  dwc3_qcom_remove+0x60/0xc0 [dwc3_qcom]
[  245.585588]  platform_remove+0x28/0x60
[  245.590361]  device_remove+0x4c/0x80
[  245.594179]  device_release_driver_internal+0x1dc/0x230
[  245.597914]  device_driver_detach+0x18/0x30
[  245.602861]  unbind_store+0xec/0x110
[  245.607027]  drv_attr_store+0x24/0x40
[  245.610847]  sysfs_kf_write+0x44/0x60
[  245.614405]  kernfs_fop_write_iter+0x128/0x1c0
[  245.618052]  new_sync_write+0xc0/0x130
[  245.622391]  vfs_write+0x1d4/0x2a0
[  245.626123]  ksys_write+0x58/0xe0
[  245.629508]  __arm64_sys_write+0x1c/0x30
[  245.632895]  invoke_syscall.constprop.0+0x5c/0x110
[  245.636890]  do_el0_svc+0xa0/0x150
[  245.641488]  el0_svc+0x18/0x60
[  245.644872]  el0t_64_sync_handler+0xa4/0x130
[  245.647914]  el0t_64_sync+0x174/0x178
[  245.652340] ---[ end trace 0000000000000000 ]---

So, add CLK_IS_CRITICAL flag to the clock so that the kernel won't try
to disable the sleep clock.

The Linux kernel CVE team has assigned CVE-2022-50029 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.14.291 with commit 38cee0d2b65eed42a44052de1bfdc0177b6c3f05
	Fixed in 4.19.256 with commit 4203b76abe539f3cac258d4cf1e16e2dd95ea60f
	Fixed in 5.4.211 with commit d401611a93b332914cf91eb9bc0b63fa1bdc17e9
	Fixed in 5.10.138 with commit 6b90ab952401bd6c1a321dcfc0e0df080f2bc905
	Fixed in 5.15.63 with commit 17d58499dc9c7e059dab7d170e9bae1e7e9c561b
	Fixed in 5.19.4 with commit 459411b9f0180e3f382d7abfa3028dd3285984c3
	Fixed in 6.0 with commit 1bf7305e79aab095196131bdc87a97796e0e3fac

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50029
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/clk/qcom/gcc-ipq8074.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/38cee0d2b65eed42a44052de1bfdc0177b6c3f05
	https://git.kernel.org/stable/c/4203b76abe539f3cac258d4cf1e16e2dd95ea60f
	https://git.kernel.org/stable/c/d401611a93b332914cf91eb9bc0b63fa1bdc17e9
	https://git.kernel.org/stable/c/6b90ab952401bd6c1a321dcfc0e0df080f2bc905
	https://git.kernel.org/stable/c/17d58499dc9c7e059dab7d170e9bae1e7e9c561b
	https://git.kernel.org/stable/c/459411b9f0180e3f382d7abfa3028dd3285984c3
	https://git.kernel.org/stable/c/1bf7305e79aab095196131bdc87a97796e0e3fac
