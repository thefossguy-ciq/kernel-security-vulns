From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50381: md: fix a crash in mempool_free
Message-Id: <2025091851-CVE-2022-50381-b83f@gregkh>
Content-Length: 5516
Lines: 118
X-Developer-Signature: v=1; a=openpgp-sha256; l=5635;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=5GkMQQ553rRxVz/6DwCJiPK0Vnmc6B3VM5I2vUUwSr4=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlnuOz19r2y43++esqOH4v0hVbwBiqmZL5ynms3MeZUm
 N62mL61HbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjCRtScYFlyZafOorKZeJPV+
 0TQxNe+ZE/IMVBnmykpaLOJw7q77GM91rNI8n2vpy93xAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

md: fix a crash in mempool_free

There's a crash in mempool_free when running the lvm test
shell/lvchange-rebuild-raid.sh.

The reason for the crash is this:
* super_written calls atomic_dec_and_test(&mddev->pending_writes) and
  wake_up(&mddev->sb_wait). Then it calls rdev_dec_pending(rdev, mddev)
  and bio_put(bio).
* so, the process that waited on sb_wait and that is woken up is racing
  with bio_put(bio).
* if the process wins the race, it calls bioset_exit before bio_put(bio)
  is executed.
* bio_put(bio) attempts to free a bio into a destroyed bio set - causing
  a crash in mempool_free.

We fix this bug by moving bio_put before atomic_dec_and_test.

We also move rdev_dec_pending before atomic_dec_and_test as suggested by
Neil Brown.

The function md_end_flush has a similar bug - we must call bio_put before
we decrement the number of in-progress bios.

 BUG: kernel NULL pointer dereference, address: 0000000000000000
 #PF: supervisor write access in kernel mode
 #PF: error_code(0x0002) - not-present page
 PGD 11557f0067 P4D 11557f0067 PUD 0
 Oops: 0002 [#1] PREEMPT SMP
 CPU: 0 PID: 73 Comm: kworker/0:1 Not tainted 6.1.0-rc3 #5
 Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-2 04/01/2014
 Workqueue: kdelayd flush_expired_bios [dm_delay]
 RIP: 0010:mempool_free+0x47/0x80
 Code: 48 89 ef 5b 5d ff e0 f3 c3 48 89 f7 e8 32 45 3f 00 48 63 53 08 48 89 c6 3b 53 04 7d 2d 48 8b 43 10 8d 4a 01 48 89 df 89 4b 08 <48> 89 2c d0 e8 b0 45 3f 00 48 8d 7b 30 5b 5d 31 c9 ba 01 00 00 00
 RSP: 0018:ffff88910036bda8 EFLAGS: 00010093
 RAX: 0000000000000000 RBX: ffff8891037b65d8 RCX: 0000000000000001
 RDX: 0000000000000000 RSI: 0000000000000202 RDI: ffff8891037b65d8
 RBP: ffff8891447ba240 R08: 0000000000012908 R09: 00000000003d0900
 R10: 0000000000000000 R11: 0000000000173544 R12: ffff889101a14000
 R13: ffff8891562ac300 R14: ffff889102b41440 R15: ffffe8ffffa00d05
 FS:  0000000000000000(0000) GS:ffff88942fa00000(0000) knlGS:0000000000000000
 CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
 CR2: 0000000000000000 CR3: 0000001102e99000 CR4: 00000000000006b0
 Call Trace:
  <TASK>
  clone_endio+0xf4/0x1c0 [dm_mod]
  clone_endio+0xf4/0x1c0 [dm_mod]
  __submit_bio+0x76/0x120
  submit_bio_noacct_nocheck+0xb6/0x2a0
  flush_expired_bios+0x28/0x2f [dm_delay]
  process_one_work+0x1b4/0x300
  worker_thread+0x45/0x3e0
  ? rescuer_thread+0x380/0x380
  kthread+0xc2/0x100
  ? kthread_complete_and_exit+0x20/0x20
  ret_from_fork+0x1f/0x30
  </TASK>
 Modules linked in: brd dm_delay dm_raid dm_mod af_packet uvesafb cfbfillrect cfbimgblt cn cfbcopyarea fb font fbdev tun autofs4 binfmt_misc configfs ipv6 virtio_rng virtio_balloon rng_core virtio_net pcspkr net_failover failover qemu_fw_cfg button mousedev raid10 raid456 libcrc32c async_raid6_recov async_memcpy async_pq raid6_pq async_xor xor async_tx raid1 raid0 md_mod sd_mod t10_pi crc64_rocksoft crc64 virtio_scsi scsi_mod evdev psmouse bsg scsi_common [last unloaded: brd]
 CR2: 0000000000000000
 ---[ end trace 0000000000000000 ]---

The Linux kernel CVE team has assigned CVE-2022-50381 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.337 with commit 732cd66ec19a17f2b9183d7d5b7bdb9c39b0776e
	Fixed in 4.14.303 with commit cf06b162f5b6337b688072a1a47941280b8f7110
	Fixed in 4.19.270 with commit b5be563b4356b3089b3245d024cae3f248ba7090
	Fixed in 5.4.229 with commit 384ef33d37cefb2ac539d44597d03f06c9b8975c
	Fixed in 5.10.163 with commit ae7793027766491c5f8635b12d15a5940d3b8698
	Fixed in 5.15.87 with commit 91bd504128a51776472445070e11a3b0f9348c90
	Fixed in 6.0.17 with commit 842f222fc42a9239831e15b1fd49a51c546902cb
	Fixed in 6.1.3 with commit 97ce99984be12b9acb49ddce0f5d8ebb037adbb6
	Fixed in 6.2 with commit 341097ee53573e06ab9fc675d96a052385b851fa

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50381
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/md/md.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/732cd66ec19a17f2b9183d7d5b7bdb9c39b0776e
	https://git.kernel.org/stable/c/cf06b162f5b6337b688072a1a47941280b8f7110
	https://git.kernel.org/stable/c/b5be563b4356b3089b3245d024cae3f248ba7090
	https://git.kernel.org/stable/c/384ef33d37cefb2ac539d44597d03f06c9b8975c
	https://git.kernel.org/stable/c/ae7793027766491c5f8635b12d15a5940d3b8698
	https://git.kernel.org/stable/c/91bd504128a51776472445070e11a3b0f9348c90
	https://git.kernel.org/stable/c/842f222fc42a9239831e15b1fd49a51c546902cb
	https://git.kernel.org/stable/c/97ce99984be12b9acb49ddce0f5d8ebb037adbb6
	https://git.kernel.org/stable/c/341097ee53573e06ab9fc675d96a052385b851fa
