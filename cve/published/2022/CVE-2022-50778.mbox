From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50778: fortify: Fix __compiletime_strlen() under UBSAN_BOUNDS_LOCAL
Message-Id: <2025122400-CVE-2022-50778-0b9a@gregkh>
Content-Length: 3428
Lines: 84
X-Developer-Signature: v=1; a=openpgp-sha256; l=3513;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=ZKzsNbK4GTfr2z0Qs6I9oU5NQXeWfD+QDKxWQKB/rlw=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJneTy1XLf7bM73j2K7MuaeFa1K1wze13uoyyvh+bErmC
 6fXfNoxHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjARns0M8+OusBpczVmhe2P3
 44oVZ1R8/jKfM2SY71j5mafoiOWiucp/43jlHkffcejsAAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

fortify: Fix __compiletime_strlen() under UBSAN_BOUNDS_LOCAL

With CONFIG_FORTIFY=y and CONFIG_UBSAN_LOCAL_BOUNDS=y enabled, we observe
a runtime panic while running Android's Compatibility Test Suite's (CTS)
android.hardware.input.cts.tests. This is stemming from a strlen()
call in hidinput_allocate().

__compiletime_strlen() is implemented in terms of __builtin_object_size(),
then does an array access to check for NUL-termination. A quirk of
__builtin_object_size() is that for strings whose values are runtime
dependent, __builtin_object_size(str, 1 or 0) returns the maximum size
of possible values when those sizes are determinable at compile time.
Example:

  static const char *v = "FOO BAR";
  static const char *y = "FOO BA";
  unsigned long x (int z) {
      // Returns 8, which is:
      // max(__builtin_object_size(v, 1), __builtin_object_size(y, 1))
      return __builtin_object_size(z ? v : y, 1);
  }

So when FORTIFY_SOURCE is enabled, the current implementation of
__compiletime_strlen() will try to access beyond the end of y at runtime
using the size of v. Mixed with UBSAN_LOCAL_BOUNDS we get a fault.

hidinput_allocate() has a local C string whose value is control flow
dependent on a switch statement, so __builtin_object_size(str, 1)
evaluates to the maximum string length, making all other cases fault on
the last character check. hidinput_allocate() could be cleaned up to
avoid runtime calls to strlen() since the local variable can only have
literal values, so there's no benefit to trying to fortify the strlen
call site there.

Perform a __builtin_constant_p() check against index 0 earlier in the
macro to filter out the control-flow-dependant case. Add a KUnit test
for checking the expected behavioral characteristics of FORTIFY_SOURCE
internals.

The Linux kernel CVE team has assigned CVE-2022-50778 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.19.17 with commit ed42391164e6839a48aaf4c53eefda516835e799
	Fixed in 6.0.3 with commit 5d59ad2bfb35fccfe2ad5e8bb8801f6224d3f7d4
	Fixed in 6.1 with commit d07c0acb4f41cc42a0d97530946965b3e4fa68c1

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50778
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/linux/fortify-string.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ed42391164e6839a48aaf4c53eefda516835e799
	https://git.kernel.org/stable/c/5d59ad2bfb35fccfe2ad5e8bb8801f6224d3f7d4
	https://git.kernel.org/stable/c/d07c0acb4f41cc42a0d97530946965b3e4fa68c1
