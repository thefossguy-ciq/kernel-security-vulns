From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50034: usb: cdns3 fix use-after-free at workaround 2
Message-Id: <2025061840-CVE-2022-50034-0d64@gregkh>
Content-Length: 2448
Lines: 68
X-Developer-Signature: v=1; a=openpgp-sha256; l=2517;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=6/tuXxueSa8bEpG6ihfzrONgy9gq+/V3dcJGkOYCzw8=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlBcyL2T09ftlH3U4Jl+Z6qg4FphZsis98tCNkne/RaL
 /fm9JCAjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZjI3yUMC44UhdaLiypMfvyy
 iPks+5uQjnwfOYYFKzzMl/gl/798J5Dl0GTf8LTDze7rAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: cdns3 fix use-after-free at workaround 2

BUG: KFENCE: use-after-free read in __list_del_entry_valid+0x10/0xac

cdns3_wa2_remove_old_request()
{
	...
	kfree(priv_req->request.buf);
	cdns3_gadget_ep_free_request(&priv_ep->endpoint, &priv_req->request);
	list_del_init(&priv_req->list);
	^^^ use after free
	...
}

cdns3_gadget_ep_free_request() free the space pointed by priv_req,
but priv_req is used in the following list_del_init().

This patch move list_del_init() before cdns3_gadget_ep_free_request().

The Linux kernel CVE team has assigned CVE-2022-50034 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.4.211 with commit e65d9b7147d7be3504893ca7dfb85286bda83d40
	Fixed in 5.10.138 with commit 6d7ac60098b206d0472475b666cb09d556bec03d
	Fixed in 5.15.63 with commit c3c1dbad3a2db32ecf371c97f2058491b8ba0f9a
	Fixed in 5.19.4 with commit 6fd50446e7c9a98b4bcf96815f5c9602a16ea472
	Fixed in 6.0 with commit 7d602f30149a117eea260208b1661bc404c21dfd

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50034
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/cdns3/cdns3-gadget.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e65d9b7147d7be3504893ca7dfb85286bda83d40
	https://git.kernel.org/stable/c/6d7ac60098b206d0472475b666cb09d556bec03d
	https://git.kernel.org/stable/c/c3c1dbad3a2db32ecf371c97f2058491b8ba0f9a
	https://git.kernel.org/stable/c/6fd50446e7c9a98b4bcf96815f5c9602a16ea472
	https://git.kernel.org/stable/c/7d602f30149a117eea260208b1661bc404c21dfd
