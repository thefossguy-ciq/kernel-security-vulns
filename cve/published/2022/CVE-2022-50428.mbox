From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50428: ext4: fix off-by-one errors in fast-commit block filling

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: fix off-by-one errors in fast-commit block filling

Due to several different off-by-one errors, or perhaps due to a late
change in design that wasn't fully reflected in the code that was
actually merged, there are several very strange constraints on how
fast-commit blocks are filled with tlv entries:

- tlvs must start at least 10 bytes before the end of the block, even
  though the minimum tlv length is 8.  Otherwise, the replay code will
  ignore them.  (BUG: ext4_fc_reserve_space() could violate this
  requirement if called with a len of blocksize - 9 or blocksize - 8.
  Fortunately, this doesn't seem to happen currently.)

- tlvs must end at least 1 byte before the end of the block.  Otherwise
  the replay code will consider them to be invalid.  This quirk
  contributed to a bug (fixed by an earlier commit) where uninitialized
  memory was being leaked to disk in the last byte of blocks.

Also, strangely these constraints don't apply to the replay code in
e2fsprogs, which will accept any tlvs in the blocks (with no bounds
checks at all, but that is a separate issue...).

Given that this all seems to be a bug, let's fix it by just filling
blocks with tlv entries in the natural way.

Note that old kernels will be unable to replay fast-commit journals
created by kernels that have this commit.

The Linux kernel CVE team has assigned CVE-2022-50428 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10 with commit aa75f4d3daaeb1389b9cce9d6b84401eaf228d4e and fixed in 5.15.87 with commit 18f28f13301d1afb8cea9c4ddcecdbff14488ec6
	Issue introduced in 5.10 with commit aa75f4d3daaeb1389b9cce9d6b84401eaf228d4e and fixed in 6.0.18 with commit 5ca65dffdead16572ca046c43fb576b227f7f635
	Issue introduced in 5.10 with commit aa75f4d3daaeb1389b9cce9d6b84401eaf228d4e and fixed in 6.1.4 with commit 5439ad45c0d0c8db41eb6f4dce6f778f15a5ee16
	Issue introduced in 5.10 with commit aa75f4d3daaeb1389b9cce9d6b84401eaf228d4e and fixed in 6.2 with commit 48a6a66db82b8043d298a630f22c62d43550cae5

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50428
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/fast_commit.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/18f28f13301d1afb8cea9c4ddcecdbff14488ec6
	https://git.kernel.org/stable/c/5ca65dffdead16572ca046c43fb576b227f7f635
	https://git.kernel.org/stable/c/5439ad45c0d0c8db41eb6f4dce6f778f15a5ee16
	https://git.kernel.org/stable/c/48a6a66db82b8043d298a630f22c62d43550cae5
