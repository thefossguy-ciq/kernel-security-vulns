From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50470: xhci: Remove device endpoints from bandwidth list when freeing the device

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

xhci: Remove device endpoints from bandwidth list when freeing the device

Endpoints are normally deleted from the bandwidth list when they are
dropped, before the virt device is freed.

If xHC host is dying or being removed then the endpoints aren't dropped
cleanly due to functions returning early to avoid interacting with a
non-accessible host controller.

So check and delete endpoints that are still on the bandwidth list when
freeing the virt device.

Solves a list_del corruption kernel crash when unbinding xhci-pci,
caused by xhci_mem_cleanup() when it later tried to delete already freed
endpoints from the bandwidth list.

This only affects hosts that use software bandwidth checking, which
currenty is only the xHC in intel Panther Point PCH (Ivy Bridge)

The Linux kernel CVE team has assigned CVE-2022-50470 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.332 with commit 5e4ce28ad907aa54f13b21d5f1dc490525957b0c
	Fixed in 4.14.298 with commit f0de39474078adef6ece7a183e34c15ce2c1d8d1
	Fixed in 4.19.264 with commit cebbc8d335d6bcc1316584f779c08f80287c6af8
	Fixed in 5.4.223 with commit 8f1cd9633d1f21efc13e8fc75be8f2b6bb85e38c
	Fixed in 5.10.153 with commit 678d2cc2041cc6ce05030852dce9ad42719abcfc
	Fixed in 5.15.77 with commit c892a81c7424b4f6a660cb9c249d354ccf3afeca
	Fixed in 6.0.7 with commit 3bf860a41e0f2fcea0ac3aae8f7ef887a7994b70
	Fixed in 6.1 with commit 5aed5b7c2430ce318a8e62f752f181e66f0d1053

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50470
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/host/xhci-mem.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5e4ce28ad907aa54f13b21d5f1dc490525957b0c
	https://git.kernel.org/stable/c/f0de39474078adef6ece7a183e34c15ce2c1d8d1
	https://git.kernel.org/stable/c/cebbc8d335d6bcc1316584f779c08f80287c6af8
	https://git.kernel.org/stable/c/8f1cd9633d1f21efc13e8fc75be8f2b6bb85e38c
	https://git.kernel.org/stable/c/678d2cc2041cc6ce05030852dce9ad42719abcfc
	https://git.kernel.org/stable/c/c892a81c7424b4f6a660cb9c249d354ccf3afeca
	https://git.kernel.org/stable/c/3bf860a41e0f2fcea0ac3aae8f7ef887a7994b70
	https://git.kernel.org/stable/c/5aed5b7c2430ce318a8e62f752f181e66f0d1053
