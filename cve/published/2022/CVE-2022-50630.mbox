From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50630: mm: hugetlb: fix UAF in hugetlb_handle_userfault

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mm: hugetlb: fix UAF in hugetlb_handle_userfault

The vma_lock and hugetlb_fault_mutex are dropped before handling userfault
and reacquire them again after handle_userfault(), but reacquire the
vma_lock could lead to UAF[1,2] due to the following race,

hugetlb_fault
  hugetlb_no_page
    /*unlock vma_lock */
    hugetlb_handle_userfault
      handle_userfault
        /* unlock mm->mmap_lock*/
                                           vm_mmap_pgoff
                                             do_mmap
                                               mmap_region
                                                 munmap_vma_range
                                                   /* clean old vma */
        /* lock vma_lock again  <--- UAF */
    /* unlock vma_lock */

Since the vma_lock will unlock immediately after
hugetlb_handle_userfault(), let's drop the unneeded lock and unlock in
hugetlb_handle_userfault() to fix the issue.

[1] https://lore.kernel.org/linux-mm/000000000000d5e00a05e834962e@google.com/
[2] https://lore.kernel.org/linux-mm/20220921014457.1668-1-liuzixian4@huawei.com/

The Linux kernel CVE team has assigned CVE-2022-50630 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.11 with commit 1a1aad8a9b7bd34f60cdf98cd7915f00ae892c45 and fixed in 5.10.150 with commit 45c33966759ea1b4040c08dacda99ef623c0ca29
	Issue introduced in 4.11 with commit 1a1aad8a9b7bd34f60cdf98cd7915f00ae892c45 and fixed in 5.15.75 with commit 0db2efb3bff879566f05341d94c3de00ac95c4cc
	Issue introduced in 4.11 with commit 1a1aad8a9b7bd34f60cdf98cd7915f00ae892c45 and fixed in 5.19.17 with commit dd691973f67b2800a97db723b1ff6f07fdcf7f5a
	Issue introduced in 4.11 with commit 1a1aad8a9b7bd34f60cdf98cd7915f00ae892c45 and fixed in 6.0.3 with commit 78504bcedb2f1bbfb353b4d233c24d641c4dda33
	Issue introduced in 4.11 with commit 1a1aad8a9b7bd34f60cdf98cd7915f00ae892c45 and fixed in 6.1 with commit 958f32ce832ba781ac20e11bb2d12a9352ea28fc

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50630
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	mm/hugetlb.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/45c33966759ea1b4040c08dacda99ef623c0ca29
	https://git.kernel.org/stable/c/0db2efb3bff879566f05341d94c3de00ac95c4cc
	https://git.kernel.org/stable/c/dd691973f67b2800a97db723b1ff6f07fdcf7f5a
	https://git.kernel.org/stable/c/78504bcedb2f1bbfb353b4d233c24d641c4dda33
	https://git.kernel.org/stable/c/958f32ce832ba781ac20e11bb2d12a9352ea28fc
