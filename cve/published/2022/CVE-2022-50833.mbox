From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50833: Bluetooth: use hdev->workqueue when queuing hdev->{cmd,ncmd}_timer works
Message-Id: <2025123017-CVE-2022-50833-92af@gregkh>
Content-Length: 2733
Lines: 62
X-Developer-Signature: v=1; a=openpgp-sha256; l=2796;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=z0VaHjVXli3Chwen6+/nDgqvnWezGNT2tE7y58seo0s=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBB+/+UT571eaEd3PCyvING9/WS+UcY49YmC57y13va
 sKyFHuXjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZjI83qGBYffGm8T5+HOuegm
 zLVft0REZPOPxQxz5TnurGB4LtcdqHxKVtf0/rRZ6oeXAgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

Bluetooth: use hdev->workqueue when queuing hdev->{cmd,ncmd}_timer works

syzbot is reporting attempt to schedule hdev->cmd_work work from system_wq
WQ into hdev->workqueue WQ which is under draining operation [1], for
commit c8efcc2589464ac7 ("workqueue: allow chained queueing during
destruction") does not allow such operation.

The check introduced by commit 877afadad2dce8aa ("Bluetooth: When HCI work
queue is drained, only queue chained work") was incomplete.

Use hdev->workqueue WQ when queuing hdev->{cmd,ncmd}_timer works because
hci_{cmd,ncmd}_timeout() calls queue_work(hdev->workqueue). Also, protect
the queuing operation with RCU read lock in order to avoid calling
queue_delayed_work() after cancel_delayed_work() completed.

The Linux kernel CVE team has assigned CVE-2022-50833 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.19.2 with commit 3b382555706558f5c0587862b6dc03e96a252bba and fixed in 5.19.15 with commit c4635cf3d845a7324c25c52d549b70c8bd7ad4c7
	Issue introduced in 6.0 with commit 877afadad2dce8aae1f2aad8ce47e072d4f6165e and fixed in 6.0.1 with commit 3c6b036fe5c8ed8b6c4cbdc03605929882907ef0
	Issue introduced in 6.0 with commit 877afadad2dce8aae1f2aad8ce47e072d4f6165e and fixed in 6.1 with commit deee93d13d385103205879a8a0915036ecd83261
	Issue introduced in 5.18.18 with commit 4bf367fa1fefabdf14938d0ac9ed60020389112e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50833
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/bluetooth/hci_core.c
	net/bluetooth/hci_event.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/c4635cf3d845a7324c25c52d549b70c8bd7ad4c7
	https://git.kernel.org/stable/c/3c6b036fe5c8ed8b6c4cbdc03605929882907ef0
	https://git.kernel.org/stable/c/deee93d13d385103205879a8a0915036ecd83261
