From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50494: thermal: intel_powerclamp: Use get_cpu() instead of smp_processor_id() to avoid crash

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

thermal: intel_powerclamp: Use get_cpu() instead of smp_processor_id() to avoid crash

When CPU 0 is offline and intel_powerclamp is used to inject
idle, it generates kernel BUG:

BUG: using smp_processor_id() in preemptible [00000000] code: bash/15687
caller is debug_smp_processor_id+0x17/0x20
CPU: 4 PID: 15687 Comm: bash Not tainted 5.19.0-rc7+ #57
Call Trace:
<TASK>
dump_stack_lvl+0x49/0x63
dump_stack+0x10/0x16
check_preemption_disabled+0xdd/0xe0
debug_smp_processor_id+0x17/0x20
powerclamp_set_cur_state+0x7f/0xf9 [intel_powerclamp]
...
...

Here CPU 0 is the control CPU by default and changed to the current CPU,
if CPU 0 offlined. This check has to be performed under cpus_read_lock(),
hence the above warning.

Use get_cpu() instead of smp_processor_id() to avoid this BUG.

[ rjw: Subject edits ]

The Linux kernel CVE team has assigned CVE-2022-50494 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 4.9.331 with commit 3e799e815097febbcb81b472285be824f5d089f9
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 4.14.296 with commit 0f91f66c568b316b19cb042cf50584467b3bdff4
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 4.19.262 with commit 6904727db0eb62fb0c2dce1cf331c341d97ee4b7
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 5.4.220 with commit 5a646c38f648185ee2c62f2a19da3c6f04e27612
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 5.10.150 with commit 513943bf879d45005213e6f5cfb7d9e9943f589f
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 5.15.75 with commit 5614908434451aafbf9b24cb5247cf1d21269f76
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 5.19.17 with commit 6e2a347b304224b2aeb1c0ea000d1cf8a02cc592
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 6.0.3 with commit 418fae0700e85a498062424f8656435c32cdb200
	Issue introduced in 3.9 with commit d6d71ee4a14ae602db343ec48c491851d7ec5267 and fixed in 6.1 with commit 68b99e94a4a2db6ba9b31fe0485e057b9354a640

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50494
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/thermal/intel/intel_powerclamp.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3e799e815097febbcb81b472285be824f5d089f9
	https://git.kernel.org/stable/c/0f91f66c568b316b19cb042cf50584467b3bdff4
	https://git.kernel.org/stable/c/6904727db0eb62fb0c2dce1cf331c341d97ee4b7
	https://git.kernel.org/stable/c/5a646c38f648185ee2c62f2a19da3c6f04e27612
	https://git.kernel.org/stable/c/513943bf879d45005213e6f5cfb7d9e9943f589f
	https://git.kernel.org/stable/c/5614908434451aafbf9b24cb5247cf1d21269f76
	https://git.kernel.org/stable/c/6e2a347b304224b2aeb1c0ea000d1cf8a02cc592
	https://git.kernel.org/stable/c/418fae0700e85a498062424f8656435c32cdb200
	https://git.kernel.org/stable/c/68b99e94a4a2db6ba9b31fe0485e057b9354a640
