From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50241: NFSD: fix use-after-free on source server when doing inter-server copy
Message-Id: <2025091548-CVE-2022-50241-0f92@gregkh>
Content-Length: 3153
Lines: 73
X-Developer-Signature: v=1; a=openpgp-sha256; l=3227;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=zI/jAWFOkkq8lYxTMo7sygmQojNvBL6ezagPrTC8Tq0=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBknZHxMAy6JSj4/M2Pui5RDgnk7OpbarGBdzztNXtxk/
 uxTnX+9O2JZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAiK7sYFvT6f/3YeplffHfO
 Z93pX5KXznervM2wYAdjSc/D+1fbzGOfWd5N2GRct+3BPwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

NFSD: fix use-after-free on source server when doing inter-server copy

Use-after-free occurred when the laundromat tried to free expired
cpntf_state entry on the s2s_cp_stateids list after inter-server
copy completed. The sc_cp_list that the expired copy state was
inserted on was already freed.

When COPY completes, the Linux client normally sends LOCKU(lock_state x),
FREE_STATEID(lock_state x) and CLOSE(open_state y) to the source server.
The nfs4_put_stid call from nfsd4_free_stateid cleans up the copy state
from the s2s_cp_stateids list before freeing the lock state's stid.

However, sometimes the CLOSE was sent before the FREE_STATEID request.
When this happens, the nfsd4_close_open_stateid call from nfsd4_close
frees all lock states on its st_locks list without cleaning up the copy
state on the sc_cp_list list. When the time the FREE_STATEID arrives the
server returns BAD_STATEID since the lock state was freed. This causes
the use-after-free error to occur when the laundromat tries to free
the expired cpntf_state.

This patch adds a call to nfs4_free_cpntf_statelist in
nfsd4_close_open_stateid to clean up the copy state before calling
free_ol_stateid_reaplist to free the lock state's stid on the reaplist.

The Linux kernel CVE team has assigned CVE-2022-50241 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.150 with commit bbacfcde5fff25ac22597e8373a065c647da6738
	Fixed in 5.15.75 with commit 83b94969751a691347606dbe6b1865efcfa5a643
	Fixed in 5.19.17 with commit 6ea71246b7a02af675d733e72d14bd0d591d5f4a
	Fixed in 6.0.3 with commit 35aa0fb8c3033a3d78603356e96fc18c5b9cceb2
	Fixed in 6.1 with commit 019805fea91599b22dfa62ffb29c022f35abeb06

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50241
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nfsd/nfs4state.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/bbacfcde5fff25ac22597e8373a065c647da6738
	https://git.kernel.org/stable/c/83b94969751a691347606dbe6b1865efcfa5a643
	https://git.kernel.org/stable/c/6ea71246b7a02af675d733e72d14bd0d591d5f4a
	https://git.kernel.org/stable/c/35aa0fb8c3033a3d78603356e96fc18c5b9cceb2
	https://git.kernel.org/stable/c/019805fea91599b22dfa62ffb29c022f35abeb06
