From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50740: wifi: ath9k: hif_usb: fix memory leak of urbs in ath9k_hif_usb_dealloc_tx_urbs()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: ath9k: hif_usb: fix memory leak of urbs in ath9k_hif_usb_dealloc_tx_urbs()

Syzkaller reports a long-known leak of urbs in
ath9k_hif_usb_dealloc_tx_urbs().

The cause of the leak is that usb_get_urb() is called but usb_free_urb()
(or usb_put_urb()) is not called inside usb_kill_urb() as urb->dev or
urb->ep fields have not been initialized and usb_kill_urb() returns
immediately.

The patch removes trying to kill urbs located in hif_dev->tx.tx_buf
because hif_dev->tx.tx_buf is not supposed to contain urbs which are in
pending state (the pending urbs are stored in hif_dev->tx.tx_pending).
The tx.tx_lock is acquired so there should not be any changes in the list.

Found by Linux Verification Center (linuxtesting.org) with Syzkaller.

The Linux kernel CVE team has assigned CVE-2022-50740 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.9.241 with commit 6f0706ef39fecc6bf56d67728fe0c94e26b43e9d and fixed in 4.9.337 with commit 134ae5eba41294eff76e4be20d6001b8f0192207
	Issue introduced in 4.14.203 with commit 795d57a558d106b8a5bc2bd7aeaf707d9a099244 and fixed in 4.14.303 with commit 472312fef2b9eccaa03bd59e0ab2527da945e736
	Issue introduced in 4.19.154 with commit df4318440c1568b7dedc5f7d4e617d0e297a1313 and fixed in 4.19.270 with commit eddbb8f7620f9f8008b090a6e10c460074ca575a
	Issue introduced in 5.4.73 with commit a9990ed2d7ca9339d37c7f67d6f5cb298c3f1b34 and fixed in 5.4.229 with commit 9850791d389b342ae6e573fe8198db0b4d338352
	Issue introduced in 5.10 with commit 03fb92a432ea5abe5909bca1455b7e44a9380480 and fixed in 5.10.163 with commit c3fb3e9a2c0c1a0fa492d90eb19bcfa92a5f884d
	Issue introduced in 5.10 with commit 03fb92a432ea5abe5909bca1455b7e44a9380480 and fixed in 5.15.86 with commit d856f7574bcc1d81de565a857caf32f122cd7ce0
	Issue introduced in 5.10 with commit 03fb92a432ea5abe5909bca1455b7e44a9380480 and fixed in 6.0.16 with commit c05189a429fdb371dd455c3c466d67ac2ebff152
	Issue introduced in 5.10 with commit 03fb92a432ea5abe5909bca1455b7e44a9380480 and fixed in 6.1.2 with commit 08aa0537ec8cf29ceccae98acc1a534fc12598c1
	Issue introduced in 5.10 with commit 03fb92a432ea5abe5909bca1455b7e44a9380480 and fixed in 6.2 with commit c2a94de38c74e86f49124ac14f093d6a5c377a90
	Issue introduced in 4.4.241 with commit b92e116ae36f498858dbb18e29a066c3f5348965
	Issue introduced in 5.8.17 with commit 7f5972267295fe49f8da8eb42bc2eb3d140860c0
	Issue introduced in 5.9.2 with commit 2d72d5ce63c92f56b9f978e8befb5838144176b9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50740
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/ath/ath9k/hif_usb.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/134ae5eba41294eff76e4be20d6001b8f0192207
	https://git.kernel.org/stable/c/472312fef2b9eccaa03bd59e0ab2527da945e736
	https://git.kernel.org/stable/c/eddbb8f7620f9f8008b090a6e10c460074ca575a
	https://git.kernel.org/stable/c/9850791d389b342ae6e573fe8198db0b4d338352
	https://git.kernel.org/stable/c/c3fb3e9a2c0c1a0fa492d90eb19bcfa92a5f884d
	https://git.kernel.org/stable/c/d856f7574bcc1d81de565a857caf32f122cd7ce0
	https://git.kernel.org/stable/c/c05189a429fdb371dd455c3c466d67ac2ebff152
	https://git.kernel.org/stable/c/08aa0537ec8cf29ceccae98acc1a534fc12598c1
	https://git.kernel.org/stable/c/c2a94de38c74e86f49124ac14f093d6a5c377a90
