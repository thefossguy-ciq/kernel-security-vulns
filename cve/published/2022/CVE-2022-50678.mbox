From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50678: wifi: brcmfmac: fix invalid address access when enabling SCAN log level

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: brcmfmac: fix invalid address access when enabling SCAN log level

The variable i is changed when setting random MAC address and causes
invalid address access when printing the value of pi->reqs[i]->reqid.

We replace reqs index with ri to fix the issue.

[  136.726473] Unable to handle kernel access to user memory outside uaccess routines at virtual address 0000000000000000
[  136.737365] Mem abort info:
[  136.740172]   ESR = 0x96000004
[  136.743359]   Exception class = DABT (current EL), IL = 32 bits
[  136.749294]   SET = 0, FnV = 0
[  136.752481]   EA = 0, S1PTW = 0
[  136.755635] Data abort info:
[  136.758514]   ISV = 0, ISS = 0x00000004
[  136.762487]   CM = 0, WnR = 0
[  136.765522] user pgtable: 4k pages, 48-bit VAs, pgdp = 000000005c4e2577
[  136.772265] [0000000000000000] pgd=0000000000000000
[  136.777160] Internal error: Oops: 96000004 [#1] PREEMPT SMP
[  136.782732] Modules linked in: brcmfmac(O) brcmutil(O) cfg80211(O) compat(O)
[  136.789788] Process wificond (pid: 3175, stack limit = 0x00000000053048fb)
[  136.796664] CPU: 3 PID: 3175 Comm: wificond Tainted: G           O      4.19.42-00001-g531a5f5 #1
[  136.805532] Hardware name: Freescale i.MX8MQ EVK (DT)
[  136.810584] pstate: 60400005 (nZCv daif +PAN -UAO)
[  136.815429] pc : brcmf_pno_config_sched_scans+0x6cc/0xa80 [brcmfmac]
[  136.821811] lr : brcmf_pno_config_sched_scans+0x67c/0xa80 [brcmfmac]
[  136.828162] sp : ffff00000e9a3880
[  136.831475] x29: ffff00000e9a3890 x28: ffff800020543400
[  136.836786] x27: ffff8000b1008880 x26: ffff0000012bf6a0
[  136.842098] x25: ffff80002054345c x24: ffff800088d22400
[  136.847409] x23: ffff0000012bf638 x22: ffff0000012bf6d8
[  136.852721] x21: ffff8000aced8fc0 x20: ffff8000ac164400
[  136.858032] x19: ffff00000e9a3946 x18: 0000000000000000
[  136.863343] x17: 0000000000000000 x16: 0000000000000000
[  136.868655] x15: ffff0000093f3b37 x14: 0000000000000050
[  136.873966] x13: 0000000000003135 x12: 0000000000000000
[  136.879277] x11: 0000000000000000 x10: ffff000009a61888
[  136.884589] x9 : 000000000000000f x8 : 0000000000000008
[  136.889900] x7 : 303a32303d726464 x6 : ffff00000a1f957d
[  136.895211] x5 : 0000000000000000 x4 : ffff00000e9a3942
[  136.900523] x3 : 0000000000000000 x2 : ffff0000012cead8
[  136.905834] x1 : ffff0000012bf6d8 x0 : 0000000000000000
[  136.911146] Call trace:
[  136.913623]  brcmf_pno_config_sched_scans+0x6cc/0xa80 [brcmfmac]
[  136.919658]  brcmf_pno_start_sched_scan+0xa4/0x118 [brcmfmac]
[  136.925430]  brcmf_cfg80211_sched_scan_start+0x80/0xe0 [brcmfmac]
[  136.931636]  nl80211_start_sched_scan+0x140/0x308 [cfg80211]
[  136.937298]  genl_rcv_msg+0x358/0x3f4
[  136.940960]  netlink_rcv_skb+0xb4/0x118
[  136.944795]  genl_rcv+0x34/0x48
[  136.947935]  netlink_unicast+0x264/0x300
[  136.951856]  netlink_sendmsg+0x2e4/0x33c
[  136.955781]  __sys_sendto+0x120/0x19c

The Linux kernel CVE team has assigned CVE-2022-50678 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 4.14.296 with commit 7ccb0529446ae68a8581916bfc95c353306d76ba
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 4.19.262 with commit 1c12d47a9017a7745585b57b9b0fdc0d8c50978e
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 5.4.220 with commit 56a0ac48634155d2b866b99fba7e1dd8df4e2804
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 5.10.150 with commit 50e45034c5802cedbf5b707364ea76ace29ad984
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 5.15.75 with commit 75995ce1c926ee87bf93d58977c766b4e7744715
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 5.19.17 with commit 4d4dcfa6b4e85a878401f4fbae4cafc88cdcceb4
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 6.0.3 with commit 826405a911473b6ee8bd2aa891cb2f03a13efa17
	Issue introduced in 4.13 with commit efc2c1fa8e145b60a7805fa9b6c92ac0746fccc3 and fixed in 6.1 with commit aa666b68e73fc06d83c070d96180b9010cf5a960

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50678
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/broadcom/brcm80211/brcmfmac/pno.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/7ccb0529446ae68a8581916bfc95c353306d76ba
	https://git.kernel.org/stable/c/1c12d47a9017a7745585b57b9b0fdc0d8c50978e
	https://git.kernel.org/stable/c/56a0ac48634155d2b866b99fba7e1dd8df4e2804
	https://git.kernel.org/stable/c/50e45034c5802cedbf5b707364ea76ace29ad984
	https://git.kernel.org/stable/c/75995ce1c926ee87bf93d58977c766b4e7744715
	https://git.kernel.org/stable/c/4d4dcfa6b4e85a878401f4fbae4cafc88cdcceb4
	https://git.kernel.org/stable/c/826405a911473b6ee8bd2aa891cb2f03a13efa17
	https://git.kernel.org/stable/c/aa666b68e73fc06d83c070d96180b9010cf5a960
