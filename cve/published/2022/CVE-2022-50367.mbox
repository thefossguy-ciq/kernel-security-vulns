From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50367: fs: fix UAF/GPF bug in nilfs_mdt_destroy
Message-Id: <2025091716-CVE-2022-50367-651c@gregkh>
Content-Length: 2942
Lines: 69
X-Developer-Signature: v=1; a=openpgp-sha256; l=3012;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=b04HDN2lOnLACmDrPUqLdQmGDUf0AwIudPNM8VhgUgc=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBmnzghY8nRauTCXnDs6xT3M/uObQ4v9uD2ue0eYf5W8f
 sBwavPCjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZgINzfDgiv10S8PBc6T+mzY
 +KeoJy5qzj2J/wwLFh9nvZ2XU/P+1szzdwpYX26ollwZCQA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

fs: fix UAF/GPF bug in nilfs_mdt_destroy

In alloc_inode, inode_init_always() could return -ENOMEM if
security_inode_alloc() fails, which causes inode->i_private
uninitialized. Then nilfs_is_metadata_file_inode() returns
true and nilfs_free_inode() wrongly calls nilfs_mdt_destroy(),
which frees the uninitialized inode->i_private
and leads to crashes(e.g., UAF/GPF).

Fix this by moving security_inode_alloc just prior to
this_cpu_inc(nr_inodes)

The Linux kernel CVE team has assigned CVE-2022-50367 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.9.331 with commit d1ff475d7c83289d0a7faef346ea3bbf90818bad
	Fixed in 4.14.296 with commit c0aa76b0f17f59dd9c9d3463550a2986a1d592e4
	Fixed in 4.19.262 with commit ec2aab115eb38ac4992ea2fcc2a02fbe7af5cf48
	Fixed in 5.4.218 with commit 70e4f70d54e0225f91814e8610477d65f33cefe4
	Fixed in 5.10.148 with commit 1e555c3ed1fce4b278aaebe18a64a934cece57d8
	Fixed in 5.15.73 with commit 64b79e632869ad3ef6c098a4731d559381da1115
	Fixed in 5.19.15 with commit 81de80330fa6907aec32eb54c5619059e6e36452
	Fixed in 6.0.1 with commit 2a96b532098284ecf8e4849b8b9e5fc7a28bdee9
	Fixed in 6.1 with commit 2e488f13755ffbb60f307e991b27024716a33b29

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50367
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/inode.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d1ff475d7c83289d0a7faef346ea3bbf90818bad
	https://git.kernel.org/stable/c/c0aa76b0f17f59dd9c9d3463550a2986a1d592e4
	https://git.kernel.org/stable/c/ec2aab115eb38ac4992ea2fcc2a02fbe7af5cf48
	https://git.kernel.org/stable/c/70e4f70d54e0225f91814e8610477d65f33cefe4
	https://git.kernel.org/stable/c/1e555c3ed1fce4b278aaebe18a64a934cece57d8
	https://git.kernel.org/stable/c/64b79e632869ad3ef6c098a4731d559381da1115
	https://git.kernel.org/stable/c/81de80330fa6907aec32eb54c5619059e6e36452
	https://git.kernel.org/stable/c/2a96b532098284ecf8e4849b8b9e5fc7a28bdee9
	https://git.kernel.org/stable/c/2e488f13755ffbb60f307e991b27024716a33b29
