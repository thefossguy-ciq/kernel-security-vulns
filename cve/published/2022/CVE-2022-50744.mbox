From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2022-50744: scsi: lpfc: Fix hard lockup when reading the rx_monitor from debugfs

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: lpfc: Fix hard lockup when reading the rx_monitor from debugfs

During I/O and simultaneous cat of /sys/kernel/debug/lpfc/fnX/rx_monitor, a
hard lockup similar to the call trace below may occur.

The spin_lock_bh in lpfc_rx_monitor_report is not protecting from timer
interrupts as expected, so change the strength of the spin lock to _irq.

Kernel panic - not syncing: Hard LOCKUP
CPU: 3 PID: 110402 Comm: cat Kdump: loaded

exception RIP: native_queued_spin_lock_slowpath+91

[IRQ stack]
 native_queued_spin_lock_slowpath at ffffffffb814e30b
 _raw_spin_lock at ffffffffb89a667a
 lpfc_rx_monitor_record at ffffffffc0a73a36 [lpfc]
 lpfc_cmf_timer at ffffffffc0abbc67 [lpfc]
 __hrtimer_run_queues at ffffffffb8184250
 hrtimer_interrupt at ffffffffb8184ab0
 smp_apic_timer_interrupt at ffffffffb8a026ba
 apic_timer_interrupt at ffffffffb8a01c4f
[End of IRQ stack]

 apic_timer_interrupt at ffffffffb8a01c4f
 lpfc_rx_monitor_report at ffffffffc0a73c80 [lpfc]
 lpfc_rx_monitor_read at ffffffffc0addde1 [lpfc]
 full_proxy_read at ffffffffb83e7fc3
 vfs_read at ffffffffb833fe71
 ksys_read at ffffffffb83402af
 do_syscall_64 at ffffffffb800430b
 entry_SYSCALL_64_after_hwframe at ffffffffb8a000ad

The Linux kernel CVE team has assigned CVE-2022-50744 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15.78 with commit 21d65b35169112af9b6f873c8eeab972e60107c2 and fixed in 5.15.86 with commit 2cf66428a2545bb33beb9624124a2377468bb478
	Issue introduced in 6.0.3 with commit 2c9b5b8326b953f2f48338a7c889e6af457d146f and fixed in 6.0.16 with commit cd542900ee5147028bbe603b238efcab8d720838
	Issue introduced in 6.1 with commit bd269188ea94e40ab002cad7b0df8f12b8f0de54 and fixed in 6.1.2 with commit 39761417ea7b654217d6d9085afbf7c87ba3675d
	Issue introduced in 6.1 with commit bd269188ea94e40ab002cad7b0df8f12b8f0de54 and fixed in 6.2 with commit c44e50f4a0ec00c2298f31f91bc2c3e9bbd81c7e
	Issue introduced in 5.19.17 with commit 147d397e08a406f5997f8a1c7f747fe546bf8395

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2022-50744
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/lpfc/lpfc_sli.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/2cf66428a2545bb33beb9624124a2377468bb478
	https://git.kernel.org/stable/c/cd542900ee5147028bbe603b238efcab8d720838
	https://git.kernel.org/stable/c/39761417ea7b654217d6d9085afbf7c87ba3675d
	https://git.kernel.org/stable/c/c44e50f4a0ec00c2298f31f91bc2c3e9bbd81c7e
