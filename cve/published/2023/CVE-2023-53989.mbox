From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53989: arm64: mm: fix VA-range sanity check

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

arm64: mm: fix VA-range sanity check

Both create_mapping_noalloc() and update_mapping_prot() sanity-check
their 'virt' parameter, but the check itself doesn't make much sense.
The condition used today appears to be a historical accident.

The sanity-check condition:

	if ((virt >= PAGE_END) && (virt < VMALLOC_START)) {
		[ ... warning here ... ]
		return;
	}

... can only be true for the KASAN shadow region or the module region,
and there's no reason to exclude these specifically for creating and
updateing mappings.

When arm64 support was first upstreamed in commit:

  c1cc1552616d0f35 ("arm64: MMU initialisation")

... the condition was:

	if (virt < VMALLOC_START) {
		[ ... warning here ... ]
		return;
	}

At the time, VMALLOC_START was the lowest kernel address, and this was
checking whether 'virt' would be translated via TTBR1.

Subsequently in commit:

  14c127c957c1c607 ("arm64: mm: Flip kernel VA space")

... the condition was changed to:

	if ((virt >= VA_START) && (virt < VMALLOC_START)) {
		[ ... warning here ... ]
		return;
	}

This appear to have been a thinko. The commit moved the linear map to
the bottom of the kernel address space, with VMALLOC_START being at the
halfway point. The old condition would warn for changes to the linear
map below this, and at the time VA_START was the end of the linear map.

Subsequently we cleaned up the naming of VA_START in commit:

  77ad4ce69321abbe ("arm64: memory: rename VA_START to PAGE_END")

... keeping the erroneous condition as:

	if ((virt >= PAGE_END) && (virt < VMALLOC_START)) {
		[ ... warning here ... ]
		return;
	}

Correct the condition to check against the start of the TTBR1 address
space, which is currently PAGE_OFFSET. This simplifies the logic, and
more clearly matches the "outside kernel range" message in the warning.

The Linux kernel CVE team has assigned CVE-2023-53989 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.4 with commit 14c127c957c1c6070647c171e72f06e0db275ebf and fixed in 5.4.251 with commit 9d8d3df71516ec3236d8d93ff029d251377ba4b1
	Issue introduced in 5.4 with commit 14c127c957c1c6070647c171e72f06e0db275ebf and fixed in 5.10.188 with commit 32020fc2a8373d3de35ae6d029d5969a42651e7a
	Issue introduced in 5.4 with commit 14c127c957c1c6070647c171e72f06e0db275ebf and fixed in 5.15.150 with commit 621619f626cbe702ddbdc54117f3868b8ebd8129
	Issue introduced in 5.4 with commit 14c127c957c1c6070647c171e72f06e0db275ebf and fixed in 6.4.7 with commit b03c7fcc5ed854d0e1b27e9abf12428bfa751a37
	Issue introduced in 5.4 with commit 14c127c957c1c6070647c171e72f06e0db275ebf and fixed in 6.5 with commit ab9b4008092c86dc12497af155a0901cc1156999

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53989
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/arm64/mm/mmu.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9d8d3df71516ec3236d8d93ff029d251377ba4b1
	https://git.kernel.org/stable/c/32020fc2a8373d3de35ae6d029d5969a42651e7a
	https://git.kernel.org/stable/c/621619f626cbe702ddbdc54117f3868b8ebd8129
	https://git.kernel.org/stable/c/b03c7fcc5ed854d0e1b27e9abf12428bfa751a37
	https://git.kernel.org/stable/c/ab9b4008092c86dc12497af155a0901cc1156999
