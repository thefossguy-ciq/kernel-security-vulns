From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54132: erofs: stop parsing non-compact HEAD index if clusterofs is invalid
Message-Id: <2025122420-CVE-2023-54132-dd33@gregkh>
Content-Length: 3891
Lines: 82
X-Developer-Signature: v=1; a=openpgp-sha256; l=3974;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=yyqToRuE/SEWMy5lou6tXJdmt00wzMzz+sRUHV9OaG8=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJneT30OZ6d5qLF8nTBr575JE0vDsl8ZHZg7V9BhmdVSf
 oNb7xhtOmJZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAiV9oZ5krHabP8VDeV2Zmb
 +K2587hbOe+SZwwLNp9r6r91pYaxhfPnIl2tDh8B3WBTAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

erofs: stop parsing non-compact HEAD index if clusterofs is invalid

Syzbot generated a crafted image [1] with a non-compact HEAD index of
clusterofs 33024 while valid numbers should be 0 ~ lclustersize-1,
which causes the following unexpected behavior as below:

 BUG: unable to handle page fault for address: fffff52101a3fff9
 #PF: supervisor read access in kernel mode
 #PF: error_code(0x0000) - not-present page
 PGD 23ffed067 P4D 23ffed067 PUD 0
 Oops: 0000 [#1] PREEMPT SMP KASAN
 CPU: 1 PID: 4398 Comm: kworker/u5:1 Not tainted 6.3.0-rc6-syzkaller-g09a9639e56c0 #0
 Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 03/30/2023
 Workqueue: erofs_worker z_erofs_decompressqueue_work
 RIP: 0010:z_erofs_decompress_queue+0xb7e/0x2b40
 ...
 Call Trace:
  <TASK>
  z_erofs_decompressqueue_work+0x99/0xe0
  process_one_work+0x8f6/0x1170
  worker_thread+0xa63/0x1210
  kthread+0x270/0x300
  ret_from_fork+0x1f/0x30

Note that normal images or images using compact indexes are not
impacted.  Let's fix this now.

[1] https://lore.kernel.org/r/000000000000ec75b005ee97fbaa@google.com

The Linux kernel CVE team has assigned CVE-2023-54132 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 5.4.243 with commit 880c79bdb002b9d5b6940e52c2ad3829c2178207
	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 5.10.180 with commit 7a4579cd6e4936de107c82499c3c9ee11b63401e
	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 5.15.111 with commit 060fecf1114ff9fcfe87953fe8c4fc5048777160
	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 6.1.28 with commit 7ee7a86e28ce9ead7112286c388df8d254c373c6
	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 6.2.15 with commit f01b2894928affa3339d355608713cf3db8360b8
	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 6.3.2 with commit 96a845419b3722869f09883319de4d55c44d9aef
	Issue introduced in 4.19 with commit 02827e1796b33f1794966f5c3101f8da2dfa9c1d and fixed in 6.4 with commit cc4efd3dd2ac9f89143e5d881609747ecff04164

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54132
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/erofs/zmap.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/880c79bdb002b9d5b6940e52c2ad3829c2178207
	https://git.kernel.org/stable/c/7a4579cd6e4936de107c82499c3c9ee11b63401e
	https://git.kernel.org/stable/c/060fecf1114ff9fcfe87953fe8c4fc5048777160
	https://git.kernel.org/stable/c/7ee7a86e28ce9ead7112286c388df8d254c373c6
	https://git.kernel.org/stable/c/f01b2894928affa3339d355608713cf3db8360b8
	https://git.kernel.org/stable/c/96a845419b3722869f09883319de4d55c44d9aef
	https://git.kernel.org/stable/c/cc4efd3dd2ac9f89143e5d881609747ecff04164
