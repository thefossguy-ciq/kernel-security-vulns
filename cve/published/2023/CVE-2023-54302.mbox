From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54302: RDMA/irdma: Fix data race on CQP completion stats
Message-Id: <2025123033-CVE-2023-54302-a9e9@gregkh>
Content-Length: 4418
Lines: 98
X-Developer-Signature: v=1; a=openpgp-sha256; l=4517;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=XwH4pXQWaeWulCGn8VkG2QswVkFd7ydXV8/TFu2WWcA=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBR1wDpAT+/cp6Hbnw13qBzckbTcTW2Bj4aj8OY4tW/
 lr9YC5DRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEzk9V6G2SzaoT+nu7w/+Izz
 gKRHz6w/1WsnxTPM95Z5GKigvva9usXTDw03414VOi68CwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

RDMA/irdma: Fix data race on CQP completion stats

CQP completion statistics is read lockesly in irdma_wait_event and
irdma_check_cqp_progress while it can be updated in the completion
thread irdma_sc_ccq_get_cqe_info on another CPU as KCSAN reports.

Make completion statistics an atomic variable to reflect coherent updates
to it. This will also avoid load/store tearing logic bug potentially
possible by compiler optimizations.

[77346.170861] BUG: KCSAN: data-race in irdma_handle_cqp_op [irdma] / irdma_sc_ccq_get_cqe_info [irdma]

[77346.171383] write to 0xffff8a3250b108e0 of 8 bytes by task 9544 on cpu 4:
[77346.171483]  irdma_sc_ccq_get_cqe_info+0x27a/0x370 [irdma]
[77346.171658]  irdma_cqp_ce_handler+0x164/0x270 [irdma]
[77346.171835]  cqp_compl_worker+0x1b/0x20 [irdma]
[77346.172009]  process_one_work+0x4d1/0xa40
[77346.172024]  worker_thread+0x319/0x700
[77346.172037]  kthread+0x180/0x1b0
[77346.172054]  ret_from_fork+0x22/0x30

[77346.172136] read to 0xffff8a3250b108e0 of 8 bytes by task 9838 on cpu 2:
[77346.172234]  irdma_handle_cqp_op+0xf4/0x4b0 [irdma]
[77346.172413]  irdma_cqp_aeq_cmd+0x75/0xa0 [irdma]
[77346.172592]  irdma_create_aeq+0x390/0x45a [irdma]
[77346.172769]  irdma_rt_init_hw.cold+0x212/0x85d [irdma]
[77346.172944]  irdma_probe+0x54f/0x620 [irdma]
[77346.173122]  auxiliary_bus_probe+0x66/0xa0
[77346.173137]  really_probe+0x140/0x540
[77346.173154]  __driver_probe_device+0xc7/0x220
[77346.173173]  driver_probe_device+0x5f/0x140
[77346.173190]  __driver_attach+0xf0/0x2c0
[77346.173208]  bus_for_each_dev+0xa8/0xf0
[77346.173225]  driver_attach+0x29/0x30
[77346.173240]  bus_add_driver+0x29c/0x2f0
[77346.173255]  driver_register+0x10f/0x1a0
[77346.173272]  __auxiliary_driver_register+0xbc/0x140
[77346.173287]  irdma_init_module+0x55/0x1000 [irdma]
[77346.173460]  do_one_initcall+0x7d/0x410
[77346.173475]  do_init_module+0x81/0x2c0
[77346.173491]  load_module+0x1232/0x12c0
[77346.173506]  __do_sys_finit_module+0x101/0x180
[77346.173522]  __x64_sys_finit_module+0x3c/0x50
[77346.173538]  do_syscall_64+0x39/0x90
[77346.173553]  entry_SYSCALL_64_after_hwframe+0x63/0xcd

[77346.173634] value changed: 0x0000000000000094 -> 0x0000000000000095

The Linux kernel CVE team has assigned CVE-2023-54302 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.14 with commit 915cc7ac0f8e2a23675ee896e87f17c7d3c47089 and fixed in 5.15.124 with commit bf0f9f65b7fe36ea9d2e23263dcefc90255d7b1f
	Issue introduced in 5.14 with commit 915cc7ac0f8e2a23675ee896e87f17c7d3c47089 and fixed in 6.1.43 with commit 4e1a5842a359ee18d5a9e75097d7cf4d93e233bb
	Issue introduced in 5.14 with commit 915cc7ac0f8e2a23675ee896e87f17c7d3c47089 and fixed in 6.4.8 with commit 2623ca92cd8f9668edabe9e4f4a3cf77fd7115f2
	Issue introduced in 5.14 with commit 915cc7ac0f8e2a23675ee896e87f17c7d3c47089 and fixed in 6.5 with commit f2c3037811381f9149243828c7eb9a1631df9f9c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54302
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/infiniband/hw/irdma/ctrl.c
	drivers/infiniband/hw/irdma/defs.h
	drivers/infiniband/hw/irdma/type.h
	drivers/infiniband/hw/irdma/utils.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/bf0f9f65b7fe36ea9d2e23263dcefc90255d7b1f
	https://git.kernel.org/stable/c/4e1a5842a359ee18d5a9e75097d7cf4d93e233bb
	https://git.kernel.org/stable/c/2623ca92cd8f9668edabe9e4f4a3cf77fd7115f2
	https://git.kernel.org/stable/c/f2c3037811381f9149243828c7eb9a1631df9f9c
