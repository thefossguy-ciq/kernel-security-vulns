From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53800: ubi: Fix use-after-free when volume resizing failed

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ubi: Fix use-after-free when volume resizing failed

There is an use-after-free problem reported by KASAN:
  ==================================================================
  BUG: KASAN: use-after-free in ubi_eba_copy_table+0x11f/0x1c0 [ubi]
  Read of size 8 at addr ffff888101eec008 by task ubirsvol/4735

  CPU: 2 PID: 4735 Comm: ubirsvol
  Not tainted 6.1.0-rc1-00003-g84fa3304a7fc-dirty #14
  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),
  BIOS 1.14.0-1.fc33 04/01/2014
  Call Trace:
   <TASK>
   dump_stack_lvl+0x34/0x44
   print_report+0x171/0x472
   kasan_report+0xad/0x130
   ubi_eba_copy_table+0x11f/0x1c0 [ubi]
   ubi_resize_volume+0x4f9/0xbc0 [ubi]
   ubi_cdev_ioctl+0x701/0x1850 [ubi]
   __x64_sys_ioctl+0x11d/0x170
   do_syscall_64+0x35/0x80
   entry_SYSCALL_64_after_hwframe+0x46/0xb0
   </TASK>

When ubi_change_vtbl_record() returns an error in ubi_resize_volume(),
"new_eba_tbl" will be freed on error handing path, but it is holded
by "vol->eba_tbl" in ubi_eba_replace_table(). It means that the liftcycle
of "vol->eba_tbl" and "vol" are different, so when resizing volume in
next time, it causing an use-after-free fault.

Fix it by not freeing "new_eba_tbl" after it replaced in
ubi_eba_replace_table(), while will be freed in next volume resizing.

The Linux kernel CVE team has assigned CVE-2023-53800 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 4.14.308 with commit bf9875aa7f7d624a8c084425b14bf7e5907ebc30
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 4.19.276 with commit bf795ebbb9995e2fe7945de71177f01c2f1215dc
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 5.4.235 with commit 9c8be1f165baee53b5a36ea0b3c9281d403a1d0b
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 5.10.173 with commit 35f8d4064e54c18424db2997059d4c0b1d13d093
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 5.15.100 with commit 53818746e549e61841428892a8d94344494be797
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 6.1.18 with commit b0c951742348d216f094d16ed4f70ae73db881c0
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 6.2.5 with commit 3d6378f7056ac7350338f941001162a8f660853c
	Issue introduced in 2.6.22 with commit 801c135ce73d5df1caf3eca35b66a10824ae0707 and fixed in 6.3 with commit 9af31d6ec1a4be4caab2550096c6bd2ba8fba472

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53800
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/mtd/ubi/vmt.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/bf9875aa7f7d624a8c084425b14bf7e5907ebc30
	https://git.kernel.org/stable/c/bf795ebbb9995e2fe7945de71177f01c2f1215dc
	https://git.kernel.org/stable/c/9c8be1f165baee53b5a36ea0b3c9281d403a1d0b
	https://git.kernel.org/stable/c/35f8d4064e54c18424db2997059d4c0b1d13d093
	https://git.kernel.org/stable/c/53818746e549e61841428892a8d94344494be797
	https://git.kernel.org/stable/c/b0c951742348d216f094d16ed4f70ae73db881c0
	https://git.kernel.org/stable/c/3d6378f7056ac7350338f941001162a8f660853c
	https://git.kernel.org/stable/c/9af31d6ec1a4be4caab2550096c6bd2ba8fba472
