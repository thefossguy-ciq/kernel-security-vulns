From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53322: scsi: qla2xxx: Wait for io return on terminate rport
Message-Id: <2025091644-CVE-2023-53322-45ba@gregkh>
Content-Length: 3004
Lines: 69
X-Developer-Signature: v=1; a=openpgp-sha256; l=3074;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=+9GH/pUlIJ6Xk0hSA6NY7y3/pCCvb+xw3Q3Y96jV0gQ=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBknexzeakz4etxLQXDRQzuJ1S7Xj93p+1rpwSPfs+gUX
 966uZZiHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjARbRGGBbN3stZlH/wj90KP
 f8EWWf7vp04pJTPMz+NTf1u6s/Hr74/C/a31bo9+LHx+DwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: qla2xxx: Wait for io return on terminate rport

System crash due to use after free.
Current code allows terminate_rport_io to exit before making
sure all IOs has returned. For FCP-2 device, IO's can hang
on in HW because driver has not tear down the session in FW at
first sign of cable pull. When dev_loss_tmo timer pops,
terminate_rport_io is called and upper layer is about to
free various resources. Terminate_rport_io trigger qla to do
the final cleanup, but the cleanup might not be fast enough where it
leave qla still holding on to the same resource.

Wait for IO's to return to upper layer before resources are freed.

The Linux kernel CVE team has assigned CVE-2023-53322 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.14.322 with commit 8a55556cd7e0220486163b1285ce11a8be2ce5fa
	Fixed in 4.19.291 with commit 4647d2e88918a078359d1532d90c417a38542c9e
	Fixed in 5.4.251 with commit d25fded78d88e1515439b3ba581684d683e0b6ab
	Fixed in 5.10.188 with commit a9fe97fb7b4ee21bffb76f2acb05769bad27ae70
	Fixed in 5.15.121 with commit 079c8264ed9fea8cbcac01ad29040f901cbc3692
	Fixed in 6.1.40 with commit 90770dad1eb30967ebd8d37d82830bcf270b3293
	Fixed in 6.4.5 with commit 5bcdaafd92be6035ddc77fa76650cf9dd5b864c4
	Fixed in 6.5 with commit fc0cba0c7be8261a1625098bd1d695077ec621c9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53322
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/qla2xxx/qla_attr.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8a55556cd7e0220486163b1285ce11a8be2ce5fa
	https://git.kernel.org/stable/c/4647d2e88918a078359d1532d90c417a38542c9e
	https://git.kernel.org/stable/c/d25fded78d88e1515439b3ba581684d683e0b6ab
	https://git.kernel.org/stable/c/a9fe97fb7b4ee21bffb76f2acb05769bad27ae70
	https://git.kernel.org/stable/c/079c8264ed9fea8cbcac01ad29040f901cbc3692
	https://git.kernel.org/stable/c/90770dad1eb30967ebd8d37d82830bcf270b3293
	https://git.kernel.org/stable/c/5bcdaafd92be6035ddc77fa76650cf9dd5b864c4
	https://git.kernel.org/stable/c/fc0cba0c7be8261a1625098bd1d695077ec621c9
