From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53998: hwrng: virtio - Fix race on data_avail and actual data
Message-Id: <2025122426-CVE-2023-53998-2282@gregkh>
Content-Length: 3898
Lines: 75
X-Developer-Signature: v=1; a=openpgp-sha256; l=3974;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=q0z8DW5qXqoahcQWy70uZKCZFv9UJ/gvCMumeNdbQAI=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnex24dULtZ/58hVDJO5ldqYmtwR9O0gwx3XmaFbzD4t
 afxneutjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZgIXw/DbPbNHw+9ueLx4eqk
 jy/id/otkWbsUWOYK/q1eLnmDOunB42mvWplYcu37t65CgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

hwrng: virtio - Fix race on data_avail and actual data

The virtio rng device kicks off a new entropy request whenever the
data available reaches zero.  When a new request occurs at the end
of a read operation, that is, when the result of that request is
only needed by the next reader, then there is a race between the
writing of the new data and the next reader.

This is because there is no synchronisation whatsoever between the
writer and the reader.

Fix this by writing data_avail with smp_store_release and reading
it with smp_load_acquire when we first enter read.  The subsequent
reads are safe because they're either protected by the first load
acquire, or by the completion mechanism.

Also remove the redundant zeroing of data_idx in random_recv_done
(data_idx must already be zero at this point) and data_avail in
request_entropy (ditto).

The Linux kernel CVE team has assigned CVE-2023-53998 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 4.19.291 with commit 241ef15776a7c8505008db689175b320d345ecd3
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 5.4.251 with commit a43bcb0b661cbbf3ad797d2aee6b6fd06b8fc69d
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 5.10.188 with commit 77471e4912d3960dafe141e268c44be8024fe4dc
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 5.15.121 with commit c76d991b6f01a5d931e7053a73bc9524975a5215
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 6.1.39 with commit 22c30022cde6e2c88612b3a499223cfa912f1bc7
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 6.3.13 with commit 318657b4c2077289659f1cd9e2a34f6a3b208e3e
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 6.4.4 with commit 2fc91f156b3f3446a1bce80cf4adedcbf41271c2
	Issue introduced in 2.6.26 with commit f7f510ec195781c857ab76366a3e1c59e1caae42 and fixed in 6.5 with commit ac52578d6e8d300dd50f790f29a24169b1edd26c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53998
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/char/hw_random/virtio-rng.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/241ef15776a7c8505008db689175b320d345ecd3
	https://git.kernel.org/stable/c/a43bcb0b661cbbf3ad797d2aee6b6fd06b8fc69d
	https://git.kernel.org/stable/c/77471e4912d3960dafe141e268c44be8024fe4dc
	https://git.kernel.org/stable/c/c76d991b6f01a5d931e7053a73bc9524975a5215
	https://git.kernel.org/stable/c/22c30022cde6e2c88612b3a499223cfa912f1bc7
	https://git.kernel.org/stable/c/318657b4c2077289659f1cd9e2a34f6a3b208e3e
	https://git.kernel.org/stable/c/2fc91f156b3f3446a1bce80cf4adedcbf41271c2
	https://git.kernel.org/stable/c/ac52578d6e8d300dd50f790f29a24169b1edd26c
