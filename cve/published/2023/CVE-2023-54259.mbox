From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54259: soundwire: bus: Fix unbalanced pm_runtime_put() causing usage count underflow

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

soundwire: bus: Fix unbalanced pm_runtime_put() causing usage count underflow

This reverts commit
443a98e649b4 ("soundwire: bus: use pm_runtime_resume_and_get()")

Change calls to pm_runtime_resume_and_get() back to pm_runtime_get_sync().
This fixes a usage count underrun caused by doing a pm_runtime_put() even
though pm_runtime_resume_and_get() returned an error.

The three affected functions ignore -EACCES error from trying to get
pm_runtime, and carry on, including a put at the end of the function.
But pm_runtime_resume_and_get() does not increment the usage count if it
returns an error. So in the -EACCES case you must not call
pm_runtime_put().

The documentation for pm_runtime_get_sync() says:
 "Consider using pm_runtime_resume_and_get() ...  as this is likely to
 result in cleaner code."

In this case I don't think it results in cleaner code because the
pm_runtime_put() at the end of the function would have to be conditional on
the return value from pm_runtime_resume_and_get() at the top of the
function.

pm_runtime_get_sync() doesn't have this problem because it always
increments the count, so always needs a put. The code can just flow through
and do the pm_runtime_put() unconditionally.

The Linux kernel CVE team has assigned CVE-2023-54259 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.19 with commit 443a98e649b469b4e6a2832799853a5764ef9002 and fixed in 6.1.30 with commit 4e5e9da139c007dfc397a159093b4c4187ee67fa
	Issue introduced in 5.19 with commit 443a98e649b469b4e6a2832799853a5764ef9002 and fixed in 6.3.4 with commit 203aa4374c433159f163acde2d0bd4118f23bbaf
	Issue introduced in 5.19 with commit 443a98e649b469b4e6a2832799853a5764ef9002 and fixed in 6.4 with commit e9537962519e88969f5f69cd0571eb4f6984403c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54259
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/soundwire/bus.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/4e5e9da139c007dfc397a159093b4c4187ee67fa
	https://git.kernel.org/stable/c/203aa4374c433159f163acde2d0bd4118f23bbaf
	https://git.kernel.org/stable/c/e9537962519e88969f5f69cd0571eb4f6984403c
