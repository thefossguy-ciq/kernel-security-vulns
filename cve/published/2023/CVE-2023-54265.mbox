From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54265: ipv6: Fix an uninit variable access bug in __ip6_make_skb()
Message-Id: <2025123059-CVE-2023-54265-02a6@gregkh>
Content-Length: 6002
Lines: 117
X-Developer-Signature: v=1; a=openpgp-sha256; l=6120;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=EJH/vuxFDrNeqQo6qtq1VpCdkehDFEIaa4ZbpgTD5LE=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBh/Ob2GXnLGJd6DuRJZx/1V/FImXr3CdiWi3sHUpXT
 rpu5Q7riGVhEGRikBVTZPmyjefo/opDil6Gtqdh5rAygQxh4OIUgIncWM0wz+hPfIl1lJFy/N2b
 /zmktB3PB62XZJinVxC2f5vm45x7Cy5estbO+S1qpW0FAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ipv6: Fix an uninit variable access bug in __ip6_make_skb()

Syzbot reported a bug as following:

=====================================================
BUG: KMSAN: uninit-value in arch_atomic64_inc arch/x86/include/asm/atomic64_64.h:88 [inline]
BUG: KMSAN: uninit-value in arch_atomic_long_inc include/linux/atomic/atomic-long.h:161 [inline]
BUG: KMSAN: uninit-value in atomic_long_inc include/linux/atomic/atomic-instrumented.h:1429 [inline]
BUG: KMSAN: uninit-value in __ip6_make_skb+0x2f37/0x30f0 net/ipv6/ip6_output.c:1956
 arch_atomic64_inc arch/x86/include/asm/atomic64_64.h:88 [inline]
 arch_atomic_long_inc include/linux/atomic/atomic-long.h:161 [inline]
 atomic_long_inc include/linux/atomic/atomic-instrumented.h:1429 [inline]
 __ip6_make_skb+0x2f37/0x30f0 net/ipv6/ip6_output.c:1956
 ip6_finish_skb include/net/ipv6.h:1122 [inline]
 ip6_push_pending_frames+0x10e/0x550 net/ipv6/ip6_output.c:1987
 rawv6_push_pending_frames+0xb12/0xb90 net/ipv6/raw.c:579
 rawv6_sendmsg+0x297e/0x2e60 net/ipv6/raw.c:922
 inet_sendmsg+0x101/0x180 net/ipv4/af_inet.c:827
 sock_sendmsg_nosec net/socket.c:714 [inline]
 sock_sendmsg net/socket.c:734 [inline]
 ____sys_sendmsg+0xa8e/0xe70 net/socket.c:2476
 ___sys_sendmsg+0x2a1/0x3f0 net/socket.c:2530
 __sys_sendmsg net/socket.c:2559 [inline]
 __do_sys_sendmsg net/socket.c:2568 [inline]
 __se_sys_sendmsg net/socket.c:2566 [inline]
 __x64_sys_sendmsg+0x367/0x540 net/socket.c:2566
 do_syscall_x64 arch/x86/entry/common.c:50 [inline]
 do_syscall_64+0x3d/0xb0 arch/x86/entry/common.c:80
 entry_SYSCALL_64_after_hwframe+0x63/0xcd

Uninit was created at:
 slab_post_alloc_hook mm/slab.h:766 [inline]
 slab_alloc_node mm/slub.c:3452 [inline]
 __kmem_cache_alloc_node+0x71f/0xce0 mm/slub.c:3491
 __do_kmalloc_node mm/slab_common.c:967 [inline]
 __kmalloc_node_track_caller+0x114/0x3b0 mm/slab_common.c:988
 kmalloc_reserve net/core/skbuff.c:492 [inline]
 __alloc_skb+0x3af/0x8f0 net/core/skbuff.c:565
 alloc_skb include/linux/skbuff.h:1270 [inline]
 __ip6_append_data+0x51c1/0x6bb0 net/ipv6/ip6_output.c:1684
 ip6_append_data+0x411/0x580 net/ipv6/ip6_output.c:1854
 rawv6_sendmsg+0x2882/0x2e60 net/ipv6/raw.c:915
 inet_sendmsg+0x101/0x180 net/ipv4/af_inet.c:827
 sock_sendmsg_nosec net/socket.c:714 [inline]
 sock_sendmsg net/socket.c:734 [inline]
 ____sys_sendmsg+0xa8e/0xe70 net/socket.c:2476
 ___sys_sendmsg+0x2a1/0x3f0 net/socket.c:2530
 __sys_sendmsg net/socket.c:2559 [inline]
 __do_sys_sendmsg net/socket.c:2568 [inline]
 __se_sys_sendmsg net/socket.c:2566 [inline]
 __x64_sys_sendmsg+0x367/0x540 net/socket.c:2566
 do_syscall_x64 arch/x86/entry/common.c:50 [inline]
 do_syscall_64+0x3d/0xb0 arch/x86/entry/common.c:80
 entry_SYSCALL_64_after_hwframe+0x63/0xcd

It is because icmp6hdr does not in skb linear region under the scenario
of SOCK_RAW socket. Access icmp6_hdr(skb)->icmp6_type directly will
trigger the uninit variable access bug.

Use a local variable icmp6_type to carry the correct value in different
scenarios.

The Linux kernel CVE team has assigned CVE-2023-54265 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 4.14.313 with commit 165370522cc48127da564a08584a7391e6341908
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 4.19.281 with commit f394f690a30a5ec0413c62777a058eaf3d6e10d5
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 5.4.241 with commit 0cf600ca1bdf1d52df977516ee6cee0cadb1f6b1
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 5.10.178 with commit 605b056d63302ae84eb136e88d4df49124bd5e0d
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 5.15.107 with commit d65ff2fe877c471aa6e79efa7bd8ff66e147c317
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 6.1.24 with commit 2c9cefc142c1dc2759e19a92d3b2b3715e985beb
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 6.2.11 with commit 02ed5700f40445af02d1c97db25ffc2d04971d9f
	Issue introduced in 2.6.24 with commit 14878f75abd5bf1d38becb405801cd491ee215dc and fixed in 6.3 with commit ea30388baebcce37fd594d425a65037ca35e59e8

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54265
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/ipv6/ip6_output.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/165370522cc48127da564a08584a7391e6341908
	https://git.kernel.org/stable/c/f394f690a30a5ec0413c62777a058eaf3d6e10d5
	https://git.kernel.org/stable/c/0cf600ca1bdf1d52df977516ee6cee0cadb1f6b1
	https://git.kernel.org/stable/c/605b056d63302ae84eb136e88d4df49124bd5e0d
	https://git.kernel.org/stable/c/d65ff2fe877c471aa6e79efa7bd8ff66e147c317
	https://git.kernel.org/stable/c/2c9cefc142c1dc2759e19a92d3b2b3715e985beb
	https://git.kernel.org/stable/c/02ed5700f40445af02d1c97db25ffc2d04971d9f
	https://git.kernel.org/stable/c/ea30388baebcce37fd594d425a65037ca35e59e8
