From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54077: fs/ntfs3: Fix memory leak if ntfs_read_mft failed
Message-Id: <2025122428-CVE-2023-54077-61a2@gregkh>
Content-Length: 3744
Lines: 82
X-Developer-Signature: v=1; a=openpgp-sha256; l=3827;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=Frn6WJtX5iYjFKKRUjMQRGhW11Spbcj4Ftd2+vPvdYY=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJneTxYYPZroIql9sjz1S1Tofo6juw4ZGnacKZRhdv1yd
 3dHt3toRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEzkUR/DLCbD6Dpe7ddXhXrV
 VF5d3HXfYBFfJcM8tZvP5SMcTFn2fskJTFI6aSJ9c94vAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

fs/ntfs3: Fix memory leak if ntfs_read_mft failed

Label ATTR_ROOT in ntfs_read_mft() sets is_root = true and
ni->ni_flags |= NI_FLAG_DIR, then next attr will goto label ATTR_ALLOC
and alloc ni->dir.alloc_run. However two states are not always
consistent and can make memory leak.

 1) attr_name in ATTR_ROOT does not fit the condition it will set
 is_root = true but NI_FLAG_DIR is not set.
 2) next attr_name in ATTR_ALLOC fits the condition and alloc
 ni->dir.alloc_run
 3) in cleanup function ni_clear(), when NI_FLAG_DIR is set, it frees
 ni->dir.alloc_run, otherwise it frees ni->file.run
 4) because NI_FLAG_DIR is not set in this case, ni->dir.alloc_run is
 leaked as kmemleak reported:

unreferenced object 0xffff888003bc5480 (size 64):
  backtrace:
    [<000000003d42e6b0>] __kmalloc_node+0x4e/0x1c0
    [<00000000d8e19b8a>] kvmalloc_node+0x39/0x1f0
    [<00000000fc3eb5b8>] run_add_entry+0x18a/0xa40 [ntfs3]
    [<0000000011c9f978>] run_unpack+0x75d/0x8e0 [ntfs3]
    [<00000000e7cf1819>] run_unpack_ex+0xbc/0x500 [ntfs3]
    [<00000000bbf0a43d>] ntfs_iget5+0xb25/0x2dd0 [ntfs3]
    [<00000000a6e50693>] ntfs_fill_super+0x218d/0x3580 [ntfs3]
    [<00000000b9170608>] get_tree_bdev+0x3fb/0x710
    [<000000004833798a>] vfs_get_tree+0x8e/0x280
    [<000000006e20b8e6>] path_mount+0xf3c/0x1930
    [<000000007bf15a5f>] do_mount+0xf3/0x110
    ...

Fix this by always setting is_root and NI_FLAG_DIR together.

The Linux kernel CVE team has assigned CVE-2023-54077 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15 with commit 82cae269cfa953032fbb8980a7d554d60fb00b17 and fixed in 5.15.111 with commit 3030f2b9b3329db3948c1a145a5493ca6f617d50
	Issue introduced in 5.15 with commit 82cae269cfa953032fbb8980a7d554d60fb00b17 and fixed in 6.1.28 with commit 1bc6bb657dfb0ab3b94ef6d477ca241bf7b6ec06
	Issue introduced in 5.15 with commit 82cae269cfa953032fbb8980a7d554d60fb00b17 and fixed in 6.2.15 with commit 93bf79f989688852deade1550fb478b0a4d8daa8
	Issue introduced in 5.15 with commit 82cae269cfa953032fbb8980a7d554d60fb00b17 and fixed in 6.3.2 with commit 3bb0d3eb475f01744ce6d6e998dfbd80220852a1
	Issue introduced in 5.15 with commit 82cae269cfa953032fbb8980a7d554d60fb00b17 and fixed in 6.4 with commit bfa434c60157c9793e9b12c9b68ade02aff9f803

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54077
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ntfs3/inode.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3030f2b9b3329db3948c1a145a5493ca6f617d50
	https://git.kernel.org/stable/c/1bc6bb657dfb0ab3b94ef6d477ca241bf7b6ec06
	https://git.kernel.org/stable/c/93bf79f989688852deade1550fb478b0a4d8daa8
	https://git.kernel.org/stable/c/3bb0d3eb475f01744ce6d6e998dfbd80220852a1
	https://git.kernel.org/stable/c/bfa434c60157c9793e9b12c9b68ade02aff9f803
