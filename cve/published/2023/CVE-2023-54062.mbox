From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54062: ext4: fix invalid free tracking in ext4_xattr_move_to_block()
Message-Id: <2025122428-CVE-2023-54062-d861@gregkh>
Content-Length: 3261
Lines: 72
X-Developer-Signature: v=1; a=openpgp-sha256; l=3334;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=xSGmVuc9L/bLOV3OaQKNhSNUxeIPYKO1PnXOJ5YkklM=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnet7/Mat7LybJiTrXLI9b8Gw6sdRwsdZ+XG3Hv8T/z4
 VVmSfWGjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZiInibDgrXPSx7ZXb+792JN
 4K+9Da78M18LnmJYcP3ol7K2xKJHwQuOO+rxuXT8fPR1GwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: fix invalid free tracking in ext4_xattr_move_to_block()

In ext4_xattr_move_to_block(), the value of the extended attribute
which we need to move to an external block may be allocated by
kvmalloc() if the value is stored in an external inode.  So at the end
of the function the code tried to check if this was the case by
testing entry->e_value_inum.

However, at this point, the pointer to the xattr entry is no longer
valid, because it was removed from the original location where it had
been stored.  So we could end up calling kvfree() on a pointer which
was not allocated by kvmalloc(); or we could also potentially leak
memory by not freeing the buffer when it should be freed.  Fix this by
storing whether it should be freed in a separate variable.

The Linux kernel CVE team has assigned CVE-2023-54062 to this issue.


Affected and fixed versions
===========================

	Fixed in 4.14.315 with commit 76887be2a96193cd11be818551b8934ecdb3123f
	Fixed in 4.19.283 with commit f30f3391d089dc91aef91d08f4b04a6c0df2b067
	Fixed in 5.4.243 with commit ba04d6af5ac440a6d5a2d35dc1d8e2cb0323550a
	Fixed in 5.10.180 with commit 1a8822343e67432b658145d2760a524c884da9d4
	Fixed in 5.15.112 with commit 8beaa3cb293a8f7bacf711cf52201d59859dbc40
	Fixed in 6.1.29 with commit c5fa4eedddd1c8342ce533cb401c0e693e55b4e3
	Fixed in 6.2.16 with commit a18670395e5f28acddeca037c5e4bd2ea961b70a
	Fixed in 6.3.3 with commit b2fab1807d26acd1c6115b95b5eddd697d84751b
	Fixed in 6.4 with commit b87c7cdf2bed4928b899e1ce91ef0d147017ba45

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54062
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/xattr.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/76887be2a96193cd11be818551b8934ecdb3123f
	https://git.kernel.org/stable/c/f30f3391d089dc91aef91d08f4b04a6c0df2b067
	https://git.kernel.org/stable/c/ba04d6af5ac440a6d5a2d35dc1d8e2cb0323550a
	https://git.kernel.org/stable/c/1a8822343e67432b658145d2760a524c884da9d4
	https://git.kernel.org/stable/c/8beaa3cb293a8f7bacf711cf52201d59859dbc40
	https://git.kernel.org/stable/c/c5fa4eedddd1c8342ce533cb401c0e693e55b4e3
	https://git.kernel.org/stable/c/a18670395e5f28acddeca037c5e4bd2ea961b70a
	https://git.kernel.org/stable/c/b2fab1807d26acd1c6115b95b5eddd697d84751b
	https://git.kernel.org/stable/c/b87c7cdf2bed4928b899e1ce91ef0d147017ba45
