From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54062: ext4: fix invalid free tracking in ext4_xattr_move_to_block()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: fix invalid free tracking in ext4_xattr_move_to_block()

In ext4_xattr_move_to_block(), the value of the extended attribute
which we need to move to an external block may be allocated by
kvmalloc() if the value is stored in an external inode.  So at the end
of the function the code tried to check if this was the case by
testing entry->e_value_inum.

However, at this point, the pointer to the xattr entry is no longer
valid, because it was removed from the original location where it had
been stored.  So we could end up calling kvfree() on a pointer which
was not allocated by kvmalloc(); or we could also potentially leak
memory by not freeing the buffer when it should be freed.  Fix this by
storing whether it should be freed in a separate variable.

The Linux kernel CVE team has assigned CVE-2023-54062 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.14.308 with commit c7851208abffe5ae4deb01cf48763911dc14fc67 and fixed in 4.14.315 with commit 76887be2a96193cd11be818551b8934ecdb3123f
	Issue introduced in 4.19.276 with commit f5cdc6a7339f250d44d4d469ed7a474ac0d6c7a7 and fixed in 4.19.283 with commit f30f3391d089dc91aef91d08f4b04a6c0df2b067
	Issue introduced in 5.4.235 with commit 3b28c799a1334adb5a19f42f03abe0d8cbb05938 and fixed in 5.4.243 with commit ba04d6af5ac440a6d5a2d35dc1d8e2cb0323550a
	Issue introduced in 5.10.173 with commit d738789ae9ec47d3458a008788f3cdc862ebf0cb and fixed in 5.10.180 with commit 1a8822343e67432b658145d2760a524c884da9d4
	Issue introduced in 5.15.99 with commit a6744e14ce7045ab1a728bde9595f62fbd39f1d2 and fixed in 5.15.112 with commit 8beaa3cb293a8f7bacf711cf52201d59859dbc40
	Issue introduced in 6.1.16 with commit 8b6d06b3be7648b3b0f428558293ddf6e2cb94bf and fixed in 6.1.29 with commit c5fa4eedddd1c8342ce533cb401c0e693e55b4e3
	Issue introduced in 6.2.3 with commit d2efaf8c870c7067b8d1779773134f3481cd8f68 and fixed in 6.2.16 with commit a18670395e5f28acddeca037c5e4bd2ea961b70a
	Issue introduced in 6.3 with commit 1e9d62d252812575ded7c620d8fc67c32ff06c16 and fixed in 6.3.3 with commit b2fab1807d26acd1c6115b95b5eddd697d84751b
	Issue introduced in 6.3 with commit 1e9d62d252812575ded7c620d8fc67c32ff06c16 and fixed in 6.4 with commit b87c7cdf2bed4928b899e1ce91ef0d147017ba45

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54062
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/xattr.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/76887be2a96193cd11be818551b8934ecdb3123f
	https://git.kernel.org/stable/c/f30f3391d089dc91aef91d08f4b04a6c0df2b067
	https://git.kernel.org/stable/c/ba04d6af5ac440a6d5a2d35dc1d8e2cb0323550a
	https://git.kernel.org/stable/c/1a8822343e67432b658145d2760a524c884da9d4
	https://git.kernel.org/stable/c/8beaa3cb293a8f7bacf711cf52201d59859dbc40
	https://git.kernel.org/stable/c/c5fa4eedddd1c8342ce533cb401c0e693e55b4e3
	https://git.kernel.org/stable/c/a18670395e5f28acddeca037c5e4bd2ea961b70a
	https://git.kernel.org/stable/c/b2fab1807d26acd1c6115b95b5eddd697d84751b
	https://git.kernel.org/stable/c/b87c7cdf2bed4928b899e1ce91ef0d147017ba45
