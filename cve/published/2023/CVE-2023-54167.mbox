From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54167: m68k: mm: Move initrd phys_to_virt handling after paging_init()
Message-Id: <2025123019-CVE-2023-54167-c6fb@gregkh>
Content-Length: 2813
Lines: 69
X-Developer-Signature: v=1; a=openpgp-sha256; l=2883;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=bYzWkXOuJLgsu7IHk51x/4dCAy8otSKRBsnjQcgW5/0=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBB96ra0RfTVLad+n9PNd5T6Munfy2uKbx84PPfeoC3
 J6FKamTOmJZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAit4UYFhyM3bD5u8zuAnO7
 k9+ucjcfEtnUmMkwTy9DRPaFqMO68o9qU4SmT1cIta9LBAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

m68k: mm: Move initrd phys_to_virt handling after paging_init()

When booting with an initial ramdisk on platforms where physical memory
does not start at address zero (e.g. on Amiga):

    initrd: 0ef0602c - 0f800000
    Zone ranges:
      DMA      [mem 0x0000000008000000-0x000000f7ffffffff]
      Normal   empty
    Movable zone start for each node
    Early memory node ranges
      node   0: [mem 0x0000000008000000-0x000000000f7fffff]
    Initmem setup node 0 [mem 0x0000000008000000-0x000000000f7fffff]
    Unable to handle kernel access at virtual address (ptrval)
    Oops: 00000000
    Modules linked in:
    PC: [<00201d3c>] memcmp+0x28/0x56

As phys_to_virt() relies on m68k_memoffset and module_fixup(), it must
not be called before paging_init().  Hence postpone the phys_to_virt
handling for the initial ramdisk until after calling paging_init().

While at it, reduce #ifdef clutter by using IS_ENABLED() instead.

The Linux kernel CVE team has assigned CVE-2023-54167 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.17 with commit 376e3fdecb0dcae216c0ac559cff066f460bf47b and fixed in 6.1.20 with commit ceb089e2337f810d3594d310953d9af4783f660a
	Issue introduced in 5.17 with commit 376e3fdecb0dcae216c0ac559cff066f460bf47b and fixed in 6.2.7 with commit 58662cfb459150b9c0c22d20cddaea439b3844bd
	Issue introduced in 5.17 with commit 376e3fdecb0dcae216c0ac559cff066f460bf47b and fixed in 6.3 with commit d4b97925e87eb133e400fe4a482d750c74ce392f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54167
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/m68k/kernel/setup_mm.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ceb089e2337f810d3594d310953d9af4783f660a
	https://git.kernel.org/stable/c/58662cfb459150b9c0c22d20cddaea439b3844bd
	https://git.kernel.org/stable/c/d4b97925e87eb133e400fe4a482d750c74ce392f
