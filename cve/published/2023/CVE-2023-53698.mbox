From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53698: xsk: fix refcount underflow in error path
Message-Id: <2025102211-CVE-2023-53698-c1f4@gregkh>
Content-Length: 3185
Lines: 67
X-Developer-Signature: v=1; a=openpgp-sha256; l=3253;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=9AVgj2Uaqa1PUZ61SKMy54IoZVx1k6MT86E+XyirIQI=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBk/bv0umfwxOU5sloO3KefSkmrNy4wr1n+UUJeoeNzhu
 W39SYHojlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZjI1c8MC641sj1nfnLF4tTk
 O5HzjWQFfXuqWxnmB4S5OS2SFX4QFWfo/Thpsrllo1Y9AA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

xsk: fix refcount underflow in error path

Fix a refcount underflow problem reported by syzbot that can happen
when a system is running out of memory. If xp_alloc_tx_descs() fails,
and it can only fail due to not having enough memory, then the error
path is triggered. In this error path, the refcount of the pool is
decremented as it has incremented before. However, the reference to
the pool in the socket was not nulled. This means that when the socket
is closed later, the socket teardown logic will think that there is a
pool attached to the socket and try to decrease the refcount again,
leading to a refcount underflow.

I chose this fix as it involved adding just a single line. Another
option would have been to move xp_get_pool() and the assignment of
xs->pool to after the if-statement and using xs_umem->pool instead of
xs->pool in the whole if-statement resulting in somewhat simpler code,
but this would have led to much more churn in the code base perhaps
making it harder to backport.

The Linux kernel CVE team has assigned CVE-2023-53698 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15.47 with commit f7019562f142bc041f9cde63af338d1886585923 and fixed in 5.15.127 with commit 789fcd94c9cac133dd4d96e193188661aca9f6c3
	Issue introduced in 5.18 with commit ba3beec2ec1d3b4fd8672ca6e781dac4b3267f6e and fixed in 6.1.46 with commit 15b453cf7348973217558235b9ece2ee5fea6777
	Issue introduced in 5.18 with commit ba3beec2ec1d3b4fd8672ca6e781dac4b3267f6e and fixed in 6.4.11 with commit 3e7722c31d4167eb7f3ffd35aba52cab69b79072
	Issue introduced in 5.18 with commit ba3beec2ec1d3b4fd8672ca6e781dac4b3267f6e and fixed in 6.5 with commit 85c2c79a07302fe68a1ad5cc449458cc559e314d
	Issue introduced in 5.17.15 with commit 9f0c8a9d4ef1b9ebee0e4ac2495fe790727044aa

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53698
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/xdp/xsk.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/789fcd94c9cac133dd4d96e193188661aca9f6c3
	https://git.kernel.org/stable/c/15b453cf7348973217558235b9ece2ee5fea6777
	https://git.kernel.org/stable/c/3e7722c31d4167eb7f3ffd35aba52cab69b79072
	https://git.kernel.org/stable/c/85c2c79a07302fe68a1ad5cc449458cc559e314d
