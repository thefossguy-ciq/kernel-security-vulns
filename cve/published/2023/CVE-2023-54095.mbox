From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54095: powerpc/iommu: Fix notifiers being shared by PCI and VIO buses
Message-Id: <2025122408-CVE-2023-54095-7fe0@gregkh>
Content-Length: 4735
Lines: 96
X-Developer-Signature: v=1; a=openpgp-sha256; l=4832;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=NsF/ZYelfsWWaeXTlFjxXYzzrvSQO9hRtbaOUa5tRWU=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJneTx3WvJL7lvdDoeWFT7373pZr/x69ZuTZJSR+bNGS1
 bHnTrdf64hlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJtNQxLLi5u2qmoX+ni6ZL
 qPDf7B9Mwi9dTjMsmHi+506908kvDcsqgk/FnuKPdpgXCgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

powerpc/iommu: Fix notifiers being shared by PCI and VIO buses

fail_iommu_setup() registers the fail_iommu_bus_notifier struct to both
PCI and VIO buses.  struct notifier_block is a linked list node, so this
causes any notifiers later registered to either bus type to also be
registered to the other since they share the same node.

This causes issues in (at least) the vgaarb code, which registers a
notifier for PCI buses.  pci_notify() ends up being called on a vio
device, converted with to_pci_dev() even though it's not a PCI device,
and finally makes a bad access in vga_arbiter_add_pci_device() as
discovered with KASAN:

 BUG: KASAN: slab-out-of-bounds in vga_arbiter_add_pci_device+0x60/0xe00
 Read of size 4 at addr c000000264c26fdc by task swapper/0/1

 Call Trace:
   dump_stack_lvl+0x1bc/0x2b8 (unreliable)
   print_report+0x3f4/0xc60
   kasan_report+0x244/0x698
   __asan_load4+0xe8/0x250
   vga_arbiter_add_pci_device+0x60/0xe00
   pci_notify+0x88/0x444
   notifier_call_chain+0x104/0x320
   blocking_notifier_call_chain+0xa0/0x140
   device_add+0xac8/0x1d30
   device_register+0x58/0x80
   vio_register_device_node+0x9ac/0xce0
   vio_bus_scan_register_devices+0xc4/0x13c
   __machine_initcall_pseries_vio_device_init+0x94/0xf0
   do_one_initcall+0x12c/0xaa8
   kernel_init_freeable+0xa48/0xba8
   kernel_init+0x64/0x400
   ret_from_kernel_thread+0x5c/0x64

Fix this by creating separate notifier_block structs for each bus type.

[mpe: Add #ifdef to fix CONFIG_IBMVIO=n build]

The Linux kernel CVE team has assigned CVE-2023-54095 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 4.14.326 with commit dc0d107e624ca96aef6dd8722eb33ba3a6d157b0
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 4.19.295 with commit 075a4dcdbc9a5ea793cb8ec8b78a6c0b7636fd52
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 5.4.257 with commit 65bf8a196ba25cf65a858b5bb8de80f0aad76691
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 5.10.195 with commit f08944e3c6962b00827de7263a9e20688e79ad84
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 5.15.132 with commit a9ddbfed53465bc7c411231db32a488066c0c1be
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 6.1.53 with commit f17d5efaafba3d5f02f0373f7c5f44711d676f3e
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 6.4.16 with commit c46af58588253e5e4063bb5ddc78cd12fdf9e55d
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 6.5.3 with commit 6670c65bf863cd0d44ca24d4c10ef6755b8d9529
	Issue introduced in 3.6 with commit d6b9a81b2a45786384f5bd3516bd6ddfb4b772c6 and fixed in 6.6 with commit c37b6908f7b2bd24dcaaf14a180e28c9132b9c58

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54095
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/powerpc/kernel/iommu.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/dc0d107e624ca96aef6dd8722eb33ba3a6d157b0
	https://git.kernel.org/stable/c/075a4dcdbc9a5ea793cb8ec8b78a6c0b7636fd52
	https://git.kernel.org/stable/c/65bf8a196ba25cf65a858b5bb8de80f0aad76691
	https://git.kernel.org/stable/c/f08944e3c6962b00827de7263a9e20688e79ad84
	https://git.kernel.org/stable/c/a9ddbfed53465bc7c411231db32a488066c0c1be
	https://git.kernel.org/stable/c/f17d5efaafba3d5f02f0373f7c5f44711d676f3e
	https://git.kernel.org/stable/c/c46af58588253e5e4063bb5ddc78cd12fdf9e55d
	https://git.kernel.org/stable/c/6670c65bf863cd0d44ca24d4c10ef6755b8d9529
	https://git.kernel.org/stable/c/c37b6908f7b2bd24dcaaf14a180e28c9132b9c58
