From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54182: f2fs: fix to check readonly condition correctly

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

f2fs: fix to check readonly condition correctly

With below case, it can mount multi-device image w/ rw option, however
one of secondary device is set as ro, later update will cause panic, so
let's introduce f2fs_dev_is_readonly(), and check multi-devices rw status
in f2fs_remount() w/ it in order to avoid such inconsistent mount status.

mkfs.f2fs -c /dev/zram1 /dev/zram0 -f
blockdev --setro /dev/zram1
mount -t f2fs dev/zram0 /mnt/f2fs
mount: /mnt/f2fs: WARNING: source write-protected, mounted read-only.
mount -t f2fs -o remount,rw mnt/f2fs
dd if=/dev/zero  of=/mnt/f2fs/file bs=1M count=8192

kernel BUG at fs/f2fs/inline.c:258!
RIP: 0010:f2fs_write_inline_data+0x23e/0x2d0 [f2fs]
Call Trace:
  f2fs_write_single_data_page+0x26b/0x9f0 [f2fs]
  f2fs_write_cache_pages+0x389/0xa60 [f2fs]
  __f2fs_write_data_pages+0x26b/0x2d0 [f2fs]
  f2fs_write_data_pages+0x2e/0x40 [f2fs]
  do_writepages+0xd3/0x1b0
  __writeback_single_inode+0x5b/0x420
  writeback_sb_inodes+0x236/0x5a0
  __writeback_inodes_wb+0x56/0xf0
  wb_writeback+0x2a3/0x490
  wb_do_writeback+0x2b2/0x330
  wb_workfn+0x6a/0x260
  process_one_work+0x270/0x5e0
  worker_thread+0x52/0x3e0
  kthread+0xf4/0x120
  ret_from_fork+0x29/0x50

The Linux kernel CVE team has assigned CVE-2023-54182 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.2 with commit f824deb54b683165b953371a0529446c723ef6d6 and fixed in 5.15.113 with commit e2759a59a4cc96af712084e9db7065c858c4fe9f
	Issue introduced in 5.2 with commit f824deb54b683165b953371a0529446c723ef6d6 and fixed in 6.1.30 with commit e05d63f8b48aad4613bd582c945bee41e2dd7255
	Issue introduced in 5.2 with commit f824deb54b683165b953371a0529446c723ef6d6 and fixed in 6.3.4 with commit da8c535b28696017e5d1532d12ea78e836432d9e
	Issue introduced in 5.2 with commit f824deb54b683165b953371a0529446c723ef6d6 and fixed in 6.4 with commit d78dfefcde9d311284434560d69c0478c55a657e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54182
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/f2fs/f2fs.h
	fs/f2fs/super.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e2759a59a4cc96af712084e9db7065c858c4fe9f
	https://git.kernel.org/stable/c/e05d63f8b48aad4613bd582c945bee41e2dd7255
	https://git.kernel.org/stable/c/da8c535b28696017e5d1532d12ea78e836432d9e
	https://git.kernel.org/stable/c/d78dfefcde9d311284434560d69c0478c55a657e
