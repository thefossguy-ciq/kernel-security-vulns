From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54267: powerpc/pseries: Rework lppaca_shared_proc() to avoid DEBUG_PREEMPT
Message-Id: <2025123059-CVE-2023-54267-6736@gregkh>
Content-Length: 3874
Lines: 82
X-Developer-Signature: v=1; a=openpgp-sha256; l=3957;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=KPNo1MwXHX9yTOzBQsvYclq4A1XPhLvxLbloYc1kGLY=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBh/ODdog2P2U6qr2px8D+2wQLy3ufnokHRyvMPft+4
 UXhcOaMjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZhIeyvDPJu/SwvmHOE6EdNu
 EnWLf1PqxZq79QzzY+fuWe+2K3n+orWbj2gcuPH58WlPAwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

powerpc/pseries: Rework lppaca_shared_proc() to avoid DEBUG_PREEMPT

lppaca_shared_proc() takes a pointer to the lppaca which is typically
accessed through get_lppaca().  With DEBUG_PREEMPT enabled, this leads
to checking if preemption is enabled, for example:

  BUG: using smp_processor_id() in preemptible [00000000] code: grep/10693
  caller is lparcfg_data+0x408/0x19a0
  CPU: 4 PID: 10693 Comm: grep Not tainted 6.5.0-rc3 #2
  Call Trace:
    dump_stack_lvl+0x154/0x200 (unreliable)
    check_preemption_disabled+0x214/0x220
    lparcfg_data+0x408/0x19a0
    ...

This isn't actually a problem however, as it does not matter which
lppaca is accessed, the shared proc state will be the same.
vcpudispatch_stats_procfs_init() already works around this by disabling
preemption, but the lparcfg code does not, erroring any time
/proc/powerpc/lparcfg is accessed with DEBUG_PREEMPT enabled.

Instead of disabling preemption on the caller side, rework
lppaca_shared_proc() to not take a pointer and instead directly access
the lppaca, bypassing any potential preemption checks.

[mpe: Rework to avoid needing a definition in paca.h and lppaca.h]

The Linux kernel CVE team has assigned CVE-2023-54267 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.12 with commit f13c13a005127b5dc5daaca190277a062d946e63 and fixed in 5.10.195 with commit 953c54dfdc5d3eb7243ed902b50acb5ea1db4355
	Issue introduced in 3.12 with commit f13c13a005127b5dc5daaca190277a062d946e63 and fixed in 5.15.132 with commit 2935443dc9c28499223d8c881474259e4b998f2a
	Issue introduced in 3.12 with commit f13c13a005127b5dc5daaca190277a062d946e63 and fixed in 6.1.53 with commit 4c8568cf4c45b415854195c8832b557cdefba57a
	Issue introduced in 3.12 with commit f13c13a005127b5dc5daaca190277a062d946e63 and fixed in 6.4.16 with commit 3c5e8e666794d7dde6d14ea846c6c04f2bb34900
	Issue introduced in 3.12 with commit f13c13a005127b5dc5daaca190277a062d946e63 and fixed in 6.5.3 with commit f45ee5c074013a0fbfce77a5af5efddb01f5d4f4
	Issue introduced in 3.12 with commit f13c13a005127b5dc5daaca190277a062d946e63 and fixed in 6.6 with commit eac030b22ea12cdfcbb2e941c21c03964403c63f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54267
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/powerpc/include/asm/lppaca.h
	arch/powerpc/platforms/pseries/lpar.c
	arch/powerpc/platforms/pseries/lparcfg.c
	arch/powerpc/platforms/pseries/setup.c
	drivers/cpuidle/cpuidle-pseries.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/953c54dfdc5d3eb7243ed902b50acb5ea1db4355
	https://git.kernel.org/stable/c/2935443dc9c28499223d8c881474259e4b998f2a
	https://git.kernel.org/stable/c/4c8568cf4c45b415854195c8832b557cdefba57a
	https://git.kernel.org/stable/c/3c5e8e666794d7dde6d14ea846c6c04f2bb34900
	https://git.kernel.org/stable/c/f45ee5c074013a0fbfce77a5af5efddb01f5d4f4
	https://git.kernel.org/stable/c/eac030b22ea12cdfcbb2e941c21c03964403c63f
