From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53822: wifi: ath11k: Ignore frags from uninitialized peer in dp.
Message-Id: <2025120950-CVE-2023-53822-c4da@gregkh>
Content-Length: 3026
Lines: 84
X-Developer-Signature: v=1; a=openpgp-sha256; l=3111;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=6WkaxcUjMgVZBKW4QZO8X8YcOYLqCZQ1t1IkO45alK8=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnm1adsa+WO3+D8Hmq+4NNs3X11r71EJi3aXLcutjr+Y
 b2Lak5cRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEzkcA/DPOvbyxgmXdjAe5z9
 7L3ivy6Plmx+1MCwYIvZvoWXb7MWeE6JjZFs4mvK6Qz2BwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: ath11k: Ignore frags from uninitialized peer in dp.

When max virtual ap interfaces are configured in all the bands with
ACS and hostapd restart is done every 60s, a crash is observed at
random times.
In this certain scenario, a fragmented packet is received for
self peer, for which rx_tid and rx_frags are not initialized in
datapath. While handling this fragment, crash is observed as the
rx_frag list is uninitialised and when we walk in
ath11k_dp_rx_h_sort_frags, skb null leads to exception.

To address this, before processing received fragments we check
dp_setup_done flag is set to ensure that peer has completed its
dp peer setup for fragment queue, else ignore processing the
fragments.

Call trace:
  ath11k_dp_process_rx_err+0x550/0x1084 [ath11k]
  ath11k_dp_service_srng+0x70/0x370 [ath11k]
  0xffffffc009693a04
  __napi_poll+0x30/0xa4
  net_rx_action+0x118/0x270
  __do_softirq+0x10c/0x244
  irq_exit+0x64/0xb4
  __handle_domain_irq+0x88/0xac
  gic_handle_irq+0x74/0xbc
  el1_irq+0xf0/0x1c0
  arch_cpu_idle+0x10/0x18
  do_idle+0x104/0x248
  cpu_startup_entry+0x20/0x64
  rest_init+0xd0/0xdc
  arch_call_rest_init+0xc/0x14
  start_kernel+0x480/0x4b8
  Code: f9400281 f94066a2 91405021 b94a0023 (f9406401)

Tested-on: IPQ8074 hw2.0 AHB WLAN.HK.2.7.0.1-01744-QCAHKSWPL_SILICONZ-1

The Linux kernel CVE team has assigned CVE-2023-53822 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.1.30 with commit e78526a06b53718bfc1dfff37864c7760e41f8ec
	Fixed in 6.3.4 with commit 41efc47f5bc53e63461579e206adc17c4452ab6e
	Fixed in 6.4 with commit a06bfb3c9f69f303692cdae87bc0899d2ae8b2a6

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53822
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/ath/ath11k/dp.c
	drivers/net/wireless/ath/ath11k/dp_rx.c
	drivers/net/wireless/ath/ath11k/peer.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e78526a06b53718bfc1dfff37864c7760e41f8ec
	https://git.kernel.org/stable/c/41efc47f5bc53e63461579e206adc17c4452ab6e
	https://git.kernel.org/stable/c/a06bfb3c9f69f303692cdae87bc0899d2ae8b2a6
