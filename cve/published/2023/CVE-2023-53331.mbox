From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53331: pstore/ram: Check start of empty przs during init

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

pstore/ram: Check start of empty przs during init

After commit 30696378f68a ("pstore/ram: Do not treat empty buffers as
valid"), initialization would assume a prz was valid after seeing that
the buffer_size is zero (regardless of the buffer start position). This
unchecked start value means it could be outside the bounds of the buffer,
leading to future access panics when written to:

 sysdump_panic_event+0x3b4/0x5b8
 atomic_notifier_call_chain+0x54/0x90
 panic+0x1c8/0x42c
 die+0x29c/0x2a8
 die_kernel_fault+0x68/0x78
 __do_kernel_fault+0x1c4/0x1e0
 do_bad_area+0x40/0x100
 do_translation_fault+0x68/0x80
 do_mem_abort+0x68/0xf8
 el1_da+0x1c/0xc0
 __raw_writeb+0x38/0x174
 __memcpy_toio+0x40/0xac
 persistent_ram_update+0x44/0x12c
 persistent_ram_write+0x1a8/0x1b8
 ramoops_pstore_write+0x198/0x1e8
 pstore_console_write+0x94/0xe0
 ...

To avoid this, also check if the prz start is 0 during the initialization
phase. If not, the next prz sanity check case will discover it (start >
size) and zap the buffer back to a sane state.

[kees: update commit log with backtrace and clarifications]

The Linux kernel CVE team has assigned CVE-2023-53331 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.14.96 with commit e1e3a46706bd4037e8b7407dc660ae6e05b8ac56 and fixed in 4.14.326 with commit 89312657337e6e03ad6e9ea1a462bd9c158c85c8
	Issue introduced in 4.19.18 with commit 265242d82a3c6a8bd9120d06b4801f8d7ae9a346 and fixed in 4.19.295 with commit c807ccdd812d18985860504b503899f3140a9549
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 5.4.257 with commit e972231db29b5d1dccc13bf9d5ba55b6979a69ed
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 5.10.195 with commit dc2f60de9a7d3efd982440117dab5579898d808c
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 5.15.132 with commit fedecaeef88899d940b69368c996e8b3b0b8650d
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 6.1.53 with commit e95d7a8a6edd14f8fab44c777dd7281db91f6ae2
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 6.4.16 with commit f77990358628b01bdc03752126ff5f716ea37615
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 6.5.3 with commit 25fb4e3402d46f425ec135ef6f09792a4c1b3003
	Issue introduced in 5.0 with commit 30696378f68a9e3dad6bfe55938b112e72af00c2 and fixed in 6.6 with commit fe8c3623ab06603eb760444a032d426542212021
	Issue introduced in 3.18.133 with commit ec7f99261da9a20d63cbd273511a11a2efe698f2
	Issue introduced in 4.4.172 with commit f250e4c562a3bd106575032666e9ef46f31231f8
	Issue introduced in 4.9.153 with commit fffdbf586866e9500b53c9d4b061d3983720375a
	Issue introduced in 4.20.5 with commit 9e969ba431b46b1891c88cea36f722f3bfe8a180

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53331
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/pstore/ram_core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/89312657337e6e03ad6e9ea1a462bd9c158c85c8
	https://git.kernel.org/stable/c/c807ccdd812d18985860504b503899f3140a9549
	https://git.kernel.org/stable/c/e972231db29b5d1dccc13bf9d5ba55b6979a69ed
	https://git.kernel.org/stable/c/dc2f60de9a7d3efd982440117dab5579898d808c
	https://git.kernel.org/stable/c/fedecaeef88899d940b69368c996e8b3b0b8650d
	https://git.kernel.org/stable/c/e95d7a8a6edd14f8fab44c777dd7281db91f6ae2
	https://git.kernel.org/stable/c/f77990358628b01bdc03752126ff5f716ea37615
	https://git.kernel.org/stable/c/25fb4e3402d46f425ec135ef6f09792a4c1b3003
	https://git.kernel.org/stable/c/fe8c3623ab06603eb760444a032d426542212021
