From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54019: sched/psi: use kernfs polling functions for PSI trigger polling
Message-Id: <2025122433-CVE-2023-54019-95e0@gregkh>
Content-Length: 3631
Lines: 82
X-Developer-Signature: v=1; a=openpgp-sha256; l=3714;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=GSR9LHR4WFmTlyu9f1lwR8fP1z38+rHhFBo6IZKIRhc=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnexx66fshzmHVwXfJJ5sK6vkf3rv5+cox3tx+TdMeO2
 XULnt6o6YhlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJrDvNsODK9aVyt6eyqM/p
 /ByWmDnN8WBT432GBSv32sxck52jvzeT7c4u62fb2/teFAEA
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

sched/psi: use kernfs polling functions for PSI trigger polling

Destroying psi trigger in cgroup_file_release causes UAF issues when
a cgroup is removed from under a polling process. This is happening
because cgroup removal causes a call to cgroup_file_release while the
actual file is still alive. Destroying the trigger at this point would
also destroy its waitqueue head and if there is still a polling process
on that file accessing the waitqueue, it will step on the freed pointer:

do_select
  vfs_poll
                           do_rmdir
                             cgroup_rmdir
                               kernfs_drain_open_files
                                 cgroup_file_release
                                   cgroup_pressure_release
                                     psi_trigger_destroy
                                       wake_up_pollfree(&t->event_wait)
// vfs_poll is unblocked
                                       synchronize_rcu
                                       kfree(t)
  poll_freewait -> UAF access to the trigger's waitqueue head

Patch [1] fixed this issue for epoll() case using wake_up_pollfree(),
however the same issue exists for synchronous poll() case.
The root cause of this issue is that the lifecycles of the psi trigger's
waitqueue and of the file associated with the trigger are different. Fix
this by using kernfs_generic_poll function when polling on cgroup-specific
psi triggers. It internally uses kernfs_open_node->poll waitqueue head
with its lifecycle tied to the file's lifecycle. This also renders the
fix in [1] obsolete, so revert it.

[1] commit c2dbe32d5db5 ("sched/psi: Fix use-after-free in ep_remove_wait_queue()")

The Linux kernel CVE team has assigned CVE-2023-54019 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.2 with commit 0e94682b73bfa6c44c98af7a26771c9c08c055d5 and fixed in 6.1.42 with commit 92cc0153324b6ae8577a39f5bf2cd83c9a34ea6a
	Issue introduced in 5.2 with commit 0e94682b73bfa6c44c98af7a26771c9c08c055d5 and fixed in 6.4.7 with commit d124ab17024cc85a1079b7810a018a497ebc13da
	Issue introduced in 5.2 with commit 0e94682b73bfa6c44c98af7a26771c9c08c055d5 and fixed in 6.5 with commit aff037078ecaecf34a7c2afab1341815f90fba5e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54019
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/linux/psi.h
	include/linux/psi_types.h
	kernel/cgroup/cgroup.c
	kernel/sched/psi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/92cc0153324b6ae8577a39f5bf2cd83c9a34ea6a
	https://git.kernel.org/stable/c/d124ab17024cc85a1079b7810a018a497ebc13da
	https://git.kernel.org/stable/c/aff037078ecaecf34a7c2afab1341815f90fba5e
