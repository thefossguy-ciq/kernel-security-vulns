From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53580: USB: Gadget: core: Help prevent panic during UVC unconfigure

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

USB: Gadget: core: Help prevent panic during UVC unconfigure

Avichal Rakesh reported a kernel panic that occurred when the UVC
gadget driver was removed from a gadget's configuration.  The panic
involves a somewhat complicated interaction between the kernel driver
and a userspace component (as described in the Link tag below), but
the analysis did make one thing clear: The Gadget core should
accomodate gadget drivers calling usb_gadget_deactivate() as part of
their unbind procedure.

Currently this doesn't work.  gadget_unbind_driver() calls
driver->unbind() while holding the udc->connect_lock mutex, and
usb_gadget_deactivate() attempts to acquire that mutex, which will
result in a deadlock.

The simple fix is for gadget_unbind_driver() to release the mutex when
invoking the ->unbind() callback.  There is no particular reason for
it to be holding the mutex at that time, and the mutex isn't held
while the ->bind() callback is invoked.  So we'll drop the mutex
before performing the unbind callback and reacquire it afterward.

We'll also add a couple of comments to usb_gadget_activate() and
usb_gadget_deactivate().  Because they run in process context they
must not be called from a gadget driver's ->disconnect() callback,
which (according to the kerneldoc for struct usb_gadget_driver in
include/linux/usb/gadget.h) may run in interrupt context.  This may
help prevent similar bugs from arising in the future.

The Linux kernel CVE team has assigned CVE-2023-53580 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1.35 with commit d8195536ce2624e2947d9f56b1a61e7a27874bd3 and fixed in 6.1.46 with commit bed19d95fcb9c98dfaa9585922b39a2dfba7898d
	Issue introduced in 6.4 with commit 286d9975a838d0a54da049765fa1d1fb96b89682 and fixed in 6.4.11 with commit 8c1edc00db65f6d4408b3d1cd845e8da3b9e0ca4
	Issue introduced in 6.4 with commit 286d9975a838d0a54da049765fa1d1fb96b89682 and fixed in 6.5 with commit 65dadb2beeb7360232b09ebc4585b54475dfee06
	Issue introduced in 6.3.9 with commit 85102a45c7390caf124a3a5796574446f1e037b9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53580
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/gadget/udc/core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/bed19d95fcb9c98dfaa9585922b39a2dfba7898d
	https://git.kernel.org/stable/c/8c1edc00db65f6d4408b3d1cd845e8da3b9e0ca4
	https://git.kernel.org/stable/c/65dadb2beeb7360232b09ebc4585b54475dfee06
