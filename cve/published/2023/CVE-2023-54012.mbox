From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54012: net: fix stack overflow when LRO is disabled for virtual interfaces

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: fix stack overflow when LRO is disabled for virtual interfaces

When the virtual interface's feature is updated, it synchronizes the
updated feature for its own lower interface.
This propagation logic should be worked as the iteration, not recursively.
But it works recursively due to the netdev notification unexpectedly.
This problem occurs when it disables LRO only for the team and bonding
interface type.

       team0
         |
  +------+------+-----+-----+
  |      |      |     |     |
team1  team2  team3  ...  team200

If team0's LRO feature is updated, it generates the NETDEV_FEAT_CHANGE
event to its own lower interfaces(team1 ~ team200).
It is worked by netdev_sync_lower_features().
So, the NETDEV_FEAT_CHANGE notification logic of each lower interface
work iteratively.
But generated NETDEV_FEAT_CHANGE event is also sent to the upper
interface too.
upper interface(team0) generates the NETDEV_FEAT_CHANGE event for its own
lower interfaces again.
lower and upper interfaces receive this event and generate this
event again and again.
So, the stack overflow occurs.

But it is not the infinite loop issue.
Because the netdev_sync_lower_features() updates features before
generating the NETDEV_FEAT_CHANGE event.
Already synchronized lower interfaces skip notification logic.
So, it is just the problem that iteration logic is changed to the
recursive unexpectedly due to the notification mechanism.

Reproducer:

ip link add team0 type team
ethtool -K team0 lro on
for i in {1..200}
do
        ip link add team$i master team0 type team
        ethtool -K team$i lro on
done

ethtool -K team0 lro off

In order to fix it, the notifier_ctx member of bonding/team is introduced.

The Linux kernel CVE team has assigned CVE-2023-54012 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.4 with commit fd867d51f889aec11cca235ebb008578780d052d and fixed in 5.4.244 with commit 9ea0c5f90a27b5b884d880e146e0f65f3052e401
	Issue introduced in 4.4 with commit fd867d51f889aec11cca235ebb008578780d052d and fixed in 5.10.181 with commit 4bb955c4d2830a58c08e2a48ab75d75368e3ff36
	Issue introduced in 4.4 with commit fd867d51f889aec11cca235ebb008578780d052d and fixed in 5.15.114 with commit cf3b5cd7127cc10c5b12400c545f263f0e5e715c
	Issue introduced in 4.4 with commit fd867d51f889aec11cca235ebb008578780d052d and fixed in 6.1.31 with commit ed66e6327a69fec95034cda2ac5b6a57b8b3b622
	Issue introduced in 4.4 with commit fd867d51f889aec11cca235ebb008578780d052d and fixed in 6.3.5 with commit 6bf00bb3dc7e5b9fb05488e11616e65d64e975fa
	Issue introduced in 4.4 with commit fd867d51f889aec11cca235ebb008578780d052d and fixed in 6.4 with commit ae9b15fbe63447bc1d3bba3769f409d17ca6fdf6

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54012
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/bonding/bond_main.c
	drivers/net/team/team.c
	include/linux/if_team.h
	include/net/bonding.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9ea0c5f90a27b5b884d880e146e0f65f3052e401
	https://git.kernel.org/stable/c/4bb955c4d2830a58c08e2a48ab75d75368e3ff36
	https://git.kernel.org/stable/c/cf3b5cd7127cc10c5b12400c545f263f0e5e715c
	https://git.kernel.org/stable/c/ed66e6327a69fec95034cda2ac5b6a57b8b3b622
	https://git.kernel.org/stable/c/6bf00bb3dc7e5b9fb05488e11616e65d64e975fa
	https://git.kernel.org/stable/c/ae9b15fbe63447bc1d3bba3769f409d17ca6fdf6
