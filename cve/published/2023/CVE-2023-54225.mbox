From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54225: net: ipa: only reset hashed tables when supported
Message-Id: <2025123028-CVE-2023-54225-e49c@gregkh>
Content-Length: 3306
Lines: 74
X-Developer-Signature: v=1; a=openpgp-sha256; l=3381;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=CZ0dOnFO9Cy1/ZdhHdEV5M0qPiSXNSPbC/H1NTMeflI=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBB18qppx48Nxf0kVwpta7H0zv7+691StXd8xU9meGa
 GPhwQlbO2JZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAiFtcZFmwTnc1XJ/5hv3em
 LN+5kMcnni2dt4lhrqDdrcT17F0+dzZ/YnwsJhvUXmnTBQA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: ipa: only reset hashed tables when supported

Last year, the code that manages GSI channel transactions switched
from using spinlock-protected linked lists to using indexes into the
ring buffer used for a channel.  Recently, Google reported seeing
transaction reference count underflows occasionally during shutdown.

Doug Anderson found a way to reproduce the issue reliably, and
bisected the issue to the commit that eliminated the linked lists
and the lock.  The root cause was ultimately determined to be
related to unused transactions being committed as part of the modem
shutdown cleanup activity.  Unused transactions are not normally
expected (except in error cases).

The modem uses some ranges of IPA-resident memory, and whenever it
shuts down we zero those ranges.  In ipa_filter_reset_table() a
transaction is allocated to zero modem filter table entries.  If
hashing is not supported, hashed table memory should not be zeroed.
But currently nothing prevents that, and the result is an unused
transaction.  Something similar occurs when we zero routing table
entries for the modem.

By preventing any attempt to clear hashed tables when hashing is not
supported, the reference count underflow is avoided in this case.

Note that there likely remains an issue with properly freeing unused
transactions (if they occur due to errors).  This patch addresses
only the underflows that Google originally reported.

The Linux kernel CVE team has assigned CVE-2023-54225 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1 with commit d338ae28d8a866c57fcac38f3d77bcc1d1702d19 and fixed in 6.1.45 with commit 50c24f0c940728792c8bdf65c1eaf6b91b3b0dcd
	Issue introduced in 6.1 with commit d338ae28d8a866c57fcac38f3d77bcc1d1702d19 and fixed in 6.4.8 with commit c00af3a818cc573e10100cc6770f0e47befa1fa4
	Issue introduced in 6.1 with commit d338ae28d8a866c57fcac38f3d77bcc1d1702d19 and fixed in 6.5 with commit e11ec2b868af2b351c6c1e2e50eb711cc5423a10

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54225
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ipa/ipa_table.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/50c24f0c940728792c8bdf65c1eaf6b91b3b0dcd
	https://git.kernel.org/stable/c/c00af3a818cc573e10100cc6770f0e47befa1fa4
	https://git.kernel.org/stable/c/e11ec2b868af2b351c6c1e2e50eb711cc5423a10
