From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53287: usb: cdns3: Put the cdns set active part outside the spin lock
Message-Id: <2025091625-CVE-2023-53287-d8cd@gregkh>
Content-Length: 2979
Lines: 79
X-Developer-Signature: v=1; a=openpgp-sha256; l=3059;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=c4QC7R8l48Tx9Ev6vXVcP++Orj8sxejrLIOsqVsbRkQ=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBknpdfGCprbxRocnrG4fJ123herBWx71gqf/nn7Yr+OI
 9vHtfO3dcSyMAgyMciKKbJ82cZzdH/FIUUvQ9vTMHNYmUCGMHBxCsBE2O4wzBU31tgiv9BV6UXh
 u6VpB5YvbJpkeohhwTUjNv7PbowVmx6358fW8jq+Y2IuBQA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: cdns3: Put the cdns set active part outside the spin lock

The device may be scheduled during the resume process,
so this cannot appear in atomic operations. Since
pm_runtime_set_active will resume suppliers, put set
active outside the spin lock, which is only used to
protect the struct cdns data structure, otherwise the
kernel will report the following warning:

  BUG: sleeping function called from invalid context at drivers/base/power/runtime.c:1163
  in_atomic(): 1, irqs_disabled(): 0, non_block: 0, pid: 651, name: sh
  preempt_count: 1, expected: 0
  RCU nest depth: 0, expected: 0
  CPU: 0 PID: 651 Comm: sh Tainted: G        WC         6.1.20 #1
  Hardware name: Freescale i.MX8QM MEK (DT)
  Call trace:
    dump_backtrace.part.0+0xe0/0xf0
    show_stack+0x18/0x30
    dump_stack_lvl+0x64/0x80
    dump_stack+0x1c/0x38
    __might_resched+0x1fc/0x240
    __might_sleep+0x68/0xc0
    __pm_runtime_resume+0x9c/0xe0
    rpm_get_suppliers+0x68/0x1b0
    __pm_runtime_set_status+0x298/0x560
    cdns_resume+0xb0/0x1c0
    cdns3_controller_resume.isra.0+0x1e0/0x250
    cdns3_plat_resume+0x28/0x40

The Linux kernel CVE team has assigned CVE-2023-53287 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.15.133 with commit c861a61be6d30538ebcf7fcab1d43f244e298840
	Fixed in 6.1.55 with commit bbc9c3652708108738009e096d608ece3cd9fa8a
	Fixed in 6.5.5 with commit d3f372ec95b89776f72d5c9a475424e27734c223
	Fixed in 6.6 with commit 2319b9c87fe243327285f2fefd7374ffd75a65fc

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53287
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/cdns3/cdns3-plat.c
	drivers/usb/cdns3/cdnsp-pci.c
	drivers/usb/cdns3/core.c
	drivers/usb/cdns3/core.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/c861a61be6d30538ebcf7fcab1d43f244e298840
	https://git.kernel.org/stable/c/bbc9c3652708108738009e096d608ece3cd9fa8a
	https://git.kernel.org/stable/c/d3f372ec95b89776f72d5c9a475424e27734c223
	https://git.kernel.org/stable/c/2319b9c87fe243327285f2fefd7374ffd75a65fc
