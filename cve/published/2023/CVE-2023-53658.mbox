From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53658: spi: bcm-qspi: return error if neither hif_mspi nor mspi is available
Message-Id: <2025100701-CVE-2023-53658-3680@gregkh>
Content-Length: 3890
Lines: 72
X-Developer-Signature: v=1; a=openpgp-sha256; l=3963;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=6md/t4QwVq6x1zegKiKsXDV6wDEKHG+yBuOOSueX3Js=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlP9e/9y9sldnX+C1fheTuZUyc7H30x8+qzTXu71K+q7
 tqxRzpbtCOWhUGQiUFWTJHlyzaeo/srDil6GdqehpnDygQyhIGLUwAmMmEmwzyT1WEGv6fIcMuU
 Pr369oswm01e9i6GeWrMU2RlDx79fcLQjq+PLyHlx5SgSQA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

spi: bcm-qspi: return error if neither hif_mspi nor mspi is available

If neither a "hif_mspi" nor "mspi" resource is present, the driver will
just early exit in probe but still return success. Apart from not doing
anything meaningful, this would then also lead to a null pointer access
on removal, as platform_get_drvdata() would return NULL, which it would
then try to dereference when trying to unregister the spi master.

Fix this by unconditionally calling devm_ioremap_resource(), as it can
handle a NULL res and will then return a viable ERR_PTR() if we get one.

The "return 0;" was previously a "goto qspi_resource_err;" where then
ret was returned, but since ret was still initialized to 0 at this place
this was a valid conversion in 63c5395bb7a9 ("spi: bcm-qspi: Fix
use-after-free on unbind"). The issue was not introduced by this commit,
only made more obvious.

The Linux kernel CVE team has assigned CVE-2023-53658 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 4.14.322 with commit a91c34357afcfaa5307e254f22a8452550a07b34
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 4.19.291 with commit d20db3c58a7f9361e370a7850ceb60dbdf62eea3
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 5.4.251 with commit 398e6a015877d44327f754aeb48ff3354945c78c
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 5.10.188 with commit 32b9c8f7892c19f7f5c9fed5fb410b9fd5990bb6
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 5.15.121 with commit 217b6ea8cf7b819477bca597a6ae2d43d38ba283
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 6.1.39 with commit d3dcdb43c872a3b967345144151a2c9bb9124c9b
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 6.4.4 with commit 22ae32d80ef590d12a2364e4621f90f7c58445c7
	Issue introduced in 4.9 with commit fa236a7ef24048bafaeed13f68df35a819794758 and fixed in 6.5 with commit 7c1f23ad34fcdace50275a6aa1e1969b41c6233f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53658
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/spi/spi-bcm-qspi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a91c34357afcfaa5307e254f22a8452550a07b34
	https://git.kernel.org/stable/c/d20db3c58a7f9361e370a7850ceb60dbdf62eea3
	https://git.kernel.org/stable/c/398e6a015877d44327f754aeb48ff3354945c78c
	https://git.kernel.org/stable/c/32b9c8f7892c19f7f5c9fed5fb410b9fd5990bb6
	https://git.kernel.org/stable/c/217b6ea8cf7b819477bca597a6ae2d43d38ba283
	https://git.kernel.org/stable/c/d3dcdb43c872a3b967345144151a2c9bb9124c9b
	https://git.kernel.org/stable/c/22ae32d80ef590d12a2364e4621f90f7c58445c7
	https://git.kernel.org/stable/c/7c1f23ad34fcdace50275a6aa1e1969b41c6233f
