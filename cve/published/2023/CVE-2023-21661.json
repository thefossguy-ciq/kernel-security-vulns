{
   "containers": {
      "cna": {
         "providerMetadata": {
            "orgId": "f4215fc3-5b6b-47ff-a258-f7189bd81038"
         },
         "descriptions": [
            {
               "lang": "en",
               "value": "binder: fix use-after-free in shinker's callback\n\nThe mmap read lock is used during the shrinker's callback, which means\nthat using alloc->vma pointer isn't safe as it can race with munmap().\nAs of commit dd2283f2605e (\"mm: mmap: zap pages with read mmap_sem in\nmunmap\") the mmap lock is downgraded after the vma has been isolated.\n\nI was able to reproduce this issue by manually adding some delays and\ntriggering page reclaiming through the shrinker's debug sysfs. The\nfollowing KASAN report confirms the UAF:\n\n  ==================================================================\n  BUG: KASAN: slab-use-after-free in zap_page_range_single+0x470/0x4b8\n  Read of size 8 at addr ffff356ed50e50f0 by task bash/478\n\n  CPU: 1 PID: 478 Comm: bash Not tainted 6.6.0-rc5-00055-g1c8b86a3799f-dirty #70\n  Hardware name: linux,dummy-virt (DT)\n  Call trace:\n   zap_page_range_single+0x470/0x4b8\n   binder_alloc_free_page+0x608/0xadc\n   __list_lru_walk_one+0x130/0x3b0\n   list_lru_walk_node+0xc4/0x22c\n   binder_shrink_scan+0x108/0x1dc\n   shrinker_debugfs_scan_write+0x2b4/0x500\n   full_proxy_write+0xd4/0x140\n   vfs_write+0x1ac/0x758\n   ksys_write+0xf0/0x1dc\n   __arm64_sys_write+0x6c/0x9c\n\n  Allocated by task 492:\n   kmem_cache_alloc+0x130/0x368\n   vm_area_alloc+0x2c/0x190\n   mmap_region+0x258/0x18bc\n   do_mmap+0x694/0xa60\n   vm_mmap_pgoff+0x170/0x29c\n   ksys_mmap_pgoff+0x290/0x3a0\n   __arm64_sys_mmap+0xcc/0x144\n\n  Freed by task 491:\n   kmem_cache_free+0x17c/0x3c8\n   vm_area_free_rcu_cb+0x74/0x98\n   rcu_core+0xa38/0x26d4\n   rcu_core_si+0x10/0x1c\n   __do_softirq+0x2fc/0xd24\n\n  Last potentially related work creation:\n   __call_rcu_common.constprop.0+0x6c/0xba0\n   call_rcu+0x10/0x1c\n   vm_area_free+0x18/0x24\n   remove_vma+0xe4/0x118\n   do_vmi_align_munmap.isra.0+0x718/0xb5c\n   do_vmi_munmap+0xdc/0x1fc\n   __vm_munmap+0x10c/0x278\n   __arm64_sys_munmap+0x58/0x7c\n\nFix this issue by performing instead a vma_lookup() which will fail to\nfind the vma that was isolated before the mmap lock downgrade. Note that\nthis option has better performance than upgrading to a mmap write lock\nwhich would increase contention. Plus, mmap_write_trylock() has been\nrecently removed anyway."
            }
         ],
         "affected": [
            {
               "product": "Linux",
               "vendor": "Linux",
               "defaultStatus": "unaffected",
               "versions": [
                  {
                     "version": "4.20",
                     "lessThan": "5.4.268",
                     "status": "affected",
                     "versionType": "custom"
                  },
                  {
                     "version": "4.20",
                     "lessThan": "5.10.209",
                     "status": "affected",
                     "versionType": "custom"
                  },
                  {
                     "version": "4.20",
                     "lessThan": "5.15.148",
                     "status": "affected",
                     "versionType": "custom"
                  },
                  {
                     "version": "4.20",
                     "lessThan": "6.1.74",
                     "status": "affected",
                     "versionType": "custom"
                  },
                  {
                     "version": "4.20",
                     "lessThan": "6.6.13",
                     "status": "affected",
                     "versionType": "custom"
                  },
                  {
                     "version": "4.20",
                     "lessThan": "6.7.1",
                     "status": "affected",
                     "versionType": "custom"
                  },
                  {
                     "version": "dd2283f2605e",
                     "lessThan": "a53e15e592b4",
                     "status": "affected",
                     "versionType": "git"
                  },
                  {
                     "version": "dd2283f2605e",
                     "lessThan": "c8c1158ffb00",
                     "status": "affected",
                     "versionType": "git"
                  },
                  {
                     "version": "dd2283f2605e",
                     "lessThan": "8ad4d580e8af",
                     "status": "affected",
                     "versionType": "git"
                  },
                  {
                     "version": "dd2283f2605e",
                     "lessThan": "9fa04c93f241",
                     "status": "affected",
                     "versionType": "git"
                  },
                  {
                     "version": "dd2283f2605e",
                     "lessThan": "a49087ab9350",
                     "status": "affected",
                     "versionType": "git"
                  },
                  {
                     "version": "dd2283f2605e",
                     "lessThan": "e074686e993f",
                     "status": "affected",
                     "versionType": "git"
                  }
               ]
            }
         ],
         "references": [
            {
               "url": "https://git.kernel.org/stable/linux/c/a53e15e592b4"
            },
            {
               "url": "https://git.kernel.org/stable/linux/c/c8c1158ffb00"
            },
            {
               "url": "https://git.kernel.org/stable/linux/c/8ad4d580e8af"
            },
            {
               "url": "https://git.kernel.org/stable/linux/c/9fa04c93f241"
            },
            {
               "url": "https://git.kernel.org/stable/linux/c/a49087ab9350"
            },
            {
               "url": "https://git.kernel.org/stable/linux/c/e074686e993f"
            }
         ],
         "title": "binder: fix use-after-free in shinker's callback",
         "x_generator": {
            "engine": "bippy-a94c04b18a2f"
         }
      }
   },
   "cveMetadata": {
      "assignerOrgId": "f4215fc3-5b6b-47ff-a258-f7189bd81038",
      "cveID": "CVE-2023-21661",
      "requesterUserId": "gregkh@linuxfoundation.org",
      "serial": "1",
      "state": "PUBLISHED"
   },
   "dataType": "CVE_RECORD",
   "dataVersion": "5.0"
}
