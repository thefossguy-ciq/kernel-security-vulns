From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53362: bus: fsl-mc: don't assume child devices are all fsl-mc devices
Message-Id: <2025091722-CVE-2023-53362-740e@gregkh>
Content-Length: 3968
Lines: 99
X-Developer-Signature: v=1; a=openpgp-sha256; l=4068;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=N8VPgg4HTBVldUyJaM/ivMJBUQjlWMlxZCaPdoDJPvQ=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBmnzoiVP6zMbH/jdvVyuBhbZZ4+F+/zxfe/b3rvwfTBb
 sWU/56hHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjARfzeGBWf95j67L+AZLVRg
 qhdjbrBuh2WNNMP8ympL/+AnTNqTlWaw3BQ9LCXcVxwAAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

bus: fsl-mc: don't assume child devices are all fsl-mc devices

Changes in VFIO caused a pseudo-device to be created as child of
fsl-mc devices causing a crash [1] when trying to bind a fsl-mc
device to VFIO. Fix this by checking the device type when enumerating
fsl-mc child devices.

[1]
Modules linked in:
Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
CPU: 6 PID: 1289 Comm: sh Not tainted 6.2.0-rc5-00047-g7c46948a6e9c #2
Hardware name: NXP Layerscape LX2160ARDB (DT)
pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : mc_send_command+0x24/0x1f0
lr : dprc_get_obj_region+0xfc/0x1c0
sp : ffff80000a88b900
x29: ffff80000a88b900 x28: ffff48a9429e1400 x27: 00000000000002b2
x26: ffff48a9429e1718 x25: 0000000000000000 x24: 0000000000000000
x23: ffffd59331ba3918 x22: ffffd59331ba3000 x21: 0000000000000000
x20: ffff80000a88b9b8 x19: 0000000000000000 x18: 0000000000000001
x17: 7270642f636d2d6c x16: 73662e3030303030 x15: ffffffffffffffff
x14: ffffd59330f1d668 x13: ffff48a8727dc389 x12: ffff48a8727dc386
x11: 0000000000000002 x10: 00008ceaf02f35d4 x9 : 0000000000000012
x8 : 0000000000000000 x7 : 0000000000000006 x6 : ffff80000a88bab0
x5 : 0000000000000000 x4 : 0000000000000000 x3 : ffff80000a88b9e8
x2 : ffff80000a88b9e8 x1 : 0000000000000000 x0 : ffff48a945142b80
Call trace:
 mc_send_command+0x24/0x1f0
 dprc_get_obj_region+0xfc/0x1c0
 fsl_mc_device_add+0x340/0x590
 fsl_mc_obj_device_add+0xd0/0xf8
 dprc_scan_objects+0x1c4/0x340
 dprc_scan_container+0x38/0x60
 vfio_fsl_mc_probe+0x9c/0xf8
 fsl_mc_driver_probe+0x24/0x70
 really_probe+0xbc/0x2a8
 __driver_probe_device+0x78/0xe0
 device_driver_attach+0x30/0x68
 bind_store+0xa8/0x130
 drv_attr_store+0x24/0x38
 sysfs_kf_write+0x44/0x60
 kernfs_fop_write_iter+0x128/0x1b8
 vfs_write+0x334/0x448
 ksys_write+0x68/0xf0
 __arm64_sys_write+0x1c/0x28
 invoke_syscall+0x44/0x108
 el0_svc_common.constprop.1+0x94/0xf8
 do_el0_svc+0x38/0xb0
 el0_svc+0x20/0x50
 el0t_64_sync_handler+0x98/0xc0
 el0t_64_sync+0x174/0x178
Code: aa0103f4 a9025bf5 d5384100 b9400801 (79401260)
---[ end trace 0000000000000000 ]---

The Linux kernel CVE team has assigned CVE-2023-53362 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1 with commit 3c28a76124b25882411f005924be73795b6ef078 and fixed in 6.1.39 with commit 5bd9dc3e767edf582be483be8d6bbc7433bd4cf8
	Issue introduced in 6.1 with commit 3c28a76124b25882411f005924be73795b6ef078 and fixed in 6.4.4 with commit 8bdd5c21ec02835bd445d022f4c23195aff407d2
	Issue introduced in 6.1 with commit 3c28a76124b25882411f005924be73795b6ef078 and fixed in 6.5 with commit 303c9c63abb9390e906052863f82bb4e9824e5c0

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53362
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/bus/fsl-mc/dprc-driver.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5bd9dc3e767edf582be483be8d6bbc7433bd4cf8
	https://git.kernel.org/stable/c/8bdd5c21ec02835bd445d022f4c23195aff407d2
	https://git.kernel.org/stable/c/303c9c63abb9390e906052863f82bb4e9824e5c0
