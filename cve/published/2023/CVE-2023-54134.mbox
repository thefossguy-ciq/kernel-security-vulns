From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54134: autofs: fix memory leak of waitqueues in autofs_catatonic_mode

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

autofs: fix memory leak of waitqueues in autofs_catatonic_mode

Syzkaller reports a memory leak:

BUG: memory leak
unreferenced object 0xffff88810b279e00 (size 96):
  comm "syz-executor399", pid 3631, jiffies 4294964921 (age 23.870s)
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 08 9e 27 0b 81 88 ff ff  ..........'.....
    08 9e 27 0b 81 88 ff ff 00 00 00 00 00 00 00 00  ..'.............
  backtrace:
    [<ffffffff814cfc90>] kmalloc_trace+0x20/0x90 mm/slab_common.c:1046
    [<ffffffff81bb75ca>] kmalloc include/linux/slab.h:576 [inline]
    [<ffffffff81bb75ca>] autofs_wait+0x3fa/0x9a0 fs/autofs/waitq.c:378
    [<ffffffff81bb88a7>] autofs_do_expire_multi+0xa7/0x3e0 fs/autofs/expire.c:593
    [<ffffffff81bb8c33>] autofs_expire_multi+0x53/0x80 fs/autofs/expire.c:619
    [<ffffffff81bb6972>] autofs_root_ioctl_unlocked+0x322/0x3b0 fs/autofs/root.c:897
    [<ffffffff81bb6a95>] autofs_root_ioctl+0x25/0x30 fs/autofs/root.c:910
    [<ffffffff81602a9c>] vfs_ioctl fs/ioctl.c:51 [inline]
    [<ffffffff81602a9c>] __do_sys_ioctl fs/ioctl.c:870 [inline]
    [<ffffffff81602a9c>] __se_sys_ioctl fs/ioctl.c:856 [inline]
    [<ffffffff81602a9c>] __x64_sys_ioctl+0xfc/0x140 fs/ioctl.c:856
    [<ffffffff84608225>] do_syscall_x64 arch/x86/entry/common.c:50 [inline]
    [<ffffffff84608225>] do_syscall_64+0x35/0xb0 arch/x86/entry/common.c:80
    [<ffffffff84800087>] entry_SYSCALL_64_after_hwframe+0x63/0xcd

autofs_wait_queue structs should be freed if their wait_ctr becomes zero.
Otherwise they will be lost.

In this case an AUTOFS_IOC_EXPIRE_MULTI ioctl is done, then a new
waitqueue struct is allocated in autofs_wait(), its initial wait_ctr
equals 2. After that wait_event_killable() is interrupted (it returns
-ERESTARTSYS), so that 'wq->name.name == NULL' condition may be not
satisfied. Actually, this condition can be satisfied when
autofs_wait_release() or autofs_catatonic_mode() is called and, what is
also important, wait_ctr is decremented in those places. Upon the exit of
autofs_wait(), wait_ctr is decremented to 1. Then the unmounting process
begins: kill_sb calls autofs_catatonic_mode(), which should have freed the
waitqueues, but it only decrements its usage counter to zero which is not
a correct behaviour.

edit:imk
This description is of course not correct. The umount performed as a result
of an expire is a umount of a mount that has been automounted, it's not the
autofs mount itself. They happen independently, usually after everything
mounted within the autofs file system has been expired away. If everything
hasn't been expired away the automount daemon can still exit leaving mounts
in place. But expires done in both cases will result in a notification that
calls autofs_wait_release() with a result status. The problem case is the
summary execution of of the automount daemon. In this case any waiting
processes won't be woken up until either they are terminated or the mount
is umounted.
end edit: imk

So in catatonic mode we should free waitqueues which counter becomes zero.

edit: imk
Initially I was concerned that the calling of autofs_wait_release() and
autofs_catatonic_mode() was not mutually exclusive but that can't be the
case (obviously) because the queue entry (or entries) is removed from the
list when either of these two functions are called. Consequently the wait
entry will be freed by only one of these functions or by the woken process
in autofs_wait() depending on the order of the calls.
end edit: imk

The Linux kernel CVE team has assigned CVE-2023-54134 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 4.14.326 with commit 1985e8eae8627f02e3364690c5fed7af1c46be55
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 4.19.295 with commit 976abbdc120a97049b9133e60fa7b29627d11de4
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 5.4.257 with commit 6079dc77c6f32936e8a6766ee8334ae3c99f4504
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 5.10.197 with commit 69ddafc7a7afd8401bab53eff5af813fa0d368a2
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 5.15.133 with commit 71eeddcad7342292c19042c290c477697acaccab
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 6.1.55 with commit 726deae613bc1b6096ad3b61cc1e63e33330fbc2
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 6.5.5 with commit 696b625f3f85d80fca48c24d2948fbc451e74366
	Issue introduced in 2.6.27 with commit 296f7bf78bc5c7a4d772aea580ce800d14040d1a and fixed in 6.6 with commit ccbe77f7e45dfb4420f7f531b650c00c6e9c7507

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54134
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/autofs/waitq.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/1985e8eae8627f02e3364690c5fed7af1c46be55
	https://git.kernel.org/stable/c/976abbdc120a97049b9133e60fa7b29627d11de4
	https://git.kernel.org/stable/c/6079dc77c6f32936e8a6766ee8334ae3c99f4504
	https://git.kernel.org/stable/c/69ddafc7a7afd8401bab53eff5af813fa0d368a2
	https://git.kernel.org/stable/c/71eeddcad7342292c19042c290c477697acaccab
	https://git.kernel.org/stable/c/726deae613bc1b6096ad3b61cc1e63e33330fbc2
	https://git.kernel.org/stable/c/696b625f3f85d80fca48c24d2948fbc451e74366
	https://git.kernel.org/stable/c/ccbe77f7e45dfb4420f7f531b650c00c6e9c7507
