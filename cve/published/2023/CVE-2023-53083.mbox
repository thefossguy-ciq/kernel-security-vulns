From bippy-1.1.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53083: nfsd: don't replace page in rq_pages if it's a continuation of last page

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nfsd: don't replace page in rq_pages if it's a continuation of last page

The splice read calls nfsd_splice_actor to put the pages containing file
data into the svc_rqst->rq_pages array. It's possible however to get a
splice result that only has a partial page at the end, if (e.g.) the
filesystem hands back a short read that doesn't cover the whole page.

nfsd_splice_actor will plop the partial page into its rq_pages array and
return. Then later, when nfsd_splice_actor is called again, the
remainder of the page may end up being filled out. At this point,
nfsd_splice_actor will put the page into the array _again_ corrupting
the reply. If this is done enough times, rq_next_page will overrun the
array and corrupt the trailing fields -- the rq_respages and
rq_next_page pointers themselves.

If we've already added the page to the array in the last pass, don't add
it to the array a second time when dealing with a splice continuation.
This was originally handled properly in nfsd_splice_actor, but commit
91e23b1c3982 ("NFSD: Clean up nfsd_splice_actor()") removed the check
for it.

The Linux kernel CVE team has assigned CVE-2023-53083 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.19 with commit 91e23b1c39820bfed642119ff6b6ef9f43cf09ce and fixed in 6.1.22 with commit 51ddb84baff6f09ad62b5999ece3ec172e4e3568
	Issue introduced in 5.19 with commit 91e23b1c39820bfed642119ff6b6ef9f43cf09ce and fixed in 6.2.9 with commit 0101067f376eb7b9afd00279270f25d5111a091d
	Issue introduced in 5.19 with commit 91e23b1c39820bfed642119ff6b6ef9f43cf09ce and fixed in 6.3 with commit 27c934dd8832dd40fd34776f916dc201e18b319b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53083
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nfsd/vfs.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8235cd619db6e67f1d7d26c55f1f3e4e575c947d
	https://git.kernel.org/stable/c/12eca509234acb6b666802edf77408bb70d7bfca
	https://git.kernel.org/stable/c/51ddb84baff6f09ad62b5999ece3ec172e4e3568
	https://git.kernel.org/stable/c/0101067f376eb7b9afd00279270f25d5111a091d
	https://git.kernel.org/stable/c/27c934dd8832dd40fd34776f916dc201e18b319b
