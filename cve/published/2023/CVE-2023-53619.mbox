From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53619: netfilter: conntrack: Avoid nf_ct_helper_hash uses after free

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

netfilter: conntrack: Avoid nf_ct_helper_hash uses after free

If nf_conntrack_init_start() fails (for example due to a
register_nf_conntrack_bpf() failure), the nf_conntrack_helper_fini()
clean-up path frees the nf_ct_helper_hash map.

When built with NF_CONNTRACK=y, further netfilter modules (e.g:
netfilter_conntrack_ftp) can still be loaded and call
nf_conntrack_helpers_register(), independently of whether nf_conntrack
initialized correctly. This accesses the nf_ct_helper_hash dangling
pointer and causes a uaf, possibly leading to random memory corruption.

This patch guards nf_conntrack_helper_register() from accessing a freed
or uninitialized nf_ct_helper_hash pointer and fixes possible
uses-after-free when loading a conntrack module.

The Linux kernel CVE team has assigned CVE-2023-53619 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 4.14.322 with commit 4ee69c91cb8f9ca144bc0861969e5a1a3c6152a7
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 4.19.291 with commit 00716f25f9697d02a0d9bd622575c7c7321ba3d0
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 5.4.251 with commit 61c7a5256543ae7d24cd9d21853d514c8632e1e9
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 5.10.188 with commit 8289d422f5e484efe4a565fe18e862ecd621c175
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 5.15.121 with commit 6f03ce2f1abcb9f9d0511e3659ca6eb60e39f566
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 6.1.39 with commit 05561f822f27b9fa88fa5504ddec34bf38833034
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 6.4.4 with commit fce5cc7cbd4b92f979bf02c9ec5fb69aaeba92d7
	Issue introduced in 3.6 with commit 12f7a505331e6b2754684b509f2ac8f0011ce644 and fixed in 6.5 with commit 6eef7a2b933885a17679eb8ed0796ddf0ee5309b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53619
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/netfilter/nf_conntrack_helper.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/4ee69c91cb8f9ca144bc0861969e5a1a3c6152a7
	https://git.kernel.org/stable/c/00716f25f9697d02a0d9bd622575c7c7321ba3d0
	https://git.kernel.org/stable/c/61c7a5256543ae7d24cd9d21853d514c8632e1e9
	https://git.kernel.org/stable/c/8289d422f5e484efe4a565fe18e862ecd621c175
	https://git.kernel.org/stable/c/6f03ce2f1abcb9f9d0511e3659ca6eb60e39f566
	https://git.kernel.org/stable/c/05561f822f27b9fa88fa5504ddec34bf38833034
	https://git.kernel.org/stable/c/fce5cc7cbd4b92f979bf02c9ec5fb69aaeba92d7
	https://git.kernel.org/stable/c/6eef7a2b933885a17679eb8ed0796ddf0ee5309b
