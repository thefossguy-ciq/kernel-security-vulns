From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54137: vfio/type1: fix cap_migration information leak

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

vfio/type1: fix cap_migration information leak

Fix an information leak where an uninitialized hole in struct
vfio_iommu_type1_info_cap_migration on the stack is exposed to userspace.

The definition of struct vfio_iommu_type1_info_cap_migration contains a hole as
shown in this pahole(1) output:

  struct vfio_iommu_type1_info_cap_migration {
          struct vfio_info_cap_header header;              /*     0     8 */
          __u32                      flags;                /*     8     4 */

          /* XXX 4 bytes hole, try to pack */

          __u64                      pgsize_bitmap;        /*    16     8 */
          __u64                      max_dirty_bitmap_size; /*    24     8 */

          /* size: 32, cachelines: 1, members: 4 */
          /* sum members: 28, holes: 1, sum holes: 4 */
          /* last cacheline: 32 bytes */
  };

The cap_mig variable is filled in without initializing the hole:

  static int vfio_iommu_migration_build_caps(struct vfio_iommu *iommu,
                         struct vfio_info_cap *caps)
  {
      struct vfio_iommu_type1_info_cap_migration cap_mig;

      cap_mig.header.id = VFIO_IOMMU_TYPE1_INFO_CAP_MIGRATION;
      cap_mig.header.version = 1;

      cap_mig.flags = 0;
      /* support minimum pgsize */
      cap_mig.pgsize_bitmap = (size_t)1 << __ffs(iommu->pgsize_bitmap);
      cap_mig.max_dirty_bitmap_size = DIRTY_BITMAP_SIZE_MAX;

      return vfio_info_add_capability(caps, &cap_mig.header, sizeof(cap_mig));
  }

The structure is then copied to a temporary location on the heap. At this point
it's already too late and ioctl(VFIO_IOMMU_GET_INFO) copies it to userspace
later:

  int vfio_info_add_capability(struct vfio_info_cap *caps,
                   struct vfio_info_cap_header *cap, size_t size)
  {
      struct vfio_info_cap_header *header;

      header = vfio_info_cap_add(caps, size, cap->id, cap->version);
      if (IS_ERR(header))
          return PTR_ERR(header);

      memcpy(header + 1, cap + 1, size - sizeof(*header));

      return 0;
  }

This issue was found by code inspection.

The Linux kernel CVE team has assigned CVE-2023-54137 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.8 with commit ad721705d09c62f0d108a6b4f59867ebfd592c90 and fixed in 5.10.195 with commit ad83d83dd891244de0d07678b257dc976db7c132
	Issue introduced in 5.8 with commit ad721705d09c62f0d108a6b4f59867ebfd592c90 and fixed in 5.15.132 with commit 13fd667db999bffb557c5de7adb3c14f1713dd51
	Issue introduced in 5.8 with commit ad721705d09c62f0d108a6b4f59867ebfd592c90 and fixed in 6.1.53 with commit f6f300ecc196d243c02adeb9ee0c62c677c24bfb
	Issue introduced in 5.8 with commit ad721705d09c62f0d108a6b4f59867ebfd592c90 and fixed in 6.4.16 with commit cbac29a1caa49a34e131394e1f4d924a76d8b0c9
	Issue introduced in 5.8 with commit ad721705d09c62f0d108a6b4f59867ebfd592c90 and fixed in 6.5.3 with commit 1b5feb8497cdb5b9962db2700814bffbc030fb4a
	Issue introduced in 5.8 with commit ad721705d09c62f0d108a6b4f59867ebfd592c90 and fixed in 6.6 with commit cd24e2a60af633f157d7e59c0a6dba64f131c0b1

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54137
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/vfio/vfio_iommu_type1.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ad83d83dd891244de0d07678b257dc976db7c132
	https://git.kernel.org/stable/c/13fd667db999bffb557c5de7adb3c14f1713dd51
	https://git.kernel.org/stable/c/f6f300ecc196d243c02adeb9ee0c62c677c24bfb
	https://git.kernel.org/stable/c/cbac29a1caa49a34e131394e1f4d924a76d8b0c9
	https://git.kernel.org/stable/c/1b5feb8497cdb5b9962db2700814bffbc030fb4a
	https://git.kernel.org/stable/c/cd24e2a60af633f157d7e59c0a6dba64f131c0b1
