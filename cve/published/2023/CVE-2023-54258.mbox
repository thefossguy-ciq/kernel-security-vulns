From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54258: cifs: fix potential oops in cifs_oplock_break
Message-Id: <2025123056-CVE-2023-54258-532c@gregkh>
Content-Length: 4045
Lines: 78
X-Developer-Signature: v=1; a=openpgp-sha256; l=4124;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=jzxlFUBCefxXt3Eh/pKSnxbWSX+JjJVSnNDAYzwbWbk=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnBh3O2bE5W8WcNr454INz213zV9nO3g4uT4jbG71q3o
 JCjvD6gI5aFQZCJQVZMkeXLNp6j+ysOKXoZ2p6GmcPKBDKEgYtTACay9inDPNX+SgnTy3cK161q
 nCw+P2fq17NLVRnmp9asMK208D6YHrx7l330uRNB37NcAQ==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

cifs: fix potential oops in cifs_oplock_break

With deferred close we can have closes that race with lease breaks,
and so with the current checks for whether to send the lease response,
oplock_response(), this can mean that an unmount (kill_sb) can occur
just before we were checking if the tcon->ses is valid.  See below:

[Fri Aug  4 04:12:50 2023] RIP: 0010:cifs_oplock_break+0x1f7/0x5b0 [cifs]
[Fri Aug  4 04:12:50 2023] Code: 7d a8 48 8b 7d c0 c0 e9 02 48 89 45 b8 41 89 cf e8 3e f5 ff ff 4c 89 f7 41 83 e7 01 e8 82 b3 03 f2 49 8b 45 50 48 85 c0 74 5e <48> 83 78 60 00 74 57 45 84 ff 75 52 48 8b 43 98 48 83 eb 68 48 39
[Fri Aug  4 04:12:50 2023] RSP: 0018:ffffb30607ddbdf8 EFLAGS: 00010206
[Fri Aug  4 04:12:50 2023] RAX: 632d223d32612022 RBX: ffff97136944b1e0 RCX: 0000000080100009
[Fri Aug  4 04:12:50 2023] RDX: 0000000000000001 RSI: 0000000080100009 RDI: ffff97136944b188
[Fri Aug  4 04:12:50 2023] RBP: ffffb30607ddbe58 R08: 0000000000000001 R09: ffffffffc08e0900
[Fri Aug  4 04:12:50 2023] R10: 0000000000000001 R11: 000000000000000f R12: ffff97136944b138
[Fri Aug  4 04:12:50 2023] R13: ffff97149147c000 R14: ffff97136944b188 R15: 0000000000000000
[Fri Aug  4 04:12:50 2023] FS:  0000000000000000(0000) GS:ffff9714f7c00000(0000) knlGS:0000000000000000
[Fri Aug  4 04:12:50 2023] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[Fri Aug  4 04:12:50 2023] CR2: 00007fd8de9c7590 CR3: 000000011228e000 CR4: 0000000000350ef0
[Fri Aug  4 04:12:50 2023] Call Trace:
[Fri Aug  4 04:12:50 2023]  <TASK>
[Fri Aug  4 04:12:50 2023]  process_one_work+0x225/0x3d0
[Fri Aug  4 04:12:50 2023]  worker_thread+0x4d/0x3e0
[Fri Aug  4 04:12:50 2023]  ? process_one_work+0x3d0/0x3d0
[Fri Aug  4 04:12:50 2023]  kthread+0x12a/0x150
[Fri Aug  4 04:12:50 2023]  ? set_kthread_struct+0x50/0x50
[Fri Aug  4 04:12:50 2023]  ret_from_fork+0x22/0x30
[Fri Aug  4 04:12:50 2023]  </TASK>

To fix this change the ordering of the checks before sending the oplock_response
to first check if the openFileList is empty.

The Linux kernel CVE team has assigned CVE-2023-54258 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.15.121 with commit 63fb45ddc491895c4b36664e0c2c3b548545ae93 and fixed in 5.15.128 with commit b99f490ea87ebcca3a429fd8837067feb56a4c7c
	Issue introduced in 6.1.39 with commit 1bf709b9625001eefdd41048c5f4c7544ee33394 and fixed in 6.1.47 with commit 5ee28bcfbaacf289eb25c662a2862542ea6ce6a7
	Issue introduced in 6.4.4 with commit 3b4c15171c3ce9120c81f5564b9367d8d0f4219c and fixed in 6.4.12 with commit 6b67a6d2e50634fe127e656147c81915955e9f5e
	Issue introduced in 6.3.13 with commit cff7fb969edaeff2bc80c8a8f7cf7b0c8df32da7

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54258
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/smb/client/file.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b99f490ea87ebcca3a429fd8837067feb56a4c7c
	https://git.kernel.org/stable/c/5ee28bcfbaacf289eb25c662a2862542ea6ce6a7
	https://git.kernel.org/stable/c/6b67a6d2e50634fe127e656147c81915955e9f5e
	https://git.kernel.org/stable/c/e8f5f849ffce24490eb9449e98312b66c0dba76f
