From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53986: mips: bmips: BCM6358: disable RAC flush for TP1

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mips: bmips: BCM6358: disable RAC flush for TP1

RAC flush causes kernel panics on BCM6358 with EHCI/OHCI when booting from TP1:
[    3.881739] usb 1-1: new high-speed USB device number 2 using ehci-platform
[    3.895011] Reserved instruction in kernel code[#1]:
[    3.900113] CPU: 0 PID: 1 Comm: init Not tainted 5.10.16 #0
[    3.905829] $ 0   : 00000000 10008700 00000000 77d94060
[    3.911238] $ 4   : 7fd1f088 00000000 81431cac 81431ca0
[    3.916641] $ 8   : 00000000 ffffefff 8075cd34 00000000
[    3.922043] $12   : 806f8d40 f3e812b7 00000000 000d9aaa
[    3.927446] $16   : 7fd1f068 7fd1f080 7ff559b8 81428470
[    3.932848] $20   : 00000000 00000000 55590000 77d70000
[    3.938251] $24   : 00000018 00000010
[    3.943655] $28   : 81430000 81431e60 81431f28 800157fc
[    3.949058] Hi    : 00000000
[    3.952013] Lo    : 00000000
[    3.955019] epc   : 80015808 setup_sigcontext+0x54/0x24c
[    3.960464] ra    : 800157fc setup_sigcontext+0x48/0x24c
[    3.965913] Status: 10008703	KERNEL EXL IE
[    3.970216] Cause : 00800028 (ExcCode 0a)
[    3.974340] PrId  : 0002a010 (Broadcom BMIPS4350)
[    3.979170] Modules linked in: ohci_platform ohci_hcd fsl_mph_dr_of ehci_platform ehci_fsl ehci_hcd gpio_button_hotplug usbcore nls_base usb_common
[    3.992907] Process init (pid: 1, threadinfo=(ptrval), task=(ptrval), tls=77e22ec8)
[    4.000776] Stack : 81431ef4 7fd1f080 81431f28 81428470 7fd1f068 81431edc 7ff559b8 81428470
[    4.009467]         81431f28 7fd1f080 55590000 77d70000 77d5498c 80015c70 806f0000 8063ae74
[    4.018149]         08100002 81431f28 0000000a 08100002 81431f28 0000000a 77d6b418 00000003
[    4.026831]         ffffffff 80016414 80080734 81431ecc 81431ecc 00000001 00000000 04000000
[    4.035512]         77d54874 00000000 00000000 00000000 00000000 00000012 00000002 00000000
[    4.044196]         ...
[    4.046706] Call Trace:
[    4.049238] [<80015808>] setup_sigcontext+0x54/0x24c
[    4.054356] [<80015c70>] setup_frame+0xdc/0x124
[    4.059015] [<80016414>] do_notify_resume+0x1dc/0x288
[    4.064207] [<80011b50>] work_notifysig+0x10/0x18
[    4.069036]
[    4.070538] Code: 8fc300b4  00001025  26240008 <ac820000> ac830004  3c048063  0c0228aa  24846a00  26240010
[    4.080686]
[    4.082517] ---[ end trace 22a8edb41f5f983b ]---
[    4.087374] Kernel panic - not syncing: Fatal exception
[    4.092753] Rebooting in 1 seconds..

Because the bootloader (CFE) is not initializing the Read-ahead cache properly
on the second thread (TP1). Since the RAC was not initialized properly, we
should avoid flushing it at the risk of corrupting the instruction stream as
seen in the trace above.

The Linux kernel CVE team has assigned CVE-2023-53986 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.19 with commit d59098a0e9cb3c7767090e935c909b37a30629ab and fixed in 5.4.240 with commit d65de5ee8b72868fbbbd39ca73017d0e526fa13a
	Issue introduced in 4.19 with commit d59098a0e9cb3c7767090e935c909b37a30629ab and fixed in 5.10.177 with commit 47a449ec09b4479b89dcc6b27ec3829fc82ffafb
	Issue introduced in 4.19 with commit d59098a0e9cb3c7767090e935c909b37a30629ab and fixed in 5.15.106 with commit 65b723644294f1d79770704162c0e8d1f700b6f1
	Issue introduced in 4.19 with commit d59098a0e9cb3c7767090e935c909b37a30629ab and fixed in 6.1.23 with commit 2cdbcff99f15db86a10672fb220379a1ae46ccae
	Issue introduced in 4.19 with commit d59098a0e9cb3c7767090e935c909b37a30629ab and fixed in 6.2.10 with commit 288c96aa5b5526cd4a946e84ef85e165857693b5
	Issue introduced in 4.19 with commit d59098a0e9cb3c7767090e935c909b37a30629ab and fixed in 6.3 with commit ab327f8acdf8d06601fbf058859a539a9422afff

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53986
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/mips/bmips/dma.c
	arch/mips/bmips/setup.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d65de5ee8b72868fbbbd39ca73017d0e526fa13a
	https://git.kernel.org/stable/c/47a449ec09b4479b89dcc6b27ec3829fc82ffafb
	https://git.kernel.org/stable/c/65b723644294f1d79770704162c0e8d1f700b6f1
	https://git.kernel.org/stable/c/2cdbcff99f15db86a10672fb220379a1ae46ccae
	https://git.kernel.org/stable/c/288c96aa5b5526cd4a946e84ef85e165857693b5
	https://git.kernel.org/stable/c/ab327f8acdf8d06601fbf058859a539a9422afff
