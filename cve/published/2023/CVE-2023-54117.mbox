From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-54117: s390/dcssblk: fix kernel crash with list_add corruption

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

s390/dcssblk: fix kernel crash with list_add corruption

Commit fb08a1908cb1 ("dax: simplify the dax_device <-> gendisk
association") introduced new logic for gendisk association, requiring
drivers to explicitly call dax_add_host() and dax_remove_host().

For dcssblk driver, some dax_remove_host() calls were missing, e.g. in
device remove path. The commit also broke error handling for out_dax case
in device add path, resulting in an extra put_device() w/o the previous
get_device() in that case.

This lead to stale xarray entries after device add / remove cycles. In the
case when a previously used struct gendisk pointer (xarray index) would be
used again, because blk_alloc_disk() happened to return such a pointer, the
xa_insert() in dax_add_host() would fail and go to out_dax, doing the extra
put_device() in the error path. In combination with an already flawed error
handling in dcssblk (device_register() cleanup), which needs to be
addressed in a separate patch, this resulted in a missing device_del() /
klist_del(), and eventually in the kernel crash with list_add corruption on
a subsequent device_add() / klist_add().

Fix this by adding the missing dax_remove_host() calls, and also move the
put_device() in the error path to restore the previous logic.

The Linux kernel CVE team has assigned CVE-2023-54117 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.17 with commit fb08a1908cb119a4585611d91461ab6d27756b14 and fixed in 6.1.53 with commit 6489ec0107860345bc57dcde39e63dfb05ac5c11
	Issue introduced in 5.17 with commit fb08a1908cb119a4585611d91461ab6d27756b14 and fixed in 6.4.16 with commit b7ad75c77349beb4983b9f27108d9b3f33ae1413
	Issue introduced in 5.17 with commit fb08a1908cb119a4585611d91461ab6d27756b14 and fixed in 6.5.3 with commit b5c531a9a7d8e047c90c909f09cef06a9f8e62f4
	Issue introduced in 5.17 with commit fb08a1908cb119a4585611d91461ab6d27756b14 and fixed in 6.6 with commit c8f40a0bccefd613748d080147469a4652d6e74c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-54117
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/s390/block/dcssblk.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/6489ec0107860345bc57dcde39e63dfb05ac5c11
	https://git.kernel.org/stable/c/b7ad75c77349beb4983b9f27108d9b3f33ae1413
	https://git.kernel.org/stable/c/b5c531a9a7d8e047c90c909f09cef06a9f8e62f4
	https://git.kernel.org/stable/c/c8f40a0bccefd613748d080147469a4652d6e74c
