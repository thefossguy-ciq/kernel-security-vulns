From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53851: drm/msm/dp: Drop aux devices together with DP controller
Message-Id: <2025120901-CVE-2023-53851-a201@gregkh>
Content-Length: 3023
Lines: 72
X-Developer-Signature: v=1; a=openpgp-sha256; l=3096;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=0uB10epKlKaVU0kY8I9BwrAhYvPATGM2gkPPJyWV2QI=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnm1VcluYM2BTVeuTu3rffkd2Oht7pTF9r+4z8/Wa+p3
 5ylpeR8RywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEzkSgnDgr3fX0yd9fL/uZjP
 lT/3/j0xe9/tJfoMCxY9fdvGou6+dNIOw9Y5Uvar7qxqewwA
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

drm/msm/dp: Drop aux devices together with DP controller

Using devres to depopulate the aux bus made sure that upon a probe
deferral the EDP panel device would be destroyed and recreated upon next
attempt.

But the struct device which the devres is tied to is the DPUs
(drm_dev->dev), which may be happen after the DP controller is torn
down.

Indications of this can be seen in the commonly seen EDID-hexdump full
of zeros in the log, or the occasional/rare KASAN fault where the
panel's attempt to read the EDID information causes a use after free on
DP resources.

It's tempting to move the devres to the DP controller's struct device,
but the resources used by the device(s) on the aux bus are explicitly
torn down in the error path. The KASAN-reported use-after-free also
remains, as the DP aux "module" explicitly frees its devres-allocated
memory in this code path.

As such, explicitly depopulate the aux bus in the error path, and in the
component unbind path, to avoid these issues.

Patchwork: https://patchwork.freedesktop.org/patch/542163/

The Linux kernel CVE team has assigned CVE-2023-53851 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1 with commit 2b57f726611e294dc4297dd48eb8c98ef1938e82 and fixed in 6.3.13 with commit e09ed06938807cb113cddd0708ed74bd8cdaff33
	Issue introduced in 6.1 with commit 2b57f726611e294dc4297dd48eb8c98ef1938e82 and fixed in 6.4.4 with commit 2fde37445807e6e6d7981402d0bf1be0e5d81291
	Issue introduced in 6.1 with commit 2b57f726611e294dc4297dd48eb8c98ef1938e82 and fixed in 6.5 with commit a7bfb2ad2184a1fba78be35209b6019aa8cc8d4d
	Issue introduced in 6.0.7 with commit 8768663188e4169333f66583e4d2432e65c421df

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53851
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/gpu/drm/msm/dp/dp_display.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e09ed06938807cb113cddd0708ed74bd8cdaff33
	https://git.kernel.org/stable/c/2fde37445807e6e6d7981402d0bf1be0e5d81291
	https://git.kernel.org/stable/c/a7bfb2ad2184a1fba78be35209b6019aa8cc8d4d
