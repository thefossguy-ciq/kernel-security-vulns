From: Linux Kernel CVE team <cve@kernel.org>
Subject: CVE-2023-1851: nfc: llcp_core: Hold a ref to llcp_local->dev when holding a ref to llcp_local

Description
===========

nfc: llcp_core: Hold a ref to llcp_local->dev when holding a ref to llcp_local

llcp_sock_sendmsg() calls nfc_llcp_send_ui_frame() which in turn calls
nfc_alloc_send_skb(), which accesses the nfc_dev from the llcp_sock for
getting the headroom and tailroom needed for skb allocation.

Parallelly the nfc_dev can be freed, as the refcount is decreased via
nfc_free_device(), leading to a UAF reported by Syzkaller, which can
be summarized as follows:

(1) llcp_sock_sendmsg() -> nfc_llcp_send_ui_frame()
	-> nfc_alloc_send_skb() -> Dereference *nfc_dev
(2) virtual_ncidev_close() -> nci_free_device() -> nfc_free_device()
	-> put_device() -> nfc_release() -> Free *nfc_dev

When a reference to llcp_local is acquired, we do not acquire the same
for the nfc_dev. This leads to freeing even when the llcp_local is in
use, and this is the case with the UAF described above too.

Thus, when we acquire a reference to llcp_local, we should acquire a
reference to nfc_dev, and release the references appropriately later.

References for llcp_local is initialized in nfc_llcp_register_device()
(which is called by nfc_register_device()). Thus, we should acquire a
reference to nfc_dev there.

nfc_unregister_device() calls nfc_llcp_unregister_device() which in
turn calls nfc_llcp_local_put(). Thus, the reference to nfc_dev is
appropriately released later.

The Linux kernel CVE team has assigned CVE-2023-1851 to this issue.


Mitigation
==========

The individual change to resolve this issue can be found at:
	https://git.kernel.org/stable/linux/c/c95f919567d6f1914f13350af61a1b044ac85014


Affected versions
=================
	Issue introduced in 3.6 and fixed in 4.14.336
	Issue introduced in 3.6 and fixed in 4.19.305
	Issue introduced in 3.6 and fixed in 5.4.267
	Issue introduced in 3.6 and fixed in 5.10.208
	Issue introduced in 3.6 and fixed in 5.15.147
	Issue introduced in 3.6 and fixed in 6.1.72
	Issue introduced in 3.6 and fixed in 6.6.11
	Issue introduced in 3.6 and fixed in 6.7


Recomendation
=============
The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are not tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.
