From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53720: net/mlx5e: Release the label when replacing existing ct entry
Message-Id: <2025102214-CVE-2023-53720-da5a@gregkh>
Content-Length: 3074
Lines: 70
X-Developer-Signature: v=1; a=openpgp-sha256; l=3145;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=U6StLU+ZqUORU7M9n+Q7wXMEQ6/+8FpqtUSBib8jZyU=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBk/bv27c+juE9mJ9csD0r7LFkwsiT95ZKO/rbR4+ccJW
 /J8LA+c64hlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJGJYxLGgwKU652t9xMf7R
 wZcG4ZIfDXeYLmVYcNqicd1jhZXmBwxMrBRt7zUG7l66GgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net/mlx5e: Release the label when replacing existing ct entry

Cited commit doesn't release the label mapping when replacing existing ct
entry which leads to following memleak report:

unreferenced object 0xffff8881854cf280 (size 96):
  comm "kworker/u48:74", pid 23093, jiffies 4296664564 (age 175.944s)
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
  backtrace:
    [<000000002722d368>] __kmalloc+0x4b/0x1c0
    [<00000000cc44e18f>] mapping_add+0x6e8/0xc90 [mlx5_core]
    [<000000003ad942a7>] mlx5_get_label_mapping+0x66/0xe0 [mlx5_core]
    [<00000000266308ac>] mlx5_tc_ct_entry_create_mod_hdr+0x1c4/0xf50 [mlx5_core]
    [<000000009a768b4f>] mlx5_tc_ct_entry_add_rule+0x16f/0xaf0 [mlx5_core]
    [<00000000a178f3e5>] mlx5_tc_ct_block_flow_offload_add+0x10cb/0x1f90 [mlx5_core]
    [<000000007b46c496>] mlx5_tc_ct_block_flow_offload+0x14a/0x630 [mlx5_core]
    [<00000000a9a18ac5>] nf_flow_offload_tuple+0x1a3/0x390 [nf_flow_table]
    [<00000000d0881951>] flow_offload_work_handler+0x257/0xd30 [nf_flow_table]
    [<000000009e4935a4>] process_one_work+0x7c2/0x13e0
    [<00000000f5cd36a7>] worker_thread+0x59d/0xec0
    [<00000000baed1daf>] kthread+0x28f/0x330
    [<0000000063d282a4>] ret_from_fork+0x1f/0x30

Fix the issue by correctly releasing the label mapping.

The Linux kernel CVE team has assigned CVE-2023-53720 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.3 with commit 94ceffb48eac7692677d8093dcde6965b70c4b35 and fixed in 6.3.2 with commit 3db903a71f1f4bbf30baae166a4a49f2e8aceb61
	Issue introduced in 6.3 with commit 94ceffb48eac7692677d8093dcde6965b70c4b35 and fixed in 6.4 with commit 8ac04a28144cfa89b61be518268233742c23d88d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53720
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3db903a71f1f4bbf30baae166a4a49f2e8aceb61
	https://git.kernel.org/stable/c/8ac04a28144cfa89b61be518268233742c23d88d
