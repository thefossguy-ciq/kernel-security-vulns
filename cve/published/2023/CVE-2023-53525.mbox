From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2023-53525: RDMA/cma: Allow UD qp_type to join multicast only
Message-Id: <2025100134-CVE-2023-53525-ee57@gregkh>
Content-Length: 4666
Lines: 94
X-Developer-Signature: v=1; a=openpgp-sha256; l=4761;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=5chXwvarGg2vz4eSeMxFqS1vfD9j5zZ6/nV/0d++3rs=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBl3ReIcc/qCfpZ5i5+WVQtYvlpXO0z/uB/HcXdvD44A1
 wMrN53riGVhEGRikBVTZPmyjefo/opDil6Gtqdh5rAygQxh4OIUgIlk6jEsWJB15azYkh3RN5U6
 /U03Wzu90Zn6mWGeumHrqpVezbH9778olZ94uiH/2YxUAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

RDMA/cma: Allow UD qp_type to join multicast only

As for multicast:
- The SIDR is the only mode that makes sense;
- Besides PS_UDP, other port spaces like PS_IB is also allowed, as it is
  UD compatible. In this case qkey also needs to be set [1].

This patch allows only UD qp_type to join multicast, and set qkey to
default if it's not set, to fix an uninit-value error: the ib->rec.qkey
field is accessed without being initialized.

=====================================================
BUG: KMSAN: uninit-value in cma_set_qkey drivers/infiniband/core/cma.c:510 [inline]
BUG: KMSAN: uninit-value in cma_make_mc_event+0xb73/0xe00 drivers/infiniband/core/cma.c:4570
 cma_set_qkey drivers/infiniband/core/cma.c:510 [inline]
 cma_make_mc_event+0xb73/0xe00 drivers/infiniband/core/cma.c:4570
 cma_iboe_join_multicast drivers/infiniband/core/cma.c:4782 [inline]
 rdma_join_multicast+0x2b83/0x30a0 drivers/infiniband/core/cma.c:4814
 ucma_process_join+0xa76/0xf60 drivers/infiniband/core/ucma.c:1479
 ucma_join_multicast+0x1e3/0x250 drivers/infiniband/core/ucma.c:1546
 ucma_write+0x639/0x6d0 drivers/infiniband/core/ucma.c:1732
 vfs_write+0x8ce/0x2030 fs/read_write.c:588
 ksys_write+0x28c/0x520 fs/read_write.c:643
 __do_sys_write fs/read_write.c:655 [inline]
 __se_sys_write fs/read_write.c:652 [inline]
 __ia32_sys_write+0xdb/0x120 fs/read_write.c:652
 do_syscall_32_irqs_on arch/x86/entry/common.c:114 [inline]
 __do_fast_syscall_32+0x96/0xf0 arch/x86/entry/common.c:180
 do_fast_syscall_32+0x34/0x70 arch/x86/entry/common.c:205
 do_SYSENTER_32+0x1b/0x20 arch/x86/entry/common.c:248
 entry_SYSENTER_compat_after_hwframe+0x4d/0x5c

Local variable ib.i created at:
cma_iboe_join_multicast drivers/infiniband/core/cma.c:4737 [inline]
rdma_join_multicast+0x586/0x30a0 drivers/infiniband/core/cma.c:4814
ucma_process_join+0xa76/0xf60 drivers/infiniband/core/ucma.c:1479

CPU: 0 PID: 29874 Comm: syz-executor.3 Not tainted 5.16.0-rc3-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
=====================================================

[1] https://lore.kernel.org/linux-rdma/20220117183832.GD84788@nvidia.com/

The Linux kernel CVE team has assigned CVE-2023-53525 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10 with commit b5de0c60cc30c2a3513c7188c73f3f29acc29234 and fixed in 5.10.178 with commit ae11498851423d6de27aebfe12a5ee85060ab1d5
	Issue introduced in 5.10 with commit b5de0c60cc30c2a3513c7188c73f3f29acc29234 and fixed in 5.15.108 with commit 48e8e7851dc0b1584d83817a78fc7108c8904b54
	Issue introduced in 5.10 with commit b5de0c60cc30c2a3513c7188c73f3f29acc29234 and fixed in 6.1.25 with commit 02eabb635bc64bd1e3a7cf887d6d182bffb64b99
	Issue introduced in 5.10 with commit b5de0c60cc30c2a3513c7188c73f3f29acc29234 and fixed in 6.2.12 with commit bb18b9dbac2bbdf7695e0bfaac4bf944ff7b207d
	Issue introduced in 5.10 with commit b5de0c60cc30c2a3513c7188c73f3f29acc29234 and fixed in 6.3 with commit 58e84f6b3e84e46524b7e5a916b53c1ad798bc8f
	Issue introduced in 5.8.17 with commit b8d1adbff983be0b54f61c9a4169609d7fab0620
	Issue introduced in 5.9.2 with commit feed39c8d1282279fcb30612aa0e8d2635c11280

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2023-53525
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/infiniband/core/cma.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ae11498851423d6de27aebfe12a5ee85060ab1d5
	https://git.kernel.org/stable/c/48e8e7851dc0b1584d83817a78fc7108c8904b54
	https://git.kernel.org/stable/c/02eabb635bc64bd1e3a7cf887d6d182bffb64b99
	https://git.kernel.org/stable/c/bb18b9dbac2bbdf7695e0bfaac4bf944ff7b207d
	https://git.kernel.org/stable/c/58e84f6b3e84e46524b7e5a916b53c1ad798bc8f
