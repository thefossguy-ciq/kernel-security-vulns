From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2026-22980: nfsd: provide locking for v4_end_grace

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nfsd: provide locking for v4_end_grace

Writing to v4_end_grace can race with server shutdown and result in
memory being accessed after it was freed - reclaim_str_hashtbl in
particularly.

We cannot hold nfsd_mutex across the nfsd4_end_grace() call as that is
held while client_tracking_op->init() is called and that can wait for
an upcall to nfsdcltrack which can write to v4_end_grace, resulting in a
deadlock.

nfsd4_end_grace() is also called by the landromat work queue and this
doesn't require locking as server shutdown will stop the work and wait
for it before freeing anything that nfsd4_end_grace() might access.

However, we must be sure that writing to v4_end_grace doesn't restart
the work item after shutdown has already waited for it.  For this we
add a new flag protected with nn->client_lock.  It is set only while it
is safe to make client tracking calls, and v4_end_grace only schedules
work while the flag is set with the spinlock held.

So this patch adds a nfsd_net field "client_tracking_active" which is
set as described.  Another field "grace_end_forced", is set when
v4_end_grace is written.  After this is set, and providing
client_tracking_active is set, the laundromat is scheduled.
This "grace_end_forced" field bypasses other checks for whether the
grace period has finished.

This resolves a race which can result in use-after-free.

The Linux kernel CVE team has assigned CVE-2026-22980 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 5.10.248 with commit ca97360860eb02e3ae4ba42c19b439a0fcecbf06
	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 5.15.198 with commit e8bfa2401d4c51eca6e48e9b33c798828ca9df61
	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 6.1.161 with commit 34eb22836e0cdba093baac66599d68c4cd245a9d
	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 6.6.121 with commit 06600719d0f7a723811c45e4d51f5b742f345309
	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 6.12.66 with commit ba4811c8b433bfa681729ca42cc62b6034f223b0
	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 6.18.6 with commit 53f07d095e7e680c5e4569a55a019f2c0348cdc6
	Issue introduced in 3.18 with commit 7f5ef2e900d9462bf9cffaf6bb246ed87a20a6d6 and fixed in 6.19-rc5 with commit 2857bd59feb63fcf40fe4baf55401baea6b4feb4

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2026-22980
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nfsd/netns.h
	fs/nfsd/nfs4state.c
	fs/nfsd/nfsctl.c
	fs/nfsd/state.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ca97360860eb02e3ae4ba42c19b439a0fcecbf06
	https://git.kernel.org/stable/c/e8bfa2401d4c51eca6e48e9b33c798828ca9df61
	https://git.kernel.org/stable/c/34eb22836e0cdba093baac66599d68c4cd245a9d
	https://git.kernel.org/stable/c/06600719d0f7a723811c45e4d51f5b742f345309
	https://git.kernel.org/stable/c/ba4811c8b433bfa681729ca42cc62b6034f223b0
	https://git.kernel.org/stable/c/53f07d095e7e680c5e4569a55a019f2c0348cdc6
	https://git.kernel.org/stable/c/2857bd59feb63fcf40fe4baf55401baea6b4feb4
