From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2026-22977: net: sock: fix hardened usercopy panic in sock_recv_errqueue
Message-Id: <2026012158-CVE-2026-22977-cead@gregkh>
Content-Length: 6672
Lines: 121
X-Developer-Signature: v=1; a=openpgp-sha256; l=6794;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=jG8tUmtpMHeE1co0KCDa2ijnzI5q2OQc9nQ4RBQ65y0=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJkF519tf/r342+R6Y3JXWVdZ6z09i/b9WTiCk27YPslB
 nf0XsS+6YhlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJfA1gWLD8ycQK322CH1cc
 fDmp3JAxgX/X3lyGecpRmRfSD0ocLHGdYfyLQbP5mI1SGQA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: sock: fix hardened usercopy panic in sock_recv_errqueue

skbuff_fclone_cache was created without defining a usercopy region,
[1] unlike skbuff_head_cache which properly whitelists the cb[] field.
[2] This causes a usercopy BUG() when CONFIG_HARDENED_USERCOPY is
enabled and the kernel attempts to copy sk_buff.cb data to userspace
via sock_recv_errqueue() -> put_cmsg().

The crash occurs when: 1. TCP allocates an skb using alloc_skb_fclone()
   (from skbuff_fclone_cache) [1]
2. The skb is cloned via skb_clone() using the pre-allocated fclone
[3] 3. The cloned skb is queued to sk_error_queue for timestamp
reporting 4. Userspace reads the error queue via recvmsg(MSG_ERRQUEUE)
5. sock_recv_errqueue() calls put_cmsg() to copy serr->ee from skb->cb
[4] 6. __check_heap_object() fails because skbuff_fclone_cache has no
   usercopy whitelist [5]

When cloned skbs allocated from skbuff_fclone_cache are used in the
socket error queue, accessing the sock_exterr_skb structure in skb->cb
via put_cmsg() triggers a usercopy hardening violation:

[    5.379589] usercopy: Kernel memory exposure attempt detected from SLUB object 'skbuff_fclone_cache' (offset 296, size 16)!
[    5.382796] kernel BUG at mm/usercopy.c:102!
[    5.383923] Oops: invalid opcode: 0000 [#1] SMP KASAN NOPTI
[    5.384903] CPU: 1 UID: 0 PID: 138 Comm: poc_put_cmsg Not tainted 6.12.57 #7
[    5.384903] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org 04/01/2014
[    5.384903] RIP: 0010:usercopy_abort+0x6c/0x80
[    5.384903] Code: 1a 86 51 48 c7 c2 40 15 1a 86 41 52 48 c7 c7 c0 15 1a 86 48 0f 45 d6 48 c7 c6 80 15 1a 86 48 89 c1 49 0f 45 f3 e8 84 27 88 ff <0f> 0b 490
[    5.384903] RSP: 0018:ffffc900006f77a8 EFLAGS: 00010246
[    5.384903] RAX: 000000000000006f RBX: ffff88800f0ad2a8 RCX: 1ffffffff0f72e74
[    5.384903] RDX: 0000000000000000 RSI: 0000000000000004 RDI: ffffffff87b973a0
[    5.384903] RBP: 0000000000000010 R08: 0000000000000000 R09: fffffbfff0f72e74
[    5.384903] R10: 0000000000000003 R11: 79706f6372657375 R12: 0000000000000001
[    5.384903] R13: ffff88800f0ad2b8 R14: ffffea00003c2b40 R15: ffffea00003c2b00
[    5.384903] FS:  0000000011bc4380(0000) GS:ffff8880bf100000(0000) knlGS:0000000000000000
[    5.384903] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[    5.384903] CR2: 000056aa3b8e5fe4 CR3: 000000000ea26004 CR4: 0000000000770ef0
[    5.384903] PKRU: 55555554
[    5.384903] Call Trace:
[    5.384903]  <TASK>
[    5.384903]  __check_heap_object+0x9a/0xd0
[    5.384903]  __check_object_size+0x46c/0x690
[    5.384903]  put_cmsg+0x129/0x5e0
[    5.384903]  sock_recv_errqueue+0x22f/0x380
[    5.384903]  tls_sw_recvmsg+0x7ed/0x1960
[    5.384903]  ? srso_alias_return_thunk+0x5/0xfbef5
[    5.384903]  ? schedule+0x6d/0x270
[    5.384903]  ? srso_alias_return_thunk+0x5/0xfbef5
[    5.384903]  ? mutex_unlock+0x81/0xd0
[    5.384903]  ? __pfx_mutex_unlock+0x10/0x10
[    5.384903]  ? __pfx_tls_sw_recvmsg+0x10/0x10
[    5.384903]  ? _raw_spin_lock_irqsave+0x8f/0xf0
[    5.384903]  ? _raw_read_unlock_irqrestore+0x20/0x40
[    5.384903]  ? srso_alias_return_thunk+0x5/0xfbef5

The crash offset 296 corresponds to skb2->cb within skbuff_fclones:
  - sizeof(struct sk_buff) = 232 - offsetof(struct sk_buff, cb) = 40 -
  offset of skb2.cb in fclones = 232 + 40 = 272 - crash offset 296 =
  272 + 24 (inside sock_exterr_skb.ee)

This patch uses a local stack variable as a bounce buffer to avoid the hardened usercopy check failure.

[1] https://elixir.bootlin.com/linux/v6.12.62/source/net/ipv4/tcp.c#L885
[2] https://elixir.bootlin.com/linux/v6.12.62/source/net/core/skbuff.c#L5104
[3] https://elixir.bootlin.com/linux/v6.12.62/source/net/core/skbuff.c#L5566
[4] https://elixir.bootlin.com/linux/v6.12.62/source/net/core/skbuff.c#L5491
[5] https://elixir.bootlin.com/linux/v6.12.62/source/mm/slub.c#L5719

The Linux kernel CVE team has assigned CVE-2026-22977 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 5.10.248 with commit 88dd6be7ebb3153b662c2cebcb06e032a92857f5
	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 5.15.198 with commit c655d2167bf014d4c61b4faeca59b60ff9b9f6b1
	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 6.1.161 with commit 8c6901aa29626e35045130bac09b75f791acca85
	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 6.6.121 with commit 582a5e922a9652fcbb7d0165c95d5b20aa37575d
	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 6.12.66 with commit 005671c60fcf1dbdb8bddf12a62568fd5e4ec391
	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 6.18.6 with commit e00b169eaac5f7cdbf710c354c8fa76d02009115
	Issue introduced in 4.16 with commit 6d07d1cd300f4c7e16005f881fea388164999cc8 and fixed in 6.19-rc5 with commit 2a71a1a8d0ed718b1c7a9ac61f07e5755c47ae20

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2026-22977
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/core/sock.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/88dd6be7ebb3153b662c2cebcb06e032a92857f5
	https://git.kernel.org/stable/c/c655d2167bf014d4c61b4faeca59b60ff9b9f6b1
	https://git.kernel.org/stable/c/8c6901aa29626e35045130bac09b75f791acca85
	https://git.kernel.org/stable/c/582a5e922a9652fcbb7d0165c95d5b20aa37575d
	https://git.kernel.org/stable/c/005671c60fcf1dbdb8bddf12a62568fd5e4ec391
	https://git.kernel.org/stable/c/e00b169eaac5f7cdbf710c354c8fa76d02009115
	https://git.kernel.org/stable/c/2a71a1a8d0ed718b1c7a9ac61f07e5755c47ae20
