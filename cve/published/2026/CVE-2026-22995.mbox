From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2026-22995: ublk: fix use-after-free in ublk_partition_scan_work
Message-Id: <2026012352-CVE-2026-22995-7465@gregkh>
Content-Length: 2606
Lines: 64
X-Developer-Signature: v=1; a=openpgp-sha256; l=2671;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=Pu8UXCKnF0kp4mPjWPDvVw0Kq5pXO58nWekSd5xHtFc=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnFk44W3zm27umkBS5Hw31Dn837ntPx9gZfu9DGtiMWG
 h73AvK2dMSyMAgyMciKKbJ82cZzdH/FIUUvQ9vTMHNYmUCGMHBxCsBEJDwZ5hmuU/TbbPErz3Iy
 75yL7y9JzjpQ2cUwP/xnxAvVBSfvZ6fvnqMZ+fj40TX5nAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ublk: fix use-after-free in ublk_partition_scan_work

A race condition exists between the async partition scan work and device
teardown that can lead to a use-after-free of ub->ub_disk:

1. ublk_ctrl_start_dev() schedules partition_scan_work after add_disk()
2. ublk_stop_dev() calls ublk_stop_dev_unlocked() which does:
   - del_gendisk(ub->ub_disk)
   - ublk_detach_disk() sets ub->ub_disk = NULL
   - put_disk() which may free the disk
3. The worker ublk_partition_scan_work() then dereferences ub->ub_disk
   leading to UAF

Fix this by using ublk_get_disk()/ublk_put_disk() in the worker to hold
a reference to the disk during the partition scan. The spinlock in
ublk_get_disk() synchronizes with ublk_detach_disk() ensuring the worker
either gets a valid reference or sees NULL and exits early.

Also change flush_work() to cancel_work_sync() to avoid running the
partition scan work unnecessarily when the disk is already detached.

The Linux kernel CVE team has assigned CVE-2026-22995 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.18.4 with commit 63dfbcd59b4b823eac4441efff10b1c303c8f49f and fixed in 6.18.6 with commit 72e28774e9644c2bdbb4920842fbf77103a15a85
	Issue introduced in 6.19-rc4 with commit 7fc4da6a304bdcd3de14fc946dc2c19437a9cc5a and fixed in 6.19-rc5 with commit f0d385f6689f37a2828c686fb279121df006b4cb

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2026-22995
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/block/ublk_drv.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/72e28774e9644c2bdbb4920842fbf77103a15a85
	https://git.kernel.org/stable/c/f0d385f6689f37a2828c686fb279121df006b4cb
