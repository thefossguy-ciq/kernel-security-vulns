From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2026-23100: mm/hugetlb: fix hugetlb_pmd_shared()
Message-Id: <2026020428-CVE-2026-23100-b482@gregkh>
Content-Length: 3959
Lines: 97
X-Developer-Signature: v=1; a=openpgp-sha256; l=4057;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=/xKjSvAcVBCV6JuJE+E1SY2/6CVyCRLpgEX+BVBExps=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJnNBSn2AtsNXule8ZPeash2kHW6deTejOnXNr1ubOl9U
 2DH9te2I5aFQZCJQVZMkeXLNp6j+ysOKXoZ2p6GmcPKBDKEgYtTACaS7M4wi7nX50iMROBnuXsL
 713dqXNhUVz4V4b5kZ+cBDa+k25J0wjzldx8lm359ghOAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mm/hugetlb: fix hugetlb_pmd_shared()

Patch series "mm/hugetlb: fixes for PMD table sharing (incl.  using
mmu_gather)", v3.

One functional fix, one performance regression fix, and two related
comment fixes.

I cleaned up my prototype I recently shared [1] for the performance fix,
deferring most of the cleanups I had in the prototype to a later point. 
While doing that I identified the other things.

The goal of this patch set is to be backported to stable trees "fairly"
easily. At least patch #1 and #4.

Patch #1 fixes hugetlb_pmd_shared() not detecting any sharing
Patch #2 + #3 are simple comment fixes that patch #4 interacts with.
Patch #4 is a fix for the reported performance regression due to excessive
IPI broadcasts during fork()+exit().

The last patch is all about TLB flushes, IPIs and mmu_gather.
Read: complicated

There are plenty of cleanups in the future to be had + one reasonable
optimization on x86. But that's all out of scope for this series.

Runtime tested, with a focus on fixing the performance regression using
the original reproducer [2] on x86.


This patch (of 4):

We switched from (wrongly) using the page count to an independent shared
count.  Now, shared page tables have a refcount of 1 (excluding
speculative references) and instead use ptdesc->pt_share_count to identify
sharing.

We didn't convert hugetlb_pmd_shared(), so right now, we would never
detect a shared PMD table as such, because sharing/unsharing no longer
touches the refcount of a PMD table.

Page migration, like mbind() or migrate_pages() would allow for migrating
folios mapped into such shared PMD tables, even though the folios are not
exclusive.  In smaps we would account them as "private" although they are
"shared", and we would be wrongly setting the PM_MMAP_EXCLUSIVE in the
pagemap interface.

Fix it by properly using ptdesc_pmd_is_shared() in hugetlb_pmd_shared().

The Linux kernel CVE team has assigned CVE-2026-23100 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.13 with commit 59d9094df3d79443937add8700b2ef1a866b1081 and fixed in 6.18.8 with commit 69c4e241ff13545d410a8b2a688c932182a858bf
	Issue introduced in 6.13 with commit 59d9094df3d79443937add8700b2ef1a866b1081 and fixed in 6.19-rc7 with commit ca1a47cd3f5f4c46ca188b1c9a27af87d1ab2216
	Issue introduced in 5.10.239 with commit 94b4b41d0cdf5cfd4d4325bc0e6e9e0d0e996133
	Issue introduced in 5.15.186 with commit 8410996eb6fea116fe1483ed977aacf580eee7b4
	Issue introduced in 6.1.142 with commit 02333ac1c35370517a19a4a131332a9690c6a5c7
	Issue introduced in 6.6.72 with commit 56b274473d6e7e7375f2d0a2b4aca11d67c6b52f
	Issue introduced in 6.12.9 with commit 2e31443a0d18ae43b9d29e02bf0563f07772193d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2026-23100
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/linux/hugetlb.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/69c4e241ff13545d410a8b2a688c932182a858bf
	https://git.kernel.org/stable/c/ca1a47cd3f5f4c46ca188b1c9a27af87d1ab2216
