From bippy-5f0117140d9a Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-27437: vfio/pci: Disable auto-enable of exclusive INTx IRQ
Message-Id: <2024040551-CVE-2024-27437-cc07@gregkh>
Content-Length: 2685
Lines: 62
X-Developer-Signature: v=1; a=openpgp-sha256; l=2748;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=RQ/BESDjypLXsfoWnQMJz5sGhitFIRHe+xj6QV5nk8M=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDGn8W4NnfnB4ssBPQOPvbYa9xUuL1qn7srGFzwi6+/x7u
 98pr0sWHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjCRxBcMc0X8Jx8+Pfe4oLj3
 rnVzBVZOu8c+eynD/Bjf2gBnpr6XaSw1Db6Lf+55/4jzCAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

vfio/pci: Disable auto-enable of exclusive INTx IRQ

Currently for devices requiring masking at the irqchip for INTx, ie.
devices without DisINTx support, the IRQ is enabled in request_irq()
and subsequently disabled as necessary to align with the masked status
flag.  This presents a window where the interrupt could fire between
these events, resulting in the IRQ incrementing the disable depth twice.
This would be unrecoverable for a user since the masked flag prevents
nested enables through vfio.

Instead, invert the logic using IRQF_NO_AUTOEN such that exclusive INTx
is never auto-enabled, then unmask as required.

The Linux kernel CVE team has assigned CVE-2024-27437 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.6 with commit 89e1f7d4c66d and fixed in 6.1.84 with commit 139dfcc4d723
	Issue introduced in 3.6 with commit 89e1f7d4c66d and fixed in 6.6.24 with commit 2a4a666c4510
	Issue introduced in 3.6 with commit 89e1f7d4c66d and fixed in 6.7.12 with commit 3b3491ad0f80
	Issue introduced in 3.6 with commit 89e1f7d4c66d and fixed in 6.8.3 with commit bf0bc84a20e6
	Issue introduced in 3.6 with commit 89e1f7d4c66d and fixed in 6.9-rc1 with commit fe9a7082684e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-27437
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/vfio/pci/vfio_pci_intrs.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/139dfcc4d723ab13469881200c7d80f49d776060
	https://git.kernel.org/stable/c/2a4a666c45107206605b7b5bc20545f8aabc4fa2
	https://git.kernel.org/stable/c/3b3491ad0f80d913e7d255941d4470f4a4d9bfda
	https://git.kernel.org/stable/c/bf0bc84a20e6109ab07d5dc072067bd01eb931ec
	https://git.kernel.org/stable/c/fe9a7082684eb059b925c535682e68c34d487d43
