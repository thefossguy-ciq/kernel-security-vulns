From bippy-7c5fe7eed585 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-58096: wifi: ath11k: add srng->lock for ath11k_hal_srng_* in monitor mode
Message-Id: <2025041653-CVE-2024-58096-2320@gregkh>
Content-Length: 2912
Lines: 73
X-Developer-Signature: v=1; a=openpgp-sha256; l=2986;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=lDzdF9TUiCT8nfFhesC9uw1wErVIlRjwRny18YFWt34=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDOn/d638E/Yk7uj3Z7+TT0/nDuqX/eu1+kMhy+UAyUmd+
 sYbcmfO6YhlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJvPvKMJvNkqtZuqDWrMPd
 1PDImfepXJOZ9jMsWBp1fUkNz6FJ3N86BC5sFm59tlXzMAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

wifi: ath11k: add srng->lock for ath11k_hal_srng_* in monitor mode

ath11k_hal_srng_* should be used with srng->lock to protect srng data.

For ath11k_dp_rx_mon_dest_process() and ath11k_dp_full_mon_process_rx(),
they use ath11k_hal_srng_* for many times but never call srng->lock.

So when running (full) monitor mode, warning will occur:
RIP: 0010:ath11k_hal_srng_dst_peek+0x18/0x30 [ath11k]
Call Trace:
 ? ath11k_hal_srng_dst_peek+0x18/0x30 [ath11k]
 ath11k_dp_rx_process_mon_status+0xc45/0x1190 [ath11k]
 ? idr_alloc_u32+0x97/0xd0
 ath11k_dp_rx_process_mon_rings+0x32a/0x550 [ath11k]
 ath11k_dp_service_srng+0x289/0x5a0 [ath11k]
 ath11k_pcic_ext_grp_napi_poll+0x30/0xd0 [ath11k]
 __napi_poll+0x30/0x1f0
 net_rx_action+0x198/0x320
 __do_softirq+0xdd/0x319

So add srng->lock for them to avoid such warnings.

Inorder to fetch the srng->lock, should change srng's definition from
'void' to 'struct hal_srng'. And initialize them elsewhere to prevent
one line of code from being too long. This is consistent with other ring
process functions, such as ath11k_dp_process_rx().

Tested-on: WCN6855 hw2.0 PCI WLAN.HSP.1.1-03125-QCAHSPSWPL_V1_V2_SILICONZ_LITE-3.6510.30
Tested-on: QCN9074 hw1.0 PCI WLAN.HK.2.7.0.1-01744-QCAHKSWPL_SILICONZ-1

The Linux kernel CVE team has assigned CVE-2024-58096 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.6 with commit d5c65159f2895379e11ca13f62feabe93278985d and fixed in 6.14.2 with commit b85758e76b6452740fc2a08ced6759af64c0d59a
	Issue introduced in 5.6 with commit d5c65159f2895379e11ca13f62feabe93278985d and fixed in 6.15-rc1 with commit 63b7af49496d0e32f7a748b6af3361ec138b1bd3

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-58096
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/wireless/ath/ath11k/dp_rx.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b85758e76b6452740fc2a08ced6759af64c0d59a
	https://git.kernel.org/stable/c/63b7af49496d0e32f7a748b6af3361ec138b1bd3
