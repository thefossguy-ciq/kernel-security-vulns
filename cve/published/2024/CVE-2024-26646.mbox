From bippy-b4257b672505 Mon Sep 17 00:00:00 2001
From: Lee Jones <lee@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-26646: thermal: intel: hfi: Add syscore callbacks for system-wide PM
X-Developer-Signature: v=1; a=openpgp-sha256; l=3135; i=lee@kernel.org;
 h=from:subject; bh=oA4bc/E0m4HTaPz24rFBP1w/Mc+E/Zzm1ZHqPAZGcsE=;
 b=owEBbQKS/ZANAwAKAVGvii+H/HdhAcsmYgBmAwrQwAyQArSh4ctH2w8ioVJjV/wkEX1NPtuXF
 BlQkjz0YIOJAjMEAAEKAB0WIQR2tsk1o74gmpTwh0hRr4ovh/x3YQUCZgMK0AAKCRBRr4ovh/x3
 YZdAEACewGAwNmgcIZJqsI8oZ1N9QJuj/BSTGjniRmc8boiuKVgoO71TKFN0OSDIV2tbdrr0kmY
 7P+iqykIbSNDlqNInQ9y03zEAaOQ8k0ARzptWKbJOEYbSXAedDVrzQSBXMXa4s6sTFUi8uxvC+w
 tdOWIaWkDdORs9Wl4aX6q6XpXM6N0Ru4qI/hCCJ+MEClAPIA/WoKuF7w+hKsgNM+dLVxtjKMkpT
 kfn6r7dSo6ASHHn5pfswEsj0SvDVAS5vlYovJIE2LSVctKRNpihNDzUQPIeyqJJuaVY1pdZeqfO
 I/iDpONR0Ns1RPGXS2r8BpDcQSbNc2/mOGvG2cTCtSoy8cqFk4g1TQMxNtCY4W2jmBgLFjgqyvb
 oZevCxG9sVQPctwPmvi0LueHkqejqzPynkavCiOerjquinaiaiOltQjJG5pLyqvOh8TrvBjHCm7
 vYiE6urz4vyVN17upBH/bz6QbMgibVJllztRnBYxgSqLN23NKqPT7m/5l06hABIhHJ3KMTSPVuz
 /IHQ2e5mwhZxoXGpQE5HqZEQunDMQX2gJzF52mM7/sA3j2EHK+27t+2j5DgJhc0OSWH3+UnnHqf
 XLoN7ujQgx2KQhipUnxTSPLtPydz0ffQOkLeAzOJL52HkbcJLTbhtSZqiidjyr0skh7p8rw8d1/
 Pd9rBmzkwdR/4HA==
X-Developer-Key: i=lee@kernel.org; a=openpgp;
 fpr=76B6C935A3BE209A94F0874851AF8A2F87FC7761

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

thermal: intel: hfi: Add syscore callbacks for system-wide PM

The kernel allocates a memory buffer and provides its location to the
hardware, which uses it to update the HFI table. This allocation occurs
during boot and remains constant throughout runtime.

When resuming from hibernation, the restore kernel allocates a second
memory buffer and reprograms the HFI hardware with the new location as
part of a normal boot. The location of the second memory buffer may
differ from the one allocated by the image kernel.

When the restore kernel transfers control to the image kernel, its HFI
buffer becomes invalid, potentially leading to memory corruption if the
hardware writes to it (the hardware continues to use the buffer from the
restore kernel).

It is also possible that the hardware "forgets" the address of the memory
buffer when resuming from "deep" suspend. Memory corruption may also occur
in such a scenario.

To prevent the described memory corruption, disable HFI when preparing to
suspend or hibernate. Enable it when resuming.

Add syscore callbacks to handle the package of the boot CPU (packages of
non-boot CPUs are handled via CPU offline). Syscore ops always run on the
boot CPU. Additionally, HFI only needs to be disabled during "deep" suspend
and hibernation. Syscore ops only run in these cases.

[ rjw: Comment adjustment, subject and changelog edits ]

The Linux kernel CVE team has assigned CVE-2024-26646 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.1.76 with commit 28f010dc50df
	Fixed in 6.6.15 with commit 019ccc66d56a
	Fixed in 6.7.3 with commit c9d6d63b6c03
	Fixed in 6.8 with commit 97566d09fd02

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-26646
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/thermal/intel/intel_hfi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/28f010dc50df0f7987c04112114fcfa7e0803566
	https://git.kernel.org/stable/c/019ccc66d56a696a4dfee3bfa2f04d0a7c3d89ee
	https://git.kernel.org/stable/c/c9d6d63b6c03afaa6f185df249af693a7939577c
	https://git.kernel.org/stable/c/97566d09fd02d2ab329774bb89a2cdf2267e86d9
