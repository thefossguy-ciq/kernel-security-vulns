From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2024-49940: l2tp: prevent possible tunnel refcount underflow

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

l2tp: prevent possible tunnel refcount underflow

When a session is created, it sets a backpointer to its tunnel. When
the session refcount drops to 0, l2tp_session_free drops the tunnel
refcount if session->tunnel is non-NULL. However, session->tunnel is
set in l2tp_session_create, before the tunnel refcount is incremented
by l2tp_session_register, which leaves a small window where
session->tunnel is non-NULL when the tunnel refcount hasn't been
bumped.

Moving the assignment to l2tp_session_register is trivial but
l2tp_session_create calls l2tp_session_set_header_len which uses
session->tunnel to get the tunnel's encap. Add an encap arg to
l2tp_session_set_header_len to avoid using session->tunnel.

If l2tpv3 sessions have colliding IDs, it is possible for
l2tp_v3_session_get to race with l2tp_session_register and fetch a
session which doesn't yet have session->tunnel set. Add a check for
this case.

The Linux kernel CVE team has assigned CVE-2024-49940 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.15 with commit 3953ae7b218df4d1e544b98a393666f9ae58a78c and fixed in 6.11.3 with commit f7415e60c25a6108cd7955a20b2e66b6251ffe02
	Issue introduced in 4.15 with commit 3953ae7b218df4d1e544b98a393666f9ae58a78c and fixed in 6.12 with commit 24256415d18695b46da06c93135f5b51c548b950
	Issue introduced in 3.2.99 with commit b102bfc2a90d14f342580285782a9a51c74f7369
	Issue introduced in 3.16.54 with commit 10c15ddabbcf888922adbdd44ca3fecf6eab19d9
	Issue introduced in 4.4.225 with commit 8d1c650d452c53fcb3f02a7b1d772741639f89a4
	Issue introduced in 4.9.225 with commit 12b5fb58ac993c24210cf8cbc72d407d3a4e6490
	Issue introduced in 4.14.182 with commit aef37401b467a0b1a9517c69924a1d66937e0789

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2024-49940
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/l2tp/l2tp_core.c
	net/l2tp/l2tp_core.h
	net/l2tp/l2tp_netlink.c
	net/l2tp/l2tp_ppp.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/f7415e60c25a6108cd7955a20b2e66b6251ffe02
	https://git.kernel.org/stable/c/24256415d18695b46da06c93135f5b51c548b950
