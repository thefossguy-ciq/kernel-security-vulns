From bippy-5f407fcff5a0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2021-47653: media: davinci: vpif: fix use-after-free on driver unbind
Message-Id: <2025022649-CVE-2021-47653-2d4e@gregkh>
Content-Length: 2747
Lines: 63
X-Developer-Signature: v=1; a=openpgp-sha256; l=2811;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=xArgljv89VLnm1Qp/355lBzmK89OrhD5T5FGKAmKSS8=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDOn7SnSjb87drf9wmdRczZn3j55s2/Pupc2L93d22N9N+
 Vrft4UhoSOWhUGQiUFWTJHlyzaeo/srDil6GdqehpnDygQyhIGLUwAm8kWJYa6ofl/oDDZTzc79
 oVproueaK24WYmaY71i33DD02u/KHzXL7+kxt/M13jhfAgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

media: davinci: vpif: fix use-after-free on driver unbind

The driver allocates and registers two platform device structures during
probe, but the devices were never deregistered on driver unbind.

This results in a use-after-free on driver unbind as the device
structures were allocated using devres and would be freed by driver
core when remove() returns.

Fix this by adding the missing deregistration calls to the remove()
callback and failing probe on registration errors.

Note that the platform device structures must be freed using a proper
release callback to avoid leaking associated resources like device
names.

The Linux kernel CVE team has assigned CVE-2021-47653 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.13 with commit 479f7a1181058689435baddc16a6a42e1a8ff0e8 and fixed in 5.15.54 with commit 6512c3c39cb6b573b791ce45365818a38b76afbe
	Issue introduced in 4.13 with commit 479f7a1181058689435baddc16a6a42e1a8ff0e8 and fixed in 5.16.19 with commit b5a3bb7f6f164eb6ee74ef4898dcd019b2063448
	Issue introduced in 4.13 with commit 479f7a1181058689435baddc16a6a42e1a8ff0e8 and fixed in 5.17.2 with commit 9ffc602e14d7b9f7e7cb2f67e18dfef9ef8af676
	Issue introduced in 4.13 with commit 479f7a1181058689435baddc16a6a42e1a8ff0e8 and fixed in 5.18 with commit 43acb728bbc40169d2e2425e84a80068270974be

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2021-47653
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/media/platform/davinci/vpif.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/6512c3c39cb6b573b791ce45365818a38b76afbe
	https://git.kernel.org/stable/c/b5a3bb7f6f164eb6ee74ef4898dcd019b2063448
	https://git.kernel.org/stable/c/9ffc602e14d7b9f7e7cb2f67e18dfef9ef8af676
	https://git.kernel.org/stable/c/43acb728bbc40169d2e2425e84a80068270974be
