From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38337: jbd2: fix data-race and null-ptr-deref in jbd2_journal_dirty_metadata()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

jbd2: fix data-race and null-ptr-deref in jbd2_journal_dirty_metadata()

Since handle->h_transaction may be a NULL pointer, so we should change it
to call is_handle_aborted(handle) first before dereferencing it.

And the following data-race was reported in my fuzzer:

==================================================================
BUG: KCSAN: data-race in jbd2_journal_dirty_metadata / jbd2_journal_dirty_metadata

write to 0xffff888011024104 of 4 bytes by task 10881 on cpu 1:
 jbd2_journal_dirty_metadata+0x2a5/0x770 fs/jbd2/transaction.c:1556
 __ext4_handle_dirty_metadata+0xe7/0x4b0 fs/ext4/ext4_jbd2.c:358
 ext4_do_update_inode fs/ext4/inode.c:5220 [inline]
 ext4_mark_iloc_dirty+0x32c/0xd50 fs/ext4/inode.c:5869
 __ext4_mark_inode_dirty+0xe1/0x450 fs/ext4/inode.c:6074
 ext4_dirty_inode+0x98/0xc0 fs/ext4/inode.c:6103
....

read to 0xffff888011024104 of 4 bytes by task 10880 on cpu 0:
 jbd2_journal_dirty_metadata+0xf2/0x770 fs/jbd2/transaction.c:1512
 __ext4_handle_dirty_metadata+0xe7/0x4b0 fs/ext4/ext4_jbd2.c:358
 ext4_do_update_inode fs/ext4/inode.c:5220 [inline]
 ext4_mark_iloc_dirty+0x32c/0xd50 fs/ext4/inode.c:5869
 __ext4_mark_inode_dirty+0xe1/0x450 fs/ext4/inode.c:6074
 ext4_dirty_inode+0x98/0xc0 fs/ext4/inode.c:6103
....

value changed: 0x00000000 -> 0x00000001
==================================================================

This issue is caused by missing data-race annotation for jh->b_modified.
Therefore, the missing annotation needs to be added.

The Linux kernel CVE team has assigned CVE-2025-38337 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 5.4.295 with commit 5c1a34ff5b0bfdfd2f9343aa9b08d25df618bac5
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 5.10.239 with commit ec669e5bf409f16e464bfad75f0ba039a45de29a
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 5.15.186 with commit 43d5e3bb5f1dcd91e30238ea0b59a5f77063f84e
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 6.1.142 with commit 23361b479f2700c00960d3ae9cdc8ededa762d47
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 6.6.95 with commit 2e7c64d7a92c031d016f11c8e8cb05131ab7b75a
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 6.12.35 with commit f78b38af3540b4875147b7b884ee11a27b3dbf4c
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 6.15.4 with commit a377996d714afb8d4d5f4906336f78510039da29
	Issue introduced in 4.3 with commit 6e06ae88edae77379bef7c0cb7d3c2dd88676867 and fixed in 6.16 with commit af98b0157adf6504fade79b3e6cb260c4ff68e37

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38337
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/jbd2/transaction.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5c1a34ff5b0bfdfd2f9343aa9b08d25df618bac5
	https://git.kernel.org/stable/c/ec669e5bf409f16e464bfad75f0ba039a45de29a
	https://git.kernel.org/stable/c/43d5e3bb5f1dcd91e30238ea0b59a5f77063f84e
	https://git.kernel.org/stable/c/23361b479f2700c00960d3ae9cdc8ededa762d47
	https://git.kernel.org/stable/c/2e7c64d7a92c031d016f11c8e8cb05131ab7b75a
	https://git.kernel.org/stable/c/f78b38af3540b4875147b7b884ee11a27b3dbf4c
	https://git.kernel.org/stable/c/a377996d714afb8d4d5f4906336f78510039da29
	https://git.kernel.org/stable/c/af98b0157adf6504fade79b3e6cb260c4ff68e37
