From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38153: net: usb: aqc111: fix error handling of usbnet read calls
Message-Id: <2025070337-CVE-2025-38153-5735@gregkh>
Content-Length: 5239
Lines: 105
X-Developer-Signature: v=1; a=openpgp-sha256; l=5345;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=7QbaTMFI6kBqpgoKcosWzF1vfBJ7ba5YMAmCHrfGL4g=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlpDjf5VU5vNFT4rxxuIXRYyuzAc73TP8QOs3/dd3f/6
 8APv0uzO2JZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAi0U0M81RD7sUvL/w7d4to
 06Xf9U3pH6RrrzPMs3m3nt88Q9Mp9Fykbsfr2PCn6hIPAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: usb: aqc111: fix error handling of usbnet read calls

Syzkaller, courtesy of syzbot, identified an error (see report [1]) in
aqc111 driver, caused by incomplete sanitation of usb read calls'
results. This problem is quite similar to the one fixed in commit
920a9fa27e78 ("net: asix: add proper error handling of usb read errors").

For instance, usbnet_read_cmd() may read fewer than 'size' bytes,
even if the caller expected the full amount, and aqc111_read_cmd()
will not check its result properly. As [1] shows, this may lead
to MAC address in aqc111_bind() being only partly initialized,
triggering KMSAN warnings.

Fix the issue by verifying that the number of bytes read is
as expected and not less.

[1] Partial syzbot report:
BUG: KMSAN: uninit-value in is_valid_ether_addr include/linux/etherdevice.h:208 [inline]
BUG: KMSAN: uninit-value in usbnet_probe+0x2e57/0x4390 drivers/net/usb/usbnet.c:1830
 is_valid_ether_addr include/linux/etherdevice.h:208 [inline]
 usbnet_probe+0x2e57/0x4390 drivers/net/usb/usbnet.c:1830
 usb_probe_interface+0xd01/0x1310 drivers/usb/core/driver.c:396
 call_driver_probe drivers/base/dd.c:-1 [inline]
 really_probe+0x4d1/0xd90 drivers/base/dd.c:658
 __driver_probe_device+0x268/0x380 drivers/base/dd.c:800
...

Uninit was stored to memory at:
 dev_addr_mod+0xb0/0x550 net/core/dev_addr_lists.c:582
 __dev_addr_set include/linux/netdevice.h:4874 [inline]
 eth_hw_addr_set include/linux/etherdevice.h:325 [inline]
 aqc111_bind+0x35f/0x1150 drivers/net/usb/aqc111.c:717
 usbnet_probe+0xbe6/0x4390 drivers/net/usb/usbnet.c:1772
 usb_probe_interface+0xd01/0x1310 drivers/usb/core/driver.c:396
...

Uninit was stored to memory at:
 ether_addr_copy include/linux/etherdevice.h:305 [inline]
 aqc111_read_perm_mac drivers/net/usb/aqc111.c:663 [inline]
 aqc111_bind+0x794/0x1150 drivers/net/usb/aqc111.c:713
 usbnet_probe+0xbe6/0x4390 drivers/net/usb/usbnet.c:1772
 usb_probe_interface+0xd01/0x1310 drivers/usb/core/driver.c:396
 call_driver_probe drivers/base/dd.c:-1 [inline]
...

Local variable buf.i created at:
 aqc111_read_perm_mac drivers/net/usb/aqc111.c:656 [inline]
 aqc111_bind+0x221/0x1150 drivers/net/usb/aqc111.c:713
 usbnet_probe+0xbe6/0x4390 drivers/net/usb/usbnet.c:1772

The Linux kernel CVE team has assigned CVE-2025-38153 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 5.4.295 with commit 8c97655275482ef5384ce0501640630a0fc0f6f4
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 5.10.239 with commit 11273279012c922f37cfb4dd95d142803fc07b98
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 5.15.186 with commit f398d2dfe450ce2c031d10b585448862d74a0501
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 6.1.142 with commit acb47a40b5e38be03ef659b7bacdddc592ed73b7
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 6.6.94 with commit 60790d287c1a1ced3554d4a87c2f27bf299a932a
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 6.12.34 with commit 30a9e834c74e260533b8d0885e3c89f6f32f7993
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 6.15.3 with commit 7c01863b1c47f040d9674171e77789a423b9b128
	Issue introduced in 5.0 with commit df2d59a2ab6c9ceac2c4104272fce03493b8f62f and fixed in 6.16-rc1 with commit 405b0d610745fb5e84fc2961d9b960abb9f3d107

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38153
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/usb/aqc111.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8c97655275482ef5384ce0501640630a0fc0f6f4
	https://git.kernel.org/stable/c/11273279012c922f37cfb4dd95d142803fc07b98
	https://git.kernel.org/stable/c/f398d2dfe450ce2c031d10b585448862d74a0501
	https://git.kernel.org/stable/c/acb47a40b5e38be03ef659b7bacdddc592ed73b7
	https://git.kernel.org/stable/c/60790d287c1a1ced3554d4a87c2f27bf299a932a
	https://git.kernel.org/stable/c/30a9e834c74e260533b8d0885e3c89f6f32f7993
	https://git.kernel.org/stable/c/7c01863b1c47f040d9674171e77789a423b9b128
	https://git.kernel.org/stable/c/405b0d610745fb5e84fc2961d9b960abb9f3d107
