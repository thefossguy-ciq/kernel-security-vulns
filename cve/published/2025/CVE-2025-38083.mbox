From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38083: net_sched: prio: fix a race in prio_tune()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net_sched: prio: fix a race in prio_tune()

Gerrard Tai reported a race condition in PRIO, whenever SFQ perturb timer
fires at the wrong time.

The race is as follows:

CPU 0                                 CPU 1
[1]: lock root
[2]: qdisc_tree_flush_backlog()
[3]: unlock root
 |
 |                                    [5]: lock root
 |                                    [6]: rehash
 |                                    [7]: qdisc_tree_reduce_backlog()
 |
[4]: qdisc_put()

This can be abused to underflow a parent's qlen.

Calling qdisc_purge_queue() instead of qdisc_tree_flush_backlog()
should fix the race, because all packets will be purged from the qdisc
before releasing the lock.

The Linux kernel CVE team has assigned CVE-2025-38083 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 5.4.295 with commit 53d11560e957d53ee87a0653d258038ce12361b7
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 5.10.239 with commit 4483d8b9127591c60c4eb789d6cab953bc4522a9
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 5.15.186 with commit 20f68e6a9e41693cb0e55e5b9ebbcb40983a4b8f
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 6.1.142 with commit 3aaa7c01cf19d9b9bb64b88b65c3a6fd05da2eb4
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 6.6.94 with commit 46c15c9d0f65c9ba857d63f53264f4b17e8a715f
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 6.12.34 with commit e3f6745006dc9423d2b065b90f191cfa11b1b584
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 6.15.3 with commit 93f9eeb678d4c9c1abf720b3615fa8299a490845
	Issue introduced in 5.0 with commit 7b8e0b6e659983154c8d7e756cdb833d89a3d4d7 and fixed in 6.16 with commit d35acc1be3480505b5931f17e4ea9b7617fea4d3

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38083
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/sched/sch_prio.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/53d11560e957d53ee87a0653d258038ce12361b7
	https://git.kernel.org/stable/c/4483d8b9127591c60c4eb789d6cab953bc4522a9
	https://git.kernel.org/stable/c/20f68e6a9e41693cb0e55e5b9ebbcb40983a4b8f
	https://git.kernel.org/stable/c/3aaa7c01cf19d9b9bb64b88b65c3a6fd05da2eb4
	https://git.kernel.org/stable/c/46c15c9d0f65c9ba857d63f53264f4b17e8a715f
	https://git.kernel.org/stable/c/e3f6745006dc9423d2b065b90f191cfa11b1b584
	https://git.kernel.org/stable/c/93f9eeb678d4c9c1abf720b3615fa8299a490845
	https://git.kernel.org/stable/c/d35acc1be3480505b5931f17e4ea9b7617fea4d3
