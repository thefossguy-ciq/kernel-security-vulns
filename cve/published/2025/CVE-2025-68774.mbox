From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68774: hfsplus: fix missing hfs_bnode_get() in __hfs_bnode_create
Message-Id: <2026011358-CVE-2025-68774-f2fd@gregkh>
Content-Length: 3808
Lines: 108
X-Developer-Signature: v=1; a=openpgp-sha256; l=3917;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=Hf3Qf1H+JTkbVoY9pGx36LA+ThpNwBhia69vBaxSl4Q=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJlpKbu1aqprVh43UDI4dPDZVsG9AbLbyoJSKrbZ754n1
 hcmdPBQRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAExk3wuGBV06fXv3dfiX2wtN
 N2rS7dbM7U3UZliwtLBM7vblu8mRG1cz/XLoz7nNqr8BAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

hfsplus: fix missing hfs_bnode_get() in __hfs_bnode_create

When sync() and link() are called concurrently, both threads may
enter hfs_bnode_find() without finding the node in the hash table
and proceed to create it.

Thread A:
  hfsplus_write_inode()
    -> hfsplus_write_system_inode()
      -> hfs_btree_write()
        -> hfs_bnode_find(tree, 0)
          -> __hfs_bnode_create(tree, 0)

Thread B:
  hfsplus_create_cat()
    -> hfs_brec_insert()
      -> hfs_bnode_split()
        -> hfs_bmap_alloc()
          -> hfs_bnode_find(tree, 0)
            -> __hfs_bnode_create(tree, 0)

In this case, thread A creates the bnode, sets refcnt=1, and hashes it.
Thread B also tries to create the same bnode, notices it has already
been inserted, drops its own instance, and uses the hashed one without
getting the node.

```

	node2 = hfs_bnode_findhash(tree, cnid);
	if (!node2) {                                 <- Thread A
		hash = hfs_bnode_hash(cnid);
		node->next_hash = tree->node_hash[hash];
		tree->node_hash[hash] = node;
		tree->node_hash_cnt++;
	} else {                                      <- Thread B
		spin_unlock(&tree->hash_lock);
		kfree(node);
		wait_event(node2->lock_wq,
			!test_bit(HFS_BNODE_NEW, &node2->flags));
		return node2;
	}
```

However, hfs_bnode_find() requires each call to take a reference.
Here both threads end up setting refcnt=1. When they later put the node,
this triggers:

BUG_ON(!atomic_read(&node->refcnt))

In this scenario, Thread B in fact finds the node in the hash table
rather than creating a new one, and thus must take a reference.

Fix this by calling hfs_bnode_get() when reusing a bnode newly created by
another thread to ensure the refcount is updated correctly.

A similar bug was fixed in HFS long ago in commit
a9dc087fd3c4 ("fix missing hfs_bnode_get() in __hfs_bnode_create")
but the same issue remained in HFS+ until now.

The Linux kernel CVE team has assigned CVE-2025-68774 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.1.160 with commit b68dc4134b18a3922cd33439ec614aad4172bc86
	Fixed in 6.6.120 with commit b9d1c6bb5f19460074ce9862cb80be86b5fb0a50
	Fixed in 6.12.64 with commit 457f795e7abd7770de10216d7f9994a3f12a56d6
	Fixed in 6.18.3 with commit 5882e7c8cdbb5e254a69628b780acff89c78071e
	Fixed in 6.19-rc1 with commit 152af114287851583cf7e0abc10129941f19466a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68774
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/hfsplus/bnode.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b68dc4134b18a3922cd33439ec614aad4172bc86
	https://git.kernel.org/stable/c/b9d1c6bb5f19460074ce9862cb80be86b5fb0a50
	https://git.kernel.org/stable/c/457f795e7abd7770de10216d7f9994a3f12a56d6
	https://git.kernel.org/stable/c/5882e7c8cdbb5e254a69628b780acff89c78071e
	https://git.kernel.org/stable/c/152af114287851583cf7e0abc10129941f19466a
