From bippy-1.1.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-23151: bus: mhi: host: Fix race between unprepare and queue_buf

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

bus: mhi: host: Fix race between unprepare and queue_buf

A client driver may use mhi_unprepare_from_transfer() to quiesce
incoming data during the client driver's tear down. The client driver
might also be processing data at the same time, resulting in a call to
mhi_queue_buf() which will invoke mhi_gen_tre(). If mhi_gen_tre() runs
after mhi_unprepare_from_transfer() has torn down the channel, a panic
will occur due to an invalid dereference leading to a page fault.

This occurs because mhi_gen_tre() does not verify the channel state
after locking it. Fix this by having mhi_gen_tre() confirm the channel
state is valid, or return error to avoid accessing deinitialized data.

[mani: added stable tag]

The Linux kernel CVE team has assigned CVE-2025-23151 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1.76 with commit 0b093176fd0967a5f56e2c86b0d48247f6c0fa0f and fixed in 6.1.135 with commit 3e7ecf181cbdde9753204ada3883ca1704d8702b
	Issue introduced in 6.6.15 with commit ce16274a6b8d1483d0d8383272deb2bfd1b577ca and fixed in 6.6.88 with commit 5f084993c90d9d0b4a52a349ede5120f992a7ca1
	Issue introduced in 6.8 with commit b89b6a863dd53bc70d8e52d50f9cfaef8ef5e9c9 and fixed in 6.12.24 with commit a77955f7704b2a00385e232cbcc1cb06b5c7a425
	Issue introduced in 6.8 with commit b89b6a863dd53bc70d8e52d50f9cfaef8ef5e9c9 and fixed in 6.13.12 with commit 178e5657c8fd285125cc6743a81b513bce099760
	Issue introduced in 6.8 with commit b89b6a863dd53bc70d8e52d50f9cfaef8ef5e9c9 and fixed in 6.14.3 with commit ee1fce83ed56450087309b9b74ad9bcb2b010fa6
	Issue introduced in 6.8 with commit b89b6a863dd53bc70d8e52d50f9cfaef8ef5e9c9 and fixed in 6.15-rc1 with commit 0686a818d77a431fc3ba2fab4b46bbb04e8c9380
	Issue introduced in 5.15.149 with commit 176ed1727badd2fad2158e2b214dcbc24f4be7a1
	Issue introduced in 6.7.3 with commit 642adb03541673f3897f64bbb62856ffd73807f5

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-23151
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/bus/mhi/host/main.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3e7ecf181cbdde9753204ada3883ca1704d8702b
	https://git.kernel.org/stable/c/5f084993c90d9d0b4a52a349ede5120f992a7ca1
	https://git.kernel.org/stable/c/a77955f7704b2a00385e232cbcc1cb06b5c7a425
	https://git.kernel.org/stable/c/178e5657c8fd285125cc6743a81b513bce099760
	https://git.kernel.org/stable/c/ee1fce83ed56450087309b9b74ad9bcb2b010fa6
	https://git.kernel.org/stable/c/0686a818d77a431fc3ba2fab4b46bbb04e8c9380
