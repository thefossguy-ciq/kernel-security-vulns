From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38026: x86/sev: Do not touch VMSA pages during SNP guest memory kdump

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

x86/sev: Do not touch VMSA pages during SNP guest memory kdump

When kdump is running makedumpfile to generate vmcore and dump SNP guest
memory it touches the VMSA page of the vCPU executing kdump.

It then results in unrecoverable #NPF/RMP faults as the VMSA page is
marked busy/in-use when the vCPU is running and subsequently a causes
guest softlockup/hang.

Additionally, other APs may be halted in guest mode and their VMSA pages
are marked busy and touching these VMSA pages during guest memory dump
will also cause #NPF.

Issue AP_DESTROY GHCB calls on other APs to ensure they are kicked out
of guest mode and then clear the VMSA bit on their VMSA pages.

If the vCPU running kdump is an AP, mark it's VMSA page as offline to
ensure that makedumpfile excludes that page while dumping guest memory.

The Linux kernel CVE team has assigned CVE-2025-38026 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.13 with commit 3074152e56c9b0f9b9c67edfbc08b371db050b6d and fixed in 6.14.8 with commit 26468ea864fecf496654459e52a6b7a7230bcb6d
	Issue introduced in 6.13 with commit 3074152e56c9b0f9b9c67edfbc08b371db050b6d and fixed in 6.15 with commit d2062cc1b1c367d5d019f595ef860159e1301351

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38026
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/x86/coco/sev/core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/26468ea864fecf496654459e52a6b7a7230bcb6d
	https://git.kernel.org/stable/c/d2062cc1b1c367d5d019f595ef860159e1301351
