From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68264: ext4: refresh inline data size before write operations

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ext4: refresh inline data size before write operations

The cached ei->i_inline_size can become stale between the initial size
check and when ext4_update_inline_data()/ext4_create_inline_data() use
it. Although ext4_get_max_inline_size() reads the correct value at the
time of the check, concurrent xattr operations can modify i_inline_size
before ext4_write_lock_xattr() is acquired.

This causes ext4_update_inline_data() and ext4_create_inline_data() to
work with stale capacity values, leading to a BUG_ON() crash in
ext4_write_inline_data():

  kernel BUG at fs/ext4/inline.c:1331!
  BUG_ON(pos + len > EXT4_I(inode)->i_inline_size);

The race window:
1. ext4_get_max_inline_size() reads i_inline_size = 60 (correct)
2. Size check passes for 50-byte write
3. [Another thread adds xattr, i_inline_size changes to 40]
4. ext4_write_lock_xattr() acquires lock
5. ext4_update_inline_data() uses stale i_inline_size = 60
6. Attempts to write 50 bytes but only 40 bytes actually available
7. BUG_ON() triggers

Fix this by recalculating i_inline_size via ext4_find_inline_data_nolock()
immediately after acquiring xattr_sem. This ensures ext4_update_inline_data()
and ext4_create_inline_data() work with current values that are protected
from concurrent modifications.

This is similar to commit a54c4613dac1 ("ext4: fix race writing to an
inline_data file while its xattrs are changing") which fixed i_inline_off
staleness. This patch addresses the related i_inline_size staleness issue.

The Linux kernel CVE team has assigned CVE-2025-68264 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.8 with commit 67cf5b09a46f72e048501b84996f2f77bc42e947 and fixed in 6.1.160 with commit 89c2c41f0974e530b2d032c3695095aa0559adb1
	Issue introduced in 3.8 with commit 67cf5b09a46f72e048501b84996f2f77bc42e947 and fixed in 6.6.120 with commit 1687a055a555347b002f406676a1aaae4668f242
	Issue introduced in 3.8 with commit 67cf5b09a46f72e048501b84996f2f77bc42e947 and fixed in 6.12.62 with commit 210ac60a86a3ad2c76ae60e0dc71c34af6e7ea0b
	Issue introduced in 3.8 with commit 67cf5b09a46f72e048501b84996f2f77bc42e947 and fixed in 6.17.12 with commit ca43ea29b4c4d2764aec8a26cffcfb677a871e6e
	Issue introduced in 3.8 with commit 67cf5b09a46f72e048501b84996f2f77bc42e947 and fixed in 6.18.1 with commit 58df743faf21ceb1880f930aa5dd428e2a5e415d
	Issue introduced in 3.8 with commit 67cf5b09a46f72e048501b84996f2f77bc42e947 and fixed in 6.19-rc1 with commit 892e1cf17555735e9d021ab036c36bc7b58b0e3b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68264
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ext4/inline.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/89c2c41f0974e530b2d032c3695095aa0559adb1
	https://git.kernel.org/stable/c/1687a055a555347b002f406676a1aaae4668f242
	https://git.kernel.org/stable/c/210ac60a86a3ad2c76ae60e0dc71c34af6e7ea0b
	https://git.kernel.org/stable/c/ca43ea29b4c4d2764aec8a26cffcfb677a871e6e
	https://git.kernel.org/stable/c/58df743faf21ceb1880f930aa5dd428e2a5e415d
	https://git.kernel.org/stable/c/892e1cf17555735e9d021ab036c36bc7b58b0e3b
