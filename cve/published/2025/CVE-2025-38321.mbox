From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38321: smb: Log an error when close_all_cached_dirs fails

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

smb: Log an error when close_all_cached_dirs fails

Under low-memory conditions, close_all_cached_dirs() can't move the
dentries to a separate list to dput() them once the locks are dropped.
This will result in a "Dentry still in use" error, so add an error
message that makes it clear this is what happened:

[  495.281119] CIFS: VFS: \\otters.example.com\share Out of memory while dropping dentries
[  495.281595] ------------[ cut here ]------------
[  495.281887] BUG: Dentry ffff888115531138{i=78,n=/}  still in use (2) [unmount of cifs cifs]
[  495.282391] WARNING: CPU: 1 PID: 2329 at fs/dcache.c:1536 umount_check+0xc8/0xf0

Also, bail out of looping through all tcons as soon as a single
allocation fails, since we're already in trouble, and kmalloc() attempts
for subseqeuent tcons are likely to fail just like the first one did.

The Linux kernel CVE team has assigned CVE-2025-38321 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.6.64 with commit 73934e535cffbda1490fa97d82690a0f9aa73e94 and fixed in 6.6.95 with commit b8ced2b9a23a1a2c1e0ed8d0d02512e51bdf38da
	Issue introduced in 6.12.2 with commit 548812afd96982a76a93ba76c0582ea670c40d9e and fixed in 6.12.35 with commit 43f26094d6702e494e800532c3f1606e7a68eb30
	Issue introduced in 6.13 with commit 3fa640d035e5ae526769615c35cb9ed4be6e3662 and fixed in 6.15.4 with commit 4479db143390bdcadc1561292aab579cdfa9f6c6
	Issue introduced in 6.13 with commit 3fa640d035e5ae526769615c35cb9ed4be6e3662 and fixed in 6.16 with commit a2182743a8b4969481f64aec4908ff162e8a206c
	Issue introduced in 6.11.11 with commit ff4528bbc82d0d90073751f7b49e7b9e9c7e5638

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38321
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/smb/client/cached_dir.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b8ced2b9a23a1a2c1e0ed8d0d02512e51bdf38da
	https://git.kernel.org/stable/c/43f26094d6702e494e800532c3f1606e7a68eb30
	https://git.kernel.org/stable/c/4479db143390bdcadc1561292aab579cdfa9f6c6
	https://git.kernel.org/stable/c/a2182743a8b4969481f64aec4908ff162e8a206c
