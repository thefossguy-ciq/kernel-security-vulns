From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38448: usb: gadget: u_serial: Fix race condition in TTY wakeup

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: gadget: u_serial: Fix race condition in TTY wakeup

A race condition occurs when gs_start_io() calls either gs_start_rx() or
gs_start_tx(), as those functions briefly drop the port_lock for
usb_ep_queue(). This allows gs_close() and gserial_disconnect() to clear
port.tty and port_usb, respectively.

Use the null-safe TTY Port helper function to wake up TTY.

Example
  CPU1:			      CPU2:
  gserial_connect() // lock
  			      gs_close() // await lock
  gs_start_rx()     // unlock
  usb_ep_queue()
  			      gs_close() // lock, reset port.tty and unlock
  gs_start_rx()     // lock
  tty_wakeup()      // NPE

The Linux kernel CVE team has assigned CVE-2025-38448 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 5.4.296 with commit 18d58a467ccf011078352d91b4d6a0108c7318e8
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 5.10.240 with commit d43657b59f36e88289a6066f15bc9a80df5014eb
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 5.15.189 with commit a5012673d49788f16bb4e375b002d7743eb642d9
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 6.1.146 with commit ee8d688e2ba558f3bb8ac225113740be5f335417
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 6.6.99 with commit c6eb4a05af3d0ba3bc4e8159287722fb9abc6359
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 6.12.39 with commit abf3620cba68e0e51e5c21054ce4f925f75b3661
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 6.15.7 with commit c8c80a3a35c2e3488409de2d5376ef7e662a2bf5
	Issue introduced in 3.5 with commit 35f95fd7f234d2b58803bab6f6ebd6bb988050a2 and fixed in 6.16 with commit c529c3730bd09115684644e26bf01ecbd7e2c2c9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38448
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/gadget/function/u_serial.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/18d58a467ccf011078352d91b4d6a0108c7318e8
	https://git.kernel.org/stable/c/d43657b59f36e88289a6066f15bc9a80df5014eb
	https://git.kernel.org/stable/c/a5012673d49788f16bb4e375b002d7743eb642d9
	https://git.kernel.org/stable/c/ee8d688e2ba558f3bb8ac225113740be5f335417
	https://git.kernel.org/stable/c/c6eb4a05af3d0ba3bc4e8159287722fb9abc6359
	https://git.kernel.org/stable/c/abf3620cba68e0e51e5c21054ce4f925f75b3661
	https://git.kernel.org/stable/c/c8c80a3a35c2e3488409de2d5376ef7e662a2bf5
	https://git.kernel.org/stable/c/c529c3730bd09115684644e26bf01ecbd7e2c2c9
