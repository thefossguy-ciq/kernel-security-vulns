From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38001: net_sched: hfsc: Address reentrant enqueue adding class to eltree twice

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net_sched: hfsc: Address reentrant enqueue adding class to eltree twice

Savino says:
    "We are writing to report that this recent patch
    (141d34391abbb315d68556b7c67ad97885407547) [1]
    can be bypassed, and a UAF can still occur when HFSC is utilized with
    NETEM.

    The patch only checks the cl->cl_nactive field to determine whether
    it is the first insertion or not [2], but this field is only
    incremented by init_vf [3].

    By using HFSC_RSC (which uses init_ed) [4], it is possible to bypass the
    check and insert the class twice in the eltree.
    Under normal conditions, this would lead to an infinite loop in
    hfsc_dequeue for the reasons we already explained in this report [5].

    However, if TBF is added as root qdisc and it is configured with a
    very low rate,
    it can be utilized to prevent packets from being dequeued.
    This behavior can be exploited to perform subsequent insertions in the
    HFSC eltree and cause a UAF."

To fix both the UAF and the infinite loop, with netem as an hfsc child,
check explicitly in hfsc_enqueue whether the class is already in the eltree
whenever the HFSC_RSC flag is set.

[1] https://web.git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=141d34391abbb315d68556b7c67ad97885407547
[2] https://elixir.bootlin.com/linux/v6.15-rc5/source/net/sched/sch_hfsc.c#L1572
[3] https://elixir.bootlin.com/linux/v6.15-rc5/source/net/sched/sch_hfsc.c#L677
[4] https://elixir.bootlin.com/linux/v6.15-rc5/source/net/sched/sch_hfsc.c#L1574
[5] https://lore.kernel.org/netdev/8DuRWwfqjoRDLDmBMlIfbrsZg9Gx50DHJc1ilxsEBNe2D6NMoigR_eIRIG0LOjMc3r10nUUZtArXx4oZBIdUfZQrwjcQhdinnMis_0G7VEk=@willsroot.io/T/#u

The Linux kernel CVE team has assigned CVE-2025-38001 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 5.4.294 with commit e5bee633cc276410337d54b99f77fbc1ad8801e5
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 5.10.238 with commit 6672e6c00810056acaac019fe26cdc26fee8a66c
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 5.15.185 with commit 2c928b3a0b04a431ffcd6c8b7d88a267124a3a28
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 6.1.141 with commit a0ec22fa20b252edbe070a9de8501eef63c17ef5
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 6.6.93 with commit 295f7c579b07b5b7cf2dffe485f71cc2f27647cb
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 6.12.32 with commit 2f2190ce4ca972051cac6a8d7937448f8cb9673c
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 6.14.10 with commit 4e38eaaabfb7fffbb371a51150203e19eee5d70e
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 6.15.1 with commit 39ed887b1dd2d6b720f87e86692ac3006cc111c8
	Issue introduced in 5.0 with commit 37d9cf1a3ce35de3df6f7d209bfb1f50cf188cea and fixed in 6.16 with commit ac9fe7dd8e730a103ae4481147395cc73492d786

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38001
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/sched/sch_hfsc.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e5bee633cc276410337d54b99f77fbc1ad8801e5
	https://git.kernel.org/stable/c/6672e6c00810056acaac019fe26cdc26fee8a66c
	https://git.kernel.org/stable/c/2c928b3a0b04a431ffcd6c8b7d88a267124a3a28
	https://git.kernel.org/stable/c/a0ec22fa20b252edbe070a9de8501eef63c17ef5
	https://git.kernel.org/stable/c/295f7c579b07b5b7cf2dffe485f71cc2f27647cb
	https://git.kernel.org/stable/c/2f2190ce4ca972051cac6a8d7937448f8cb9673c
	https://git.kernel.org/stable/c/4e38eaaabfb7fffbb371a51150203e19eee5d70e
	https://git.kernel.org/stable/c/39ed887b1dd2d6b720f87e86692ac3006cc111c8
	https://git.kernel.org/stable/c/ac9fe7dd8e730a103ae4481147395cc73492d786
