From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38034: btrfs: correct the order of prelim_ref arguments in btrfs__prelim_ref
Message-Id: <2025061825-CVE-2025-38034-87a3@gregkh>
Content-Length: 4773
Lines: 107
X-Developer-Signature: v=1; a=openpgp-sha256; l=4881;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=/w9vXhqVQ1c8awlIqYHKDNnbtc4mLUujl9wAnR0r+Fo=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlB7c/m3FZ54/vNQ3fCsj3GBtOX6B+LMJsYM9/paedey
 45oIYOYjlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZjICRuGBb0Burs7fGMP79oY
 Pqs81HztLz6rOoZ5Zr+X54urFcmIi1q/KXM87XVx1oSPAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

btrfs: correct the order of prelim_ref arguments in btrfs__prelim_ref

btrfs_prelim_ref() calls the old and new reference variables in the
incorrect order. This causes a NULL pointer dereference because oldref
is passed as NULL to trace_btrfs_prelim_ref_insert().

Note, trace_btrfs_prelim_ref_insert() is being called with newref as
oldref (and oldref as NULL) on purpose in order to print out
the values of newref.

To reproduce:
echo 1 > /sys/kernel/debug/tracing/events/btrfs/btrfs_prelim_ref_insert/enable

Perform some writeback operations.

Backtrace:
BUG: kernel NULL pointer dereference, address: 0000000000000018
 #PF: supervisor read access in kernel mode
 #PF: error_code(0x0000) - not-present page
 PGD 115949067 P4D 115949067 PUD 11594a067 PMD 0
 Oops: Oops: 0000 [#1] SMP NOPTI
 CPU: 1 UID: 0 PID: 1188 Comm: fsstress Not tainted 6.15.0-rc2-tester+ #47 PREEMPT(voluntary)  7ca2cef72d5e9c600f0c7718adb6462de8149622
 Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.3-2-gc13ff2cd-prebuilt.qemu.org 04/01/2014
 RIP: 0010:trace_event_raw_event_btrfs__prelim_ref+0x72/0x130
 Code: e8 43 81 9f ff 48 85 c0 74 78 4d 85 e4 0f 84 8f 00 00 00 49 8b 94 24 c0 06 00 00 48 8b 0a 48 89 48 08 48 8b 52 08 48 89 50 10 <49> 8b 55 18 48 89 50 18 49 8b 55 20 48 89 50 20 41 0f b6 55 28 88
 RSP: 0018:ffffce44820077a0 EFLAGS: 00010286
 RAX: ffff8c6b403f9014 RBX: ffff8c6b55825730 RCX: 304994edf9cf506b
 RDX: d8b11eb7f0fdb699 RSI: ffff8c6b403f9010 RDI: ffff8c6b403f9010
 RBP: 0000000000000001 R08: 0000000000000001 R09: 0000000000000010
 R10: 00000000ffffffff R11: 0000000000000000 R12: ffff8c6b4e8fb000
 R13: 0000000000000000 R14: ffffce44820077a8 R15: ffff8c6b4abd1540
 FS:  00007f4dc6813740(0000) GS:ffff8c6c1d378000(0000) knlGS:0000000000000000
 CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
 CR2: 0000000000000018 CR3: 000000010eb42000 CR4: 0000000000750ef0
 PKRU: 55555554
 Call Trace:
  <TASK>
  prelim_ref_insert+0x1c1/0x270
  find_parent_nodes+0x12a6/0x1ee0
  ? __entry_text_end+0x101f06/0x101f09
  ? srso_alias_return_thunk+0x5/0xfbef5
  ? srso_alias_return_thunk+0x5/0xfbef5
  ? srso_alias_return_thunk+0x5/0xfbef5
  ? srso_alias_return_thunk+0x5/0xfbef5
  btrfs_is_data_extent_shared+0x167/0x640
  ? fiemap_process_hole+0xd0/0x2c0
  extent_fiemap+0xa5c/0xbc0
  ? __entry_text_end+0x101f05/0x101f09
  btrfs_fiemap+0x7e/0xd0
  do_vfs_ioctl+0x425/0x9d0
  __x64_sys_ioctl+0x75/0xc0

The Linux kernel CVE team has assigned CVE-2025-38034 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.4.294 with commit 5755b6731655e248c4f1d52a2e1b18795b4a2a3a
	Fixed in 5.10.238 with commit a641154cedf9d69730f8af5d0a901fe86e6486bd
	Fixed in 5.15.185 with commit a876703894a6dd6e8c04b0635d86e9f7a7c81b79
	Fixed in 6.1.141 with commit 0528bba48dce7820d2da72e1a114e1c4552367eb
	Fixed in 6.6.93 with commit 7a97f961a568a8f72472dc804af02a0f73152c5f
	Fixed in 6.12.31 with commit 7f7c8c03feba5f2454792fab3bb8bd45bd6883f9
	Fixed in 6.14.9 with commit 137bfa08c6441f324d00692d1e9d22cfd773329b
	Fixed in 6.15 with commit bc7e0975093567f51be8e1bdf4aa5900a3cf0b1e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38034
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/trace/events/btrfs.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5755b6731655e248c4f1d52a2e1b18795b4a2a3a
	https://git.kernel.org/stable/c/a641154cedf9d69730f8af5d0a901fe86e6486bd
	https://git.kernel.org/stable/c/a876703894a6dd6e8c04b0635d86e9f7a7c81b79
	https://git.kernel.org/stable/c/0528bba48dce7820d2da72e1a114e1c4552367eb
	https://git.kernel.org/stable/c/7a97f961a568a8f72472dc804af02a0f73152c5f
	https://git.kernel.org/stable/c/7f7c8c03feba5f2454792fab3bb8bd45bd6883f9
	https://git.kernel.org/stable/c/137bfa08c6441f324d00692d1e9d22cfd773329b
	https://git.kernel.org/stable/c/bc7e0975093567f51be8e1bdf4aa5900a3cf0b1e
