From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38257: s390/pkey: Prevent overflow in size calculation for memdup_user()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

s390/pkey: Prevent overflow in size calculation for memdup_user()

Number of apqn target list entries contained in 'nr_apqns' variable is
determined by userspace via an ioctl call so the result of the product in
calculation of size passed to memdup_user() may overflow.

In this case the actual size of the allocated area and the value
describing it won't be in sync leading to various types of unpredictable
behaviour later.

Use a proper memdup_array_user() helper which returns an error if an
overflow is detected. Note that it is different from when nr_apqns is
initially zero - that case is considered valid and should be handled in
subsequent pkey_handler implementations.

Found by Linux Verification Center (linuxtesting.org).

The Linux kernel CVE team has assigned CVE-2025-38257 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.4 with commit f2bbc96e7cfad3891b7bf9bd3e566b9b7ab4553d and fixed in 6.1.143 with commit faa1ab4a23c42e34dc000ef4977b751d94d5148c
	Issue introduced in 5.4 with commit f2bbc96e7cfad3891b7bf9bd3e566b9b7ab4553d and fixed in 6.6.96 with commit 88f3869649edbc4a13f6c2877091f81cd5a50f05
	Issue introduced in 5.4 with commit f2bbc96e7cfad3891b7bf9bd3e566b9b7ab4553d and fixed in 6.12.36 with commit f855b119e62b004a5044ed565f2a2b368c4d3f16
	Issue introduced in 5.4 with commit f2bbc96e7cfad3891b7bf9bd3e566b9b7ab4553d and fixed in 6.15.5 with commit 73483ca7e07a5e39bdf612eec9d3d293e8bef649
	Issue introduced in 5.4 with commit f2bbc96e7cfad3891b7bf9bd3e566b9b7ab4553d and fixed in 6.16-rc4 with commit 7360ee47599af91a1d5f4e74d635d9408a54e489

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38257
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/s390/crypto/pkey_api.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/faa1ab4a23c42e34dc000ef4977b751d94d5148c
	https://git.kernel.org/stable/c/88f3869649edbc4a13f6c2877091f81cd5a50f05
	https://git.kernel.org/stable/c/f855b119e62b004a5044ed565f2a2b368c4d3f16
	https://git.kernel.org/stable/c/73483ca7e07a5e39bdf612eec9d3d293e8bef649
	https://git.kernel.org/stable/c/7360ee47599af91a1d5f4e74d635d9408a54e489
