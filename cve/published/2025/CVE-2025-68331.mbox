From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68331: usb: uas: fix urb unmapping issue when the uas device is remove during ongoing data transfer

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

usb: uas: fix urb unmapping issue when the uas device is remove during ongoing data transfer

When a UAS device is unplugged during data transfer, there is
a probability of a system panic occurring. The root cause is
an access to an invalid memory address during URB callback handling.
Specifically, this happens when the dma_direct_unmap_sg() function
is called within the usb_hcd_unmap_urb_for_dma() interface, but the
sg->dma_address field is 0 and the sg data structure has already been
freed.

The SCSI driver sends transfer commands by invoking uas_queuecommand_lck()
in uas.c, using the uas_submit_urbs() function to submit requests to USB.
Within the uas_submit_urbs() implementation, three URBs (sense_urb,
data_urb, and cmd_urb) are sequentially submitted. Device removal may
occur at any point during uas_submit_urbs execution, which may result
in URB submission failure. However, some URBs might have been successfully
submitted before the failure, and uas_submit_urbs will return the -ENODEV
error code in this case. The current error handling directly calls
scsi_done(). In the SCSI driver, this eventually triggers scsi_complete()
to invoke scsi_end_request() for releasing the sgtable. The successfully
submitted URBs, when being unlinked to giveback, call
usb_hcd_unmap_urb_for_dma() in hcd.c, leading to exceptions during sg
unmapping operations since the sg data structure has already been freed.

This patch modifies the error condition check in the uas_submit_urbs()
function. When a UAS device is removed but one or more URBs have already
been successfully submitted to USB, it avoids immediately invoking
scsi_done() and save the cmnd to devinfo->cmnd array. If the successfully
submitted URBs is completed before devinfo->resetting being set, then
the scsi_done() function will be called within uas_try_complete() after
all pending URB operations are finalized. Otherwise, the scsi_done()
function will be called within uas_zap_pending(), which is executed after
usb_kill_anchored_urbs().

The error handling only takes effect when uas_queuecommand_lck() calls
uas_submit_urbs() and returns the error value -ENODEV . In this case,
the device is disconnected, and the flow proceeds to uas_disconnect(),
where uas_zap_pending() is invoked to call uas_try_complete().

The Linux kernel CVE team has assigned CVE-2025-68331 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 5.10.247 with commit 6289fc489e94c9beb6be2b502ccc263663733d72
	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 5.15.197 with commit 66ac05e7b0d6bbd1bee9fcf729e20fd4cce86d17
	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 6.1.159 with commit 75f8e2643085db4f7e136fc6b368eb114dd80a64
	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 6.6.119 with commit e3a55221f4de080cb7a91ba10f01c4f708603f8d
	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 6.12.61 with commit 2b90a8131c83f6f2be69397d2b7d14d217d95d2f
	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 6.17.11 with commit 426edbfc88b22601ea34a441a469092e7b301c52
	Issue introduced in 5.10 with commit eb2a86ae8c544be0ab04aa8169390c0669bc7148 and fixed in 6.18 with commit 26d56a9fcb2014b99e654127960aa0a48a391e3c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68331
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/usb/storage/uas.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/6289fc489e94c9beb6be2b502ccc263663733d72
	https://git.kernel.org/stable/c/66ac05e7b0d6bbd1bee9fcf729e20fd4cce86d17
	https://git.kernel.org/stable/c/75f8e2643085db4f7e136fc6b368eb114dd80a64
	https://git.kernel.org/stable/c/e3a55221f4de080cb7a91ba10f01c4f708603f8d
	https://git.kernel.org/stable/c/2b90a8131c83f6f2be69397d2b7d14d217d95d2f
	https://git.kernel.org/stable/c/426edbfc88b22601ea34a441a469092e7b301c52
	https://git.kernel.org/stable/c/26d56a9fcb2014b99e654127960aa0a48a391e3c
