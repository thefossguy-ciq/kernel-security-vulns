From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38074: vhost-scsi: protect vq->log_used with vq->mutex

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

vhost-scsi: protect vq->log_used with vq->mutex

The vhost-scsi completion path may access vq->log_base when vq->log_used is
already set to false.

    vhost-thread                       QEMU-thread

vhost_scsi_complete_cmd_work()
-> vhost_add_used()
   -> vhost_add_used_n()
      if (unlikely(vq->log_used))
                                      QEMU disables vq->log_used
                                      via VHOST_SET_VRING_ADDR.
                                      mutex_lock(&vq->mutex);
                                      vq->log_used = false now!
                                      mutex_unlock(&vq->mutex);

				      QEMU gfree(vq->log_base)
        log_used()
        -> log_write(vq->log_base)

Assuming the VMM is QEMU. The vq->log_base is from QEMU userpace and can be
reclaimed via gfree(). As a result, this causes invalid memory writes to
QEMU userspace.

The control queue path has the same issue.

The Linux kernel CVE team has assigned CVE-2025-38074 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.240 with commit 80cf68489681c165ded460930e391b1eb37b5f6f
	Fixed in 5.15.189 with commit 8312a1ccff1566f375191a89b9ba71b6eb48a8cd
	Fixed in 6.1.146 with commit 59614c5acf6688f7af3c245d359082c0e9e53117
	Fixed in 6.6.93 with commit ca85c2d0db5f8309832be45858b960d933c2131c
	Fixed in 6.12.31 with commit bd8c9404e44adb9f6219c09b3409a61ab7ce3427
	Fixed in 6.14.9 with commit c0039e3afda29be469d29b3013d7f9bdee136834
	Fixed in 6.15 with commit f591cf9fce724e5075cc67488c43c6e39e8cbe27

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38074
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/vhost/scsi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/80cf68489681c165ded460930e391b1eb37b5f6f
	https://git.kernel.org/stable/c/8312a1ccff1566f375191a89b9ba71b6eb48a8cd
	https://git.kernel.org/stable/c/59614c5acf6688f7af3c245d359082c0e9e53117
	https://git.kernel.org/stable/c/ca85c2d0db5f8309832be45858b960d933c2131c
	https://git.kernel.org/stable/c/bd8c9404e44adb9f6219c09b3409a61ab7ce3427
	https://git.kernel.org/stable/c/c0039e3afda29be469d29b3013d7f9bdee136834
	https://git.kernel.org/stable/c/f591cf9fce724e5075cc67488c43c6e39e8cbe27
