From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38074: vhost-scsi: protect vq->log_used with vq->mutex
Message-Id: <2025061839-CVE-2025-38074-dc14@gregkh>
Content-Length: 2707
Lines: 74
X-Developer-Signature: v=1; a=openpgp-sha256; l=2782;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=uJtPUfGys2YUrv+djqZaysaqeBkDiQtNzJM+jTwaWaQ=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlB7V+sLQ9POqCVetJ+UYSG3/6beX+flrwve2O7Rai86
 U6A3++ojlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZjI4ekMC85/3zlRr2a5t4KB
 oubUwv2+zGfShRnmaYn17vNVcdriJlNrYFAuY7Fl0UcFAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

vhost-scsi: protect vq->log_used with vq->mutex

The vhost-scsi completion path may access vq->log_base when vq->log_used is
already set to false.

    vhost-thread                       QEMU-thread

vhost_scsi_complete_cmd_work()
-> vhost_add_used()
   -> vhost_add_used_n()
      if (unlikely(vq->log_used))
                                      QEMU disables vq->log_used
                                      via VHOST_SET_VRING_ADDR.
                                      mutex_lock(&vq->mutex);
                                      vq->log_used = false now!
                                      mutex_unlock(&vq->mutex);

				      QEMU gfree(vq->log_base)
        log_used()
        -> log_write(vq->log_base)

Assuming the VMM is QEMU. The vq->log_base is from QEMU userpace and can be
reclaimed via gfree(). As a result, this causes invalid memory writes to
QEMU userspace.

The control queue path has the same issue.

The Linux kernel CVE team has assigned CVE-2025-38074 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.6.93 with commit ca85c2d0db5f8309832be45858b960d933c2131c
	Fixed in 6.12.31 with commit bd8c9404e44adb9f6219c09b3409a61ab7ce3427
	Fixed in 6.14.9 with commit c0039e3afda29be469d29b3013d7f9bdee136834
	Fixed in 6.15 with commit f591cf9fce724e5075cc67488c43c6e39e8cbe27

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38074
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/vhost/scsi.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ca85c2d0db5f8309832be45858b960d933c2131c
	https://git.kernel.org/stable/c/bd8c9404e44adb9f6219c09b3409a61ab7ce3427
	https://git.kernel.org/stable/c/c0039e3afda29be469d29b3013d7f9bdee136834
	https://git.kernel.org/stable/c/f591cf9fce724e5075cc67488c43c6e39e8cbe27
