From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68340: team: Move team device type change at the end of team_port_add

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

team: Move team device type change at the end of team_port_add

Attempting to add a port device that is already up will expectedly fail,
but not before modifying the team device header_ops.

In the case of the syzbot reproducer the gre0 device is
already in state UP when it attempts to add it as a
port device of team0, this fails but before that
header_ops->create of team0 is changed from eth_header to ipgre_header
in the call to team_dev_type_check_change.

Later when we end up in ipgre_header() struct ip_tunnel* points to nonsense
as the private data of the device still holds a struct team.

Example sequence of iproute2 commands to reproduce the hang/BUG():
ip link add dev team0 type team
ip link add dev gre0 type gre
ip link set dev gre0 up
ip link set dev gre0 master team0
ip link set dev team0 up
ping -I team0 1.1.1.1

Move team_dev_type_check_change down where all other checks have passed
as it changes the dev type with no way to restore it in case
one of the checks that follow it fail.

Also make sure to preserve the origial mtu assignment:
  - If port_dev is not the same type as dev, dev takes mtu from port_dev
  - If port_dev is the same type as dev, port_dev takes mtu from dev

This is done by adding a conditional before the call to dev_set_mtu
to prevent it from assigning port_dev->mtu = dev->mtu and instead
letting team_dev_type_check_change assign dev->mtu = port_dev->mtu.
The conditional is needed because the patch moves the call to
team_dev_type_check_change past dev_set_mtu.

Testing:
  - team device driver in-tree selftests
  - Add/remove various devices as slaves of team device
  - syzbot

The Linux kernel CVE team has assigned CVE-2025-68340 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.7 with commit 1d76efe1577b4323609b1bcbfafa8b731eda071a and fixed in 5.15.199 with commit c8b15b0d2eec3b5c7f585e5a53dfc8d36c818283
	Issue introduced in 3.7 with commit 1d76efe1577b4323609b1bcbfafa8b731eda071a and fixed in 6.1.162 with commit a74ab1b532ecc5f9106621a8f75b4c3d04466b35
	Issue introduced in 3.7 with commit 1d76efe1577b4323609b1bcbfafa8b731eda071a and fixed in 6.6.123 with commit e26235840fd961e4ebe5568f11a2a078cf726663
	Issue introduced in 3.7 with commit 1d76efe1577b4323609b1bcbfafa8b731eda071a and fixed in 6.12.61 with commit 4040b5e8963982a00aa821300cb746efc9f2947e
	Issue introduced in 3.7 with commit 1d76efe1577b4323609b1bcbfafa8b731eda071a and fixed in 6.17.11 with commit e3eed4f038214494af62c7d2d64749e5108ce6ca
	Issue introduced in 3.7 with commit 1d76efe1577b4323609b1bcbfafa8b731eda071a and fixed in 6.18 with commit 0ae9cfc454ea5ead5f3ddbdfe2e70270d8e2c8ef

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68340
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/team/team_core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/c8b15b0d2eec3b5c7f585e5a53dfc8d36c818283
	https://git.kernel.org/stable/c/a74ab1b532ecc5f9106621a8f75b4c3d04466b35
	https://git.kernel.org/stable/c/e26235840fd961e4ebe5568f11a2a078cf726663
	https://git.kernel.org/stable/c/4040b5e8963982a00aa821300cb746efc9f2947e
	https://git.kernel.org/stable/c/e3eed4f038214494af62c7d2d64749e5108ce6ca
	https://git.kernel.org/stable/c/0ae9cfc454ea5ead5f3ddbdfe2e70270d8e2c8ef
