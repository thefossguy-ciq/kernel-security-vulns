From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68211: ksm: use range-walk function to jump over holes in scan_get_next_rmap_item

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ksm: use range-walk function to jump over holes in scan_get_next_rmap_item

Currently, scan_get_next_rmap_item() walks every page address in a VMA to
locate mergeable pages.  This becomes highly inefficient when scanning
large virtual memory areas that contain mostly unmapped regions, causing
ksmd to use large amount of cpu without deduplicating much pages.

This patch replaces the per-address lookup with a range walk using
walk_page_range().  The range walker allows KSM to skip over entire
unmapped holes in a VMA, avoiding unnecessary lookups.  This problem was
previously discussed in [1].

Consider the following test program which creates a 32 TiB mapping in the
virtual address space but only populates a single page:

#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>

/* 32 TiB */
const size_t size = 32ul * 1024 * 1024 * 1024 * 1024;

int main() {
        char *area = mmap(NULL, size, PROT_READ | PROT_WRITE,
                          MAP_NORESERVE | MAP_PRIVATE | MAP_ANON, -1, 0);

        if (area == MAP_FAILED) {
                perror("mmap() failed\n");
                return -1;
        }

        /* Populate a single page such that we get an anon_vma. */
        *area = 0;

        /* Enable KSM. */
        madvise(area, size, MADV_MERGEABLE);
        pause();
        return 0;
}

$ ./ksm-sparse  &
$ echo 1 > /sys/kernel/mm/ksm/run 

Without this patch ksmd uses 100% of the cpu for a long time (more then 1
hour in my test machine) scanning all the 32 TiB virtual address space
that contain only one mapped page.  This makes ksmd essentially deadlocked
not able to deduplicate anything of value.  With this patch ksmd walks
only the one mapped page and skips the rest of the 32 TiB virtual address
space, making the scan fast using little cpu.

The Linux kernel CVE team has assigned CVE-2025-68211 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.32 with commit 31dbd01f314364b70c2e026a5793a29a4da8a9dc and fixed in 6.6.121 with commit 9c2f8a9b68024e5ebb4813665845ec0a95f2eac3
	Issue introduced in 2.6.32 with commit 31dbd01f314364b70c2e026a5793a29a4da8a9dc and fixed in 6.12.59 with commit 74f78421c925b6d17695566f0c5941de57fd44b3
	Issue introduced in 2.6.32 with commit 31dbd01f314364b70c2e026a5793a29a4da8a9dc and fixed in 6.17.9 with commit f62973e0767e4fcd6799087787fca08ca2a85b8c
	Issue introduced in 2.6.32 with commit 31dbd01f314364b70c2e026a5793a29a4da8a9dc and fixed in 6.18 with commit f5548c318d6520d4fa3c5ed6003eeb710763cbc5

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68211
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	mm/ksm.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9c2f8a9b68024e5ebb4813665845ec0a95f2eac3
	https://git.kernel.org/stable/c/74f78421c925b6d17695566f0c5941de57fd44b3
	https://git.kernel.org/stable/c/f62973e0767e4fcd6799087787fca08ca2a85b8c
	https://git.kernel.org/stable/c/f5548c318d6520d4fa3c5ed6003eeb710763cbc5
