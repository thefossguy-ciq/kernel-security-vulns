From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40350: net/mlx5e: RX, Fix generating skb from non-linear xdp_buff for striding RQ

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net/mlx5e: RX, Fix generating skb from non-linear xdp_buff for striding RQ

XDP programs can change the layout of an xdp_buff through
bpf_xdp_adjust_tail() and bpf_xdp_adjust_head(). Therefore, the driver
cannot assume the size of the linear data area nor fragments. Fix the
bug in mlx5 by generating skb according to xdp_buff after XDP programs
run.

Currently, when handling multi-buf XDP, the mlx5 driver assumes the
layout of an xdp_buff to be unchanged. That is, the linear data area
continues to be empty and fragments remain the same. This may cause
the driver to generate erroneous skb or triggering a kernel
warning. When an XDP program added linear data through
bpf_xdp_adjust_head(), the linear data will be ignored as
mlx5e_build_linear_skb() builds an skb without linear data and then
pull data from fragments to fill the linear data area. When an XDP
program has shrunk the non-linear data through bpf_xdp_adjust_tail(),
the delta passed to __pskb_pull_tail() may exceed the actual nonlinear
data size and trigger the BUG_ON in it.

To fix the issue, first record the original number of fragments. If the
number of fragments changes after the XDP program runs, rewind the end
fragment pointer by the difference and recalculate the truesize. Then,
build the skb with the linear data area matching the xdp_buff. Finally,
only pull data in if there is non-linear data and fill the linear part
up to 256 bytes.

The Linux kernel CVE team has assigned CVE-2025-40350 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.4 with commit f52ac7028bec22e925c8fece4f21641eb13b4d6f and fixed in 6.6.115 with commit 8b051d7f530e8a5237da242fbeafef02fec6b813
	Issue introduced in 6.4 with commit f52ac7028bec22e925c8fece4f21641eb13b4d6f and fixed in 6.12.56 with commit cb9edd583e23979ee546981be963ad5f217e8b18
	Issue introduced in 6.4 with commit f52ac7028bec22e925c8fece4f21641eb13b4d6f and fixed in 6.17.6 with commit f2557d7fa38e9475b38588f5c124476091480f53
	Issue introduced in 6.4 with commit f52ac7028bec22e925c8fece4f21641eb13b4d6f and fixed in 6.18 with commit 87bcef158ac1faca1bd7e0104588e8e2956d10be

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40350
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/mellanox/mlx5/core/en_rx.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8b051d7f530e8a5237da242fbeafef02fec6b813
	https://git.kernel.org/stable/c/cb9edd583e23979ee546981be963ad5f217e8b18
	https://git.kernel.org/stable/c/f2557d7fa38e9475b38588f5c124476091480f53
	https://git.kernel.org/stable/c/87bcef158ac1faca1bd7e0104588e8e2956d10be
