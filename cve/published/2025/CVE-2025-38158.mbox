From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38158: hisi_acc_vfio_pci: fix XQE dma address error
Message-Id: <2025070338-CVE-2025-38158-d5f0@gregkh>
Content-Length: 3090
Lines: 67
X-Developer-Signature: v=1; a=openpgp-sha256; l=3158;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=8WdMcTV7l1O/rGvNHiVx7dkxy0iPO0019FpiJggbH7E=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlpDrfqv59WXx9815nb8cPvrpw6ASaxA/Gr3vosEP3cU
 sIvt+5lRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEykv5phwZ4l3qsv1Bfdujat
 QO/KSkvughrxZQwLdvau2Sb8Jym/w3jb8UmBB7+/UxY2AAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

hisi_acc_vfio_pci: fix XQE dma address error

The dma addresses of EQE and AEQE are wrong after migration and
results in guest kernel-mode encryption services  failure.
Comparing the definition of hardware registers, we found that
there was an error when the data read from the register was
combined into an address. Therefore, the address combination
sequence needs to be corrected.

Even after fixing the above problem, we still have an issue
where the Guest from an old kernel can get migrated to
new kernel and may result in wrong data.

In order to ensure that the address is correct after migration,
if an old magic number is detected, the dma address needs to be
updated.

The Linux kernel CVE team has assigned CVE-2025-38158 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.18 with commit b0eed085903e7758532696d64397901a75bba8ba and fixed in 6.1.142 with commit 809a9c10274e1bcf6d05f1c0341459a425a4f05f
	Issue introduced in 5.18 with commit b0eed085903e7758532696d64397901a75bba8ba and fixed in 6.6.94 with commit f0423873e7aeb69cb68f4e8fa3827832e7b037ba
	Issue introduced in 5.18 with commit b0eed085903e7758532696d64397901a75bba8ba and fixed in 6.12.34 with commit 884a76e813178778d271fea59783763d32bb7e72
	Issue introduced in 5.18 with commit b0eed085903e7758532696d64397901a75bba8ba and fixed in 6.15.3 with commit 7710c883eb8cb5cf510ca47ec0e26c6cb7e94a4f
	Issue introduced in 5.18 with commit b0eed085903e7758532696d64397901a75bba8ba and fixed in 6.16-rc1 with commit 8bb7170c5a055ea17c6857c256ee73c10ff872eb

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38158
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/vfio/pci/hisilicon/hisi_acc_vfio_pci.c
	drivers/vfio/pci/hisilicon/hisi_acc_vfio_pci.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/809a9c10274e1bcf6d05f1c0341459a425a4f05f
	https://git.kernel.org/stable/c/f0423873e7aeb69cb68f4e8fa3827832e7b037ba
	https://git.kernel.org/stable/c/884a76e813178778d271fea59783763d32bb7e72
	https://git.kernel.org/stable/c/7710c883eb8cb5cf510ca47ec0e26c6cb7e94a4f
	https://git.kernel.org/stable/c/8bb7170c5a055ea17c6857c256ee73c10ff872eb
