From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38194: jffs2: check that raw node were preallocated before writing summary
Message-Id: <2025070415-CVE-2025-38194-1c50@gregkh>
Content-Length: 5290
Lines: 102
X-Developer-Signature: v=1; a=openpgp-sha256; l=5393;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=8nh4bwdaBz4sm2xje+S1FitMPMLd8waXmC/0tdMSaVU=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBnpN3kmW8WwMLxj+2K87i1/wnzOtaoi9722MZzXjE+Uk
 6zxWLS1I5aFQZCJQVZMkeXLNp6j+ysOKXoZ2p6GmcPKBDKEgYtTACYyu45hftbVcLfSebsY20Pu
 tkldWrtnLquOFcOCgwsKBEqyOj+4nsz2mK3ps0R2WYw8AA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

jffs2: check that raw node were preallocated before writing summary

Syzkaller detected a kernel bug in jffs2_link_node_ref, caused by fault
injection in jffs2_prealloc_raw_node_refs. jffs2_sum_write_sumnode doesn't
check return value of jffs2_prealloc_raw_node_refs and simply lets any
error propagate into jffs2_sum_write_data, which eventually calls
jffs2_link_node_ref in order to link the summary to an expectedly allocated
node.

kernel BUG at fs/jffs2/nodelist.c:592!
invalid opcode: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 1 PID: 31277 Comm: syz-executor.7 Not tainted 6.1.128-syzkaller-00139-ge10f83ca10a1 #0
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
RIP: 0010:jffs2_link_node_ref+0x570/0x690 fs/jffs2/nodelist.c:592
Call Trace:
 <TASK>
 jffs2_sum_write_data fs/jffs2/summary.c:841 [inline]
 jffs2_sum_write_sumnode+0xd1a/0x1da0 fs/jffs2/summary.c:874
 jffs2_do_reserve_space+0xa18/0xd60 fs/jffs2/nodemgmt.c:388
 jffs2_reserve_space+0x55f/0xaa0 fs/jffs2/nodemgmt.c:197
 jffs2_write_inode_range+0x246/0xb50 fs/jffs2/write.c:362
 jffs2_write_end+0x726/0x15d0 fs/jffs2/file.c:301
 generic_perform_write+0x314/0x5d0 mm/filemap.c:3856
 __generic_file_write_iter+0x2ae/0x4d0 mm/filemap.c:3973
 generic_file_write_iter+0xe3/0x350 mm/filemap.c:4005
 call_write_iter include/linux/fs.h:2265 [inline]
 do_iter_readv_writev+0x20f/0x3c0 fs/read_write.c:735
 do_iter_write+0x186/0x710 fs/read_write.c:861
 vfs_iter_write+0x70/0xa0 fs/read_write.c:902
 iter_file_splice_write+0x73b/0xc90 fs/splice.c:685
 do_splice_from fs/splice.c:763 [inline]
 direct_splice_actor+0x10c/0x170 fs/splice.c:950
 splice_direct_to_actor+0x337/0xa10 fs/splice.c:896
 do_splice_direct+0x1a9/0x280 fs/splice.c:1002
 do_sendfile+0xb13/0x12c0 fs/read_write.c:1255
 __do_sys_sendfile64 fs/read_write.c:1323 [inline]
 __se_sys_sendfile64 fs/read_write.c:1309 [inline]
 __x64_sys_sendfile64+0x1cf/0x210 fs/read_write.c:1309
 do_syscall_x64 arch/x86/entry/common.c:51 [inline]
 do_syscall_64+0x35/0x80 arch/x86/entry/common.c:81
 entry_SYSCALL_64_after_hwframe+0x6e/0xd8

Fix this issue by checking return value of jffs2_prealloc_raw_node_refs
before calling jffs2_sum_write_data.

Found by Linux Verification Center (linuxtesting.org) with Syzkaller.

The Linux kernel CVE team has assigned CVE-2025-38194 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 5.4.295 with commit 337f80f3d546e131c7aa90b61d8cde051ae858c7
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 5.10.239 with commit 8ce46dc5b10b0b6f67663202a4921b0e11ad7367
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 5.15.186 with commit 4adee34098a6ee86a54bf3ec885eab620c126a6b
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 6.1.142 with commit c0edcdb4fc106d69a2d1a0ce4868193511c389f3
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 6.6.95 with commit 3f46644a5131a4793fc95c32a7d0a769745b06e7
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 6.12.35 with commit da12ef7e19048dc5714032c2db587a215852b200
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 6.15.4 with commit 346cfb9d19ea7feb6fb57917b21c4797fb444dab
	Issue introduced in 2.6.18 with commit 2f785402f39b96a077b6e62bf26164bfb8e0c980 and fixed in 6.16-rc1 with commit ec9e6f22bce433b260ea226de127ec68042849b0

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38194
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/jffs2/summary.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/337f80f3d546e131c7aa90b61d8cde051ae858c7
	https://git.kernel.org/stable/c/8ce46dc5b10b0b6f67663202a4921b0e11ad7367
	https://git.kernel.org/stable/c/4adee34098a6ee86a54bf3ec885eab620c126a6b
	https://git.kernel.org/stable/c/c0edcdb4fc106d69a2d1a0ce4868193511c389f3
	https://git.kernel.org/stable/c/3f46644a5131a4793fc95c32a7d0a769745b06e7
	https://git.kernel.org/stable/c/da12ef7e19048dc5714032c2db587a215852b200
	https://git.kernel.org/stable/c/346cfb9d19ea7feb6fb57917b21c4797fb444dab
	https://git.kernel.org/stable/c/ec9e6f22bce433b260ea226de127ec68042849b0
