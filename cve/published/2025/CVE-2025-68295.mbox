From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68295: smb: client: fix memory leak in cifs_construct_tcon()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

smb: client: fix memory leak in cifs_construct_tcon()

When having a multiuser mount with domain= specified and using
cifscreds, cifs_set_cifscreds() will end up setting @ctx->domainname,
so it needs to be freed before leaving cifs_construct_tcon().

This fixes the following memory leak reported by kmemleak:

  mount.cifs //srv/share /mnt -o domain=ZELDA,multiuser,...
  su - testuser
  cifscreds add -d ZELDA -u testuser
  ...
  ls /mnt/1
  ...
  umount /mnt
  echo scan > /sys/kernel/debug/kmemleak
  cat /sys/kernel/debug/kmemleak
  unreferenced object 0xffff8881203c3f08 (size 8):
    comm "ls", pid 5060, jiffies 4307222943
    hex dump (first 8 bytes):
      5a 45 4c 44 41 00 cc cc                          ZELDA...
    backtrace (crc d109a8cf):
      __kmalloc_node_track_caller_noprof+0x572/0x710
      kstrdup+0x3a/0x70
      cifs_sb_tlink+0x1209/0x1770 [cifs]
      cifs_get_fattr+0xe1/0xf50 [cifs]
      cifs_get_inode_info+0xb5/0x240 [cifs]
      cifs_revalidate_dentry_attr+0x2d1/0x470 [cifs]
      cifs_getattr+0x28e/0x450 [cifs]
      vfs_getattr_nosec+0x126/0x180
      vfs_statx+0xf6/0x220
      do_statx+0xab/0x110
      __x64_sys_statx+0xd5/0x130
      do_syscall_64+0xbb/0x380
      entry_SYSCALL_64_after_hwframe+0x77/0x7f

The Linux kernel CVE team has assigned CVE-2025-68295 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 5.10.247 with commit ff8f9bd1c46ee02d5558293915d42e82646d5ee9
	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 5.15.197 with commit d146e96fef876492979658dce644305de35878d4
	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 6.1.159 with commit 3dd546e867e94c2f954bca45a961b6104ba708b6
	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 6.6.119 with commit f62ffdfb431bdfa4b6d24233b7fd830eca0b801e
	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 6.12.61 with commit f15288c137d960836277d0e3ecc62de68e52f00f
	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 6.17.11 with commit a67e91d5f446e455dd9201cdd6e865f7078d251d
	Issue introduced in 5.3 with commit f2aee329a68f5a907bcff11a109dfe17c0b41aeb and fixed in 6.18 with commit 3184b6a5a24ec9ee74087b2a550476f386df7dc2
	Issue introduced in 4.4.194 with commit 1456d3cea31114137fabf1110d20a2e2c6d6060f
	Issue introduced in 4.9.194 with commit 16764d7486d02b1699ae16e91d7a577602398b17
	Issue introduced in 4.14.146 with commit 904847402bd74a28164bd4d8da082d1eace7c190
	Issue introduced in 4.19.75 with commit 325fa2a6729b74b2806b31725940cb54658515e5
	Issue introduced in 5.2.17 with commit 8db988a982908b7bff76e095000adabf9c29698b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68295
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/smb/client/connect.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ff8f9bd1c46ee02d5558293915d42e82646d5ee9
	https://git.kernel.org/stable/c/d146e96fef876492979658dce644305de35878d4
	https://git.kernel.org/stable/c/3dd546e867e94c2f954bca45a961b6104ba708b6
	https://git.kernel.org/stable/c/f62ffdfb431bdfa4b6d24233b7fd830eca0b801e
	https://git.kernel.org/stable/c/f15288c137d960836277d0e3ecc62de68e52f00f
	https://git.kernel.org/stable/c/a67e91d5f446e455dd9201cdd6e865f7078d251d
	https://git.kernel.org/stable/c/3184b6a5a24ec9ee74087b2a550476f386df7dc2
