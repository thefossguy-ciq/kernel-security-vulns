From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40039: ksmbd: Fix race condition in RPC handle list access

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ksmbd: Fix race condition in RPC handle list access

The 'sess->rpc_handle_list' XArray manages RPC handles within a ksmbd
session. Access to this list is intended to be protected by
'sess->rpc_lock' (an rw_semaphore). However, the locking implementation was
flawed, leading to potential race conditions.

In ksmbd_session_rpc_open(), the code incorrectly acquired only a read lock
before calling xa_store() and xa_erase(). Since these operations modify
the XArray structure, a write lock is required to ensure exclusive access
and prevent data corruption from concurrent modifications.

Furthermore, ksmbd_session_rpc_method() accessed the list using xa_load()
without holding any lock at all. This could lead to reading inconsistent
data or a potential use-after-free if an entry is concurrently removed and
the pointer is dereferenced.

Fix these issues by:
1. Using down_write() and up_write() in ksmbd_session_rpc_open()
   to ensure exclusive access during XArray modification, and ensuring
   the lock is correctly released on error paths.
2. Adding down_read() and up_read() in ksmbd_session_rpc_method()
   to safely protect the lookup.

The Linux kernel CVE team has assigned CVE-2025-40039 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.3 with commit b685757c7b08d5073046fb379be965fd6c06aafc and fixed in 6.6.123 with commit 6b615a8fb3af0baf8126cde3d4fee97d57222ffc
	Issue introduced in 6.3 with commit b685757c7b08d5073046fb379be965fd6c06aafc and fixed in 6.12.53 with commit 5cc679ba0f4505936124cd4179ba66bb0a4bd9f3
	Issue introduced in 6.3 with commit b685757c7b08d5073046fb379be965fd6c06aafc and fixed in 6.17.3 with commit 6bd7e0e55dcea2cf0d391bbc21c2eb069b4be3e1
	Issue introduced in 6.3 with commit b685757c7b08d5073046fb379be965fd6c06aafc and fixed in 6.18 with commit 305853cce379407090a73b38c5de5ba748893aee
	Issue introduced in 5.15.145 with commit 1f485b54d04a920723984062c912174330a05178
	Issue introduced in 6.1.71 with commit 052b41ef2abe274f068e892aee81406f11bd1f3a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40039
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/smb/server/mgmt/user_session.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/69674b029002b1d90b655f014bdf64f404efa54d
	https://git.kernel.org/stable/c/6b615a8fb3af0baf8126cde3d4fee97d57222ffc
	https://git.kernel.org/stable/c/5cc679ba0f4505936124cd4179ba66bb0a4bd9f3
	https://git.kernel.org/stable/c/6bd7e0e55dcea2cf0d391bbc21c2eb069b4be3e1
	https://git.kernel.org/stable/c/305853cce379407090a73b38c5de5ba748893aee
