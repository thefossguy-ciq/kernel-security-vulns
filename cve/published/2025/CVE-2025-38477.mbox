From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38477: net/sched: sch_qfq: Fix race condition on qfq_aggregate

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net/sched: sch_qfq: Fix race condition on qfq_aggregate

A race condition can occur when 'agg' is modified in qfq_change_agg
(called during qfq_enqueue) while other threads access it
concurrently. For example, qfq_dump_class may trigger a NULL
dereference, and qfq_delete_class may cause a use-after-free.

This patch addresses the issue by:

1. Moved qfq_destroy_class into the critical section.

2. Added sch_tree_lock protection to qfq_dump_class and
qfq_dump_class_stats.

The Linux kernel CVE team has assigned CVE-2025-38477 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.8 with commit 462dbc9101acd38e92eda93c0726857517a24bbd and fixed in 6.1.147 with commit 466e10194ab81caa2ee6a332d33ba16bcceeeba6
	Issue introduced in 3.8 with commit 462dbc9101acd38e92eda93c0726857517a24bbd and fixed in 6.6.100 with commit fbe48f06e64134dfeafa89ad23387f66ebca3527
	Issue introduced in 3.8 with commit 462dbc9101acd38e92eda93c0726857517a24bbd and fixed in 6.12.40 with commit a6d735100f602c830c16d69fb6d780eebd8c9ae1
	Issue introduced in 3.8 with commit 462dbc9101acd38e92eda93c0726857517a24bbd and fixed in 6.15.8 with commit c000a3a330d97f6c073ace5aa5faf94b9adb4b79
	Issue introduced in 3.8 with commit 462dbc9101acd38e92eda93c0726857517a24bbd and fixed in 6.16 with commit 5e28d5a3f774f118896aec17a3a20a9c5c9dfc64

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38477
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/sched/sch_qfq.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/466e10194ab81caa2ee6a332d33ba16bcceeeba6
	https://git.kernel.org/stable/c/fbe48f06e64134dfeafa89ad23387f66ebca3527
	https://git.kernel.org/stable/c/a6d735100f602c830c16d69fb6d780eebd8c9ae1
	https://git.kernel.org/stable/c/c000a3a330d97f6c073ace5aa5faf94b9adb4b79
	https://git.kernel.org/stable/c/5e28d5a3f774f118896aec17a3a20a9c5c9dfc64
