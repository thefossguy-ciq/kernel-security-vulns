From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40270: mm, swap: fix potential UAF issue for VMA readahead
Message-Id: <2025120716-CVE-2025-40270-78dc@gregkh>
Content-Length: 2687
Lines: 65
X-Developer-Signature: v=1; a=openpgp-sha256; l=2753;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=Fe0ivYdjM1Qb3Pvu+Kn8o4FYE04CWLASOAchHfPzDmw=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJkmSyfY3Zl4a1P+tD7W9Uz/F6uGJLiL2kaFvZjL+Nq4p
 YLlqq5TRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEyk2Z9hfkz8NvV+aVOhYqtt
 DhrF/OLPmIPlGOYH6dyd0Z94v0XxyPkb1/d5KdrOttUHAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mm, swap: fix potential UAF issue for VMA readahead

Since commit 78524b05f1a3 ("mm, swap: avoid redundant swap device
pinning"), the common helper for allocating and preparing a folio in the
swap cache layer no longer tries to get a swap device reference
internally, because all callers of __read_swap_cache_async are already
holding a swap entry reference.  The repeated swap device pinning isn't
needed on the same swap device.

Caller of VMA readahead is also holding a reference to the target entry's
swap device, but VMA readahead walks the page table, so it might encounter
swap entries from other devices, and call __read_swap_cache_async on
another device without holding a reference to it.

So it is possible to cause a UAF when swapoff of device A raced with
swapin on device B, and VMA readahead tries to read swap entries from
device A.  It's not easy to trigger, but in theory, it could cause real
issues.

Make VMA readahead try to get the device reference first if the swap
device is a different one from the target entry.

The Linux kernel CVE team has assigned CVE-2025-40270 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.15 with commit 78524b05f1a3e16a5d00cc9c6259c41a9d6003ce and fixed in 6.17.9 with commit a4145be7b56bfa87dce56415c3ad993071462b8a
	Issue introduced in 6.15 with commit 78524b05f1a3e16a5d00cc9c6259c41a9d6003ce and fixed in 6.18 with commit 1c2a936edd71e133f2806e68324ec81a4eb07588

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40270
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	mm/swap_state.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/a4145be7b56bfa87dce56415c3ad993071462b8a
	https://git.kernel.org/stable/c/1c2a936edd71e133f2806e68324ec81a4eb07588
