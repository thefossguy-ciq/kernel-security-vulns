From bippy-7c5fe7eed585 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-21928: HID: intel-ish-hid: Fix use-after-free issue in ishtp_hid_remove()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

HID: intel-ish-hid: Fix use-after-free issue in ishtp_hid_remove()

The system can experience a random crash a few minutes after the driver is
removed. This issue occurs due to improper handling of memory freeing in
the ishtp_hid_remove() function.

The function currently frees the `driver_data` directly within the loop
that destroys the HID devices, which can lead to accessing freed memory.
Specifically, `hid_destroy_device()` uses `driver_data` when it calls
`hid_ishtp_set_feature()` to power off the sensor, so freeing
`driver_data` beforehand can result in accessing invalid memory.

This patch resolves the issue by storing the `driver_data` in a temporary
variable before calling `hid_destroy_device()`, and then freeing the
`driver_data` after the device is destroyed.

The Linux kernel CVE team has assigned CVE-2025-21928 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 5.4.291 with commit 0c1fb475ef999d6c22fc3f963fdf20cb3ed1b03d
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 5.10.235 with commit d3faae7f42181865c799d88c5054176f38ae4625
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 5.15.179 with commit 01b18a330cda61cc21423a7d1af92cf31ded8f60
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 6.1.131 with commit cf1a6015d2f6b1f0afaa0fd6a0124ff2c7943394
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 6.6.83 with commit 560f4d1299342504a6ab8a47f575b5e6b8345ada
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 6.12.19 with commit dea6a349bcaf243fff95dfd0428a26be6a0fb44e
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 6.13.7 with commit eb0695d87a81e7c1f0509b7d8ee7c65fbc26aec9
	Issue introduced in 4.9 with commit 0b28cb4bcb17dcb5fe0763fc3e1a94398b8f6cf6 and fixed in 6.14 with commit 07583a0010696a17fb0942e0b499a62785c5fc9f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-21928
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/hid/intel-ish-hid/ishtp-hid.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/0c1fb475ef999d6c22fc3f963fdf20cb3ed1b03d
	https://git.kernel.org/stable/c/d3faae7f42181865c799d88c5054176f38ae4625
	https://git.kernel.org/stable/c/01b18a330cda61cc21423a7d1af92cf31ded8f60
	https://git.kernel.org/stable/c/cf1a6015d2f6b1f0afaa0fd6a0124ff2c7943394
	https://git.kernel.org/stable/c/560f4d1299342504a6ab8a47f575b5e6b8345ada
	https://git.kernel.org/stable/c/dea6a349bcaf243fff95dfd0428a26be6a0fb44e
	https://git.kernel.org/stable/c/eb0695d87a81e7c1f0509b7d8ee7c65fbc26aec9
	https://git.kernel.org/stable/c/07583a0010696a17fb0942e0b499a62785c5fc9f
