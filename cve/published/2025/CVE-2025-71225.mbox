From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-71225: md: suspend array while updating raid_disks via sysfs

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

md: suspend array while updating raid_disks via sysfs

In raid1_reshape(), freeze_array() is called before modifying the r1bio
memory pool (conf->r1bio_pool) and conf->raid_disks, and
unfreeze_array() is called after the update is completed.

However, freeze_array() only waits until nr_sync_pending and
(nr_pending - nr_queued) of all buckets reaches zero. When an I/O error
occurs, nr_queued is increased and the corresponding r1bio is queued to
either retry_list or bio_end_io_list. As a result, freeze_array() may
unblock before these r1bios are released.

This can lead to a situation where conf->raid_disks and the mempool have
already been updated while queued r1bios, allocated with the old
raid_disks value, are later released. Consequently, free_r1bio() may
access memory out of bounds in put_all_bios() and release r1bios of the
wrong size to the new mempool, potentially causing issues with the
mempool as well.

Since only normal I/O might increase nr_queued while an I/O error occurs,
suspending the array avoids this issue.

Note: Updating raid_disks via ioctl SET_ARRAY_INFO already suspends
the array. Therefore, we suspend the array when updating raid_disks
via sysfs to avoid this issue too.

The Linux kernel CVE team has assigned CVE-2025-71225 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.10 with commit e2d59925221cd562e07fee38ec8839f7209ae603 and fixed in 6.12.70 with commit 165d1359f945b72c5f90088f60d48ff46115269e
	Issue introduced in 3.10 with commit e2d59925221cd562e07fee38ec8839f7209ae603 and fixed in 6.18.10 with commit 0107b18cd8ac17eb3e54786adc05a85cdbb6ef22
	Issue introduced in 3.10 with commit e2d59925221cd562e07fee38ec8839f7209ae603 and fixed in 6.19 with commit 2cc583653bbe050bacd1cadcc9776d39bf449740
	Issue introduced in 3.4.59 with commit 1b9203bb4c658c0242afa6fdb025c71d2fc3ad76
	Issue introduced in 3.9.7 with commit 8ccf6cfb157419847f3cb2bfdfbcdbd39860e8e9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-71225
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/md/md.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/165d1359f945b72c5f90088f60d48ff46115269e
	https://git.kernel.org/stable/c/0107b18cd8ac17eb3e54786adc05a85cdbb6ef22
	https://git.kernel.org/stable/c/2cc583653bbe050bacd1cadcc9776d39bf449740
