From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68745: scsi: qla2xxx: Clear cmds after chip reset

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: qla2xxx: Clear cmds after chip reset

Commit aefed3e5548f ("scsi: qla2xxx: target: Fix offline port handling
and host reset handling") caused two problems:

1. Commands sent to FW, after chip reset got stuck and never freed as FW
   is not going to respond to them anymore.

2. BUG_ON(cmd->sg_mapped) in qlt_free_cmd().  Commit 26f9ce53817a
   ("scsi: qla2xxx: Fix missed DMA unmap for aborted commands")
   attempted to fix this, but introduced another bug under different
   circumstances when two different CPUs were racing to call
   qlt_unmap_sg() at the same time: BUG_ON(!valid_dma_direction(dir)) in
   dma_unmap_sg_attrs().

So revert "scsi: qla2xxx: Fix missed DMA unmap for aborted commands" and
partially revert "scsi: qla2xxx: target: Fix offline port handling and
host reset handling" at __qla2x00_abort_all_cmds.

The Linux kernel CVE team has assigned CVE-2025-68745 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.2 with commit aefed3e5548f28e5fecafda6604fcbc65484dbaa and fixed in 6.18.2 with commit 5c1fb3fd05da3d55b8cbc42d7d660b313cbdc936
	Issue introduced in 5.2 with commit aefed3e5548f28e5fecafda6604fcbc65484dbaa and fixed in 6.19 with commit d46c69a087aa3d1513f7a78f871b80251ea0c1ae
	Issue introduced in 4.9.316 with commit eb67b7a23d357f578578e737cb6412ae2384f352
	Issue introduced in 4.14.281 with commit ec9639d92c1e10d4bc667e842753d85e21683d5c
	Issue introduced in 4.19.245 with commit e6e957f552d5b696879a31e5b0e2a9120e1ea86e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68745
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/qla2xxx/qla_os.c
	drivers/scsi/qla2xxx/qla_target.c
	drivers/scsi/qla2xxx/qla_target.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5c1fb3fd05da3d55b8cbc42d7d660b313cbdc936
	https://git.kernel.org/stable/c/d46c69a087aa3d1513f7a78f871b80251ea0c1ae
