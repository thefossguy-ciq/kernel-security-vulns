From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-39845: x86/mm/64: define ARCH_PAGE_TABLE_SYNC_MASK and arch_sync_kernel_mappings()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

x86/mm/64: define ARCH_PAGE_TABLE_SYNC_MASK and arch_sync_kernel_mappings()

Define ARCH_PAGE_TABLE_SYNC_MASK and arch_sync_kernel_mappings() to ensure
page tables are properly synchronized when calling p*d_populate_kernel().

For 5-level paging, synchronization is performed via
pgd_populate_kernel().  In 4-level paging, pgd_populate() is a no-op, so
synchronization is instead performed at the P4D level via
p4d_populate_kernel().

This fixes intermittent boot failures on systems using 4-level paging and
a large amount of persistent memory:

  BUG: unable to handle page fault for address: ffffe70000000034
  #PF: supervisor write access in kernel mode
  #PF: error_code(0x0002) - not-present page
  PGD 0 P4D 0
  Oops: 0002 [#1] SMP NOPTI
  RIP: 0010:__init_single_page+0x9/0x6d
  Call Trace:
   <TASK>
   __init_zone_device_page+0x17/0x5d
   memmap_init_zone_device+0x154/0x1bb
   pagemap_range+0x2e0/0x40f
   memremap_pages+0x10b/0x2f0
   devm_memremap_pages+0x1e/0x60
   dev_dax_probe+0xce/0x2ec [device_dax]
   dax_bus_probe+0x6d/0xc9
   [... snip ...]
   </TASK>

It also fixes a crash in vmemmap_set_pmd() caused by accessing vmemmap
before sync_global_pgds() [1]:

  BUG: unable to handle page fault for address: ffffeb3ff1200000
  #PF: supervisor write access in kernel mode
  #PF: error_code(0x0002) - not-present page
  PGD 0 P4D 0
  Oops: Oops: 0002 [#1] PREEMPT SMP NOPTI
  Tainted: [W]=WARN
  RIP: 0010:vmemmap_set_pmd+0xff/0x230
   <TASK>
   vmemmap_populate_hugepages+0x176/0x180
   vmemmap_populate+0x34/0x80
   __populate_section_memmap+0x41/0x90
   sparse_add_section+0x121/0x3e0
   __add_pages+0xba/0x150
   add_pages+0x1d/0x70
   memremap_pages+0x3dc/0x810
   devm_memremap_pages+0x1c/0x60
   xe_devm_add+0x8b/0x100 [xe]
   xe_tile_init_noalloc+0x6a/0x70 [xe]
   xe_device_probe+0x48c/0x740 [xe]
   [... snip ...]

The Linux kernel CVE team has assigned CVE-2025-39845 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.13 with commit 8d400913c231bd1da74067255816453f96cd35b0 and fixed in 5.15.192 with commit 744ff519c72de31344a627eaf9b24e9595aae554
	Issue introduced in 5.13 with commit 8d400913c231bd1da74067255816453f96cd35b0 and fixed in 6.1.151 with commit 5f761d40ee95d2624f839c90ebeef2d5c55007f5
	Issue introduced in 5.13 with commit 8d400913c231bd1da74067255816453f96cd35b0 and fixed in 6.6.105 with commit 26ff568f390a531d1bd792e49f1a401849921960
	Issue introduced in 5.13 with commit 8d400913c231bd1da74067255816453f96cd35b0 and fixed in 6.12.46 with commit b7f4051dd3388edd30e9a6077c05c486aa31e0d4
	Issue introduced in 5.13 with commit 8d400913c231bd1da74067255816453f96cd35b0 and fixed in 6.16.6 with commit 6bf9473727569e8283c1e2445c7ac42cf4fc9fa9
	Issue introduced in 5.13 with commit 8d400913c231bd1da74067255816453f96cd35b0 and fixed in 6.17-rc5 with commit 6659d027998083fbb6d42a165b0c90dc2e8ba989

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-39845
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/x86/include/asm/pgtable_64_types.h
	arch/x86/mm/init_64.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/744ff519c72de31344a627eaf9b24e9595aae554
	https://git.kernel.org/stable/c/5f761d40ee95d2624f839c90ebeef2d5c55007f5
	https://git.kernel.org/stable/c/26ff568f390a531d1bd792e49f1a401849921960
	https://git.kernel.org/stable/c/b7f4051dd3388edd30e9a6077c05c486aa31e0d4
	https://git.kernel.org/stable/c/6bf9473727569e8283c1e2445c7ac42cf4fc9fa9
	https://git.kernel.org/stable/c/6659d027998083fbb6d42a165b0c90dc2e8ba989
