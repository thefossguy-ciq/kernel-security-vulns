From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-22021: netfilter: socket: Lookup orig tuple for IPv6 SNAT

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

netfilter: socket: Lookup orig tuple for IPv6 SNAT

nf_sk_lookup_slow_v4 does the conntrack lookup for IPv4 packets to
restore the original 5-tuple in case of SNAT, to be able to find the
right socket (if any). Then socket_match() can correctly check whether
the socket was transparent.

However, the IPv6 counterpart (nf_sk_lookup_slow_v6) lacks this
conntrack lookup, making xt_socket fail to match on the socket when the
packet was SNATed. Add the same logic to nf_sk_lookup_slow_v6.

IPv6 SNAT is used in Kubernetes clusters for pod-to-world packets, as
pods' addresses are in the fd00::/8 ULA subnet and need to be replaced
with the node's external address. Cilium leverages Envoy to enforce L7
policies, and Envoy uses transparent sockets. Cilium inserts an iptables
prerouting rule that matches on `-m socket --transparent` and redirects
the packets to localhost, but it fails to match SNATed IPv6 packets due
to that missing conntrack lookup.

The Linux kernel CVE team has assigned CVE-2025-22021 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 5.4.292 with commit 6488b96a79a26e19100ad872622f04e93b638d7f
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 5.10.236 with commit 58ab63d3ded2ca6141357a2b24eee8453d0f871d
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 5.15.180 with commit 1ca2169cc19dca893c7aae6af122852097435d16
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 6.1.133 with commit 1ec43100f7123010730b7ddfc3d5c2eac19e70e7
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 6.6.86 with commit 5251041573850e5020cd447374e23010be698898
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 6.12.22 with commit 2bb139e483f8cbe488d19d8c1135ac3615e2668c
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 6.13.10 with commit 41904cbb343d115931d6bf79aa2c815cac4ef72b
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 6.14.1 with commit 221c27259324ec1404f028d4f5a0f2ae7f63ee23
	Issue introduced in 3.13 with commit eb31628e37a0a4e01fffd79dcc7f815d2357f53a and fixed in 6.15 with commit 932b32ffd7604fb00b5c57e239a3cc4d901ccf6e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-22021
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/ipv6/netfilter/nf_socket_ipv6.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/6488b96a79a26e19100ad872622f04e93b638d7f
	https://git.kernel.org/stable/c/58ab63d3ded2ca6141357a2b24eee8453d0f871d
	https://git.kernel.org/stable/c/1ca2169cc19dca893c7aae6af122852097435d16
	https://git.kernel.org/stable/c/1ec43100f7123010730b7ddfc3d5c2eac19e70e7
	https://git.kernel.org/stable/c/5251041573850e5020cd447374e23010be698898
	https://git.kernel.org/stable/c/2bb139e483f8cbe488d19d8c1135ac3615e2668c
	https://git.kernel.org/stable/c/41904cbb343d115931d6bf79aa2c815cac4ef72b
	https://git.kernel.org/stable/c/221c27259324ec1404f028d4f5a0f2ae7f63ee23
	https://git.kernel.org/stable/c/932b32ffd7604fb00b5c57e239a3cc4d901ccf6e
