From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-39784: PCI: Fix link speed calculation on retrain failure
Message-Id: <2025091150-CVE-2025-39784-7851@gregkh>
Content-Length: 2751
Lines: 67
X-Developer-Signature: v=1; a=openpgp-sha256; l=2819;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=642bARQiBPieFnFUM6ryWfJHJrxHCl33i4xDSy3n84M=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBmH/ge1TN8VwCvz0PRQ74G/78xjV51KDRZgOH1WS6HgT
 2h0QldnRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEzEbDHDTMZMxYf76vmFzWI/
 Z07a8nXizHusfgzzS9u0Dsc3KJ5/yJu5wchGSXlW7hMOAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

PCI: Fix link speed calculation on retrain failure

When pcie_failed_link_retrain() fails to retrain, it tries to revert to the
previous link speed.  However it calculates that speed from the Link
Control 2 register without masking out non-speed bits first.

PCIE_LNKCTL2_TLS2SPEED() converts such incorrect values to
PCI_SPEED_UNKNOWN (0xff), which in turn causes a WARN splat in
pcie_set_target_speed():

  pci 0000:00:01.1: [1022:14ed] type 01 class 0x060400 PCIe Root Port
  pci 0000:00:01.1: broken device, retraining non-functional downstream link at 2.5GT/s
  pci 0000:00:01.1: retraining failed
  WARNING: CPU: 1 PID: 1 at drivers/pci/pcie/bwctrl.c:168 pcie_set_target_speed
  RDX: 0000000000000001 RSI: 00000000000000ff RDI: ffff9acd82efa000
  pcie_failed_link_retrain
  pci_device_add
  pci_scan_single_device

Mask out the non-speed bits in PCIE_LNKCTL2_TLS2SPEED() and
PCIE_LNKCAP_SLS2SPEED() so they don't incorrectly return PCI_SPEED_UNKNOWN.

[bhelgaas: commit log, add details from https://lore.kernel.org/r/1c92ef6bcb314ee6977839b46b393282e4f52e74.1750684771.git.lukas@wunner.de]

The Linux kernel CVE team has assigned CVE-2025-39784 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.13 with commit de9a6c8d5dbfedb5eb3722c822da0490f6a59a45 and fixed in 6.16.4 with commit 16557320f378262b5c605b15edebd3642406992a
	Issue introduced in 6.13 with commit de9a6c8d5dbfedb5eb3722c822da0490f6a59a45 and fixed in 6.17-rc1 with commit 9989e0ca7462c62f93dbc62f684448aa2efb9226

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-39784
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/pci/pci.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/16557320f378262b5c605b15edebd3642406992a
	https://git.kernel.org/stable/c/9989e0ca7462c62f93dbc62f684448aa2efb9226
