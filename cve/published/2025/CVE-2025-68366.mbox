From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68366: nbd: defer config unlock in nbd_genl_connect

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nbd: defer config unlock in nbd_genl_connect

There is one use-after-free warning when running NBD_CMD_CONNECT and
NBD_CLEAR_SOCK:

nbd_genl_connect
  nbd_alloc_and_init_config // config_refs=1
  nbd_start_device // config_refs=2
  set NBD_RT_HAS_CONFIG_REF			open nbd // config_refs=3
  recv_work done // config_refs=2
						NBD_CLEAR_SOCK // config_refs=1
						close nbd // config_refs=0
  refcount_inc -> uaf

------------[ cut here ]------------
refcount_t: addition on 0; use-after-free.
WARNING: CPU: 24 PID: 1014 at lib/refcount.c:25 refcount_warn_saturate+0x12e/0x290
 nbd_genl_connect+0x16d0/0x1ab0
 genl_family_rcv_msg_doit+0x1f3/0x310
 genl_rcv_msg+0x44a/0x790

The issue can be easily reproduced by adding a small delay before
refcount_inc(&nbd->config_refs) in nbd_genl_connect():

        mutex_unlock(&nbd->config_lock);
        if (!ret) {
                set_bit(NBD_RT_HAS_CONFIG_REF, &config->runtime_flags);
+               printk("before sleep\n");
+               mdelay(5 * 1000);
+               printk("after sleep\n");
                refcount_inc(&nbd->config_refs);
                nbd_connect_reply(info, nbd->index);
        }

The Linux kernel CVE team has assigned CVE-2025-68366 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 5.10.248 with commit 330d688a5ca53857828081a3cf31b92ad1b0b3ed
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 5.15.198 with commit cd93db1b1b4460e6ee77564024ea461e5940f69c
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 6.1.160 with commit ae3e7bc1f4b393ae20e5c85583eb2c6977374716
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 6.6.120 with commit 2e5e0665a594f076ef2b9439447bae8be293d09d
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 6.12.63 with commit c9b99c948b4fb014812afe7b5ccf2db121d22e46
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 6.17.13 with commit 9a38306643874566d20f7aba7dff9e6f657b51a9
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 6.18.2 with commit c9e805f6a35d1dd189a9345595a5c20e87611942
	Issue introduced in 4.12 with commit e46c7287b1c27683a8e30ca825fb98e2b97f1099 and fixed in 6.19 with commit 1649714b930f9ea6233ce0810ba885999da3b5d4

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68366
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/block/nbd.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/330d688a5ca53857828081a3cf31b92ad1b0b3ed
	https://git.kernel.org/stable/c/cd93db1b1b4460e6ee77564024ea461e5940f69c
	https://git.kernel.org/stable/c/ae3e7bc1f4b393ae20e5c85583eb2c6977374716
	https://git.kernel.org/stable/c/2e5e0665a594f076ef2b9439447bae8be293d09d
	https://git.kernel.org/stable/c/c9b99c948b4fb014812afe7b5ccf2db121d22e46
	https://git.kernel.org/stable/c/9a38306643874566d20f7aba7dff9e6f657b51a9
	https://git.kernel.org/stable/c/c9e805f6a35d1dd189a9345595a5c20e87611942
	https://git.kernel.org/stable/c/1649714b930f9ea6233ce0810ba885999da3b5d4
