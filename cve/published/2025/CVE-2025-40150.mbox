From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40150: f2fs: fix to avoid migrating empty section
Message-Id: <2025111257-CVE-2025-40150-0f36@gregkh>
Content-Length: 3048
Lines: 78
X-Developer-Signature: v=1; a=openpgp-sha256; l=3127;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=aFcQ0SD0oEGabtJaLh8B50u90piwkpz5prwsU9OQy4c=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJkiCbYcKRxh2l+7NQWKo9V2fbf26phV4iZ88elvz8uHP
 q96tc2sI5aFQZCJQVZMkeXLNp6j+ysOKXoZ2p6GmcPKBDKEgYtTACYSGswwv7giQHKmffElgfiP
 +j4ve666FB7tYphnGf7A+o9/68f/X5R8tq7ZoBX6724mAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

f2fs: fix to avoid migrating empty section

It reports a bug from device w/ zufs:

F2FS-fs (dm-64): Inconsistent segment (173822) type [1, 0] in SSA and SIT
F2FS-fs (dm-64): Stopped filesystem due to reason: 4

Thread A				Thread B
- f2fs_expand_inode_data
 - f2fs_allocate_pinning_section
  - f2fs_gc_range
   - do_garbage_collect w/ segno #x
					- writepage
					 - f2fs_allocate_data_block
					  - new_curseg
					   - allocate segno #x

The root cause is: fallocate on pinning file may race w/ block allocation
as above, result in do_garbage_collect() from fallocate() may migrate
segment which is just allocated by a log, the log will update segment type
in its in-memory structure, however GC will get segment type from on-disk
SSA block, once segment type changes by log, we can detect such
inconsistency, then shutdown filesystem.

In this case, on-disk SSA shows type of segno #173822 is 1 (SUM_TYPE_NODE),
however segno #173822 was just allocated as data type segment, so in-memory
SIT shows type of segno #173822 is 0 (SUM_TYPE_DATA).

Change as below to fix this issue:
- check whether current section is empty before gc
- add sanity checks on do_garbage_collect() to avoid any race case, result
in migrating segment used by log.
- btw, it fixes misc issue in printed logs: "SSA and SIT" -> "SIT and SSA".

The Linux kernel CVE team has assigned CVE-2025-40150 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.9 with commit 9703d69d9d153bb230711d0d577454552aeb13d4 and fixed in 6.17.3 with commit eec1589be36fcf7440755703e4faeee2c01e360b
	Issue introduced in 6.9 with commit 9703d69d9d153bb230711d0d577454552aeb13d4 and fixed in 6.18-rc1 with commit d625a2b08c089397d3a03bff13fa8645e4ec7a01
	Issue introduced in 6.6.33 with commit 40d76c393cca83938b11eb7ca8983aa3cd0ed69b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40150
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/f2fs/gc.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/eec1589be36fcf7440755703e4faeee2c01e360b
	https://git.kernel.org/stable/c/d625a2b08c089397d3a03bff13fa8645e4ec7a01
