From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-39927: ceph: fix race condition validating r_parent before applying state
Message-Id: <2025100125-CVE-2025-39927-5a57@gregkh>
Content-Length: 3120
Lines: 75
X-Developer-Signature: v=1; a=openpgp-sha256; l=3196;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=/hJOpXMkKTH7AB/dJEXsz+xMv4sbvcQP1X0yh8IzXd4=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBl3Htoui3p2NTm1d40f71Ob+jt70q4f0dn5IX1arXAvL
 7OKiV58RywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAExk1yKG+bEbzNbJuCi22idM
 0l/7wOT5xqnr5zHM4fv23bXmY1DqE/EPyzZYPdVcz7rJGgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ceph: fix race condition validating r_parent before applying state

Add validation to ensure the cached parent directory inode matches the
directory info in MDS replies. This prevents client-side race conditions
where concurrent operations (e.g. rename) cause r_parent to become stale
between request initiation and reply processing, which could lead to
applying state changes to incorrect directory inodes.

[ idryomov: folded a kerneldoc fixup and a follow-up fix from Alex to
  move CEPH_CAP_PIN reference when r_parent is updated:

  When the parent directory lock is not held, req->r_parent can become
  stale and is updated to point to the correct inode.  However, the
  associated CEPH_CAP_PIN reference was not being adjusted.  The
  CEPH_CAP_PIN is a reference on an inode that is tracked for
  accounting purposes.  Moving this pin is important to keep the
  accounting balanced. When the pin was not moved from the old parent
  to the new one, it created two problems: The reference on the old,
  stale parent was never released, causing a reference leak.
  A reference for the new parent was never acquired, creating the risk
  of a reference underflow later in ceph_mdsc_release_request().  This
  patch corrects the logic by releasing the pin from the old parent and
  acquiring it for the new parent when r_parent is switched.  This
  ensures reference accounting stays balanced. ]

The Linux kernel CVE team has assigned CVE-2025-39927 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.12.48 with commit db378e6f83ec705c6091c65d482d555edc2b0a72
	Fixed in 6.16.8 with commit 2bfe45987eb346e299d9f763f9cd05f77011519f
	Fixed in 6.17 with commit 15f519e9f883b316d86e2bb6b767a023aafd9d83

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-39927
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ceph/debugfs.c
	fs/ceph/dir.c
	fs/ceph/file.c
	fs/ceph/inode.c
	fs/ceph/mds_client.c
	fs/ceph/mds_client.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/db378e6f83ec705c6091c65d482d555edc2b0a72
	https://git.kernel.org/stable/c/2bfe45987eb346e299d9f763f9cd05f77011519f
	https://git.kernel.org/stable/c/15f519e9f883b316d86e2bb6b767a023aafd9d83
