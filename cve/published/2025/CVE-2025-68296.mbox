From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68296: drm, fbcon, vga_switcheroo: Avoid race condition in fbcon setup
Message-Id: <2025121641-CVE-2025-68296-c946@gregkh>
Content-Length: 3266
Lines: 73
X-Developer-Signature: v=1; a=openpgp-sha256; l=3340;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=rRLLnVQ3MQelnZ8Tt7PNSWmivmFzi+0FUrUqNgaU+V8=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJmOpY2xX/N8gyZ2SNVpPhfrmXDoj3uW76E8l0WJ+w4rr
 t1+u35bRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEwk/yrDbBZ161OvlzbXehZx
 PfjBzdN/ztDwOcNc6V6X5HkrA/473C9XmyDLLd+auLAVAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

drm, fbcon, vga_switcheroo: Avoid race condition in fbcon setup

Protect vga_switcheroo_client_fb_set() with console lock. Avoids OOB
access in fbcon_remap_all(). Without holding the console lock the call
races with switching outputs.

VGA switcheroo calls fbcon_remap_all() when switching clients. The fbcon
function uses struct fb_info.node, which is set by register_framebuffer().
As the fb-helper code currently sets up VGA switcheroo before registering
the framebuffer, the value of node is -1 and therefore not a legal value.
For example, fbcon uses the value within set_con2fb_map() [1] as an index
into an array.

Moving vga_switcheroo_client_fb_set() after register_framebuffer() can
result in VGA switching that does not switch fbcon correctly.

Therefore move vga_switcheroo_client_fb_set() under fbcon_fb_registered(),
which already holds the console lock. Fbdev calls fbcon_fb_registered()
from within register_framebuffer(). Serializes the helper with VGA
switcheroo's call to fbcon_remap_all().

Although vga_switcheroo_client_fb_set() takes an instance of struct fb_info
as parameter, it really only needs the contained fbcon state. Moving the
call to fbcon initialization is therefore cleaner than before. Only amdgpu,
i915, nouveau and radeon support vga_switcheroo. For all other drivers,
this change does nothing.

The Linux kernel CVE team has assigned CVE-2025-68296 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.34 with commit 6a9ee8af344e3bd7dbd61e67037096cdf7f83289 and fixed in 6.12.61 with commit 482330f8261b4bea8146d9bd69c1199e5dfcbb5c
	Issue introduced in 2.6.34 with commit 6a9ee8af344e3bd7dbd61e67037096cdf7f83289 and fixed in 6.17.11 with commit 05814c389b53d2f3a0b9eeb90ba7a05ba77c4c2a
	Issue introduced in 2.6.34 with commit 6a9ee8af344e3bd7dbd61e67037096cdf7f83289 and fixed in 6.18 with commit eb76d0f5553575599561010f24c277cc5b31d003

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68296
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/gpu/drm/drm_fb_helper.c
	drivers/video/fbdev/core/fbcon.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/482330f8261b4bea8146d9bd69c1199e5dfcbb5c
	https://git.kernel.org/stable/c/05814c389b53d2f3a0b9eeb90ba7a05ba77c4c2a
	https://git.kernel.org/stable/c/eb76d0f5553575599561010f24c277cc5b31d003
