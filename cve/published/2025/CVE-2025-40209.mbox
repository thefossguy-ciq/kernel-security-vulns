From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40209: btrfs: fix memory leak of qgroup_list in btrfs_add_qgroup_relation

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

btrfs: fix memory leak of qgroup_list in btrfs_add_qgroup_relation

When btrfs_add_qgroup_relation() is called with invalid qgroup levels
(src >= dst), the function returns -EINVAL directly without freeing the
preallocated qgroup_list structure passed by the caller. This causes a
memory leak because the caller unconditionally sets the pointer to NULL
after the call, preventing any cleanup.

The issue occurs because the level validation check happens before the
mutex is acquired and before any error handling path that would free
the prealloc pointer. On this early return, the cleanup code at the
'out' label (which includes kfree(prealloc)) is never reached.

In btrfs_ioctl_qgroup_assign(), the code pattern is:

    prealloc = kzalloc(sizeof(*prealloc), GFP_KERNEL);
    ret = btrfs_add_qgroup_relation(trans, sa->src, sa->dst, prealloc);
    prealloc = NULL;  // Always set to NULL regardless of return value
    ...
    kfree(prealloc);  // This becomes kfree(NULL), does nothing

When the level check fails, 'prealloc' is never freed by either the
callee or the caller, resulting in a 64-byte memory leak per failed
operation. This can be triggered repeatedly by an unprivileged user
with access to a writable btrfs mount, potentially exhausting kernel
memory.

Fix this by freeing prealloc before the early return, ensuring prealloc
is always freed on all error paths.

The Linux kernel CVE team has assigned CVE-2025-40209 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.11 with commit 4addc1ffd67ad34394674dc91379dc04cfdd2537 and fixed in 6.12.58 with commit 3412d0e973e8f8381747d69033eda809a57a2581
	Issue introduced in 6.11 with commit 4addc1ffd67ad34394674dc91379dc04cfdd2537 and fixed in 6.17.8 with commit a4d9ebe23bcb79d9d057e3c995db73b7b3aae414
	Issue introduced in 6.11 with commit 4addc1ffd67ad34394674dc91379dc04cfdd2537 and fixed in 6.18 with commit f260c6aff0b8af236084012d14f9f1bf792ea883

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40209
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/btrfs/qgroup.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3412d0e973e8f8381747d69033eda809a57a2581
	https://git.kernel.org/stable/c/a4d9ebe23bcb79d9d057e3c995db73b7b3aae414
	https://git.kernel.org/stable/c/f260c6aff0b8af236084012d14f9f1bf792ea883
