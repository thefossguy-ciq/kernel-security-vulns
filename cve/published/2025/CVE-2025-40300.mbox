From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40300: x86/vmscape: Add conditional IBPB mitigation
Message-Id: <2025091128-CVE-2025-40300-5569@gregkh>
Content-Length: 4167
Lines: 91
X-Developer-Signature: v=1; a=openpgp-sha256; l=4259;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=r9AsRx6v6x2gPR7wLM5ZGiMpX/jziUpVXvUIfAAsSAQ=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBmH/s74UuSVYCzItL5fYtsddyG1snXCqrOE716eJR/xa
 qNlyZH6jlgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZhITS/DPJMj6vGnWXpCP1rc
 2LYl4c4jDvHIgwzzc+xyXvz81ul1Wynwn7zsjx397eYiAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

x86/vmscape: Add conditional IBPB mitigation

VMSCAPE is a vulnerability that exploits insufficient branch predictor
isolation between a guest and a userspace hypervisor (like QEMU). Existing
mitigations already protect kernel/KVM from a malicious guest. Userspace
can additionally be protected by flushing the branch predictors after a
VMexit.

Since it is the userspace that consumes the poisoned branch predictors,
conditionally issue an IBPB after a VMexit and before returning to
userspace. Workloads that frequently switch between hypervisor and
userspace will incur the most overhead from the new IBPB.

This new IBPB is not integrated with the existing IBPB sites. For
instance, a task can use the existing speculation control prctl() to
get an IBPB at context switch time. With this implementation, the
IBPB is doubled up: one at context switch and another before running
userspace.

The intent is to integrate and optimize these cases post-embargo.

[ dhansen: elaborate on suboptimal IBPB solution ]

The Linux kernel CVE team has assigned CVE-2025-40300 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.10.244 with commit ac60717f9a8d21c58617d0b34274babf24135835
	Fixed in 5.10.244 with commit c08192b5d6730a914dee6175bc71092ee6a65f14
	Fixed in 5.15.193 with commit d5490dfa35427a2967e00a4c7a1b95fdbc8ede34
	Fixed in 5.15.193 with commit 2f4f2f8f860cb4c3336a7435ebe8dcfded0c9c6e
	Fixed in 6.1.152 with commit 15006289e5c38b2a830e1fba221977a27598176c
	Fixed in 6.1.152 with commit 893387c18612bb452336a5881da0d015a7e8f4a2
	Fixed in 6.6.106 with commit f866eef8d1c65504d30923c3f14082ad294d0e6d
	Fixed in 6.6.106 with commit 34e5667041050711a947e260fc9ebebe08bddee5
	Fixed in 6.12.47 with commit d7ddc93392e4a7ffcccc86edf6ef3e64c778db52
	Fixed in 6.12.47 with commit 459274c77b37ac63b78c928b4b4e748d1f9d05c8
	Fixed in 6.16.7 with commit 510603f504796c3535f67f55fb0b124a303b44c8
	Fixed in 6.16.7 with commit 9c23a90648e831d611152ac08dbcd1283d405e7f

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40300
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/x86/include/asm/cpufeatures.h
	arch/x86/include/asm/entry-common.h
	arch/x86/include/asm/nospec-branch.h
	arch/x86/kernel/cpu/bugs.c
	arch/x86/kvm/x86.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ac60717f9a8d21c58617d0b34274babf24135835
	https://git.kernel.org/stable/c/c08192b5d6730a914dee6175bc71092ee6a65f14
	https://git.kernel.org/stable/c/d5490dfa35427a2967e00a4c7a1b95fdbc8ede34
	https://git.kernel.org/stable/c/2f4f2f8f860cb4c3336a7435ebe8dcfded0c9c6e
	https://git.kernel.org/stable/c/15006289e5c38b2a830e1fba221977a27598176c
	https://git.kernel.org/stable/c/893387c18612bb452336a5881da0d015a7e8f4a2
	https://git.kernel.org/stable/c/f866eef8d1c65504d30923c3f14082ad294d0e6d
	https://git.kernel.org/stable/c/34e5667041050711a947e260fc9ebebe08bddee5
	https://git.kernel.org/stable/c/d7ddc93392e4a7ffcccc86edf6ef3e64c778db52
	https://git.kernel.org/stable/c/459274c77b37ac63b78c928b4b4e748d1f9d05c8
	https://git.kernel.org/stable/c/510603f504796c3535f67f55fb0b124a303b44c8
	https://git.kernel.org/stable/c/9c23a90648e831d611152ac08dbcd1283d405e7f
	https://git.kernel.org/stable/c/2f8f173413f1cbf52660d04df92d0069c4306d25
