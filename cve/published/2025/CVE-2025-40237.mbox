From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40237: fs/notify: call exportfs_encode_fid with s_umount

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

fs/notify: call exportfs_encode_fid with s_umount

Calling intotify_show_fdinfo() on fd watching an overlayfs inode, while
the overlayfs is being unmounted, can lead to dereferencing NULL ptr.

This issue was found by syzkaller.

Race Condition Diagram:

Thread 1                           Thread 2
--------                           --------

generic_shutdown_super()
 shrink_dcache_for_umount
  sb->s_root = NULL

                    |
                    |             vfs_read()
                    |              inotify_fdinfo()
                    |               * inode get from mark *
                    |               show_mark_fhandle(m, inode)
                    |                exportfs_encode_fid(inode, ..)
                    |                 ovl_encode_fh(inode, ..)
                    |                  ovl_check_encode_origin(inode)
                    |                   * deref i_sb->s_root *
                    |
                    |
                    v
 fsnotify_sb_delete(sb)

Which then leads to:

[   32.133461] Oops: general protection fault, probably for non-canonical address 0xdffffc0000000006: 0000 [#1] SMP DEBUG_PAGEALLOC KASAN NOPTI
[   32.134438] KASAN: null-ptr-deref in range [0x0000000000000030-0x0000000000000037]
[   32.135032] CPU: 1 UID: 0 PID: 4468 Comm: systemd-coredum Not tainted 6.17.0-rc6 #22 PREEMPT(none)

<snip registers, unreliable trace>

[   32.143353] Call Trace:
[   32.143732]  ovl_encode_fh+0xd5/0x170
[   32.144031]  exportfs_encode_inode_fh+0x12f/0x300
[   32.144425]  show_mark_fhandle+0xbe/0x1f0
[   32.145805]  inotify_fdinfo+0x226/0x2d0
[   32.146442]  inotify_show_fdinfo+0x1c5/0x350
[   32.147168]  seq_show+0x530/0x6f0
[   32.147449]  seq_read_iter+0x503/0x12a0
[   32.148419]  seq_read+0x31f/0x410
[   32.150714]  vfs_read+0x1f0/0x9e0
[   32.152297]  ksys_read+0x125/0x240

IOW ovl_check_encode_origin derefs inode->i_sb->s_root, after it was set
to NULL in the unmount path.

Fix it by protecting calling exportfs_encode_fid() from
show_mark_fhandle() with s_umount lock.

This form of fix was suggested by Amir in [1].

[1]: https://lore.kernel.org/all/CAOQ4uxhbDwhb+2Brs1UdkoF0a3NSdBAOQPNfEHjahrgoKJpLEw@mail.gmail.com/

The Linux kernel CVE team has assigned CVE-2025-40237 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.6.72 with commit a1a541fbfa7e97c1100144db34b57553d7164ce5 and fixed in 6.6.73 with commit 950b604384fd75d62e860bec7135b2b62eb4d508
	Issue introduced in 6.6.74 with commit f0c0ac84de17c37e6e84da65fb920f91dada55ad and fixed in 6.6.115 with commit bc1c6b803e14ea2b8f7e33b7164013f666ceb656
	Issue introduced in 6.12.10 with commit 3c7c90274ae339e1ad443c9be1c67a20b80b9c76 and fixed in 6.12.56 with commit 3f307a9f7a7a2822e38ac451b73e2244e7279496
	Issue introduced in 6.13 with commit c45beebfde34aa71afbc48b2c54cdda623515037 and fixed in 6.17.6 with commit d1894bc542becb0fda61e7e513b09523cab44030
	Issue introduced in 6.13 with commit c45beebfde34aa71afbc48b2c54cdda623515037 and fixed in 6.18 with commit a7c4bb43bfdc2b9f06ee9d036028ed13a83df42a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40237
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/notify/fdinfo.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/950b604384fd75d62e860bec7135b2b62eb4d508
	https://git.kernel.org/stable/c/bc1c6b803e14ea2b8f7e33b7164013f666ceb656
	https://git.kernel.org/stable/c/3f307a9f7a7a2822e38ac451b73e2244e7279496
	https://git.kernel.org/stable/c/d1894bc542becb0fda61e7e513b09523cab44030
	https://git.kernel.org/stable/c/a7c4bb43bfdc2b9f06ee9d036028ed13a83df42a
