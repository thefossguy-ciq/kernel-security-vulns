From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-39870: dmaengine: idxd: Fix double free in idxd_setup_wqs()
Message-Id: <2025092359-CVE-2025-39870-2af3@gregkh>
Content-Length: 3172
Lines: 67
X-Developer-Signature: v=1; a=openpgp-sha256; l=3240;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=YnKiwzuroqVSat2/5wUZ/xbmWZ8/lYYGZfYOeLXnLCo=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBmXzGfvcmx8trTrGUcj4639MXl/BV9s3ejca/qrPd1ul
 /2pPVctO2JZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAi2hsZ5nCaflv/ZI9hz9r9
 jbPk10xL+fRi7kGG+b7bzXrKHpQ0hZr5lfkovDxhInrqNgA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

dmaengine: idxd: Fix double free in idxd_setup_wqs()

The clean up in idxd_setup_wqs() has had a couple bugs because the error
handling is a bit subtle.  It's simpler to just re-write it in a cleaner
way.  The issues here are:

1) If "idxd->max_wqs" is <= 0 then we call put_device(conf_dev) when
   "conf_dev" hasn't been initialized.
2) If kzalloc_node() fails then again "conf_dev" is invalid.  It's
   either uninitialized or it points to the "conf_dev" from the
   previous iteration so it leads to a double free.

It's better to free partial loop iterations within the loop and then
the unwinding at the end can handle whole loop iterations.  I also
renamed the labels to describe what the goto does and not where the goto
was located.

The Linux kernel CVE team has assigned CVE-2025-39870 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1.140 with commit d584acdf54f409cb7eae1359ae6c12aaabedeed8 and fixed in 6.1.153 with commit 25e6146c2812487a88f619d5ff6efbdcd5b2bc31
	Issue introduced in 6.6.92 with commit 47846211998a9ffb0fcc08092eb95ac783d2b11a and fixed in 6.6.107 with commit df82c7901513fd0fc738052a8e6a330d92cc8ec9
	Issue introduced in 6.12.30 with commit 5fcd392dae6d6aba7dc64ffdbb838ff191315da3 and fixed in 6.12.48 with commit ec5430d090d0b6ace8fefa290fc37e88930017d2
	Issue introduced in 6.15 with commit 3fd2f4bc010cdfbc07dd21018dc65bd9370eb7a4 and fixed in 6.16.8 with commit 9f0e225635475b2285b966271d5e82cba74295b1
	Issue introduced in 6.15 with commit 3fd2f4bc010cdfbc07dd21018dc65bd9370eb7a4 and fixed in 6.17-rc6 with commit 39aaa337449e71a41d4813be0226a722827ba606
	Issue introduced in 6.14.8 with commit ed2c66000aa64c0d2621864831f0d04c820a1441

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-39870
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/dma/idxd/init.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/25e6146c2812487a88f619d5ff6efbdcd5b2bc31
	https://git.kernel.org/stable/c/df82c7901513fd0fc738052a8e6a330d92cc8ec9
	https://git.kernel.org/stable/c/ec5430d090d0b6ace8fefa290fc37e88930017d2
	https://git.kernel.org/stable/c/9f0e225635475b2285b966271d5e82cba74295b1
	https://git.kernel.org/stable/c/39aaa337449e71a41d4813be0226a722827ba606
