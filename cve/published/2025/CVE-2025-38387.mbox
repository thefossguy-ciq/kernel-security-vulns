From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38387: RDMA/mlx5: Initialize obj_event->obj_sub_list before xa_insert
Message-Id: <2025072507-CVE-2025-38387-f9d4@gregkh>
Content-Length: 6622
Lines: 115
X-Developer-Signature: v=1; a=openpgp-sha256; l=6738;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=WmbmNUCBJQKKoT97aH3xVwV02eAyQ7egjv4GFVbONS8=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBnNdavP+G5WLTrXGx86/f8JrqjLfjOPP7wU+HDGydvrd
 K681W3i6ohlYRBkYpAVU2T5so3n6P6KQ4pehranYeawMoEMYeDiFICJtDxgWLAxt9W7/ng5a+J+
 y8CFjVwfZhw4rM4wv+hR0y1TAdsZ3yNfJOWd2tAz0dIwEwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

RDMA/mlx5: Initialize obj_event->obj_sub_list before xa_insert

The obj_event may be loaded immediately after inserted, then if the
list_head is not initialized then we may get a poisonous pointer.  This
fixes the crash below:

 mlx5_core 0000:03:00.0: MLX5E: StrdRq(1) RqSz(8) StrdSz(2048) RxCqeCmprss(0 enhanced)
 mlx5_core.sf mlx5_core.sf.4: firmware version: 32.38.3056
 mlx5_core 0000:03:00.0 en3f0pf0sf2002: renamed from eth0
 mlx5_core.sf mlx5_core.sf.4: Rate limit: 127 rates are supported, range: 0Mbps to 195312Mbps
 IPv6: ADDRCONF(NETDEV_CHANGE): en3f0pf0sf2002: link becomes ready
 Unable to handle kernel NULL pointer dereference at virtual address 0000000000000060
 Mem abort info:
   ESR = 0x96000006
   EC = 0x25: DABT (current EL), IL = 32 bits
   SET = 0, FnV = 0
   EA = 0, S1PTW = 0
 Data abort info:
   ISV = 0, ISS = 0x00000006
   CM = 0, WnR = 0
 user pgtable: 4k pages, 48-bit VAs, pgdp=00000007760fb000
 [0000000000000060] pgd=000000076f6d7003, p4d=000000076f6d7003, pud=0000000777841003, pmd=0000000000000000
 Internal error: Oops: 96000006 [#1] SMP
 Modules linked in: ipmb_host(OE) act_mirred(E) cls_flower(E) sch_ingress(E) mptcp_diag(E) udp_diag(E) raw_diag(E) unix_diag(E) tcp_diag(E) inet_diag(E) binfmt_misc(E) bonding(OE) rdma_ucm(OE) rdma_cm(OE) iw_cm(OE) ib_ipoib(OE) ib_cm(OE) isofs(E) cdrom(E) mst_pciconf(OE) ib_umad(OE) mlx5_ib(OE) ipmb_dev_int(OE) mlx5_core(OE) kpatch_15237886(OEK) mlxdevm(OE) auxiliary(OE) ib_uverbs(OE) ib_core(OE) psample(E) mlxfw(OE) tls(E) sunrpc(E) vfat(E) fat(E) crct10dif_ce(E) ghash_ce(E) sha1_ce(E) sbsa_gwdt(E) virtio_console(E) ext4(E) mbcache(E) jbd2(E) xfs(E) libcrc32c(E) mmc_block(E) virtio_net(E) net_failover(E) failover(E) sha2_ce(E) sha256_arm64(E) nvme(OE) nvme_core(OE) gpio_mlxbf3(OE) mlx_compat(OE) mlxbf_pmc(OE) i2c_mlxbf(OE) sdhci_of_dwcmshc(OE) pinctrl_mlxbf3(OE) mlxbf_pka(OE) gpio_generic(E) i2c_core(E) mmc_core(E) mlxbf_gige(OE) vitesse(E) pwr_mlxbf(OE) mlxbf_tmfifo(OE) micrel(E) mlxbf_bootctl(OE) virtio_ring(E) virtio(E) ipmi_devintf(E) ipmi_msghandler(E)
  [last unloaded: mst_pci]
 CPU: 11 PID: 20913 Comm: rte-worker-11 Kdump: loaded Tainted: G           OE K   5.10.134-13.1.an8.aarch64 #1
 Hardware name: https://www.mellanox.com BlueField-3 SmartNIC Main Card/BlueField-3 SmartNIC Main Card, BIOS 4.2.2.12968 Oct 26 2023
 pstate: a0400089 (NzCv daIf +PAN -UAO -TCO BTYPE=--)
 pc : dispatch_event_fd+0x68/0x300 [mlx5_ib]
 lr : devx_event_notifier+0xcc/0x228 [mlx5_ib]
 sp : ffff80001005bcf0
 x29: ffff80001005bcf0 x28: 0000000000000001
 x27: ffff244e0740a1d8 x26: ffff244e0740a1d0
 x25: ffffda56beff5ae0 x24: ffffda56bf911618
 x23: ffff244e0596a480 x22: ffff244e0596a480
 x21: ffff244d8312ad90 x20: ffff244e0596a480
 x19: fffffffffffffff0 x18: 0000000000000000
 x17: 0000000000000000 x16: ffffda56be66d620
 x15: 0000000000000000 x14: 0000000000000000
 x13: 0000000000000000 x12: 0000000000000000
 x11: 0000000000000040 x10: ffffda56bfcafb50
 x9 : ffffda5655c25f2c x8 : 0000000000000010
 x7 : 0000000000000000 x6 : ffff24545a2e24b8
 x5 : 0000000000000003 x4 : ffff80001005bd28
 x3 : 0000000000000000 x2 : 0000000000000000
 x1 : ffff244e0596a480 x0 : ffff244d8312ad90
 Call trace:
  dispatch_event_fd+0x68/0x300 [mlx5_ib]
  devx_event_notifier+0xcc/0x228 [mlx5_ib]
  atomic_notifier_call_chain+0x58/0x80
  mlx5_eq_async_int+0x148/0x2b0 [mlx5_core]
  atomic_notifier_call_chain+0x58/0x80
  irq_int_handler+0x20/0x30 [mlx5_core]
  __handle_irq_event_percpu+0x60/0x220
  handle_irq_event_percpu+0x3c/0x90
  handle_irq_event+0x58/0x158
  handle_fasteoi_irq+0xfc/0x188
  generic_handle_irq+0x34/0x48
  ...

The Linux kernel CVE team has assigned CVE-2025-38387 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 5.4.296 with commit 716b555fc0580c2aa4c2c32ae4401c7e3ad9873e
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 5.10.240 with commit 972e968aac0dce8fe8faad54f6106de576695d8e
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 5.15.187 with commit 00ed215f593876385451423924fe0358c556179c
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 6.1.144 with commit 9a28377a96fb299c180dd9cf0be3b0a038a52d4e
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 6.6.97 with commit 23a3b32a274a8d6f33480d0eff436eb100981651
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 6.12.37 with commit 93fccfa71c66a4003b3d2fef3a38de7307e14a4e
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 6.15.6 with commit e8069711139249994450c214cec152b917b959e0
	Issue introduced in 5.3 with commit 7597385371425febdaa8c6a1da3625d4ffff16f5 and fixed in 6.16-rc5 with commit 8edab8a72d67742f87e9dc2e2b0cdfddda5dc29a

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38387
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/infiniband/hw/mlx5/devx.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/716b555fc0580c2aa4c2c32ae4401c7e3ad9873e
	https://git.kernel.org/stable/c/972e968aac0dce8fe8faad54f6106de576695d8e
	https://git.kernel.org/stable/c/00ed215f593876385451423924fe0358c556179c
	https://git.kernel.org/stable/c/9a28377a96fb299c180dd9cf0be3b0a038a52d4e
	https://git.kernel.org/stable/c/23a3b32a274a8d6f33480d0eff436eb100981651
	https://git.kernel.org/stable/c/93fccfa71c66a4003b3d2fef3a38de7307e14a4e
	https://git.kernel.org/stable/c/e8069711139249994450c214cec152b917b959e0
	https://git.kernel.org/stable/c/8edab8a72d67742f87e9dc2e2b0cdfddda5dc29a
