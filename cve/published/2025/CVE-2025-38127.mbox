From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38127: ice: fix Tx scheduler error handling in XDP callback
Message-Id: <2025070329-CVE-2025-38127-686d@gregkh>
Content-Length: 4148
Lines: 93
X-Developer-Signature: v=1; a=openpgp-sha256; l=4242;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=W4fQ2tGcFwpLCjnr7FVuN8qjErNmJtxBmyd8j7/zPFI=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlpDhcfrnDoEyy78e6i1pYp504mumzmXjfpgKZiR15V8
 qw/Lh6aHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjARtRiGWUwCU+u5F75O2B62
 r07y64XeB1Ot3jAsmBj5ZEtI0J0AH4/0lVv9vhb2bHPfDAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ice: fix Tx scheduler error handling in XDP callback

When the XDP program is loaded, the XDP callback adds new Tx queues.
This means that the callback must update the Tx scheduler with the new
queue number. In the event of a Tx scheduler failure, the XDP callback
should also fail and roll back any changes previously made for XDP
preparation.

The previous implementation had a bug that not all changes made by the
XDP callback were rolled back. This caused the crash with the following
call trace:

[  +9.549584] ice 0000:ca:00.0: Failed VSI LAN queue config for XDP, error: -5
[  +0.382335] Oops: general protection fault, probably for non-canonical address 0x50a2250a90495525: 0000 [#1] SMP NOPTI
[  +0.010710] CPU: 103 UID: 0 PID: 0 Comm: swapper/103 Not tainted 6.14.0-net-next-mar-31+ #14 PREEMPT(voluntary)
[  +0.010175] Hardware name: Intel Corporation M50CYP2SBSTD/M50CYP2SBSTD, BIOS SE5C620.86B.01.01.0005.2202160810 02/16/2022
[  +0.010946] RIP: 0010:__ice_update_sample+0x39/0xe0 [ice]

[...]

[  +0.002715] Call Trace:
[  +0.002452]  <IRQ>
[  +0.002021]  ? __die_body.cold+0x19/0x29
[  +0.003922]  ? die_addr+0x3c/0x60
[  +0.003319]  ? exc_general_protection+0x17c/0x400
[  +0.004707]  ? asm_exc_general_protection+0x26/0x30
[  +0.004879]  ? __ice_update_sample+0x39/0xe0 [ice]
[  +0.004835]  ice_napi_poll+0x665/0x680 [ice]
[  +0.004320]  __napi_poll+0x28/0x190
[  +0.003500]  net_rx_action+0x198/0x360
[  +0.003752]  ? update_rq_clock+0x39/0x220
[  +0.004013]  handle_softirqs+0xf1/0x340
[  +0.003840]  ? sched_clock_cpu+0xf/0x1f0
[  +0.003925]  __irq_exit_rcu+0xc2/0xe0
[  +0.003665]  common_interrupt+0x85/0xa0
[  +0.003839]  </IRQ>
[  +0.002098]  <TASK>
[  +0.002106]  asm_common_interrupt+0x26/0x40
[  +0.004184] RIP: 0010:cpuidle_enter_state+0xd3/0x690

Fix this by performing the missing unmapping of XDP queues from
q_vectors and setting the XDP rings pointer back to NULL after all those
queues are released.
Also, add an immediate exit from the XDP callback in case of ring
preparation failure.

The Linux kernel CVE team has assigned CVE-2025-38127 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.5 with commit efc2214b6047b6f5b4ca53151eba62521b9452d6 and fixed in 6.6.94 with commit 1d3c5d0dec6797eca3a861dab0816fa9505d9c3e
	Issue introduced in 5.5 with commit efc2214b6047b6f5b4ca53151eba62521b9452d6 and fixed in 6.12.34 with commit 276849954d7cbe6eec827b21fe2df43f9bf07011
	Issue introduced in 5.5 with commit efc2214b6047b6f5b4ca53151eba62521b9452d6 and fixed in 6.15.3 with commit 0e061abaad1498c5b76c10c594d4359ceb6b9145
	Issue introduced in 5.5 with commit efc2214b6047b6f5b4ca53151eba62521b9452d6 and fixed in 6.16-rc1 with commit 0153f36041b8e52019ebfa8629c13bf8f9b0a951

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38127
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/intel/ice/ice_main.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/1d3c5d0dec6797eca3a861dab0816fa9505d9c3e
	https://git.kernel.org/stable/c/276849954d7cbe6eec827b21fe2df43f9bf07011
	https://git.kernel.org/stable/c/0e061abaad1498c5b76c10c594d4359ceb6b9145
	https://git.kernel.org/stable/c/0153f36041b8e52019ebfa8629c13bf8f9b0a951
