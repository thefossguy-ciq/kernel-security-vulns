From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-37818: LoongArch: Return NULL from huge_pte_offset() for invalid PMD

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

LoongArch: Return NULL from huge_pte_offset() for invalid PMD

LoongArch's huge_pte_offset() currently returns a pointer to a PMD slot
even if the underlying entry points to invalid_pte_table (indicating no
mapping). Callers like smaps_hugetlb_range() fetch this invalid entry
value (the address of invalid_pte_table) via this pointer.

The generic is_swap_pte() check then incorrectly identifies this address
as a swap entry on LoongArch, because it satisfies the "!pte_present()
&& !pte_none()" conditions. This misinterpretation, combined with a
coincidental match by is_migration_entry() on the address bits, leads to
kernel crashes in pfn_swap_entry_to_page().

Fix this at the architecture level by modifying huge_pte_offset() to
check the PMD entry's content using pmd_none() before returning. If the
entry is invalid (i.e., it points to invalid_pte_table), return NULL
instead of the pointer to the slot.

The Linux kernel CVE team has assigned CVE-2025-37818 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.1.136 with commit 34256805720993e37adf6127371a1265aea8376a
	Fixed in 6.6.89 with commit 2ca9380b12711afe95b3589bd82b59623b3c96b3
	Fixed in 6.12.26 with commit 51424fd171cee6a33f01f7c66b8eb23ac42289d4
	Fixed in 6.14.5 with commit b49f085cd671addbda4802d6b9382513f7dd0f30
	Fixed in 6.15-rc4 with commit bd51834d1cf65a2c801295d230c220aeebf87a73

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-37818
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	arch/loongarch/mm/hugetlbpage.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/34256805720993e37adf6127371a1265aea8376a
	https://git.kernel.org/stable/c/2ca9380b12711afe95b3589bd82b59623b3c96b3
	https://git.kernel.org/stable/c/51424fd171cee6a33f01f7c66b8eb23ac42289d4
	https://git.kernel.org/stable/c/b49f085cd671addbda4802d6b9382513f7dd0f30
	https://git.kernel.org/stable/c/bd51834d1cf65a2c801295d230c220aeebf87a73
