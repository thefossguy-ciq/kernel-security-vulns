From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68780: sched/deadline: only set free_cpus for online runqueues

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

sched/deadline: only set free_cpus for online runqueues

Commit 16b269436b72 ("sched/deadline: Modify cpudl::free_cpus
to reflect rd->online") introduced the cpudl_set/clear_freecpu
functions to allow the cpu_dl::free_cpus mask to be manipulated
by the deadline scheduler class rq_on/offline callbacks so the
mask would also reflect this state.

Commit 9659e1eeee28 ("sched/deadline: Remove cpu_active_mask
from cpudl_find()") removed the check of the cpu_active_mask to
save some processing on the premise that the cpudl::free_cpus
mask already reflected the runqueue online state.

Unfortunately, there are cases where it is possible for the
cpudl_clear function to set the free_cpus bit for a CPU when the
deadline runqueue is offline. When this occurs while a CPU is
connected to the default root domain the flag may retain the bad
state after the CPU has been unplugged. Later, a different CPU
that is transitioning through the default root domain may push a
deadline task to the powered down CPU when cpudl_find sees its
free_cpus bit is set. If this happens the task will not have the
opportunity to run.

One example is outlined here:
https://lore.kernel.org/lkml/20250110233010.2339521-1-opendmb@gmail.com

Another occurs when the last deadline task is migrated from a
CPU that has an offlined runqueue. The dequeue_task member of
the deadline scheduler class will eventually call cpudl_clear
and set the free_cpus bit for the CPU.

This commit modifies the cpudl_clear function to be aware of the
online state of the deadline runqueue so that the free_cpus mask
can be updated appropriately.

It is no longer necessary to manage the mask outside of the
cpudl_set/clear functions so the cpudl_set/clear_freecpu
functions are removed. In addition, since the free_cpus mask is
now only updated under the cpudl lock the code was changed to
use the non-atomic __cpumask functions.

The Linux kernel CVE team has assigned CVE-2025-68780 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 4.0 with commit 9659e1eeee28f7025b6545934d644d19e9c6e603 and fixed in 5.15.198 with commit 9019e399684e3cc68c4a3f050e268f74d69c1317
	Issue introduced in 4.0 with commit 9659e1eeee28f7025b6545934d644d19e9c6e603 and fixed in 6.1.160 with commit fb36846cbcc936954f2ad2bffdff13d16c0be08a
	Issue introduced in 4.0 with commit 9659e1eeee28f7025b6545934d644d19e9c6e603 and fixed in 6.6.120 with commit 91e448e69aca4bb0ba2e998eb3e555644db7322b
	Issue introduced in 4.0 with commit 9659e1eeee28f7025b6545934d644d19e9c6e603 and fixed in 6.12.64 with commit dbc61834b0412435df21c71410562d933e4eba49
	Issue introduced in 4.0 with commit 9659e1eeee28f7025b6545934d644d19e9c6e603 and fixed in 6.18.3 with commit 3ed049fbfb4d75b4e0b8ab54c934f485129d5dc8
	Issue introduced in 4.0 with commit 9659e1eeee28f7025b6545934d644d19e9c6e603 and fixed in 6.19-rc1 with commit 382748c05e58a9f1935f5a653c352422375566ea

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68780
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	kernel/sched/cpudeadline.c
	kernel/sched/cpudeadline.h
	kernel/sched/deadline.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9019e399684e3cc68c4a3f050e268f74d69c1317
	https://git.kernel.org/stable/c/fb36846cbcc936954f2ad2bffdff13d16c0be08a
	https://git.kernel.org/stable/c/91e448e69aca4bb0ba2e998eb3e555644db7322b
	https://git.kernel.org/stable/c/dbc61834b0412435df21c71410562d933e4eba49
	https://git.kernel.org/stable/c/3ed049fbfb4d75b4e0b8ab54c934f485129d5dc8
	https://git.kernel.org/stable/c/382748c05e58a9f1935f5a653c352422375566ea
