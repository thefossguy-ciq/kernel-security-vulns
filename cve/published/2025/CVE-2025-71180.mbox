From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-71180: counter: interrupt-cnt: Drop IRQF_NO_THREAD flag

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

counter: interrupt-cnt: Drop IRQF_NO_THREAD flag

An IRQ handler can either be IRQF_NO_THREAD or acquire spinlock_t, as
CONFIG_PROVE_RAW_LOCK_NESTING warns:
=============================
[ BUG: Invalid wait context ]
6.18.0-rc1+git... #1
-----------------------------
some-user-space-process/1251 is trying to lock:
(&counter->events_list_lock){....}-{3:3}, at: counter_push_event [counter]
other info that might help us debug this:
context-{2:2}
no locks held by some-user-space-process/....
stack backtrace:
CPU: 0 UID: 0 PID: 1251 Comm: some-user-space-process 6.18.0-rc1+git... #1 PREEMPT
Call trace:
 show_stack (C)
 dump_stack_lvl
 dump_stack
 __lock_acquire
 lock_acquire
 _raw_spin_lock_irqsave
 counter_push_event [counter]
 interrupt_cnt_isr [interrupt_cnt]
 __handle_irq_event_percpu
 handle_irq_event
 handle_simple_irq
 handle_irq_desc
 generic_handle_domain_irq
 gpio_irq_handler
 handle_irq_desc
 generic_handle_domain_irq
 gic_handle_irq
 call_on_irq_stack
 do_interrupt_handler
 el0_interrupt
 __el0_irq_handler_common
 el0t_64_irq_handler
 el0t_64_irq

... and Sebastian correctly points out. Remove IRQF_NO_THREAD as an
alternative to switching to raw_spinlock_t, because the latter would limit
all potential nested locks to raw_spinlock_t only.

The Linux kernel CVE team has assigned CVE-2025-71180 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.13 with commit a55ebd47f21f6f0472766fb52c973849e31d1466 and fixed in 5.15.198 with commit ef668c9a2261ec9287faba6e6ef05a98b391aa2b
	Issue introduced in 5.13 with commit a55ebd47f21f6f0472766fb52c973849e31d1466 and fixed in 6.1.161 with commit 51d2e5d6491447258cb39ff1deb93df15d3c23cb
	Issue introduced in 5.13 with commit a55ebd47f21f6f0472766fb52c973849e31d1466 and fixed in 6.6.121 with commit 1c5a3175aecf82cd86dfcbef2a23e8b26d8d8e7c
	Issue introduced in 5.13 with commit a55ebd47f21f6f0472766fb52c973849e31d1466 and fixed in 6.12.66 with commit 49a66829dd3653695e60d7cae13521d131362fcd
	Issue introduced in 5.13 with commit a55ebd47f21f6f0472766fb52c973849e31d1466 and fixed in 6.18.6 with commit 425886b1f8304621b3f16632b274357067d5f13f
	Issue introduced in 5.13 with commit a55ebd47f21f6f0472766fb52c973849e31d1466 and fixed in 6.19-rc5 with commit 23f9485510c338476b9735d516c1d4aacb810d46

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-71180
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/counter/interrupt-cnt.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ef668c9a2261ec9287faba6e6ef05a98b391aa2b
	https://git.kernel.org/stable/c/51d2e5d6491447258cb39ff1deb93df15d3c23cb
	https://git.kernel.org/stable/c/1c5a3175aecf82cd86dfcbef2a23e8b26d8d8e7c
	https://git.kernel.org/stable/c/49a66829dd3653695e60d7cae13521d131362fcd
	https://git.kernel.org/stable/c/425886b1f8304621b3f16632b274357067d5f13f
	https://git.kernel.org/stable/c/23f9485510c338476b9735d516c1d4aacb810d46
