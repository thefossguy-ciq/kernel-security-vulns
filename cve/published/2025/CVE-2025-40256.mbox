From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40256: xfrm: also call xfrm_state_delete_tunnel at destroy time for states that were never added

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

xfrm: also call xfrm_state_delete_tunnel at destroy time for states that were never added

In commit b441cf3f8c4b ("xfrm: delete x->tunnel as we delete x"), I
missed the case where state creation fails between full
initialization (->init_state has been called) and being inserted on
the lists.

In this situation, ->init_state has been called, so for IPcomp
tunnels, the fallback tunnel has been created and added onto the
lists, but the user state never gets added, because we fail before
that. The user state doesn't go through __xfrm_state_delete, so we
don't call xfrm_state_delete_tunnel for those states, and we end up
leaking the FB tunnel.

There are several codepaths affected by this: the add/update paths, in
both net/key and xfrm, and the migrate code (xfrm_migrate,
xfrm_state_migrate). A "proper" rollback of the init_state work would
probably be doable in the add/update code, but for migrate it gets
more complicated as multiple states may be involved.

At some point, the new (not-inserted) state will be destroyed, so call
xfrm_state_delete_tunnel during xfrm_state_gc_destroy. Most states
will have their fallback tunnel cleaned up during __xfrm_state_delete,
which solves the issue that b441cf3f8c4b (and other patches before it)
aimed at. All states (including FB tunnels) will be removed from the
lists once xfrm_state_fini has called flush_work(&xfrm_state_gc_work).

The Linux kernel CVE team has assigned CVE-2025-40256 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.16 with commit b441cf3f8c4b8576639d20c8eb4aa32917602ecd and fixed in 6.17.10 with commit d6fe5c740c573af10943b8353992e1325cdb2715
	Issue introduced in 6.16 with commit b441cf3f8c4b8576639d20c8eb4aa32917602ecd and fixed in 6.18 with commit 10deb69864840ccf96b00ac2ab3a2055c0c04721

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40256
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/xfrm/xfrm_state.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/57b72d74d4651dc19d046308a8304eb9abfe66ac
	https://git.kernel.org/stable/c/1dad653643f28ccc89be93f9440b8804cded85b2
	https://git.kernel.org/stable/c/64441724387b4ac92f67ef51caaaeffe99c950d1
	https://git.kernel.org/stable/c/763e5c351206c1e4d910db4a1159053f6263689c
	https://git.kernel.org/stable/c/f7d879c19d306512c2e260f37e8a3e5c85e37c50
	https://git.kernel.org/stable/c/d6fe5c740c573af10943b8353992e1325cdb2715
	https://git.kernel.org/stable/c/10deb69864840ccf96b00ac2ab3a2055c0c04721
