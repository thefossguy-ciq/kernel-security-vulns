From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38224: can: kvaser_pciefd: refine error prone echo_skb_max handling logic
Message-Id: <2025070426-CVE-2025-38224-5e01@gregkh>
Content-Length: 4116
Lines: 92
X-Developer-Signature: v=1; a=openpgp-sha256; l=4209;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=4tbooCssa1I9G7Ki3DLi/Hvvv+pRat0CTtpSL8Cr0Fc=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBnpN8UmcFzdvuMhx95jjfVep3648FzeXlu1Ne66hNKKv
 fzONT0KHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjCRiUkMCybXafn4/+ZLSblW
 oVva1vyDzXd3CsN8/97ra3k7/h3icw56PF+uV/tdq2U6AA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

can: kvaser_pciefd: refine error prone echo_skb_max handling logic

echo_skb_max should define the supported upper limit of echo_skb[]
allocated inside the netdevice's priv. The corresponding size value
provided by this driver to alloc_candev() is KVASER_PCIEFD_CAN_TX_MAX_COUNT
which is 17.

But later echo_skb_max is rounded up to the nearest power of two (for the
max case, that would be 32) and the tx/ack indices calculated further
during tx/rx may exceed the upper array boundary. Kasan reported this for
the ack case inside kvaser_pciefd_handle_ack_packet(), though the xmit
function has actually caught the same thing earlier.

 BUG: KASAN: slab-out-of-bounds in kvaser_pciefd_handle_ack_packet+0x2d7/0x92a drivers/net/can/kvaser_pciefd.c:1528
 Read of size 8 at addr ffff888105e4f078 by task swapper/4/0

 CPU: 4 UID: 0 PID: 0 Comm: swapper/4 Not tainted 6.15.0 #12 PREEMPT(voluntary)
 Call Trace:
  <IRQ>
 dump_stack_lvl lib/dump_stack.c:122
 print_report mm/kasan/report.c:521
 kasan_report mm/kasan/report.c:634
 kvaser_pciefd_handle_ack_packet drivers/net/can/kvaser_pciefd.c:1528
 kvaser_pciefd_read_packet drivers/net/can/kvaser_pciefd.c:1605
 kvaser_pciefd_read_buffer drivers/net/can/kvaser_pciefd.c:1656
 kvaser_pciefd_receive_irq drivers/net/can/kvaser_pciefd.c:1684
 kvaser_pciefd_irq_handler drivers/net/can/kvaser_pciefd.c:1733
 __handle_irq_event_percpu kernel/irq/handle.c:158
 handle_irq_event kernel/irq/handle.c:210
 handle_edge_irq kernel/irq/chip.c:833
 __common_interrupt arch/x86/kernel/irq.c:296
 common_interrupt arch/x86/kernel/irq.c:286
  </IRQ>

Tx max count definitely matters for kvaser_pciefd_tx_avail(), but for seq
numbers' generation that's not the case - we're free to calculate them as
would be more convenient, not taking tx max count into account. The only
downside is that the size of echo_skb[] should correspond to the max seq
number (not tx max count), so in some situations a bit more memory would
be consumed than could be.

Thus make the size of the underlying echo_skb[] sufficient for the rounded
max tx value.

Found by Linux Verification Center (linuxtesting.org) with Syzkaller.

The Linux kernel CVE team has assigned CVE-2025-38224 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.12.31 with commit 352fbde14177d608a54120b6ff559ce5b3cf6238 and fixed in 6.12.35 with commit d8a054b6e6824a8b52c3977ebd38c9583a63efac
	Issue introduced in 6.15 with commit 8256e0ca601051933e9395746817f3801fa9a6bf and fixed in 6.15.4 with commit a6550c9aa11e2f57f9cdaa6249cdd44d446be874
	Issue introduced in 6.15 with commit 8256e0ca601051933e9395746817f3801fa9a6bf and fixed in 6.16-rc1 with commit 54ec8b08216f3be2cc98b33633d3c8ea79749895
	Issue introduced in 6.14.9 with commit f14512f3ee09cda986191c8dd7f54972afa2c763

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38224
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/can/kvaser_pciefd.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d8a054b6e6824a8b52c3977ebd38c9583a63efac
	https://git.kernel.org/stable/c/a6550c9aa11e2f57f9cdaa6249cdd44d446be874
	https://git.kernel.org/stable/c/54ec8b08216f3be2cc98b33633d3c8ea79749895
