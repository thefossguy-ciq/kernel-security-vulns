From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68371: scsi: smartpqi: Fix device resources accessed after device removal

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: smartpqi: Fix device resources accessed after device removal

Correct possible race conditions during device removal.

Previously, a scheduled work item to reset a LUN could still execute
after the device was removed, leading to use-after-free and other
resource access issues.

This race condition occurs because the abort handler may schedule a LUN
reset concurrently with device removal via sdev_destroy(), leading to
use-after-free and improper access to freed resources.

  - Check in the device reset handler if the device is still present in
    the controller's SCSI device list before running; if not, the reset
    is skipped.

  - Cancel any pending TMF work that has not started in sdev_destroy().

  - Ensure device freeing in sdev_destroy() is done while holding the
    LUN reset mutex to avoid races with ongoing resets.

The Linux kernel CVE team has assigned CVE-2025-68371 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.0 with commit 2d80f4054f7f901b8ad97358a9069616ac8524c7 and fixed in 6.1.160 with commit 7dfa5a5516ec3c6b9b6c22ee18f0eb2df3f38ef2
	Issue introduced in 6.0 with commit 2d80f4054f7f901b8ad97358a9069616ac8524c7 and fixed in 6.6.120 with commit 6d2390653d82cad0e1ba2676e536dd99678f6ef1
	Issue introduced in 6.0 with commit 2d80f4054f7f901b8ad97358a9069616ac8524c7 and fixed in 6.12.63 with commit eccc02ba1747501d92bb2049e3ce378ba372f641
	Issue introduced in 6.0 with commit 2d80f4054f7f901b8ad97358a9069616ac8524c7 and fixed in 6.17.13 with commit 4e1acf1b6dd6dd0495bda139daafd7a403ae2dc1
	Issue introduced in 6.0 with commit 2d80f4054f7f901b8ad97358a9069616ac8524c7 and fixed in 6.18.2 with commit 1a5c5a2f88e839af5320216a02ffb075b668596a
	Issue introduced in 6.0 with commit 2d80f4054f7f901b8ad97358a9069616ac8524c7 and fixed in 6.19-rc1 with commit b518e86d1a70a88f6592a7c396cf1b93493d1aab

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68371
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/smartpqi/smartpqi_init.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/7dfa5a5516ec3c6b9b6c22ee18f0eb2df3f38ef2
	https://git.kernel.org/stable/c/6d2390653d82cad0e1ba2676e536dd99678f6ef1
	https://git.kernel.org/stable/c/eccc02ba1747501d92bb2049e3ce378ba372f641
	https://git.kernel.org/stable/c/4e1acf1b6dd6dd0495bda139daafd7a403ae2dc1
	https://git.kernel.org/stable/c/1a5c5a2f88e839af5320216a02ffb075b668596a
	https://git.kernel.org/stable/c/b518e86d1a70a88f6592a7c396cf1b93493d1aab
