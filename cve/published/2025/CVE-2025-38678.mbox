From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38678: netfilter: nf_tables: reject duplicate device on updates

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

netfilter: nf_tables: reject duplicate device on updates

A chain/flowtable update with duplicated devices in the same batch is
possible. Unfortunately, netdev event path only removes the first
device that is found, leaving unregistered the hook of the duplicated
device.

Check if a duplicated device exists in the transaction batch, bail out
with EEXIST in such case.

WARNING is hit when unregistering the hook:

 [49042.221275] WARNING: CPU: 4 PID: 8425 at net/netfilter/core.c:340 nf_hook_entry_head+0xaa/0x150
 [49042.221375] CPU: 4 UID: 0 PID: 8425 Comm: nft Tainted: G S                  6.16.0+ #170 PREEMPT(full)
 [...]
 [49042.221382] RIP: 0010:nf_hook_entry_head+0xaa/0x150

The Linux kernel CVE team has assigned CVE-2025-38678 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 5.10.247 with commit 0521e694d5b80899fba8695881a6349f9bc538cb
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 5.15.197 with commit 4681960bc0f4f8bcc782cbf2fd205f48ad314dfd
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.1.159 with commit 4ce2a0c3b8497a66cfc25fc7ca3d087258a785d2
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.6.117 with commit 3f358a66a04513311668ea4b40f5064e253d8386
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.12.59 with commit cf23d531a9d496863aa4c5a0e2f71f0a23f3df3c
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.16.2 with commit d7615bde541f16517d6790412da6ec46fa8a4c1f
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.17 with commit cf5fb87fcdaaaafec55dcc0dc5a9e15ead343973

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38678
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/netfilter/nf_tables_api.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/0521e694d5b80899fba8695881a6349f9bc538cb
	https://git.kernel.org/stable/c/4681960bc0f4f8bcc782cbf2fd205f48ad314dfd
	https://git.kernel.org/stable/c/4ce2a0c3b8497a66cfc25fc7ca3d087258a785d2
	https://git.kernel.org/stable/c/3f358a66a04513311668ea4b40f5064e253d8386
	https://git.kernel.org/stable/c/cf23d531a9d496863aa4c5a0e2f71f0a23f3df3c
	https://git.kernel.org/stable/c/d7615bde541f16517d6790412da6ec46fa8a4c1f
	https://git.kernel.org/stable/c/cf5fb87fcdaaaafec55dcc0dc5a9e15ead343973
