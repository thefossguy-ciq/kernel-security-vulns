From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38678: netfilter: nf_tables: reject duplicate device on updates
Message-Id: <2025090318-CVE-2025-38678-faa7@gregkh>
Content-Length: 2350
Lines: 60
X-Developer-Signature: v=1; a=openpgp-sha256; l=2411;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=/5d+XjNbmp8r3G2UCCz0G1qpK79B093haBY/4ITJzMM=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBk7bOTWfZj4R0l2QvdpV1uz/tQrHi66tfq3wnZ+Wfzpz
 GcrkTiljhgWBkEmBlkxRZYv23iO7q84pOhlaHsaZg4rE8gQBi5OAZhIjSnDPEtrcYVJrF98OTgd
 zD5wvLy+Wqm2kmHGHMspf94dcV/K/WBC202P5sZdreUA
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

netfilter: nf_tables: reject duplicate device on updates

A chain/flowtable update with duplicated devices in the same batch is
possible. Unfortunately, netdev event path only removes the first
device that is found, leaving unregistered the hook of the duplicated
device.

Check if a duplicated device exists in the transaction batch, bail out
with EEXIST in such case.

WARNING is hit when unregistering the hook:

 [49042.221275] WARNING: CPU: 4 PID: 8425 at net/netfilter/core.c:340 nf_hook_entry_head+0xaa/0x150
 [49042.221375] CPU: 4 UID: 0 PID: 8425 Comm: nft Tainted: G S                  6.16.0+ #170 PREEMPT(full)
 [...]
 [49042.221382] RIP: 0010:nf_hook_entry_head+0xaa/0x150

The Linux kernel CVE team has assigned CVE-2025-38678 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.16.2 with commit d7615bde541f16517d6790412da6ec46fa8a4c1f
	Issue introduced in 5.8 with commit 78d9f48f7f44431a25da2b46b3a8812f6ff2b981 and fixed in 6.17-rc2 with commit cf5fb87fcdaaaafec55dcc0dc5a9e15ead343973

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38678
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/netfilter/nf_tables_api.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/d7615bde541f16517d6790412da6ec46fa8a4c1f
	https://git.kernel.org/stable/c/cf5fb87fcdaaaafec55dcc0dc5a9e15ead343973
