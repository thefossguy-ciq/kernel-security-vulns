From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38174: thunderbolt: Do not double dequeue a configuration request
Message-Id: <2025070400-CVE-2025-38174-7553@gregkh>
Content-Length: 3466
Lines: 85
X-Developer-Signature: v=1; a=openpgp-sha256; l=3552;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=a0EITJk02R5/rZmQ1OuCfL6zzzljmD6AuHa6KxAlB8g=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBnp6xtWmhr23TtpfLBLKmZmlFUxY6XYLNvPVx7IOE+4c
 SjJiou7I5aFQZCJQVZMkeXLNp6j+ysOKXoZ2p6GmcPKBDKEgYtTACbySJ1hftqOimQtQZNpV2ay
 Tzsx5Vh4V+DGLIa54n8O+By08pihIb9glutHp4hPk9cuBQA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

thunderbolt: Do not double dequeue a configuration request

Some of our devices crash in tb_cfg_request_dequeue():

 general protection fault, probably for non-canonical address 0xdead000000000122

 CPU: 6 PID: 91007 Comm: kworker/6:2 Tainted: G U W 6.6.65
 RIP: 0010:tb_cfg_request_dequeue+0x2d/0xa0
 Call Trace:
 <TASK>
 ? tb_cfg_request_dequeue+0x2d/0xa0
 tb_cfg_request_work+0x33/0x80
 worker_thread+0x386/0x8f0
 kthread+0xed/0x110
 ret_from_fork+0x38/0x50
 ret_from_fork_asm+0x1b/0x30

The circumstances are unclear, however, the theory is that
tb_cfg_request_work() can be scheduled twice for a request:
first time via frame.callback from ring_work() and second
time from tb_cfg_request().  Both times kworkers will execute
tb_cfg_request_dequeue(), which results in double list_del()
from the ctl->request_queue (the list poison deference hints
at it: 0xdead000000000122).

Do not dequeue requests that don't have TB_CFG_REQUEST_ACTIVE
bit set.

The Linux kernel CVE team has assigned CVE-2025-38174 to this issue.


Affected and fixed versions
===========================

	Fixed in 5.4.295 with commit e49e994cd83705f7ca30eda1e304abddfd96a37a
	Fixed in 5.10.239 with commit 0a3011d47dbc92a33621861c423cb64833d7fe57
	Fixed in 5.15.186 with commit 2f62eda4d974c26bc595425eafd429067541f2c9
	Fixed in 6.1.142 with commit 85286e634ebbaf9c0fb1cdf580add2f33fc7628c
	Fixed in 6.6.94 with commit 5a057f261539720165d03d85024da2b52e67f63d
	Fixed in 6.12.33 with commit eb2d5e794fb966b3ef8bde99eb8561446a53509f
	Fixed in 6.14.11 with commit 0771bcbe2f6e5d5f263cf466efe571d2754a46da
	Fixed in 6.15.2 with commit cdb4feab2f39e75a66239e3a112beced279612a8
	Fixed in 6.16-rc1 with commit 0f73628e9da1ee39daf5f188190cdbaee5e0c98c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38174
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/thunderbolt/ctl.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e49e994cd83705f7ca30eda1e304abddfd96a37a
	https://git.kernel.org/stable/c/0a3011d47dbc92a33621861c423cb64833d7fe57
	https://git.kernel.org/stable/c/2f62eda4d974c26bc595425eafd429067541f2c9
	https://git.kernel.org/stable/c/85286e634ebbaf9c0fb1cdf580add2f33fc7628c
	https://git.kernel.org/stable/c/5a057f261539720165d03d85024da2b52e67f63d
	https://git.kernel.org/stable/c/eb2d5e794fb966b3ef8bde99eb8561446a53509f
	https://git.kernel.org/stable/c/0771bcbe2f6e5d5f263cf466efe571d2754a46da
	https://git.kernel.org/stable/c/cdb4feab2f39e75a66239e3a112beced279612a8
	https://git.kernel.org/stable/c/0f73628e9da1ee39daf5f188190cdbaee5e0c98c
