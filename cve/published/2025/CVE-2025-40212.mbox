From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40212: nfsd: fix refcount leak in nfsd_set_fh_dentry()

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

nfsd: fix refcount leak in nfsd_set_fh_dentry()

nfsd exports a "pseudo root filesystem" which is used by NFSv4 to find
the various exported filesystems using LOOKUP requests from a known root
filehandle.  NFSv3 uses the MOUNT protocol to find those exported
filesystems and so is not given access to the pseudo root filesystem.

If a v3 (or v2) client uses a filehandle from that filesystem,
nfsd_set_fh_dentry() will report an error, but still stores the export
in "struct svc_fh" even though it also drops the reference (exp_put()).
This means that when fh_put() is called an extra reference will be dropped
which can lead to use-after-free and possible denial of service.

Normal NFS usage will not provide a pseudo-root filehandle to a v3
client.  This bug can only be triggered by the client synthesising an
incorrect filehandle.

To fix this we move the assignments to the svc_fh later, after all
possible error cases have been detected.

The Linux kernel CVE team has assigned CVE-2025-40212 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.12 with commit ef7f6c4904d03ccd7478e1ac20ed75f79c4ac444 and fixed in 6.12.59 with commit b6bc86ce3944b10b9fc181fc00c1a520a20ed965
	Issue introduced in 6.12 with commit ef7f6c4904d03ccd7478e1ac20ed75f79c4ac444 and fixed in 6.17.9 with commit c83d7365cec5eb5ebeeee2a72e29b4ca58a7e4c2
	Issue introduced in 6.12 with commit ef7f6c4904d03ccd7478e1ac20ed75f79c4ac444 and fixed in 6.18-rc6 with commit 8a7348a9ed70bda1c1f51d3f1815bcbdf9f3b38c

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40212
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/nfsd/nfsfh.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/b6bc86ce3944b10b9fc181fc00c1a520a20ed965
	https://git.kernel.org/stable/c/c83d7365cec5eb5ebeeee2a72e29b4ca58a7e4c2
	https://git.kernel.org/stable/c/8a7348a9ed70bda1c1f51d3f1815bcbdf9f3b38c
