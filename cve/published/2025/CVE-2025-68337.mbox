From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68337: jbd2: avoid bug_on in jbd2_journal_get_create_access() when file system corrupted

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

jbd2: avoid bug_on in jbd2_journal_get_create_access() when file system corrupted

There's issue when file system corrupted:
------------[ cut here ]------------
kernel BUG at fs/jbd2/transaction.c:1289!
Oops: invalid opcode: 0000 [#1] SMP KASAN PTI
CPU: 5 UID: 0 PID: 2031 Comm: mkdir Not tainted 6.18.0-rc1-next
RIP: 0010:jbd2_journal_get_create_access+0x3b6/0x4d0
RSP: 0018:ffff888117aafa30 EFLAGS: 00010202
RAX: 0000000000000000 RBX: ffff88811a86b000 RCX: ffffffff89a63534
RDX: 1ffff110200ec602 RSI: 0000000000000004 RDI: ffff888100763010
RBP: ffff888100763000 R08: 0000000000000001 R09: ffff888100763028
R10: 0000000000000003 R11: 0000000000000000 R12: 0000000000000000
R13: ffff88812c432000 R14: ffff88812c608000 R15: ffff888120bfc000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f91d6970c99 CR3: 00000001159c4000 CR4: 00000000000006f0
Call Trace:
 <TASK>
 __ext4_journal_get_create_access+0x42/0x170
 ext4_getblk+0x319/0x6f0
 ext4_bread+0x11/0x100
 ext4_append+0x1e6/0x4a0
 ext4_init_new_dir+0x145/0x1d0
 ext4_mkdir+0x326/0x920
 vfs_mkdir+0x45c/0x740
 do_mkdirat+0x234/0x2f0
 __x64_sys_mkdir+0xd6/0x120
 do_syscall_64+0x5f/0xfa0
 entry_SYSCALL_64_after_hwframe+0x76/0x7e

The above issue occurs with us in errors=continue mode when accompanied by
storage failures. There have been many inconsistencies in the file system
data.
In the case of file system data inconsistency, for example, if the block
bitmap of a referenced block is not set, it can lead to the situation where
a block being committed is allocated and used again. As a result, the
following condition will not be satisfied then trigger BUG_ON. Of course,
it is entirely possible to construct a problematic image that can trigger
this BUG_ON through specific operations. In fact, I have constructed such
an image and easily reproduced this issue.
Therefore, J_ASSERT() holds true only under ideal conditions, but it may
not necessarily be satisfied in exceptional scenarios. Using J_ASSERT()
directly in abnormal situations would cause the system to crash, which is
clearly not what we want. So here we directly trigger a JBD abort instead
of immediately invoking BUG_ON.

The Linux kernel CVE team has assigned CVE-2025-68337 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.19 with commit 470decc613ab2048b619a01028072d932d9086ee and fixed in 6.1.160 with commit 3faac6531d4818cd6be45e5bbf32937bbbc795c0
	Issue introduced in 2.6.19 with commit 470decc613ab2048b619a01028072d932d9086ee and fixed in 6.6.120 with commit b4f8eabf6d991bd41fabcdf9302c4b3eab590cf4
	Issue introduced in 2.6.19 with commit 470decc613ab2048b619a01028072d932d9086ee and fixed in 6.12.62 with commit a2a7f854d154a3e9232fec80782dad951655f52f
	Issue introduced in 2.6.19 with commit 470decc613ab2048b619a01028072d932d9086ee and fixed in 6.17.12 with commit bf34c72337e40c4670cceeb79b353356933a254b
	Issue introduced in 2.6.19 with commit 470decc613ab2048b619a01028072d932d9086ee and fixed in 6.18.1 with commit aa1703f3f706ea0867fb1991dcac709c9ec94cfb
	Issue introduced in 2.6.19 with commit 470decc613ab2048b619a01028072d932d9086ee and fixed in 6.19-rc1 with commit 986835bf4d11032bba4ab8414d18fce038c61bb4

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68337
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/jbd2/transaction.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/3faac6531d4818cd6be45e5bbf32937bbbc795c0
	https://git.kernel.org/stable/c/b4f8eabf6d991bd41fabcdf9302c4b3eab590cf4
	https://git.kernel.org/stable/c/a2a7f854d154a3e9232fec80782dad951655f52f
	https://git.kernel.org/stable/c/bf34c72337e40c4670cceeb79b353356933a254b
	https://git.kernel.org/stable/c/aa1703f3f706ea0867fb1991dcac709c9ec94cfb
	https://git.kernel.org/stable/c/986835bf4d11032bba4ab8414d18fce038c61bb4
