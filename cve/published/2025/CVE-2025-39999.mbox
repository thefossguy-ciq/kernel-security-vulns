From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-39999: blk-mq: fix blk_mq_tags double free while nr_requests grown

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

blk-mq: fix blk_mq_tags double free while nr_requests grown

In the case user trigger tags grow by queue sysfs attribute nr_requests,
hctx->sched_tags will be freed directly and replaced with a new
allocated tags, see blk_mq_tag_update_depth().

The problem is that hctx->sched_tags is from elevator->et->tags, while
et->tags is still the freed tags, hence later elevator exit will try to
free the tags again, causing kernel panic.

Fix this problem by replacing et->tags with new allocated tags as well.

Noted there are still some long term problems that will require some
refactor to be fixed thoroughly[1].

[1] https://lore.kernel.org/all/20250815080216.410665-1-yukuai1@huaweicloud.com/

The Linux kernel CVE team has assigned CVE-2025-39999 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.16.4 with commit 58567d8e95c096ad234963df90a2ca518901f4b6 and fixed in 6.16.11 with commit 8faee580d63bc2a54a59dcdb7f9ce4de29384fec
	Issue introduced in 6.17 with commit f5a6604f7a4405450e4a1f54e5430f47290c500f and fixed in 6.17.1 with commit 392b1d64911f4de8887fe8b68299fa8bd6e5b923
	Issue introduced in 6.17 with commit f5a6604f7a4405450e4a1f54e5430f47290c500f and fixed in 6.18-rc1 with commit ba28afbd9eff2a6370f23ef4e6a036ab0cfda409

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-39999
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	block/blk-mq-tag.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8faee580d63bc2a54a59dcdb7f9ce4de29384fec
	https://git.kernel.org/stable/c/392b1d64911f4de8887fe8b68299fa8bd6e5b923
	https://git.kernel.org/stable/c/ba28afbd9eff2a6370f23ef4e6a036ab0cfda409
