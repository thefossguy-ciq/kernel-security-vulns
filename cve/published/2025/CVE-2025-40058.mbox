From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40058: iommu/vt-d: Disallow dirty tracking if incoherent page walk
Message-Id: <2025102815-CVE-2025-40058-0eba@gregkh>
Content-Length: 2691
Lines: 63
X-Developer-Signature: v=1; a=openpgp-sha256; l=2755;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=pleBzZt5vC/MWfxn2vA+kDp4Jsz13BbJgwBO3BNhCLk=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJkMaxt2v/6S8uNrssnxSWev3w9YoF9VXjd3Tr7Mp0ipr
 oT7i3/6dMSyMAgyMciKKbJ82cZzdH/FIUUvQ9vTMHNYmUCGMHBxCsBE3KMZFjRv9q87OPWW1KmK
 83efTXG8ejf9DC/D/NhnVoGuPkx7Z2d7C8tLTxN4nHDPFwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

iommu/vt-d: Disallow dirty tracking if incoherent page walk

Dirty page tracking relies on the IOMMU atomically updating the dirty bit
in the paging-structure entry. For this operation to succeed, the paging-
structure memory must be coherent between the IOMMU and the CPU. In
another word, if the iommu page walk is incoherent, dirty page tracking
doesn't work.

The Intel VT-d specification, Section 3.10 "Snoop Behavior" states:

"Remapping hardware encountering the need to atomically update A/EA/D bits
 in a paging-structure entry that is not snooped will result in a non-
 recoverable fault."

To prevent an IOMMU from being incorrectly configured for dirty page
tracking when it is operating in an incoherent mode, mark SSADS as
supported only when both ecap_slads and ecap_smpwc are supported.

The Linux kernel CVE team has assigned CVE-2025-40058 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.7 with commit f35f22cc760eb2c7034bf53251399685d611e03f and fixed in 6.12.53 with commit ebe16d245a00626bb87163862a1b07daf5475a3e
	Issue introduced in 6.7 with commit f35f22cc760eb2c7034bf53251399685d611e03f and fixed in 6.17.3 with commit 8d096ce0e87bdc361f0b25d7943543bc53aa0b9e
	Issue introduced in 6.7 with commit f35f22cc760eb2c7034bf53251399685d611e03f and fixed in 6.18-rc1 with commit 57f55048e564dedd8a4546d018e29d6bbfff0a7e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40058
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/iommu/intel/iommu.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ebe16d245a00626bb87163862a1b07daf5475a3e
	https://git.kernel.org/stable/c/8d096ce0e87bdc361f0b25d7943543bc53aa0b9e
	https://git.kernel.org/stable/c/57f55048e564dedd8a4546d018e29d6bbfff0a7e
