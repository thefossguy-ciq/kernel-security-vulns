From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68245: net: netpoll: fix incorrect refcount handling causing incorrect cleanup
Message-Id: <2025121633-CVE-2025-68245-4e60@gregkh>
Content-Length: 4579
Lines: 93
X-Developer-Signature: v=1; a=openpgp-sha256; l=4673;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=hRDx75yomJJKN4mk+TbOLxnMo7UdCqDJOJKrE4GRc8Y=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJmOWW9PK7qU6K//b1t+W+SN+/HHLdwPJm2Qnlm1/0bw3
 fytsV89O2JZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAi3jkMC/r/OT1u5pNsWNYQ
 eybu4i8Bdeu/Pxjme2RNy58pdOflHUftnisZW1Sn/HFaCwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: netpoll: fix incorrect refcount handling causing incorrect cleanup

commit efa95b01da18 ("netpoll: fix use after free") incorrectly
ignored the refcount and prematurely set dev->npinfo to NULL during
netpoll cleanup, leading to improper behavior and memory leaks.

Scenario causing lack of proper cleanup:

1) A netpoll is associated with a NIC (e.g., eth0) and netdev->npinfo is
   allocated, and refcnt = 1
   - Keep in mind that npinfo is shared among all netpoll instances. In
     this case, there is just one.

2) Another netpoll is also associated with the same NIC and
   npinfo->refcnt += 1.
   - Now dev->npinfo->refcnt = 2;
   - There is just one npinfo associated to the netdev.

3) When the first netpolls goes to clean up:
   - The first cleanup succeeds and clears np->dev->npinfo, ignoring
     refcnt.
     - It basically calls `RCU_INIT_POINTER(np->dev->npinfo, NULL);`
   - Set dev->npinfo = NULL, without proper cleanup
   - No ->ndo_netpoll_cleanup() is either called

4) Now the second target tries to clean up
   - The second cleanup fails because np->dev->npinfo is already NULL.
     * In this case, ops->ndo_netpoll_cleanup() was never called, and
       the skb pool is not cleaned as well (for the second netpoll
       instance)
  - This leaks npinfo and skbpool skbs, which is clearly reported by
    kmemleak.

Revert commit efa95b01da18 ("netpoll: fix use after free") and adds
clarifying comments emphasizing that npinfo cleanup should only happen
once the refcount reaches zero, ensuring stable and correct netpoll
behavior.

The Linux kernel CVE team has assigned CVE-2025-68245 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 5.4.302 with commit 8e6a50edad11e3e1426e4c29e7aa6201f3468ac2
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 5.10.247 with commit 9b0bb18b4b9dc017c1825a2c5e763615e34a1593
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 5.15.197 with commit 890472d6fbf062e6de7fdd56642cb305ab79d669
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 6.1.159 with commit 4afd4ebbad52aa146838ec23082ba393e426a2bb
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 6.6.117 with commit c645693180a98606c430825223d2029315d85e9d
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 6.12.59 with commit c79a6d9da29219616b118a3adce9a14cd30f9bd0
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 6.17.9 with commit 9a51b5ccd1c79afec1c03a4e1e6688da52597556
	Issue introduced in 3.17 with commit efa95b01da18ad22af62f6d99a3243f3be8fd264 and fixed in 6.18 with commit 49c8d2c1f94cc2f4d1a108530d7ba52614b874c2

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68245
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/core/netpoll.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/8e6a50edad11e3e1426e4c29e7aa6201f3468ac2
	https://git.kernel.org/stable/c/9b0bb18b4b9dc017c1825a2c5e763615e34a1593
	https://git.kernel.org/stable/c/890472d6fbf062e6de7fdd56642cb305ab79d669
	https://git.kernel.org/stable/c/4afd4ebbad52aa146838ec23082ba393e426a2bb
	https://git.kernel.org/stable/c/c645693180a98606c430825223d2029315d85e9d
	https://git.kernel.org/stable/c/c79a6d9da29219616b118a3adce9a14cd30f9bd0
	https://git.kernel.org/stable/c/9a51b5ccd1c79afec1c03a4e1e6688da52597556
	https://git.kernel.org/stable/c/49c8d2c1f94cc2f4d1a108530d7ba52614b874c2
