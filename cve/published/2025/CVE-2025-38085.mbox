From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38085: mm/hugetlb: fix huge_pmd_unshare() vs GUP-fast race

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mm/hugetlb: fix huge_pmd_unshare() vs GUP-fast race

huge_pmd_unshare() drops a reference on a page table that may have
previously been shared across processes, potentially turning it into a
normal page table used in another process in which unrelated VMAs can
afterwards be installed.

If this happens in the middle of a concurrent gup_fast(), gup_fast() could
end up walking the page tables of another process.  While I don't see any
way in which that immediately leads to kernel memory corruption, it is
really weird and unexpected.

Fix it with an explicit broadcast IPI through tlb_remove_table_sync_one(),
just like we do in khugepaged when removing page tables for a THP
collapse.

The Linux kernel CVE team has assigned CVE-2025-38085 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 5.10.239 with commit 952596b08c74e8fe9e2883d1dc8a8f54a37384ec
	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 5.15.186 with commit a3d864c901a300c295692d129159fc3001a56185
	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 6.1.142 with commit b7754d3aa7bf9f62218d096c0c8f6c13698fac8b
	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 6.6.95 with commit fe684290418ef9ef76630072086ee530b92f02b8
	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 6.12.35 with commit 034a52b5ef57c9c8225d94e9067f3390bb33922f
	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 6.15.4 with commit a6bfeb97941a9187833b526bc6cc4ff5706d0ce9
	Issue introduced in 2.6.20 with commit 39dde65c9940c97fcd178a3d2b1c57ed8b7b68aa and fixed in 6.16-rc1 with commit 1013af4f585fccc4d3e5c5824d174de2257f7d6d

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38085
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	mm/hugetlb.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/952596b08c74e8fe9e2883d1dc8a8f54a37384ec
	https://git.kernel.org/stable/c/a3d864c901a300c295692d129159fc3001a56185
	https://git.kernel.org/stable/c/b7754d3aa7bf9f62218d096c0c8f6c13698fac8b
	https://git.kernel.org/stable/c/fe684290418ef9ef76630072086ee530b92f02b8
	https://git.kernel.org/stable/c/034a52b5ef57c9c8225d94e9067f3390bb33922f
	https://git.kernel.org/stable/c/a6bfeb97941a9187833b526bc6cc4ff5706d0ce9
	https://git.kernel.org/stable/c/1013af4f585fccc4d3e5c5824d174de2257f7d6d
