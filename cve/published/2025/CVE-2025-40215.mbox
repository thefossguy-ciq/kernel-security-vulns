From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40215: xfrm: delete x->tunnel as we delete x

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

xfrm: delete x->tunnel as we delete x

The ipcomp fallback tunnels currently get deleted (from the various
lists and hashtables) as the last user state that needed that fallback
is destroyed (not deleted). If a reference to that user state still
exists, the fallback state will remain on the hashtables/lists,
triggering the WARN in xfrm_state_fini. Because of those remaining
references, the fix in commit f75a2804da39 ("xfrm: destroy xfrm_state
synchronously on net exit path") is not complete.

We recently fixed one such situation in TCP due to defered freeing of
skbs (commit 9b6412e6979f ("tcp: drop secpath at the same time as we
currently drop dst")). This can also happen due to IP reassembly: skbs
with a secpath remain on the reassembly queue until netns
destruction. If we can't guarantee that the queues are flushed by the
time xfrm_state_fini runs, there may still be references to a (user)
xfrm_state, preventing the timely deletion of the corresponding
fallback state.

Instead of chasing each instance of skbs holding a secpath one by one,
this patch fixes the issue directly within xfrm, by deleting the
fallback state as soon as the last user state depending on it has been
deleted. Destruction will still happen when the final reference is
dropped.

A separate lockdep class for the fallback state is required since
we're going to lock x->tunnel while x is locked.

The Linux kernel CVE team has assigned CVE-2025-40215 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 2.6.29 with commit 9d4139c76905833afcb77fe8ccc17f302a0eb9ab and fixed in 5.10.248 with commit 1b28a7fae0128fa140a7dccd995182ff6cd1c67b
	Issue introduced in 2.6.29 with commit 9d4139c76905833afcb77fe8ccc17f302a0eb9ab and fixed in 5.15.198 with commit 4b2c17d0f9be8b58bb30468bc81a4b61c985b04e
	Issue introduced in 2.6.29 with commit 9d4139c76905833afcb77fe8ccc17f302a0eb9ab and fixed in 6.1.160 with commit 0da961fa46da1b37ef868d9b603bd202136f8f8e
	Issue introduced in 2.6.29 with commit 9d4139c76905833afcb77fe8ccc17f302a0eb9ab and fixed in 6.6.120 with commit d0e0d1097118461463b76562c7ebaabaa5b90b13
	Issue introduced in 2.6.29 with commit 9d4139c76905833afcb77fe8ccc17f302a0eb9ab and fixed in 6.12.62 with commit dc3636912d41770466543623cb76e7b88fdb42c7
	Issue introduced in 2.6.29 with commit 9d4139c76905833afcb77fe8ccc17f302a0eb9ab and fixed in 6.16 with commit b441cf3f8c4b8576639d20c8eb4aa32917602ecd

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40215
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	include/net/xfrm.h
	net/ipv4/ipcomp.c
	net/ipv6/ipcomp6.c
	net/ipv6/xfrm6_tunnel.c
	net/xfrm/xfrm_ipcomp.c
	net/xfrm/xfrm_state.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/1b28a7fae0128fa140a7dccd995182ff6cd1c67b
	https://git.kernel.org/stable/c/4b2c17d0f9be8b58bb30468bc81a4b61c985b04e
	https://git.kernel.org/stable/c/0da961fa46da1b37ef868d9b603bd202136f8f8e
	https://git.kernel.org/stable/c/d0e0d1097118461463b76562c7ebaabaa5b90b13
	https://git.kernel.org/stable/c/dc3636912d41770466543623cb76e7b88fdb42c7
	https://git.kernel.org/stable/c/b441cf3f8c4b8576639d20c8eb4aa32917602ecd
