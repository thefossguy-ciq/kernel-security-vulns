From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-37837: iommu/tegra241-cmdqv: Fix warnings due to dmam_free_coherent()
Message-Id: <2025050914-CVE-2025-37837-406b@gregkh>
Content-Length: 4144
Lines: 94
X-Developer-Signature: v=1; a=openpgp-sha256; l=4239;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=GSy+fVS8wtI6wcjWZ2bQcZovqC0lFIsxUXizZQDrtzk=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBmyi49Pun7+8OND6TwCNk/ursuxDOo1/j3luauO7HSTs
 nV2C94GdMSyMAgyMciKKbJ82cZzdH/FIUUvQ9vTMHNYmUCGMHBxCsBEZkxhmJ8puWA6h6rsn14t
 py2tPkyXmQPmTmOYn/6M5+csxfexS6Rf5Lyd1dbOfHy6KwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

iommu/tegra241-cmdqv: Fix warnings due to dmam_free_coherent()

Two WARNINGs are observed when SMMU driver rolls back upon failure:
 arm-smmu-v3.9.auto: Failed to register iommu
 arm-smmu-v3.9.auto: probe with driver arm-smmu-v3 failed with error -22
 ------------[ cut here ]------------
 WARNING: CPU: 5 PID: 1 at kernel/dma/mapping.c:74 dmam_free_coherent+0xc0/0xd8
 Call trace:
  dmam_free_coherent+0xc0/0xd8 (P)
  tegra241_vintf_free_lvcmdq+0x74/0x188
  tegra241_cmdqv_remove_vintf+0x60/0x148
  tegra241_cmdqv_remove+0x48/0xc8
  arm_smmu_impl_remove+0x28/0x60
  devm_action_release+0x1c/0x40
 ------------[ cut here ]------------
 128 pages are still in use!
 WARNING: CPU: 16 PID: 1 at mm/page_alloc.c:6902 free_contig_range+0x18c/0x1c8
 Call trace:
  free_contig_range+0x18c/0x1c8 (P)
  cma_release+0x154/0x2f0
  dma_free_contiguous+0x38/0xa0
  dma_direct_free+0x10c/0x248
  dma_free_attrs+0x100/0x290
  dmam_free_coherent+0x78/0xd8
  tegra241_vintf_free_lvcmdq+0x74/0x160
  tegra241_cmdqv_remove+0x98/0x198
  arm_smmu_impl_remove+0x28/0x60
  devm_action_release+0x1c/0x40

This is because the LVCMDQ queue memory are managed by devres, while that
dmam_free_coherent() is called in the context of devm_action_release().

Jason pointed out that "arm_smmu_impl_probe() has mis-ordered the devres
callbacks if ops->device_remove() is going to be manually freeing things
that probe allocated":
https://lore.kernel.org/linux-iommu/20250407174408.GB1722458@nvidia.com/

In fact, tegra241_cmdqv_init_structures() only allocates memory resources
which means any failure that it generates would be similar to -ENOMEM, so
there is no point in having that "falling back to standard SMMU" routine,
as the standard SMMU would likely fail to allocate memory too.

Remove the unwind part in tegra241_cmdqv_init_structures(), and return a
proper error code to ask SMMU driver to call tegra241_cmdqv_remove() via
impl_ops->device_remove(). Then, drop tegra241_vintf_free_lvcmdq() since
devres will take care of that.

The Linux kernel CVE team has assigned CVE-2025-37837 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.12 with commit 483e0bd8883a40fd3dd3193997a4014337698d72 and fixed in 6.12.24 with commit e5dd974d6e00704553308ef1a88659f8dcfb39d4
	Issue introduced in 6.12 with commit 483e0bd8883a40fd3dd3193997a4014337698d72 and fixed in 6.13.12 with commit 5584dbf393df509159813645a487b1ef76557722
	Issue introduced in 6.12 with commit 483e0bd8883a40fd3dd3193997a4014337698d72 and fixed in 6.14.3 with commit e38ed6908080047d8fa1763d1da86b584f9eb55b
	Issue introduced in 6.12 with commit 483e0bd8883a40fd3dd3193997a4014337698d72 and fixed in 6.15-rc2 with commit 767e22001dfce64cc03b7def1562338591ab6031

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-37837
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/iommu/arm/arm-smmu-v3/tegra241-cmdqv.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e5dd974d6e00704553308ef1a88659f8dcfb39d4
	https://git.kernel.org/stable/c/5584dbf393df509159813645a487b1ef76557722
	https://git.kernel.org/stable/c/e38ed6908080047d8fa1763d1da86b584f9eb55b
	https://git.kernel.org/stable/c/767e22001dfce64cc03b7def1562338591ab6031
