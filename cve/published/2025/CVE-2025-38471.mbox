From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38471: tls: always refresh the queue when reading sock

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

tls: always refresh the queue when reading sock

After recent changes in net-next TCP compacts skbs much more
aggressively. This unearthed a bug in TLS where we may try
to operate on an old skb when checking if all skbs in the
queue have matching decrypt state and geometry.

    BUG: KASAN: slab-use-after-free in tls_strp_check_rcv+0x898/0x9a0 [tls]
    (net/tls/tls_strp.c:436 net/tls/tls_strp.c:530 net/tls/tls_strp.c:544)
    Read of size 4 at addr ffff888013085750 by task tls/13529

    CPU: 2 UID: 0 PID: 13529 Comm: tls Not tainted 6.16.0-rc5-virtme
    Call Trace:
     kasan_report+0xca/0x100
     tls_strp_check_rcv+0x898/0x9a0 [tls]
     tls_rx_rec_wait+0x2c9/0x8d0 [tls]
     tls_sw_recvmsg+0x40f/0x1aa0 [tls]
     inet_recvmsg+0x1c3/0x1f0

Always reload the queue, fast path is to have the record in the queue
when we wake, anyway (IOW the path going down "if !strp->stm.full_len").

The Linux kernel CVE team has assigned CVE-2025-38471 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.1 with commit 0d87bbd39d7fd1135ab9eca672d760470f6508e8 and fixed in 6.1.147 with commit 730fed2ff5e259495712518e18d9f521f61972bb
	Issue introduced in 6.1 with commit 0d87bbd39d7fd1135ab9eca672d760470f6508e8 and fixed in 6.6.100 with commit 1f3a429c21e0e43e8b8c55d30701e91411a4df02
	Issue introduced in 6.1 with commit 0d87bbd39d7fd1135ab9eca672d760470f6508e8 and fixed in 6.12.40 with commit cdb767915fc9a15d88d19d52a1455f1dc3e5ddc8
	Issue introduced in 6.1 with commit 0d87bbd39d7fd1135ab9eca672d760470f6508e8 and fixed in 6.15.8 with commit c76f6f437c46b2390888e0e1dc7aafafa9f4e0c6
	Issue introduced in 6.1 with commit 0d87bbd39d7fd1135ab9eca672d760470f6508e8 and fixed in 6.16 with commit 4ab26bce3969f8fd925fe6f6f551e4d1a508c68b
	Issue introduced in 6.0.6 with commit 2277d7cbdf47531b2c3cd01ba15255fa955aab35

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38471
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/tls/tls_strp.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/730fed2ff5e259495712518e18d9f521f61972bb
	https://git.kernel.org/stable/c/1f3a429c21e0e43e8b8c55d30701e91411a4df02
	https://git.kernel.org/stable/c/cdb767915fc9a15d88d19d52a1455f1dc3e5ddc8
	https://git.kernel.org/stable/c/c76f6f437c46b2390888e0e1dc7aafafa9f4e0c6
	https://git.kernel.org/stable/c/4ab26bce3969f8fd925fe6f6f551e4d1a508c68b
