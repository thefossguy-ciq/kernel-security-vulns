From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38710: gfs2: Validate i_depth for exhash directories
Message-Id: <2025090456-CVE-2025-38710-1b60@gregkh>
Content-Length: 2558
Lines: 68
X-Developer-Signature: v=1; a=openpgp-sha256; l=2627;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=Qykzrg2MLyb2RPIwMmOhuLG0VKgDtFjd0JghfSrWh8Y=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBk7N2oc6PmdqNOyo2oWp0//C5fTxtfWTlPfWfFKu8VqZ
 o/VrPtPOmJZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAi3jwM88MYZtc6R4nfepwR
 /X9dv1D3BSGnPQzzM+fHx7QuKLeutts4tez5otp7fhPzAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

gfs2: Validate i_depth for exhash directories

A fuzzer test introduced corruption that ends up with a depth of 0 in
dir_e_read(), causing an undefined shift by 32 at:

  index = hash >> (32 - dip->i_depth);

As calculated in an open-coded way in dir_make_exhash(), the minimum
depth for an exhash directory is ilog2(sdp->sd_hash_ptrs) and 0 is
invalid as sdp->sd_hash_ptrs is fixed as sdp->bsize / 16 at mount time.

So we can avoid the undefined behaviour by checking for depth values
lower than the minimum in gfs2_dinode_in(). Values greater than the
maximum are already being checked for there.

Also switch the calculation in dir_make_exhash() to use ilog2() to
clarify how the depth is calculated.

Tested with the syzkaller repro.c and xfstests '-g quick'.

The Linux kernel CVE team has assigned CVE-2025-38710 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.12.43 with commit 53a0249d68a210c16e961b83adfa82f94ee0a53d
	Fixed in 6.15.11 with commit b5f46951e62377b6e406fadc18bc3c5bdf1632a7
	Fixed in 6.16.2 with commit 9680c58675b82348ab84d387e4fa727f7587e1a0
	Fixed in 6.17-rc1 with commit 557c024ca7250bb65ae60f16c02074106c2f197b

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38710
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/gfs2/dir.c
	fs/gfs2/glops.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/53a0249d68a210c16e961b83adfa82f94ee0a53d
	https://git.kernel.org/stable/c/b5f46951e62377b6e406fadc18bc3c5bdf1632a7
	https://git.kernel.org/stable/c/9680c58675b82348ab84d387e4fa727f7587e1a0
	https://git.kernel.org/stable/c/557c024ca7250bb65ae60f16c02074106c2f197b
