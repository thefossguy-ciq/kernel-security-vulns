From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-39841: scsi: lpfc: Fix buffer free/clear order in deferred receive path
Message-Id: <2025091902-CVE-2025-39841-2c0f@gregkh>
Content-Length: 3610
Lines: 67
X-Developer-Signature: v=1; a=openpgp-sha256; l=3678;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=ykOjPmyv+wpA1WezDqyC/tgOIYViC1LMFYr5e+4itRU=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBlny5qkKpekfHKLkjz+4RV7UMNNr+Z1ITUzZvxqW1v6y
 LCm7n1IRywLgyATg6yYIsuXbTxH91ccUvQytD0NM4eVCWQIAxenAEzkjRbD/OL9ZV4eB3e8m5OV
 HDRT72BhnuhiOYYF86+vzV0qcf3L9Dm8m28c2rvnjNXLfAA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

scsi: lpfc: Fix buffer free/clear order in deferred receive path

Fix a use-after-free window by correcting the buffer release sequence in
the deferred receive path. The code freed the RQ buffer first and only
then cleared the context pointer under the lock. Concurrent paths (e.g.,
ABTS and the repost path) also inspect and release the same pointer under
the lock, so the old order could lead to double-free/UAF.

Note that the repost path already uses the correct pattern: detach the
pointer under the lock, then free it after dropping the lock. The
deferred path should do the same.

The Linux kernel CVE team has assigned CVE-2025-39841 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 5.4.299 with commit ab34084f42ee06a9028d67c78feafb911d33d111
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 5.10.243 with commit baa39f6ad79d372a6ce0aa639fbb2f1578479f57
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 5.15.192 with commit 95b63d15fce5c54a73bbf195e1aacb5a75b128e2
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 6.1.151 with commit 55658c7501467ca9ef3bd4453dd920010db8bc13
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 6.6.105 with commit d96cc9a1b57725930c60b607423759d563b4d900
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 6.12.46 with commit 367cb5ffd8a8a4c85dc89f55e7fa7cc191425b11
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 6.16.6 with commit 897f64b01c1249ac730329b83f4f40bab71e86c7
	Issue introduced in 5.1 with commit 472e146d1cf3410a898b49834500fa9e33ac41a2 and fixed in 6.17-rc5 with commit 9dba9a45c348e8460da97c450cddf70b2056deb3

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-39841
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/scsi/lpfc/lpfc_nvmet.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/ab34084f42ee06a9028d67c78feafb911d33d111
	https://git.kernel.org/stable/c/baa39f6ad79d372a6ce0aa639fbb2f1578479f57
	https://git.kernel.org/stable/c/95b63d15fce5c54a73bbf195e1aacb5a75b128e2
	https://git.kernel.org/stable/c/55658c7501467ca9ef3bd4453dd920010db8bc13
	https://git.kernel.org/stable/c/d96cc9a1b57725930c60b607423759d563b4d900
	https://git.kernel.org/stable/c/367cb5ffd8a8a4c85dc89f55e7fa7cc191425b11
	https://git.kernel.org/stable/c/897f64b01c1249ac730329b83f4f40bab71e86c7
	https://git.kernel.org/stable/c/9dba9a45c348e8460da97c450cddf70b2056deb3
