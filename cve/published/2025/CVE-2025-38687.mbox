From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38687: comedi: fix race between polling and detaching
Message-Id: <2025090448-CVE-2025-38687-564a@gregkh>
Content-Length: 4693
Lines: 87
X-Developer-Signature: v=1; a=openpgp-sha256; l=4781;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=uSy5rMAk88H1TfLI8OcUEKYNmeUdMBpPHgLYoeCnz0A=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDBk7NyoczAzJLulySFp3hvvhEbuM8KeBkT2zNeecbt+05
 W2byKZTHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjARwwcM81NZUy9m5XFc+/vs
 8Ffb6WE8drenRDHMM9qgZs8ou/3FnfAVgdPND6hLn/27AwA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

comedi: fix race between polling and detaching

syzbot reports a use-after-free in comedi in the below link, which is
due to comedi gladly removing the allocated async area even though poll
requests are still active on the wait_queue_head inside of it. This can
cause a use-after-free when the poll entries are later triggered or
removed, as the memory for the wait_queue_head has been freed.  We need
to check there are no tasks queued on any of the subdevices' wait queues
before allowing the device to be detached by the `COMEDI_DEVCONFIG`
ioctl.

Tasks will read-lock `dev->attach_lock` before adding themselves to the
subdevice wait queue, so fix the problem in the `COMEDI_DEVCONFIG` ioctl
handler by write-locking `dev->attach_lock` before checking that all of
the subdevices are safe to be deleted.  This includes testing for any
sleepers on the subdevices' wait queues.  It remains locked until the
device has been detached.  This requires the `comedi_device_detach()`
function to be refactored slightly, moving the bulk of it into new
function `comedi_device_detach_locked()`.

Note that the refactor of `comedi_device_detach()` results in
`comedi_device_cancel_all()` now being called while `dev->attach_lock`
is write-locked, which wasn't the case previously, but that does not
matter.

Thanks to Jens Axboe for diagnosing the problem and co-developing this
patch.

The Linux kernel CVE team has assigned CVE-2025-38687 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 5.4.297 with commit fe67122ba781df44a1a9716eb1dfd751321ab512
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 5.10.241 with commit cd4286123d6948ff638ea9cd5818ae4796d5d252
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 5.15.190 with commit d85fac8729c9acfd72368faff1d576ec585e5c8f
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 6.1.149 with commit 0f989f9d05492028afd2bded4b42023c57d8a76e
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 6.6.103 with commit 5c4a2ffcbd052c69bbf4680677d4c4eaa5a252d4
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 6.12.43 with commit 017198079551a2a5cf61eae966af3c4b145e1f3b
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 6.15.11 with commit 71ca60d2e631cf9c63bcbc7017961c61ff04e419
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 6.16.2 with commit 5724e82df4f9a4be62908362c97d522d25de75dd
	Issue introduced in 3.14 with commit 2f3fdcd7ce935f6f2899ceab57dc8fe5286db3e1 and fixed in 6.17-rc1 with commit 35b6fc51c666fc96355be5cd633ed0fe4ccf68b2

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38687
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/comedi/comedi_fops.c
	drivers/comedi/comedi_internal.h
	drivers/comedi/drivers.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/fe67122ba781df44a1a9716eb1dfd751321ab512
	https://git.kernel.org/stable/c/cd4286123d6948ff638ea9cd5818ae4796d5d252
	https://git.kernel.org/stable/c/d85fac8729c9acfd72368faff1d576ec585e5c8f
	https://git.kernel.org/stable/c/0f989f9d05492028afd2bded4b42023c57d8a76e
	https://git.kernel.org/stable/c/5c4a2ffcbd052c69bbf4680677d4c4eaa5a252d4
	https://git.kernel.org/stable/c/017198079551a2a5cf61eae966af3c4b145e1f3b
	https://git.kernel.org/stable/c/71ca60d2e631cf9c63bcbc7017961c61ff04e419
	https://git.kernel.org/stable/c/5724e82df4f9a4be62908362c97d522d25de75dd
	https://git.kernel.org/stable/c/35b6fc51c666fc96355be5cd633ed0fe4ccf68b2
