From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40297: net: bridge: fix use-after-free due to MST port state bypass

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

net: bridge: fix use-after-free due to MST port state bypass

syzbot reported[1] a use-after-free when deleting an expired fdb. It is
due to a race condition between learning still happening and a port being
deleted, after all its fdbs have been flushed. The port's state has been
toggled to disabled so no learning should happen at that time, but if we
have MST enabled, it will bypass the port's state, that together with VLAN
filtering disabled can lead to fdb learning at a time when it shouldn't
happen while the port is being deleted. VLAN filtering must be disabled
because we flush the port VLANs when it's being deleted which will stop
learning. This fix adds a check for the port's vlan group which is
initialized to NULL when the port is getting deleted, that avoids the port
state bypass. When MST is enabled there would be a minimal new overhead
in the fast-path because the port's vlan group pointer is cache-hot.

[1] https://syzkaller.appspot.com/bug?extid=dd280197f0f7ab3917be

The Linux kernel CVE team has assigned CVE-2025-40297 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.18 with commit ec7328b59176227216c461601c6bd0e922232a9b and fixed in 6.1.159 with commit e19085b2a86addccff33ab8536fc67ebd9d52198
	Issue introduced in 5.18 with commit ec7328b59176227216c461601c6bd0e922232a9b and fixed in 6.6.117 with commit 3b60ce334c1ce8b3fad7e02dcd5ed9f6646477c8
	Issue introduced in 5.18 with commit ec7328b59176227216c461601c6bd0e922232a9b and fixed in 6.12.58 with commit bf3843183bc3158e5821b46f330c438ae9bd6ddb
	Issue introduced in 5.18 with commit ec7328b59176227216c461601c6bd0e922232a9b and fixed in 6.17.8 with commit 991fbe1680cd41a5f97c92cd3a3496315df36e4b
	Issue introduced in 5.18 with commit ec7328b59176227216c461601c6bd0e922232a9b and fixed in 6.18 with commit 8dca36978aa80bab9d4da130c211db75c9e00048

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40297
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	net/bridge/br_forward.c
	net/bridge/br_input.c
	net/bridge/br_private.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/e19085b2a86addccff33ab8536fc67ebd9d52198
	https://git.kernel.org/stable/c/3b60ce334c1ce8b3fad7e02dcd5ed9f6646477c8
	https://git.kernel.org/stable/c/bf3843183bc3158e5821b46f330c438ae9bd6ddb
	https://git.kernel.org/stable/c/991fbe1680cd41a5f97c92cd3a3496315df36e4b
	https://git.kernel.org/stable/c/8dca36978aa80bab9d4da130c211db75c9e00048
