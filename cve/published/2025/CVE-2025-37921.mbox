From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-37921: vxlan: vnifilter: Fix unlocked deletion of default FDB entry

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

vxlan: vnifilter: Fix unlocked deletion of default FDB entry

When a VNI is deleted from a VXLAN device in 'vnifilter' mode, the FDB
entry associated with the default remote (assuming one was configured)
is deleted without holding the hash lock. This is wrong and will result
in a warning [1] being generated by the lockdep annotation that was
added by commit ebe642067455 ("vxlan: Create wrappers for FDB lookup").

Reproducer:

 # ip link add vx0 up type vxlan dstport 4789 external vnifilter local 192.0.2.1
 # bridge vni add vni 10010 remote 198.51.100.1 dev vx0
 # bridge vni del vni 10010 dev vx0

Fix by acquiring the hash lock before the deletion and releasing it
afterwards. Blame the original commit that introduced the issue rather
than the one that exposed it.

[1]
WARNING: CPU: 3 PID: 392 at drivers/net/vxlan/vxlan_core.c:417 vxlan_find_mac+0x17f/0x1a0
[...]
RIP: 0010:vxlan_find_mac+0x17f/0x1a0
[...]
Call Trace:
 <TASK>
 __vxlan_fdb_delete+0xbe/0x560
 vxlan_vni_delete_group+0x2ba/0x940
 vxlan_vni_del.isra.0+0x15f/0x580
 vxlan_process_vni_filter+0x38b/0x7b0
 vxlan_vnifilter_process+0x3bb/0x510
 rtnetlink_rcv_msg+0x2f7/0xb70
 netlink_rcv_skb+0x131/0x360
 netlink_unicast+0x426/0x710
 netlink_sendmsg+0x75a/0xc20
 __sock_sendmsg+0xc1/0x150
 ____sys_sendmsg+0x5aa/0x7b0
 ___sys_sendmsg+0xfc/0x180
 __sys_sendmsg+0x121/0x1b0
 do_syscall_64+0xbb/0x1d0
 entry_SYSCALL_64_after_hwframe+0x4b/0x53

The Linux kernel CVE team has assigned CVE-2025-37921 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.18 with commit f9c4bb0b245cee35ef66f75bf409c9573d934cf9 and fixed in 6.1.138 with commit 2d4a121296aa3940d2df9906f955c2b6b4e38bc3
	Issue introduced in 5.18 with commit f9c4bb0b245cee35ef66f75bf409c9573d934cf9 and fixed in 6.6.90 with commit 3576e9a80b6c4381b01ce0cbaa07f5e92d4492ed
	Issue introduced in 5.18 with commit f9c4bb0b245cee35ef66f75bf409c9573d934cf9 and fixed in 6.12.28 with commit 5cb9e07f84e527974b12e82e2549fa6c0cc6eef0
	Issue introduced in 5.18 with commit f9c4bb0b245cee35ef66f75bf409c9573d934cf9 and fixed in 6.14.6 with commit 470206205588559e60035fceb5f256640cb45f99
	Issue introduced in 5.18 with commit f9c4bb0b245cee35ef66f75bf409c9573d934cf9 and fixed in 6.15 with commit 087a9eb9e5978e3ba362e1163691e41097e8ca20

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-37921
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/vxlan/vxlan_vnifilter.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/2d4a121296aa3940d2df9906f955c2b6b4e38bc3
	https://git.kernel.org/stable/c/3576e9a80b6c4381b01ce0cbaa07f5e92d4492ed
	https://git.kernel.org/stable/c/5cb9e07f84e527974b12e82e2549fa6c0cc6eef0
	https://git.kernel.org/stable/c/470206205588559e60035fceb5f256640cb45f99
	https://git.kernel.org/stable/c/087a9eb9e5978e3ba362e1163691e41097e8ca20
