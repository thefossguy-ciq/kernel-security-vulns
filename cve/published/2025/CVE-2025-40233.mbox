From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-40233: ocfs2: clear extent cache after moving/defragmenting extents

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

ocfs2: clear extent cache after moving/defragmenting extents

The extent map cache can become stale when extents are moved or
defragmented, causing subsequent operations to see outdated extent flags. 
This triggers a BUG_ON in ocfs2_refcount_cal_cow_clusters().

The problem occurs when:
1. copy_file_range() creates a reflinked extent with OCFS2_EXT_REFCOUNTED
2. ioctl(FITRIM) triggers ocfs2_move_extents()
3. __ocfs2_move_extents_range() reads and caches the extent (flags=0x2)
4. ocfs2_move_extent()/ocfs2_defrag_extent() calls __ocfs2_move_extent()
   which clears OCFS2_EXT_REFCOUNTED flag on disk (flags=0x0)
5. The extent map cache is not invalidated after the move
6. Later write() operations read stale cached flags (0x2) but disk has
   updated flags (0x0), causing a mismatch
7. BUG_ON(!(rec->e_flags & OCFS2_EXT_REFCOUNTED)) triggers

Fix by clearing the extent map cache after each extent move/defrag
operation in __ocfs2_move_extents_range().  This ensures subsequent
operations read fresh extent data from disk.

The Linux kernel CVE team has assigned CVE-2025-40233 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 5.4.301 with commit 93166bc53c0e3587058327a4121daea34b4fecd5
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 5.10.246 with commit a7ee72286efba1d407c6f15a0528e43593fb7007
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 5.15.196 with commit 93b1ab422f1966b71561158e1aedce4ec100f357
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 6.1.158 with commit e92af7737a94a729225d2a5d180eaaa77fe0bbc1
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 6.6.115 with commit aa6a21409dd6221bb268b56bb410e031c632ff9a
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 6.12.56 with commit bb69928ed578f881e68d26aaf1a8f6e7faab3b44
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 6.17.6 with commit a21750df2f6169af6e039a3bb4893d6c9564e48d
	Issue introduced in 3.0 with commit 53069d4e76954e2e63c1b3c501051c6fbcf7298c and fixed in 6.18 with commit 78a63493f8e352296dbc7cb7b3f4973105e8679e

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-40233
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	fs/ocfs2/move_extents.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/93166bc53c0e3587058327a4121daea34b4fecd5
	https://git.kernel.org/stable/c/a7ee72286efba1d407c6f15a0528e43593fb7007
	https://git.kernel.org/stable/c/93b1ab422f1966b71561158e1aedce4ec100f357
	https://git.kernel.org/stable/c/e92af7737a94a729225d2a5d180eaaa77fe0bbc1
	https://git.kernel.org/stable/c/aa6a21409dd6221bb268b56bb410e031c632ff9a
	https://git.kernel.org/stable/c/bb69928ed578f881e68d26aaf1a8f6e7faab3b44
	https://git.kernel.org/stable/c/a21750df2f6169af6e039a3bb4893d6c9564e48d
	https://git.kernel.org/stable/c/78a63493f8e352296dbc7cb7b3f4973105e8679e
