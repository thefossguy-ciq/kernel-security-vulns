From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-38384: mtd: spinand: fix memory leak of ECC engine conf

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

mtd: spinand: fix memory leak of ECC engine conf

Memory allocated for the ECC engine conf is not released during spinand
cleanup. Below kmemleak trace is seen for this memory leak:

unreferenced object 0xffffff80064f00e0 (size 8):
  comm "swapper/0", pid 1, jiffies 4294937458
  hex dump (first 8 bytes):
    00 00 00 00 00 00 00 00                          ........
  backtrace (crc 0):
    kmemleak_alloc+0x30/0x40
    __kmalloc_cache_noprof+0x208/0x3c0
    spinand_ondie_ecc_init_ctx+0x114/0x200
    nand_ecc_init_ctx+0x70/0xa8
    nanddev_ecc_engine_init+0xec/0x27c
    spinand_probe+0xa2c/0x1620
    spi_mem_probe+0x130/0x21c
    spi_probe+0xf0/0x170
    really_probe+0x17c/0x6e8
    __driver_probe_device+0x17c/0x21c
    driver_probe_device+0x58/0x180
    __device_attach_driver+0x15c/0x1f8
    bus_for_each_drv+0xec/0x150
    __device_attach+0x188/0x24c
    device_initial_probe+0x10/0x20
    bus_probe_device+0x11c/0x160

Fix the leak by calling nanddev_ecc_engine_cleanup() inside
spinand_cleanup().

The Linux kernel CVE team has assigned CVE-2025-38384 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.11 with commit 3d1f08b032dc4e168f3aefed1e07a63c3c080325 and fixed in 5.15.187 with commit 68d3417305ee100dcad90fd6e5846b22497aa394
	Issue introduced in 5.11 with commit 3d1f08b032dc4e168f3aefed1e07a63c3c080325 and fixed in 6.1.144 with commit f99408670407abb6493780e38cb4ece3fbb52cfc
	Issue introduced in 5.11 with commit 3d1f08b032dc4e168f3aefed1e07a63c3c080325 and fixed in 6.6.97 with commit d5c1e3f32902ab518519d05515ee6030fd6c59ae
	Issue introduced in 5.11 with commit 3d1f08b032dc4e168f3aefed1e07a63c3c080325 and fixed in 6.12.37 with commit c40b207cafd006c610832ba52a81cedee77adcb9
	Issue introduced in 5.11 with commit 3d1f08b032dc4e168f3aefed1e07a63c3c080325 and fixed in 6.15.6 with commit 93147abf80a831dd3b5660b3309b4f09546073b2
	Issue introduced in 5.11 with commit 3d1f08b032dc4e168f3aefed1e07a63c3c080325 and fixed in 6.16 with commit 6463cbe08b0cbf9bba8763306764f5fd643023e1

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-38384
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/mtd/nand/spi/core.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/68d3417305ee100dcad90fd6e5846b22497aa394
	https://git.kernel.org/stable/c/f99408670407abb6493780e38cb4ece3fbb52cfc
	https://git.kernel.org/stable/c/d5c1e3f32902ab518519d05515ee6030fd6c59ae
	https://git.kernel.org/stable/c/c40b207cafd006c610832ba52a81cedee77adcb9
	https://git.kernel.org/stable/c/93147abf80a831dd3b5660b3309b4f09546073b2
	https://git.kernel.org/stable/c/6463cbe08b0cbf9bba8763306764f5fd643023e1
