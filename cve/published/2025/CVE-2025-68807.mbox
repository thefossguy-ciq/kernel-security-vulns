From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68807: block: fix race between wbt_enable_default and IO submission
Message-Id: <2026011310-CVE-2025-68807-0fd6@gregkh>
Content-Length: 3525
Lines: 96
X-Developer-Signature: v=1; a=openpgp-sha256; l=3622;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=HBYWPPxaKVqTUTVefF0bZA76HuTJ0D0VJRvwxVR9CkU=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJlpKcfMw68/CtBQXtr4+qGFW9obn2x/Qe/fBwXXrJ0yb
 UvI91W7OmJZGASZGGTFFFm+bOM5ur/ikKKXoe1pmDmsTCBDGLg4BWAiu34xLDg3gaVMeOeMzJO1
 CzbK/jXbcfbgRBuGOXwSkS8Vbz0p3nQiLbTKxfxCjP7h+wA=
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

block: fix race between wbt_enable_default and IO submission

When wbt_enable_default() is moved out of queue freezing in elevator_change(),
it can cause the wbt inflight counter to become negative (-1), leading to hung
tasks in the writeback path. Tasks get stuck in wbt_wait() because the counter
is in an inconsistent state.

The issue occurs because wbt_enable_default() could race with IO submission,
allowing the counter to be decremented before proper initialization. This manifests
as:

  rq_wait[0]:
    inflight:             -1
    has_waiters:        True

rwb_enabled() checks the state, which can be updated exactly between wbt_wait()
(rq_qos_throttle()) and wbt_track()(rq_qos_track()), then the inflight counter
will become negative.

And results in hung task warnings like:
  task:kworker/u24:39 state:D stack:0 pid:14767
  Call Trace:
    rq_qos_wait+0xb4/0x150
    wbt_wait+0xa9/0x100
    __rq_qos_throttle+0x24/0x40
    blk_mq_submit_bio+0x672/0x7b0
    ...

Fix this by:

1. Splitting wbt_enable_default() into:
   - __wbt_enable_default(): Returns true if wbt_init() should be called
   - wbt_enable_default(): Wrapper for existing callers (no init)
   - wbt_init_enable_default(): New function that checks and inits WBT

2. Using wbt_init_enable_default() in blk_register_queue() to ensure
   proper initialization during queue registration

3. Move wbt_init() out of wbt_enable_default() which is only for enabling
   disabled wbt from bfq and iocost, and wbt_init() isn't needed. Then the
   original lock warning can be avoided.

4. Removing the ELEVATOR_FLAG_ENABLE_WBT_ON_EXIT flag and its handling
   code since it's no longer needed

This ensures WBT is properly initialized before any IO can be submitted,
preventing the counter from going negative.

The Linux kernel CVE team has assigned CVE-2025-68807 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 6.16 with commit 78c271344b6f64ce24c845e54903e09928cf2061 and fixed in 6.18.3 with commit f55201fb3becff6a903fd29f4d1147cc7e91eb0c
	Issue introduced in 6.16 with commit 78c271344b6f64ce24c845e54903e09928cf2061 and fixed in 6.19-rc2 with commit 9869d3a6fed381f3b98404e26e1afc75d680cbf9

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68807
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	block/bfq-iosched.c
	block/blk-sysfs.c
	block/blk-wbt.c
	block/blk-wbt.h
	block/elevator.c
	block/elevator.h


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/f55201fb3becff6a903fd29f4d1147cc7e91eb0c
	https://git.kernel.org/stable/c/9869d3a6fed381f3b98404e26e1afc75d680cbf9
