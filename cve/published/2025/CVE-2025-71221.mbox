From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-71221: dmaengine: mmp_pdma: Fix race condition in mmp_pdma_residue()
Message-Id: <2026021426-CVE-2025-71221-2987@gregkh>
Content-Length: 2590
Lines: 71
X-Developer-Signature: v=1; a=openpgp-sha256; l=2662;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=ThM8mMdIgOh40+CBo9jg9zhlKBxTt1I08WovCpukCQI=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJkTFq0ylRTl4JJcaPJq+rqMr9mrq04Um0cl5B7/9LR14
 8rurpBFHbEsDIJMDLJiiixftvEc3V9xSNHL0PY0zBxWJpAhDFycAjCRG58Z5ll86vTy7tJw0Lrh
 2O8oJ/STS+p6AcP8zOabb9y+6DTJ3lMST+Oxefz8VsI5AA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

dmaengine: mmp_pdma: Fix race condition in mmp_pdma_residue()

Add proper locking in mmp_pdma_residue() to prevent use-after-free when
accessing descriptor list and descriptor contents.

The race occurs when multiple threads call tx_status() while the tasklet
on another CPU is freeing completed descriptors:

CPU 0                              CPU 1
-----                              -----
mmp_pdma_tx_status()
mmp_pdma_residue()
  -> NO LOCK held
     list_for_each_entry(sw, ..)
                                   DMA interrupt
                                   dma_do_tasklet()
                                     -> spin_lock(&desc_lock)
                                        list_move(sw->node, ...)
                                        spin_unlock(&desc_lock)
  |                                     dma_pool_free(sw) <- FREED!
  -> access sw->desc <- UAF!

This issue can be reproduced when running dmatest on the same channel with
multiple threads (threads_per_chan > 1).

Fix by protecting the chain_running list iteration and descriptor access
with the chan->desc_lock spinlock.

The Linux kernel CVE team has assigned CVE-2025-71221 to this issue.


Affected and fixed versions
===========================

	Fixed in 6.18.10 with commit 9f665b3c3d9a168410251f27a5d019b7bf93185c
	Fixed in 6.19 with commit a143545855bc2c6e1330f6f57ae375ac44af00a7

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-71221
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/dma/mmp_pdma.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/9f665b3c3d9a168410251f27a5d019b7bf93185c
	https://git.kernel.org/stable/c/a143545855bc2c6e1330f6f57ae375ac44af00a7
