From bippy-1.2.0 Mon Sep 17 00:00:00 2001
From: Greg Kroah-Hartman <gregkh@kernel.org>
To: <linux-cve-announce@vger.kernel.org>
Reply-to: <cve@kernel.org>, <linux-kernel@vger.kernel.org>
Subject: CVE-2025-68320: lan966x: Fix sleeping in atomic context
Message-Id: <2025121622-CVE-2025-68320-4e08@gregkh>
Content-Length: 3853
Lines: 85
X-Developer-Signature: v=1; a=openpgp-sha256; l=3939;
 i=gregkh@linuxfoundation.org; h=from:subject:message-id;
 bh=htv425bb0qkm763+Z3LiKO362ZueOIeXEYS58YVenEs=;
 b=owGbwMvMwCRo6H6F97bub03G02pJDJmOdWEMU8qfzJl66mii7aS5+3sjIrZ+7/fnk+YKnHB72
 +01O6c3dsSyMAgyMciKKbJ82cZzdH/FIUUvQ9vTMHNYmcCGcHEKwETaExnmB03b52a27fCPZelB
 j39WtinMnT1VlWHBiimeP6I/9FxMOrj/tLgYq8T00JcTAA==
X-Developer-Key: i=gregkh@linuxfoundation.org; a=openpgp;
 fpr=F4B60CC5BF78C2214A313DCB3147D40DDB2DFB29

Description
===========

In the Linux kernel, the following vulnerability has been resolved:

lan966x: Fix sleeping in atomic context

The following warning was seen when we try to connect using ssh to the device.

BUG: sleeping function called from invalid context at kernel/locking/mutex.c:575
in_atomic(): 1, irqs_disabled(): 0, non_block: 0, pid: 104, name: dropbear
preempt_count: 1, expected: 0
INFO: lockdep is turned off.
CPU: 0 UID: 0 PID: 104 Comm: dropbear Tainted: G        W           6.18.0-rc2-00399-g6f1ab1b109b9-dirty #530 NONE
Tainted: [W]=WARN
Hardware name: Generic DT based system
Call trace:
 unwind_backtrace from show_stack+0x10/0x14
 show_stack from dump_stack_lvl+0x7c/0xac
 dump_stack_lvl from __might_resched+0x16c/0x2b0
 __might_resched from __mutex_lock+0x64/0xd34
 __mutex_lock from mutex_lock_nested+0x1c/0x24
 mutex_lock_nested from lan966x_stats_get+0x5c/0x558
 lan966x_stats_get from dev_get_stats+0x40/0x43c
 dev_get_stats from dev_seq_printf_stats+0x3c/0x184
 dev_seq_printf_stats from dev_seq_show+0x10/0x30
 dev_seq_show from seq_read_iter+0x350/0x4ec
 seq_read_iter from seq_read+0xfc/0x194
 seq_read from proc_reg_read+0xac/0x100
 proc_reg_read from vfs_read+0xb0/0x2b0
 vfs_read from ksys_read+0x6c/0xec
 ksys_read from ret_fast_syscall+0x0/0x1c
Exception stack(0xf0b11fa8 to 0xf0b11ff0)
1fa0:                   00000001 00001000 00000008 be9048d8 00001000 00000001
1fc0: 00000001 00001000 00000008 00000003 be905920 0000001e 00000000 00000001
1fe0: 0005404c be9048c0 00018684 b6ec2cd8

It seems that we are using a mutex in a atomic context which is wrong.
Change the mutex with a spinlock.

The Linux kernel CVE team has assigned CVE-2025-68320 to this issue.


Affected and fixed versions
===========================

	Issue introduced in 5.17 with commit 12c2d0a5b8e2a1afc8c7738e19a0d1dd7f3d4007 and fixed in 6.6.117 with commit 5a5d2f7727752b64d13263eacd9f8d08a322e662
	Issue introduced in 5.17 with commit 12c2d0a5b8e2a1afc8c7738e19a0d1dd7f3d4007 and fixed in 6.12.58 with commit c8ab03aa5bd9fd8bfe5d9552d8605826759fdd4d
	Issue introduced in 5.17 with commit 12c2d0a5b8e2a1afc8c7738e19a0d1dd7f3d4007 and fixed in 6.17.8 with commit 3ac743c60ec502163c435712d527eeced8d83348
	Issue introduced in 5.17 with commit 12c2d0a5b8e2a1afc8c7738e19a0d1dd7f3d4007 and fixed in 6.18 with commit 0216721ce71252f60d89af49c8dff613358058d3

Please see https://www.kernel.org for a full list of currently supported
kernel versions by the kernel community.

Unaffected versions might change over time as fixes are backported to
older supported kernel versions.  The official CVE entry at
	https://cve.org/CVERecord/?id=CVE-2025-68320
will be updated if fixes are backported, please check that for the most
up to date information about this issue.


Affected files
==============

The file(s) affected by this issue are:
	drivers/net/ethernet/microchip/lan966x/lan966x_ethtool.c
	drivers/net/ethernet/microchip/lan966x/lan966x_main.c
	drivers/net/ethernet/microchip/lan966x/lan966x_main.h
	drivers/net/ethernet/microchip/lan966x/lan966x_vcap_impl.c


Mitigation
==========

The Linux kernel CVE team recommends that you update to the latest
stable kernel version for this, and many other bugfixes.  Individual
changes are never tested alone, but rather are part of a larger kernel
release.  Cherry-picking individual commits is not recommended or
supported by the Linux kernel community at all.  If however, updating to
the latest release is impossible, the individual changes to resolve this
issue can be found at these commits:
	https://git.kernel.org/stable/c/5a5d2f7727752b64d13263eacd9f8d08a322e662
	https://git.kernel.org/stable/c/c8ab03aa5bd9fd8bfe5d9552d8605826759fdd4d
	https://git.kernel.org/stable/c/3ac743c60ec502163c435712d527eeced8d83348
	https://git.kernel.org/stable/c/0216721ce71252f60d89af49c8dff613358058d3
